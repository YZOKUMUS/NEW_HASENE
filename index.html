<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Hasene Arapça Oyunu</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="icon-192-v4-RED-MUSHAF.png">
    
    <script>
    const manifestPath = "manifest.json";
    document.write(`<link rel="manifest" href="${manifestPath}">`);
</script>



    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Hasene Arapça">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; media-src 'self' https://audios.quranwbw.com https://tanzil.net https://everyayah.com; connect-src 'self' https://audios.quranwbw.com https://tanzil.net https://everyayah.com;">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icon-192-v4-RED-MUSHAF.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192-v4-RED-MUSHAF.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512-v4-RED-MUSHAF.png">
    
    <!-- Uthmani Kur'an Fonts -->
    <!-- Note: Uthmani font is loaded locally via style.css (KFGQPC Uthmanic Script HAFS Regular.otf) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Google Fonts with error handling - loads asynchronously to prevent blocking on certificate errors -->
    <link href="https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@400;500;600;700&family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'" onerror="this.onerror=null; this.remove();">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@400;500;600;700&family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet"></noscript>
    
    <!-- Material Icons (served via Google Fonts) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" rel="stylesheet" media="print" onload="this.media='all'" onerror="this.onerror=null; this.remove();">
    <noscript><link href="https://fonts.googleapis.com/icon?family=Material+Icons&display=swap" rel="stylesheet"></noscript>
    
    <!-- Flutter Modern CSS -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Modüler JavaScript Dosyaları -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/error-handler.js"></script>
    <script src="js/data-loader.js"></script>
    <script src="js/favorites.js"></script>
    
    
    
</head>
<body>
    <!-- Loading Sayfası - Yeni Tasarım -->
    <div class="loading-screen-new" id="loadingScreen">
        <!-- Logo -->
        <div class="loading-logo-wrapper">
            <img src="icon-512-v4-RED-MUSHAF.png" alt="HASENE Logo" class="loading-logo-img">
        </div>
        
        <!-- Title -->
        <h1 class="loading-app-title">HASENE</h1>

        <!-- Hadith Box -->
        <div class="loading-hadith-container" id="hadisBox">
            <div class="loading-hadith-arabic-text" id="hadisArabic">
                مَنْ قَرَأَ حَرْفًا مِنْ كِتَابِ اللَّهِ فَلَهُ بِهِ حَسَنَةٌ وَالْحَسَنَةُ بِعَشْرِ أَمْثَالِهَا
            </div>
            <div class="loading-hadith-turkish-text" id="hadisTurkish">
                "Kim Allah'ın kitabından bir harf okursa, ona bir sevap verilir. O sevap da on mislidir."
            </div>
            <div class="loading-hadith-source-text">(Tirmizi, Sevâbü'l-Kur'ân 16)</div>
        </div>
        
        <!-- Book Icon -->
        <div class="loading-book-wrapper">
            <img src="OPENBOOK.png" alt="Book" class="loading-book-icon" id="bagIcon" onerror="this.onerror=null; this.src='OPENBOOK.PNG'; this.onerror=function(){this.style.display='none'; this.parentElement.innerHTML='<div style=\'color:#999;font-size:14px;\'>📖</div>';};">
        </div>

        <!-- Progress Section -->
        <div class="loading-progress-wrapper">
            <div class="loading-progress-text" id="loadingProgressLabel">Kelime verileri yükleniyor...</div>
            <div class="loading-progress-track">
                <div class="loading-progress-fill" id="loadingProgressBar"></div>
            </div>
        </div>
        
        <!-- Copyright -->
        <div class="loading-footer-text">© YZOKUMUS 2025</div>
    </div>

   




    <!-- Onboarding/Tutorial Modal - Yeni Oyuncular İçin -->
    <div class="modal onboarding-modal" id="onboardingModal" style="display: none;">
        <div class="onboarding-container">
            <div class="onboarding-progress">
                <div class="progress-bar" id="onboardingProgressBar"></div>
                <div class="progress-text" id="onboardingProgressText">1 / 6</div>
            </div>
            <div class="onboarding-slides" id="onboardingSlides">
                <div class="onboarding-slide active" data-slide="1">
                    <div class="slide-icon">👋</div>
                    <h2 class="slide-title">Hoş Geldin!</h2>
                    <p class="slide-description">Kur'an-ı Kerim kelimelerini öğrenmek için hazır mısın?<br>Bu kısa turda sana oyunu tanıtacağız.</p>
                </div>
                <div class="onboarding-slide" data-slide="2">
                    <div class="slide-icon">🎮</div>
                    <h2 class="slide-title">6 Farklı Oyun Modu</h2>
                    <div class="slide-features">
                        <div class="feature-item">📚 <strong>Kelime Çevir</strong> - Kelimeleri öğren</div>
                        <div class="feature-item">🎧 <strong>Dinle & Bul</strong> - Dinleyerek bul</div>
                        <div class="feature-item">📝 <strong>Boşluk Doldur</strong> - Ayetleri tamamla</div>
                        <div class="feature-item">📖 <strong>Ayet Oku</strong> - Ayetleri oku</div>
                        <div class="feature-item">🤲 <strong>Dua Öğren</strong> - Duaları öğren</div>
                        <div class="feature-item">📜 <strong>Hadis Oku</strong> - Hadisleri oku</div>
                    </div>
                </div>
                <div class="onboarding-slide" data-slide="3">
                    <div class="slide-icon">📿</div>
                    <h2 class="slide-title">Hasene Sistemi</h2>
                    <p class="slide-description">Her doğru cevap ile <strong>Hasene</strong> kazanırsın!<br><br><span style="font-size: 0.9em; color: #666;">• 100 Hasene = 1 ⭐ Yıldız<br>• Her 3 doğru = +5 Hasene Bonus<br>• Günlük hedefi tamamla = +1,000 Hasene</span></p>
                </div>
                <div class="onboarding-slide" data-slide="4">
                    <div class="slide-icon">🎯</div>
                    <h2 class="slide-title">Günlük Görevler</h2>
                    <p class="slide-description">Her gün yeni görevler seni bekliyor!<br><br><span style="font-size: 0.9em; color: #666;">• 8 temel görev + 3 bonus görev<br>• Tüm görevleri tamamla = +2,500 Hasene<br>• Her gün sıfırlanır</span></p>
                </div>
                <div class="onboarding-slide" data-slide="5">
                    <div class="slide-icon">🔥</div>
                    <h2 class="slide-title">Muvazebet (Streak)</h2>
                    <p class="slide-description">Her gün oyna, serini bozma!<br><br><span style="font-size: 0.9em; color: #666;">• Her gün oynayarak serini artır<br>• Günlük hedefi tamamla = +1 gün<br>• En uzun serini kırma!</span></p>
                </div>
                <div class="onboarding-slide" data-slide="6">
                    <div class="slide-icon">🚀</div>
                    <h2 class="slide-title">Hazırsın!</h2>
                    <p class="slide-description">Artık oyuna başlayabilirsin!<br><br><span style="font-size: 0.9em; color: #666;">İyi eğlenceler ve başarılar!<br>Her gün biraz daha ilerle! 📈</span></p>
                </div>
            </div>
            <div class="onboarding-buttons">
                <button class="onboarding-btn skip-btn" id="onboardingSkipBtn" onclick="event.stopPropagation(); skipOnboarding();" style="display: block !important; visibility: visible !important; opacity: 1 !important;">Atla</button>
                <button class="onboarding-btn next-btn" id="onboardingNextBtn" onclick="event.stopPropagation(); nextOnboardingSlide();" style="display: block !important; visibility: visible !important; opacity: 1 !important;">İleri →</button>
            </div>
        </div>
    </div>

        <!-- Ana Menü -->
        <div class="main-menu" id="mainMenu">


            <!-- Günlük Hedef Progress Bar - Modern Design -->
            <div class="daily-goal-section">
                <!-- Modern Stats Panel -->
                <div class="premium-stats-panel">   
                    <!-- TEST: Reset Butonu - Sol Üst Köşe (Test Amaçlı) -->
                    <button onclick="confirmResetStats()" class="reset-stats-btn" style="position: absolute; top: 12px; left: 12px; background: rgba(231, 76, 60, 0.9); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3); transition: all 0.3s; z-index: 10; opacity: 0.7;" onmouseover="this.style.opacity='1'; this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(231, 76, 60, 0.5)'" onmouseout="this.style.opacity='0.7'; this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(231, 76, 60, 0.3)'" title="Test: Tüm İstatistikleri Sıfırla">
                        <span style="font-size: 16px;">🔄</span>
                    </button>
                    
                    <!-- Hedef Butonu - Premium -->
                    <button onclick="showDailyGoalSettings()" class="goal-settings-btn" style="position: absolute; top: 12px; right: 12px; background: linear-gradient(135deg, #58cc02 0%, #4db300 100%); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(88, 204, 2, 0.4), 0 0 0 0 rgba(88, 204, 2, 0.7); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 10; animation: goalButtonPulse 2s infinite;" onmouseover="this.style.transform='scale(1.15) rotate(5deg)'; this.style.boxShadow='0 6px 20px rgba(88, 204, 2, 0.5), 0 0 0 4px rgba(88, 204, 2, 0.2)'; this.style.animation='none'" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='0 4px 12px rgba(88, 204, 2, 0.4), 0 0 0 0 rgba(88, 204, 2, 0.7)'; this.style.animation='goalButtonPulse 2s infinite'" onmousedown="this.style.transform='scale(0.95) rotate(-5deg)'" onmouseup="this.style.transform='scale(1.15) rotate(5deg)'">
                        <span style="font-size: 20px; display: inline-block; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);" id="goalButtonIcon">🎯</span>
                    </button>
                    
                    <!-- Stats - Modern Grid -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px; padding-right: 40px;">
                        <!-- Hasene -->
                        <div class="stat-card" style="text-align: center; padding: 12px 8px; background: linear-gradient(135deg, rgba(255, 143, 0, 0.1) 0%, rgba(255, 193, 7, 0.1) 100%); border-radius: 12px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 143, 0, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <div style="color: #FF8F00; font-weight: 700; font-size: clamp(18px, 4vw, 22px); margin-bottom: 4px; text-shadow: 0 1px 2px rgba(255, 143, 0, 0.2);" id="gamePoints">0</div>
                            <div style="color: rgba(0,0,0,0.65); font-size: clamp(10px, 2vw, 11px); font-weight: 600; letter-spacing: 0.5px;">HASENE</div>
                        </div>
                        <!-- Yıldız -->
                        <div class="stat-card" style="text-align: center; padding: 12px 8px; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 235, 59, 0.1) 100%); border-radius: 12px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 193, 7, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <div style="color: #FFC107; font-weight: 700; font-size: clamp(18px, 4vw, 22px); margin-bottom: 4px; text-shadow: 0 1px 2px rgba(255, 193, 7, 0.2);" id="starPoints">0</div>
                            <div style="color: rgba(0,0,0,0.65); font-size: clamp(10px, 2vw, 11px); font-weight: 600; letter-spacing: 0.5px;">⭐ YILDIZ</div>
                        </div>
                        <!-- Mertebe -->
                        <div class="stat-card" style="text-align: center; padding: 12px 8px; background: linear-gradient(135deg, rgba(156, 39, 176, 0.1) 0%, rgba(186, 104, 200, 0.1) 100%); border-radius: 12px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(156, 39, 176, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <div style="color: #9C27B0; font-weight: 700; font-size: clamp(16px, 3.5vw, 20px); margin-bottom: 4px; text-shadow: 0 1px 2px rgba(156, 39, 176, 0.2);" id="playerLevel">1. Mertebe</div>
                            <div style="color: rgba(0,0,0,0.65); font-size: clamp(10px, 2vw, 11px); font-weight: 600; letter-spacing: 0.5px;">MERTEBE</div>
                        </div>
                    </div>
                    
                    <!-- Progress Bar - Modern -->
                    <div style="background: rgba(0,0,0,0.08); height: 8px; border-radius: 8px; overflow: hidden; margin-bottom: 8px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="dailyGoalProgress" style="background: linear-gradient(90deg, #58cc02 0%, #4db300 100%); height: 100%; width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 8px rgba(88, 204, 2, 0.4);"></div>
                    </div>
                    <!-- Progress Text - Modern -->
                    <div style="text-align: center; margin-top: 4px; color: rgba(0,0,0,0.7); font-size: clamp(10px, 2vw, 11px); font-weight: 600; line-height: 1.4;">
                        <span id="dailyGoalText" style="color: #58cc02; font-weight: 700;">Günlük Vird: 2700 Hasene</span> • <span id="dailyGoalProgressText" style="color: rgba(0,0,0,0.7);">0 / 2700 Hasene</span>
                    </div>
                </div>
            </div>

            
            <!-- Hasene Bilgi Butonu -->
            <div style="margin: 0 20px 3px 20px;">
                <button id="xpInfoBtn" style="width: 100%; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; border: none; border-radius: 8px; padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 2px 6px rgba(251,191,36,0.3); transition: all 0.3s; font-weight: 600; font-size: 0.8em;">
                    <span style="font-size: 1em;">📿</span>
                    <div>Hasene Nasıl Kazanılır?</div>
                    <span style="font-size: 0.8em;">ℹ️</span>
                </button>
            </div>
            
            <!-- Zorluk Butonları -->
            <div style="display: flex; gap: 2px; margin: 0 20px 3px 20px; flex-wrap: nowrap; justify-content: center;">
                <button class="diff-btn" id="mainDiffKolay" style="flex: 1; min-width: 60px; max-width: 85px; margin: 0; padding: 4px; font-size: 0.7em; background: white; color: #4CAF50; border: 1px solid #4CAF50; border-radius: 5px;">
                    <strong>🌱 Kolay</strong>
                </button>
                <button class="diff-btn active" id="mainDiffOrta" style="flex: 1; min-width: 60px; max-width: 85px; margin: 0; padding: 4px; font-size: 0.7em; background: #FF9800; color: white; border: 1px solid #FF9800; border-radius: 5px;">
                    <strong>⚖️ Orta</strong>
                </button>
                <button class="diff-btn" id="mainDiffZor" style="flex: 1; min-width: 60px; max-width: 85px; margin: 0; padding: 4px; font-size: 0.7em; background: white; color: #f44336; border: 1px solid #f44336; border-radius: 5px;">
                    <strong>🔥 Zor</strong>
                </button>
            </div>

            <!-- Flutter Oyun Kartları -->
            <div class="flutter-game-grid">

    <button class="game-card glass kelime" id="kelimeCevirBtn" aria-label="Kelime Çevir oyununu başlat - Arapça kelimeleri Türkçe'ye çevir" role="button">
        <div class="card-icon" aria-hidden="true">🔄</div>
        <div class="card-title">Kelime Çevir</div>
        <div class="card-desc">Arapça kelimeleri Türkçe'ye çevir</div>
    </button>

    <button class="game-card glass dinle" id="dinleBulBtn" aria-label="Dinle ve Bul oyununu başlat - Kelimeyi dinle ve sahih kelimeyi seç" role="button">
        <div class="card-icon" aria-hidden="true">🎧</div>
        <div class="card-title">Dinle ve Bul</div>
        <div class="card-desc">Kelimeyi dinle ve sahih kelimeyi seç</div>
    </button>

    <button class="game-card glass bosluk" id="boslukDoldurBtn" aria-label="Boşluk Doldur oyununu başlat - Ayetteki eksik kelimeyi tamamla" role="button">
        <div class="card-icon" aria-hidden="true">✏️</div>
        <div class="card-title">Boşluk Doldur</div>
        <div class="card-desc">Ayetteki eksik kelimeyi tamamla</div>
    </button>

    <button class="game-card glass dua" id="duaEtBtn" aria-label="Dua Et modunu aç - Kur'an'dan duaları öğren ve dinle" role="button">
        <div class="card-icon" aria-hidden="true">🤲</div>
        <div class="card-title">Dua Et</div>
        <div class="card-desc">Kur'an'dan duaları öğren ve dinle</div>
    </button>

    <button class="game-card glass ayet" id="ayetOkuBtn" aria-label="Ayet Oku modunu aç - Ayetleri oku ve anlamlarını öğren" role="button">
        <div class="card-icon" aria-hidden="true">📖</div>
        <div class="card-title">Ayet Oku</div>
        <div class="card-desc">Ayetleri oku ve anlamlarını öğren</div>
    </button>

    <button class="game-card glass hadis" id="hadisOkuBtn" aria-label="Hadis Oku modunu aç - Hadis-i şerifleri oku ve öğren" role="button">
        <div class="card-icon" aria-hidden="true">📜</div>
        <div class="card-title">Hadis Oku</div>
        <div class="card-desc">Hadis-i şerifleri oku ve öğren</div>
    </button>

</div>


            <!-- 🔍 STREAK DEBUG PANEL (DEV MODE) -->
            
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    
                
                   
                </div>
            </div>
        </div>

        <!-- Kelime Çevir Alt Mod Seçimi -->
        <div class="mode-selector" id="modeSelector" style="display: none;">
            <button class="back-btn" id="backToMenuBtn" style="margin: 6px 8px 4px 8px; padding: 4px 8px; font-size: 0.75em;">
                <i class="material-icons" style="font-size: 14px;">west</i>
                Geri
            </button>
            
            <div id="modeButtons"></div>
            
            <button class="start-btn" id="startBtn">Oyunu Başlat</button>
        </div>

        <!-- Ayet Okuma Modu -->
        <div class="ayet-mode" id="ayetMode" style="display: none;">
            <button class="back-btn" id="backFromAyetBtn">
                <i class="material-icons" style="font-size: 16px;">arrow_back</i>
                <span>Ana Sayfa</span>
            </button>
            <div class="ayet-card">
                <div class="sure-info" id="ayetSureInfo">Yükleniyor...</div>
                <div class="arabic" id="ayetArabic">بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ</div>
                <div class="translation" id="ayetTranslation">Yükleniyor...</div>
                <button class="audio-btn" id="ayetAudioBtn" title="Ses çal"></button>
                <div class="navigation-btns">
                    <button class="nav-btn" id="prevAyetBtn">← Önceki</button>
                    <button class="nav-btn" id="nextAyetBtn">Sonraki →</button>
                </div>
            </div>
        </div>

        <!-- Dua Modu -->
        <div class="dua-mode" id="duaMode" style="display: none;">
            <button class="back-btn" id="backFromDuaBtn">
                <i class="material-icons" style="font-size: 16px;">arrow_back</i>
                <span>Ana Sayfa</span>
            </button>
            <div class="dua-card">
                <div class="sure-info" id="duaSureInfo">Yükleniyor...</div>
                <div class="arabic" id="duaArabic">Arapça Metin</div>
                <div class="translation" id="duaTranslation">Anlamı</div>
                <button class="audio-btn" id="duaAudioBtn" title="Ses çal"></button>
                <div class="navigation-btns">
                    <button class="nav-btn" id="prevDuaBtn">← Önceki</button>
                    <button class="nav-btn" id="nextDuaBtn">Sonraki →</button>
                </div>
            </div>
        </div>

        <!-- Hadis Oku Modu -->
        <div class="hadis-mode" id="hadisMode" style="display: none;">
            <button class="back-btn" id="backFromHadisBtn">
                <i class="material-icons" style="font-size: 16px;">arrow_back</i>
                <span>Ana Sayfa</span>
            </button>
            <div class="hadis-card">
                <div class="hadis-category" id="hadisCategory">Kategori</div>
                <div class="hadis-title" id="hadisTitle">Başlık</div>
                <div class="hadis-header" id="hadisHeader">Ravi</div>
                <div class="hadis-text" id="hadisText">Hadis Metni</div>
                <div class="hadis-ref" id="hadisRef">Referans</div>
                <div class="navigation-btns">
                    <button class="nav-btn" id="prevHadisBtn">← Önceki</button>
                    <button class="nav-btn" id="nextHadisBtn">Sonraki →</button>
                </div>
            </div>
        </div>

        <!-- Boşluk Doldur Modu - Duolingo Tarzı -->
        <div class="bosluk-mode" id="boslukMode" style="display: none;">
            <!-- Duolingo Tarzı Header -->
            <div class="duolingo-header">
                <button class="duolingo-back-btn" id="backFromBoslukBtn">
                    ←
            </button>
                <div class="duolingo-progress-container">
                    <div class="duolingo-progress-bar" id="boslukProgressBar" style="width: 0%;"></div>
                </div>
                <div class="duolingo-hearts" id="boslukHearts" style="display: none;">
                    <span>❤️</span>
                    <span>❤️</span>
                    <span>❤️</span>
                </div>
            </div>

            <!-- Duolingo Tarzı Soru Alanı -->
            <div class="duolingo-question-area">
                <div class="duolingo-question-number" id="boslukQuestionNumber">Soru 1 / 10</div>
                <div class="arabic" id="boslukAyetText" style="color: #1a1a1a; margin: 20px 0; font-size: clamp(24px, 5vw, 36px); text-align: center; word-break: break-word; overflow-wrap: break-word; max-width: 100%; box-sizing: border-box; direction: rtl; line-height: 1.8;">Ayet metni yükleniyor...</div>
                <div class="duolingo-question-hint" id="boslukQuestionHint">Eksik kelimeyi seç</div>
                <div class="sure-info" id="boslukSureInfo" style="font-size: 12px; color: #999; margin-top: 8px; display: none;">ID: 0</div>
                
                <div class="duolingo-audio-buttons">
                    <button class="duolingo-audio-btn" id="boslukAudioBtn" title="Sesi çal">
                        <img src="hoparlor.png" alt="Ses">
                    </button>
                </div>
                </div>

            <!-- Duolingo Tarzı Seçenekler -->
            <div class="duolingo-options-container">
                <div id="boslukOptions" style="display: flex; flex-direction: column; gap: 0;">
                    <!-- Seçenekler buraya dinamik eklenecek -->
                </div>
                <div class="feedback" id="boslukFeedback" style="font-size: 16px; margin: 16px 0 8px 0; text-align: center; min-height: 24px; color: #666;"></div>
                <button class="flutter-btn flutter-btn-primary" id="boslukNextBtn" style="width: 100%; margin-top: 8px; display: none; min-height: 50px; font-size: 16px; font-weight: 600; border-radius: 16px; border: none; background: #58cc02; color: #fff; cursor: pointer; transition: all 0.2s;" aria-label="Sonraki soruya geç" onmouseover="this.style.background='#4fb802'" onmouseout="this.style.background='#58cc02'">Sonraki Soru →</button>
            </div>

            <!-- Duolingo Tarzı İstatistikler -->
            <div class="duolingo-stats-bar">
                <div class="duolingo-stat-item">
                    <div class="duolingo-stat-value hasene" id="boslukScore">0</div>
                    <div class="duolingo-stat-label">Hasene</div>
                </div>
                <div class="duolingo-stat-item">
                    <div class="duolingo-stat-value correct" id="boslukCorrect">0</div>
                    <div class="duolingo-stat-label">Sahih</div>
                </div>
                <div class="duolingo-stat-item">
                    <div class="duolingo-stat-value wrong" id="boslukWrong">0</div>
                    <div class="duolingo-stat-label">Hatalı</div>
                </div>
            </div>
        </div>

        <!-- Dinle ve Bul Modu - Duolingo Tarzı -->
        <div class="dinle-mode" id="dinleMode" style="display: none;">
            <!-- Duolingo Tarzı Header -->
            <div class="duolingo-header">
                <button class="duolingo-back-btn" id="backFromDinleBtn">
                    ←
            </button>
                <div class="duolingo-progress-container">
                    <div class="duolingo-progress-bar" id="dinleProgressBar" style="width: 0%;"></div>
                </div>
                <div class="duolingo-hearts" id="dinleHearts" style="display: none;">
                    <span>❤️</span>
                    <span>❤️</span>
                    <span>❤️</span>
                </div>
            </div>

            <!-- Duolingo Tarzı Soru Alanı -->
            <div class="duolingo-question-area">
                <div class="duolingo-question-number" id="dinleQuestionNumber">Soru 1 / 10</div>
                <div style="text-align: center; margin: 30px 0;">
                    <div style="font-size: 3em; color: #00CED1; text-shadow: 0 0 10px #00CED1;">🎧</div>
                </div>
                <div class="duolingo-question-hint" id="dinleQuestionHint">Kelimeyi dinle ve sahih kelimeyi seç</div>
                <div class="sure-info" id="dinleSureInfo" style="font-size: 12px; color: #999; margin-top: 8px; display: none;">ID: 0</div>
                
                <div class="duolingo-audio-buttons">
                    <button class="duolingo-audio-btn" id="dinleAudioBtn" title="Sesi tekrar çal">
                        <img src="hoparlor.png" alt="Ses">
                    </button>
                    <button class="duolingo-audio-btn" id="dinleMicBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #667eea;" title="Ses tanıma ile cevap ver">
                        <span style="font-size: 1.5em;">🎤</span>
                    </button>
                </div>
                <div id="speechStatus" style="text-align: center; font-size: 0.85em; color: #666; margin-top: 12px; min-height: 20px;"></div>
            </div>

            <!-- Duolingo Tarzı Seçenekler -->
            <div class="duolingo-options-container">
                <div id="dinleOptions" style="display: flex; flex-direction: column; gap: 0;">
                    <!-- Seçenekler buraya dinamik eklenecek -->
                </div>
                <div class="feedback" id="dinleFeedback" style="font-size: 16px; margin: 16px 0 8px 0; text-align: center; min-height: 24px; color: #666;"></div>
                <button class="flutter-btn flutter-btn-primary" id="dinleNextBtn" style="width: 100%; margin-top: 8px; display: none; min-height: 50px; font-size: 16px; font-weight: 600; border-radius: 16px; border: none; background: #58cc02; color: #fff; cursor: pointer; transition: all 0.2s;" aria-label="Sonraki soruya geç" onmouseover="this.style.background='#4fb802'" onmouseout="this.style.background='#58cc02'">Sonraki Soru →</button>
        </div>

            <!-- Duolingo Tarzı İstatistikler -->
            <div class="duolingo-stats-bar">
                <div class="duolingo-stat-item">
                    <div class="duolingo-stat-value hasene" id="dinleScore">0</div>
                    <div class="duolingo-stat-label">Hasene</div>
                </div>
                <div class="duolingo-stat-item">
                    <div class="duolingo-stat-value correct" id="dinleCorrect">0</div>
                    <div class="duolingo-stat-label">Sahih</div>
                </div>
                <div class="duolingo-stat-item">
                    <div class="duolingo-stat-value wrong" id="dinleWrong">0</div>
                    <div class="duolingo-stat-label">Hatalı</div>
                </div>
            </div>
        </div>

        <!-- Oyun Ekranı - Duolingo Tarzı -->
        <div class="game-screen" id="gameScreen" style="display: none;">
            <!-- Duolingo Tarzı Header -->
            <div class="duolingo-header">
                <button class="duolingo-back-btn" id="backFromGameBtn">
                    ←
        </button>
                <div class="duolingo-progress-container">
                    <div class="duolingo-progress-bar" id="duolingoProgressBar" style="width: 0%;"></div>
            </div>
                <div class="duolingo-hearts" id="duolingoHearts" style="display: none;">
                    <span>❤️</span>
                    <span>❤️</span>
                    <span>❤️</span>
            </div>
            </div>

            <!-- Duolingo Tarzı Soru Alanı -->
            <div class="duolingo-question-area">
                <div class="duolingo-question-number" id="duolingoQuestionNumber">Soru 1 / 10</div>
                <div class="arabic-text arabic-large" id="arabicWord" style="color: #1a1a1a; margin: 20px 0; font-size: clamp(28px, 6vw, 42px); text-align: center; word-break: break-word; overflow-wrap: break-word; max-width: 100%; box-sizing: border-box; direction: rtl; line-height: 1.6;">
                    فَكُبْكِبُوا۟
        </div>
                <div class="duolingo-question-hint" id="duolingoQuestionHint">Bu kelimenin Türkçe karşılığı nedir?</div>
                <div class="sure-info" id="sureInfo" style="font-size: 12px; color: #999; margin-top: 8px; display: none;">ID: 26:94:1 | Zorluk: 13</div>
                
                <div class="duolingo-audio-buttons">
                    <button class="duolingo-audio-btn" id="audioBtn">
                        <img src="hoparlor.png" alt="Ses">
                    </button>
                    <button class="duolingo-audio-btn" id="hintBtn">
                        <img src="clue.png" alt="İpucu">
                    </button>
            </div>
            </div>

            <!-- Duolingo Tarzı Seçenekler -->
            <div class="duolingo-options-container">
                <div id="options" style="display: flex; flex-direction: column; gap: 0;">
                    <!-- Seçenekler buraya dinamik eklenecek -->
            </div>
                <div class="feedback" id="feedback" style="font-size: 16px; margin: 16px 0 8px 0; text-align: center; min-height: 24px; color: #666;"></div>
                <button class="flutter-btn flutter-btn-primary" id="nextBtn" style="width: 100%; margin-top: 8px; display: none; min-height: 50px; font-size: 16px; font-weight: 600; border-radius: 16px; border: none; background: #58cc02; color: #fff; cursor: pointer; transition: all 0.2s;" aria-label="Sonraki soruya geç" onmouseover="this.style.background='#4fb802'" onmouseout="this.style.background='#58cc02'">Sonraki Soru →</button>
        </div>

            <!-- Combo Indicator -->
            <div id="comboIndicator" style="display: none; text-align: center; padding: 10px 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin: 0 20px 12px 20px; border-radius: 10px; animation: comboPopIn 0.3s ease; box-shadow: 0 4px 15px rgba(245,87,108,0.4);">
                <div style="font-size: 14px; font-weight: bold; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                    🔥 COMBO <span id="comboCount">3</span>x 🔥
            </div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.9); margin-top: 3px;">
                    +<span id="comboBonus">5</span> Bonus Hasene!
            </div>
        </div>

            <!-- Duolingo Tarzı İstatistikler -->
            <div class="duolingo-stats-bar">
                <div class="duolingo-stat-item">
                    <div class="duolingo-stat-value hasene" id="score">0</div>
                    <div class="duolingo-stat-label">Hasene</div>
    </div>
                <div class="duolingo-stat-item">
                    <div class="duolingo-stat-value correct" id="correct">0</div>
                    <div class="duolingo-stat-label">Sahih</div>
    </div>
                <div class="duolingo-stat-item">
                    <div class="duolingo-stat-value wrong" id="wrong">0</div>
                    <div class="duolingo-stat-label">Hatalı</div>
    </div>
</div>
        </div>  <!-- gameScreen sonu -->
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <h2>🎉 Tebrikler!</h2>
            <p><span id="newLevel"></span>. Mertebeye yükseldiniz!</p>
            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                Toplam Haseneleriniz: <strong id="modalTotalPoints">0</strong><br>
                Bir sonraki mertebe için: <strong id="modalNextLevelPoints">0</strong> hasene gerekli
            </p>
            <button class="modal-btn" id="modalBtn">Devam Et</button>
        </div>
    </div>

    <!-- Başarılar/Rozetler Modal - Duolingo Tarzı Yeni Tasarım -->
    <div class="modal" id="badgesModal" onclick="handleBadgesModalClick(event)">
        <div class="modal-content badges-content" style="max-width: 500px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; padding: 20px; touch-action: pan-y;">
            <!-- Başlık ve Kapat Butonu -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-shrink: 0;">
                <h3 style="margin: 0; font-size: 1.2em; font-weight: 700; color: #667eea;">🏆 Başarılar</h3>
                <button onclick="event.stopPropagation(); closeBadgesModal();" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'; this.style.color='#e74c3c';" onmouseout="this.style.background='transparent'; this.style.color='#999';">×</button>
            </div>
            
            <!-- Scroll Edilebilir İçerik -->
            <div id="badgesScrollableContent" style="flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; padding-right: 4px; margin-bottom: 12px; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; will-change: scroll-position;">
                
                <!-- İstatistikler Özeti -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center;">
                    <h3 style="font-size: 16px; margin-bottom: 16px; opacity: 0.9; font-weight: 600;">📊 İlerleme Özeti</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        <div class="stat-item">
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px;" id="badgesUnlockedCount">0</div>
                            <div style="font-size: 12px; opacity: 0.9;">Açılan Rozet</div>
                        </div>
                        <div class="stat-item">
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px;" id="badgesTotalCount">20</div>
                            <div style="font-size: 12px; opacity: 0.9;">Toplam Rozet</div>
                        </div>
                        <div class="stat-item">
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px;" id="badgesProgressPercent">0%</div>
                            <div style="font-size: 12px; opacity: 0.9;">Tamamlanma</div>
                        </div>
                    </div>
                </div>

                <!-- Kategori Sekmeleri -->
                <div class="category-tabs" style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; flex-wrap: wrap;">
                    <button class="badge-tab active" onclick="showBadgeCategory('daily', this); event.stopPropagation();" style="flex: 1; min-width: 80px; padding: 10px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 12px; font-size: 13px; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s;">📅 Günlük</button>
                    <button class="badge-tab" onclick="showBadgeCategory('special', this); event.stopPropagation();" style="flex: 1; min-width: 80px; padding: 10px 12px; background: transparent; border: none; border-radius: 12px; font-size: 13px; font-weight: 600; color: #999; cursor: pointer; transition: all 0.3s;">⭐ Özel</button>
                    <button class="badge-tab" onclick="showBadgeCategory('streak', this); event.stopPropagation();" style="flex: 1; min-width: 80px; padding: 10px 12px; background: transparent; border: none; border-radius: 12px; font-size: 13px; font-weight: 600; color: #999; cursor: pointer; transition: all 0.3s;">🔥 Seri</button>
                    <button class="badge-tab" onclick="showBadgeCategory('level', this); event.stopPropagation();" style="flex: 1; min-width: 80px; padding: 10px 12px; background: transparent; border: none; border-radius: 12px; font-size: 13px; font-weight: 600; color: #999; cursor: pointer; transition: all 0.3s;">🏅 Mertebe</button>
                </div>

                <!-- Günlük Başarılar -->
                <div id="badgeCategoryDaily" class="badge-category-content" style="display: block;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <!-- İlk Zafer -->
                        <div class="achievement-card" id="achievement-first_win" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">🎯</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">İlk Zafer</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">İlk sahih cevabin</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">Kilitli</div>
                        </div>

                        <!-- Günlük Kahraman -->
                        <div class="achievement-card" id="achievement-daily_goal" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">⭐</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">Günlük Kahraman</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">Günlük hedefini tamamla</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">Kilitli</div>
                        </div>
                    </div>
                </div>

                <!-- Özel Başarılar -->
                <div id="badgeCategorySpecial" class="badge-category-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <!-- Combo Ustası -->
                        <div class="achievement-card" id="achievement-combo_master" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">🔥</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">Combo Ustası</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">5x combo yap</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">0/5</div>
                        </div>

                        <!-- İlk Adım -->
                        <div class="achievement-card" id="achievement-xp_500" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">🌱</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">İlk Adım</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">500 Hasene topla</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">0/500</div>
                        </div>

                        <!-- Bronz Yolcu -->
                        <div class="achievement-card" id="achievement-xp_2000" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">🥉</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">Bronz Yolcu</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">2,000 Hasene</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">0/2000</div>
                        </div>

                        <!-- Gümüş Master -->
                        <div class="achievement-card" id="achievement-xp_8500" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">🥈</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">Gümüş Master</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">8,500 Hasene</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">0/8500</div>
                        </div>

                        <!-- Altın Master -->
                        <div class="achievement-card" id="achievement-xp_25500" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">🥇</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">Altın Master</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">25,500 Hasene</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">0/25500</div>
                        </div>

                        <!-- Elmas Master -->
                        <div class="achievement-card" id="achievement-xp_85000" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">💎</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">Elmas Master</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">85,000 Hasene</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">0/85000</div>
                        </div>
                    </div>
                </div>

                <!-- Seri Başarılar -->
                <div id="badgeCategoryStreak" class="badge-category-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <!-- 7 Gün Streak -->
                        <div class="achievement-card" id="achievement-streak_7" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">🔥</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">7 Gün Seri</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">7 gün üst üste oyna</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">0/7</div>
                        </div>
                    </div>
                </div>

                <!-- Mertebe Başarılar -->
                <div id="badgeCategoryLevel" class="badge-category-content" style="display: none;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <!-- Seviye 5 -->
                        <div class="achievement-card" id="achievement-level_5" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">🏆</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">Seviye 5</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">Seviye 5'e ulaş</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">0/5</div>
                        </div>

                        <!-- Seviye 10 -->
                        <div class="achievement-card" id="achievement-level_10" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">💎</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">Seviye 10</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">Seviye 10'a ulaş</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">0/10</div>
                        </div>

                        <!-- Seviye 20 -->
                        <div class="achievement-card" id="achievement-level_20" style="background: #f8f9fa; border-radius: 16px; padding: 16px 12px; text-align: center; position: relative; transition: all 0.3s; border: 3px solid transparent; cursor: pointer;" onclick="event.stopPropagation();">
                            <div style="font-size: 48px; margin-bottom: 8px; display: block;">🌟</div>
                            <div style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 4px;">Seviye 20</div>
                            <div style="font-size: 11px; color: #666; line-height: 1.4; margin-bottom: 8px;">Seviye 20'ye ulaş</div>
                            <div class="achievement-progress" style="width: 100%; height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden; margin-top: 8px;">
                                <div class="achievement-progress-fill" style="height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); border-radius: 2px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div class="progress-text" style="font-size: 10px; color: #999; margin-top: 4px;">0/20</div>
                        </div>
                    </div>

                    <!-- Mertebe Rozetleri (Mevcut Sistem) -->
                    <div style="margin-top: 24px; margin-bottom: 16px;">
                        <div style="font-size: 0.75em; font-weight: 600; color: #667eea; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🏅 Mertebe Rozetleri</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <!-- Mütebahhir -->
                            <div style="text-align: center; padding: 16px 12px; border-radius: 16px; background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%); border: 3px solid #00bcd4; box-shadow: 0 2px 8px rgba(0,188,212,0.2); transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="event.stopPropagation();">
                                <div style="font-size: 2.5em; margin-bottom: 8px;">💎</div>
                                <div style="font-weight: bold; margin: 4px 0; font-size: 0.9em; color: #00bcd4;">Mütebahhir</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #00bcd4; margin: 8px 0;" id="diamondBadgeCount">0</div>
                                <div style="font-size: 0.7em; color: #666; margin-top: 4px;">5 Mütecaviz = 1</div>
                            </div>
                            
                            <!-- Mütecaviz -->
                            <div style="text-align: center; padding: 16px 12px; border-radius: 16px; background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border: 3px solid #ff9800; box-shadow: 0 2px 8px rgba(255,152,0,0.2); transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="event.stopPropagation();">
                                <div style="font-size: 2.5em; margin-bottom: 8px;">🥇</div>
                                <div style="font-weight: bold; margin: 4px 0; font-size: 0.9em; color: #ff9800;">Mütecaviz</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #ff9800; margin: 8px 0;" id="goldBadgeCount">0</div>
                                <div style="font-size: 0.7em; color: #666; margin-top: 4px;">5 Müterakki = 1</div>
                            </div>
                            
                            <!-- Müterakki -->
                            <div style="text-align: center; padding: 16px 12px; border-radius: 16px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); border: 3px solid #9c27b0; box-shadow: 0 2px 8px rgba(156,39,176,0.2); transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="event.stopPropagation();">
                                <div style="font-size: 2.5em; margin-bottom: 8px;">🥈</div>
                                <div style="font-weight: bold; margin: 4px 0; font-size: 0.9em; color: #9c27b0;">Müterakki</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #9c27b0; margin: 8px 0;" id="silverBadgeCount">0</div>
                                <div style="font-size: 0.7em; color: #666; margin-top: 4px;">5 Mübtedi = 1</div>
                            </div>
                            
                            <!-- Mübtedi -->
                            <div style="text-align: center; padding: 16px 12px; border-radius: 16px; background: linear-gradient(135deg, #fff3e0 0%, #ffcc80 100%); border: 3px solid #ff5722; box-shadow: 0 2px 8px rgba(255,87,34,0.2); transition: transform 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'" onclick="event.stopPropagation();">
                                <div style="font-size: 2.5em; margin-bottom: 8px;">🥉</div>
                                <div style="font-weight: bold; margin: 4px 0; font-size: 0.9em; color: #ff5722;">Mübtedi</div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #ff5722; margin: 8px 0;" id="bronzeBadgeCount">0</div>
                                <div style="font-size: 0.7em; color: #666; margin-top: 4px;">5 Yıldız = 1</div>
                            </div>
                        </div>
                    </div>

                    <!-- Bilgi Kutusu -->
                    <div style="background: #f0f9ff; padding: 12px; border-radius: 12px; margin-top: 16px; border-left: 4px solid #3b82f6;">
                        <div style="font-size: 0.8em; color: #1e40af; font-weight: 600; margin-bottom: 4px;">💡 Rozet Sistemi</div>
                        <div style="font-size: 0.75em; color: #555; line-height: 1.5;">
                            • 5 Yıldız = 1 Mübtedi Rozeti<br>
                            • 5 Mübtedi = 1 Müterakki Rozeti<br>
                            • 5 Müterakki = 1 Mütecaviz Rozeti<br>
                            • 5 Mütecaviz = 1 Mütebahhir Rozeti
                        </div>
                    </div>
                </div>
            
            </div>
            <!-- Scroll Edilebilir İçerik Sonu -->

        </div>
    </div>

    <!-- Takvim Modal - Duolingo Style -->
    <div class="modal" id="calendarModal" onclick="handleCalendarModalClick(event)">
        <div class="modal-content calendar-content" style="max-width: 500px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; padding: 24px; background: #ffffff; border-radius: 16px; touch-action: pan-y;">
            <!-- Başlık ve Kapat Butonu -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; font-size: 1.2em; font-weight: 700; color: #58cc02;">📅 Takvim</h3>
                <button onclick="event.stopPropagation(); closeCalendarModal();" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'; this.style.color='#e74c3c';" onmouseout="this.style.background='transparent'; this.style.color='#999';">×</button>
            </div>
            
            <!-- Scroll Edilebilir İçerik -->
            <div id="calendarScrollableContent" style="flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; padding-right: 4px; margin-bottom: 12px; -webkit-overflow-scrolling: touch;">
                
                <!-- Streak Bilgisi - Modern Tasarım -->
                <div style="background: linear-gradient(135deg, #58cc02 0%, #4db300 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 24px; text-align: center; box-shadow: 0 4px 12px rgba(88,204,2,0.3);">
                    <h3 style="font-size: 16px; margin-bottom: 12px; opacity: 0.9; font-weight: 600;">🔥 Seri Bilgisi</h3>
                    <div style="font-size: 36px; font-weight: 700; margin-bottom: 8px;">
                        <span id="calendarStreakCount" style="color: white;">0</span> gün seri
                    </div>
                    <div style="font-size: 14px; opacity: 0.9; font-weight: 500;">
                        Her gün oyna, serini bozma!
                    </div>
                </div>
            
                <!-- Haftalık Streak Gösterimi (Duolingo Style) - Modern Tasarım -->
                <div id="weeklyStreakDisplay" style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #f7f7f7 0%, #e9ecef 100%); border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                <!-- Bu alan JavaScript ile doldurulacak -->
            </div>
            
                <!-- Aylık Takvim Bölümü (Duolingo Style) - Modern Tasarım -->
                <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <!-- Ay Başlığı -->
                    <div style="text-align: center; font-weight: 600; font-size: 18px; color: #1a1a1a; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e0e0e0;" id="calendarMonth">
                        Ocak 2025
                    </div>
                    
                    <!-- Takvim Grid -->
                    <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; max-width: 100%; margin: 0 auto;">
                        <!-- Takvim günleri buraya eklenecek -->
                    </div>
                    </div>
                    
                        </div>
            <!-- Scroll Edilebilir İçerik Sonu -->

                    </div>
                </div>
            </div>

    <!-- Günlük Görevler Modal -->
    <!-- Günlük Görevler Modal - İstatistikler Modalı ile Aynı Yapı -->
    <div class="modal" id="dailyTasksModal" onclick="handleDailyTasksModalClick(event)">
        <div class="modal-content daily-tasks-content" style="max-width: 500px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; padding: 20px; touch-action: pan-y; box-sizing: border-box;">
            <!-- Başlık ve Kapat Butonu -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-shrink: 0;">
                <h3 style="margin: 0; font-size: 1.2em; font-weight: 700; color: #667eea;">🎯 Günlük Görevler</h3>
                <button onclick="event.stopPropagation(); closeDailyTasksModal();" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'; this.style.color='#e74c3c';" onmouseout="this.style.background='transparent'; this.style.color='#999';">×</button>
            </div>

            <!-- Scroll Edilebilir İçerik -->
            <div id="dailyTasksScrollableContent" style="flex: 1 1 auto; overflow-y: auto; overflow-x: hidden; min-height: 0; max-height: 100%; padding-right: 4px; margin-bottom: 12px; -webkit-overflow-scrolling: touch; touch-action: pan-y;">

            <!-- Genel İlerleme - Modern Tasarım -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 12px rgba(102,126,234,0.3);">
                <h3 style="font-size: 16px; margin-bottom: 16px; opacity: 0.9; font-weight: 600;">📊 Bugünkü İlerleme</h3>
                <div style="font-size: 28px; font-weight: 700; margin-bottom: 16px;">
                    <span id="completedTasks">0</span>/<span id="totalTasks">11</span> Görev Tamamlandı
                </div>
                <div style="background: rgba(255,255,255,0.2); border-radius: 12px; height: 8px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                    <div id="taskProgress" style="background: rgba(255,255,255,0.95); height: 100%; border-radius: 12px; width: 0%; transition: width 0.5s ease; box-shadow: 0 2px 8px rgba(255,255,255,0.5);"></div>
                </div>
            </div>

            <!-- Temel Görevler - Modern Tasarım -->
            <div style="margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: 600; color: #667eea; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2em;">📋</span> Temel Görevler
                </div>
                <div id="dailyTasksList" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <!-- Görevler buraya dinamik eklenecek -->
                </div>
            </div>

            <!-- Bonus Görevler - Modern Tasarım -->
            <div style="margin-bottom: 20px;">
                <div style="font-size: 14px; font-weight: 600; color: #f59e0b; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2em;">⭐</span> Bonus Görevler
                </div>
                <div id="bonusTasksList" style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <!-- Bonus görevler buraya dinamik eklenecek -->
                </div>
            </div>

            <!-- Ödül Toplama - Modern Tasarım -->
            <div id="rewardsSection" style="display: none; background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border-radius: 16px; padding: 20px; margin-top: 16px; text-align: center; border: 3px solid #4caf50; box-shadow: 0 4px 12px rgba(76,175,80,0.3);">
                <div style="font-size: 24px; margin-bottom: 8px;">🎉</div>
                <div style="font-size: 18px; color: #2e7d2e; font-weight: 700; margin-bottom: 8px;">Tebrikler!</div>
                <div style="font-size: 14px; color: #555; margin-bottom: 16px;">Tüm görevleri tamamladın!</div>
                <button id="claimRewardsBtn" onclick="claimDailyRewards()" style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(76,175,80,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    +2,500 Hasene Ödül Topla 🎁
                </button>
            </div>

            </div>
        </div>
    </div>

    <!-- İstatistikler Modal -->
    <div class="modal" id="statsModal" onclick="handleStatsModalClick(event)">
        <div class="modal-content stats-content" style="max-width: 500px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; padding: 20px; touch-action: pan-y; box-sizing: border-box;">
            <!-- Başlık ve Kapat Butonu -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-shrink: 0;">
                <h3 style="margin: 0; font-size: 1.2em; font-weight: 700; color: #667eea;">📊 İstatistikler</h3>
                <button onclick="event.stopPropagation(); closeStatsModal();" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'; this.style.color='#e74c3c';" onmouseout="this.style.background='transparent'; this.style.color='#999';">×</button>
            </div>

            <!-- Scroll Edilebilir İçerik -->
            <div id="statsScrollableContent" style="flex: 1 1 auto; overflow-y: auto; overflow-x: hidden; min-height: 0; max-height: 100%; padding-right: 4px; margin-bottom: 12px; -webkit-overflow-scrolling: touch; touch-action: pan-y;">

            <!-- Genel Özet - Modern Tasarım -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 12px rgba(102,126,234,0.3);">
                <h3 style="font-size: 16px; margin-bottom: 16px; opacity: 0.9; font-weight: 600;">📊 Genel Özet</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                    <div class="stat-item">
                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px;" id="statsLevel">1</div>
                        <div style="font-size: 12px; opacity: 0.9;">Mertebe</div>
                    </div>
                    <div class="stat-item">
                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px;" id="statsPoints">0</div>
                        <div style="font-size: 12px; opacity: 0.9;">Hasene</div>
                    </div>
                    <div class="stat-item">
                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 4px;" id="statsStars">0</div>
                        <div style="font-size: 12px; opacity: 0.9;">⭐ Yıldız</div>
                    </div>
                </div>
                
                <!-- Seviye İlerleme Barı - Modern -->
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px; opacity: 0.9; font-weight: 600;">
                        <span>Mertebe <span id="statsCurrentLevel">1</span></span>
                        <span>Mertebe <span id="statsNextLevel">2</span></span>
                    </div>
                    <div style="background: rgba(255,255,255,0.2); height: 8px; border-radius: 8px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="statsLevelProgress" style="background: rgba(255,255,255,0.95); height: 100%; width: 0%; border-radius: 8px; transition: width 0.5s ease; box-shadow: 0 2px 8px rgba(255,255,255,0.5);"></div>
                    </div>
                    <div style="font-size: 12px; margin-top: 8px; opacity: 0.9; font-weight: 500;">
                        <span id="statsLevelPointsNeeded">0</span> hasene daha
                    </div>
                </div>
            </div>

            <!-- Rozet Sistemi - Modern Tasarım -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(102,126,234,0.3);">
                <h4 style="margin: 0 0 16px 0; color: white; font-size: 16px; text-align: center; font-weight: 600;">🏆 Hasene Bazlı Rozet Sistemi</h4>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; text-align: center;">
                    <div style="padding: 12px 8px; background: white; border-radius: 12px; border: 3px solid #cd7f32; box-shadow: 0 2px 8px rgba(205,127,50,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 2em; margin-bottom: 4px;">🥉</div>
                        <div style="font-size: 12px; color: #666; margin: 4px 0; font-weight: 600;">Bronz</div>
                        <div style="font-weight: bold; font-size: 18px; color: #cd7f32; margin: 4px 0;" id="statsBronze">0</div>
                        <div style="font-size: 10px; color: #888; margin-top: 4px;">2K Hasene</div>
                    </div>
                    <div style="padding: 12px 8px; background: white; border-radius: 12px; border: 3px solid #c0c0c0; box-shadow: 0 2px 8px rgba(192,192,192,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 2em; margin-bottom: 4px;">🥈</div>
                        <div style="font-size: 12px; color: #666; margin: 4px 0; font-weight: 600;">Gümüş</div>
                        <div style="font-weight: bold; font-size: 18px; color: #c0c0c0; margin: 4px 0;" id="statsSilver">0</div>
                        <div style="font-size: 10px; color: #888; margin-top: 4px;">8.5K Hasene</div>
                    </div>
                    <div style="padding: 12px 8px; background: white; border-radius: 12px; border: 3px solid #ffd700; box-shadow: 0 2px 8px rgba(255,215,0,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 2em; margin-bottom: 4px;">🥇</div>
                        <div style="font-size: 12px; color: #666; margin: 4px 0; font-weight: 600;">Altın</div>
                        <div style="font-weight: bold; font-size: 18px; color: #ffd700; margin: 4px 0;" id="statsGold">0</div>
                        <div style="font-size: 10px; color: #888; margin-top: 4px;">25.5K Hasene</div>
                    </div>
                    <div style="padding: 12px 8px; background: white; border-radius: 12px; border: 3px solid #b9f2ff; box-shadow: 0 2px 8px rgba(185,242,255,0.2); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 2em; margin-bottom: 4px;">💎</div>
                        <div style="font-size: 12px; color: #666; margin: 4px 0; font-weight: 600;">Elmas</div>
                        <div style="font-weight: bold; font-size: 18px; color: #00d9ff; margin: 4px 0;" id="statsDiamond">0</div>
                        <div style="font-size: 10px; color: #888; margin-top: 4px;">85K Hasene</div>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 13px; text-align: center; font-weight: 500;">
                    💡 1 saat oyun = ~8500 Hasene (1 Müterakki)
                </div>
            </div>

            <!-- Başarı Analizi - Modern Tasarım -->
            <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); padding: 16px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #2980b9; box-shadow: 0 2px 8px rgba(41,128,185,0.1);">
                <h4 style="margin: 0 0 12px 0; color: #2980b9; font-size: 16px; font-weight: 600;">📈 Başarı Analizi</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 24px; font-weight: bold; color: #27ae60; margin-bottom: 4px;" id="statsSuccessRate">0%</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Başarı Oranı</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 24px; font-weight: bold; color: #3498db; margin-bottom: 4px;" id="statsAvgPointsPerDay">0</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Günlük Ort. Hasene</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 24px; font-weight: bold; color: #e67e22; margin-bottom: 4px;" id="statsPlayConsistency">0%</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Talim Tutarlılığı</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 24px; font-weight: bold; color: #9b59b6; margin-bottom: 4px;" id="statsLevelProgressText">0%</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Mertebe İlerlemesi</div>
                    </div>
                </div>
            </div>

            <!-- Devam (Streak) Bilgileri - Modern Tasarım -->
            <div style="background: linear-gradient(135deg, #fff7e6 0%, #ffe6d9 100%); padding: 16px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #d68910; box-shadow: 0 2px 8px rgba(214,137,16,0.1);">
                <h4 style="margin: 0 0 12px 0; color: #d68910; font-size: 16px; font-weight: 600;">🔥 Muvazebet İstatistikleri</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 28px; font-weight: bold; color: #e67e22; margin-bottom: 4px;" id="statsCurrentStreak">0</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Mevcut Devam</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 28px; font-weight: bold; color: #e67e22; margin-bottom: 4px;" id="statsBestStreak">0</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">En İyi Devam</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 28px; font-weight: bold; color: #27ae60; margin-bottom: 4px;" id="statsTotalDays">0</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Toplam Amel Günü</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 28px; font-weight: bold; color: #3498db; margin-bottom: 4px;" id="statsTodayProgress">0</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Bugünkü Amel</div>
                    </div>
                </div>
            </div>

            <!-- Oyun Türü İstatistikleri - Modern Tasarım -->
            <div style="background: linear-gradient(135deg, #f0fff4 0%, #e6ffe6 100%); padding: 16px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #27ae60; box-shadow: 0 2px 8px rgba(39,174,96,0.1);">
                <h4 style="margin: 0 0 12px 0; color: #27ae60; font-size: 16px; font-weight: 600;">🎮 Oyun Türü İstatistikleri (Bugün)</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <div style="padding: 10px; background: white; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='translateX(0)'">
                        <span style="font-size: 13px; font-weight: 500; color: #333;">📚 Kelime Çevir:</span>
                        <strong style="font-size: 16px; color: #27ae60;" id="statsKelimeCevir">0</strong>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='translateX(0)'">
                        <span style="font-size: 13px; font-weight: 500; color: #333;">🎧 Dinle & Bul:</span>
                        <strong style="font-size: 16px; color: #27ae60;" id="statsDinleBul">0</strong>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='translateX(0)'">
                        <span style="font-size: 13px; font-weight: 500; color: #333;">📝 Boşluk Doldur:</span>
                        <strong style="font-size: 16px; color: #27ae60;" id="statsBoslukDoldur">0</strong>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='translateX(0)'">
                        <span style="font-size: 13px; font-weight: 500; color: #333;">📖 Ayet Oku:</span>
                        <strong style="font-size: 16px; color: #27ae60;" id="statsAyetOku">0</strong>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='translateX(0)'">
                        <span style="font-size: 13px; font-weight: 500; color: #333;">🤲 Dua Öğren:</span>
                        <strong style="font-size: 16px; color: #27ae60;" id="statsDuaOgre">0</strong>
                    </div>
                    <div style="padding: 10px; background: white; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='translateX(0)'">
                        <span style="font-size: 13px; font-weight: 500; color: #333;">📜 Hadis Oku:</span>
                        <strong style="font-size: 16px; color: #27ae60;" id="statsHadisOku">0</strong>
                    </div>
                </div>
            </div>

            <!-- Bugünkü Toplam İstatistikler - Modern Tasarım -->
            <div style="background: linear-gradient(135deg, #fef9e7 0%, #ffe6d9 100%); padding: 16px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #b7950b; box-shadow: 0 2px 8px rgba(183,149,11,0.1);">
                <h4 style="margin: 0 0 12px 0; color: #b7950b; font-size: 16px; font-weight: 600;">⚡ Bugünkü Performans</h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 24px; font-weight: bold; color: #27ae60; margin-bottom: 4px;" id="statsTodayCorrect">0</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Toplam Sahih</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 24px; font-weight: bold; color: #f39c12; margin-bottom: 4px;" id="statsTodayPoints">0</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Toplam Hasene</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 24px; font-weight: bold; color: #e74c3c; margin-bottom: 4px;" id="statsPerfectStreak">0</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Mükemmel Seri</div>
                    </div>
                    <div style="text-align: center; padding: 12px; background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-size: 24px; font-weight: bold; color: #8e44ad; margin-bottom: 4px;" id="statsDifficultyCount">0</div>
                        <div style="font-size: 12px; color: #666; font-weight: 500;">Farklı Zorluk</div>
                    </div>
                </div>
            </div>

            <!-- Kelime İstatistikleri Bölümü -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
            <!-- Genel Özet -->
            <div style="background: linear-gradient(135deg, #845EC2 0%, #4E8397 100%); color: white; padding: 15px; border-radius: 12px; margin: 15px 0; text-align: center;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 1.4em; font-weight: bold;" id="wordStatsTotal">0</div>
                        <div style="font-size: 0.8em; opacity: 0.9;">Kelime Görüldü</div>
                    </div>
                    <div>
                        <div style="font-size: 1.4em; font-weight: bold;" id="wordStatsMastered">0</div>
                        <div style="font-size: 0.8em; opacity: 0.9;">Öğrenildi</div>
                    </div>
                    <div>
                        <div style="font-size: 1.4em; font-weight: bold;" id="wordStatsStruggling">0</div>
                        <div style="font-size: 0.8em; opacity: 0.9;">Zorlanılan</div>
                    </div>
                </div>
            </div>

            <!-- Filtreleme Butonları -->
            <div style="display: flex; gap: 8px; margin: 15px 0; flex-wrap: wrap;">
                <button id="filterAll" class="filter-btn active" style="flex: 1; min-width: 80px; padding: 8px; border: none; border-radius: 6px; background: #3498db; color: white; font-size: 0.85em; cursor: pointer;">
                    Hepsi
                </button>
                <button id="filterFavorites" class="filter-btn" style="flex: 1; min-width: 80px; padding: 8px; border: none; border-radius: 6px; background: #95a5a6; color: white; font-size: 0.85em; cursor: pointer;">
                    ⭐ Favoriler
                </button>
                <button id="filterReview" class="filter-btn" style="flex: 1; min-width: 80px; padding: 8px; border: none; border-radius: 6px; background: #95a5a6; color: white; font-size: 0.85em; cursor: pointer;">
                    🔄 Tekrar
                </button>
                <button id="filterMastered" class="filter-btn" style="flex: 1; min-width: 80px; padding: 8px; border: none; border-radius: 6px; background: #95a5a6; color: white; font-size: 0.85em; cursor: pointer;">
                    Öğrenildi
                </button>
                <button id="filterStruggling" class="filter-btn" style="flex: 1; min-width: 80px; padding: 8px; border: none; border-radius: 6px; background: #95a5a6; color: white; font-size: 0.85em; cursor: pointer;">
                    Zorlanılan
                </button>
                <button id="filterRecent" class="filter-btn" style="flex: 1; min-width: 80px; padding: 8px; border: none; border-radius: 6px; background: #95a5a6; color: white; font-size: 0.85em; cursor: pointer;">
                    Son Görülen
                </button>
            </div>

            <!-- Kelime Listesi -->
            <div id="wordStatsList" style="max-height: 400px; overflow-y: auto; margin: 15px 0;">
                <!-- Kelime istatistikleri buraya dinamik eklenecek -->
            </div>

            <!-- Öğrenme İpuçları -->
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #f39c12;">
                <div style="font-size: 0.9em; color: #856404; font-weight: bold; margin-bottom: 6px;">💡 Öğrenme İpuçları</div>
                <div style="font-size: 0.8em; color: #666; line-height: 1.6;">
                    <strong>📚 Zorlanılan Kelimeler:</strong><br>
                    • İlk oyundan itibaren görünebilir<br>
                    • Başarı oranı %60'ın altında VEYA ustalık seviyesi 1.0'ın altında olan kelimeler<br>
                    • Yanlış cevap verdiğin kelimeler hemen bu kategoride görünür<br><br>
                    
                    <strong>✅ Öğrenildi Kelimeler:</strong><br>
                    • En az 15 doğru cevap ve %60 başarı oranı gerekir<br>
                    • Ustalık seviyesi 3.0'ın üzerinde olmalı<br>
                    • Her doğru cevap +0.2, her yanlış cevap -0.5 ustalık puanı verir<br>
                    • Tahmini: 15-20 soru (yanlışlar varsa daha fazla)<br><br>
                    
                    <strong>🔄 Genel:</strong><br>
                    • Zorlandığın kelimeler otomatik olarak daha sık gösterilir<br>
                    • Uzun süre görülmeyen kelimeler tekrar önceliklendirilir
                </div>
            </div>

            </div>
            <!-- Kelime İstatistikleri Bölümü Sonu -->
            
            <!-- Detaylı Analitik Bölümü -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: #667eea; font-weight: 600;">📊 Detaylı Analitik</h4>
                
                <!-- Zaman Analizi -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="font-size: 0.9em; font-weight: 600; color: #333; margin-bottom: 10px;">⏰ Bugünkü Aktiflik</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85em;">
                        <div>
                            <div style="color: #666; margin-bottom: 4px;">Süre</div>
                            <div style="font-weight: 600; color: #667eea;" id="analyticsTodayTime">0 dk</div>
            </div>
                        <div>
                            <div style="color: #666; margin-bottom: 4px;">Soru/Saat</div>
                            <div style="font-weight: 600; color: #667eea;" id="analyticsQuestionPerHour">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Hedef Tahmini -->
                <div style="background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="font-size: 0.9em; font-weight: 600; color: #333; margin-bottom: 10px;">🎯 Günlük Hedef Durumu</div>
                    <div style="font-size: 0.85em; color: #555; margin-bottom: 8px;">
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666;">Hedef:</span> <strong id="analyticsDailyGoal">0</strong> Hasene
            </div>
                        <div style="margin-bottom: 6px;">
                            <span style="color: #666;">İlerleme:</span> <strong id="analyticsTodayProgress">0</strong> / <span id="analyticsDailyGoalTotal">0</span> Hasene
                        </div>
                        <div style="background: rgba(255,255,255,0.5); height: 8px; border-radius: 4px; margin: 8px 0; overflow: hidden;">
                            <div id="analyticsGoalProgressBar" style="background: #f39c12; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.8em; color: #856404;">
                            <span id="analyticsTimeToGoal">Tahmini süre hesaplanıyor...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Kelime Performans Özeti -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="font-size: 0.9em; font-weight: 600; color: #333; margin-bottom: 10px;">📈 Kelime Performansı</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85em;">
                        <div>
                            <div style="color: #666; margin-bottom: 4px;">Ortalama Başarı</div>
                            <div style="font-weight: 600; color: #27ae60;" id="analyticsAvgSuccess">%0</div>
                        </div>
                        <div>
                            <div style="color: #666; margin-bottom: 4px;">En Zor Kelime</div>
                            <div style="font-weight: 600; color: #e74c3c; font-size: 0.8em;" id="analyticsHardestWord">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Öğrenme Haritası -->
                <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="font-size: 0.9em; font-weight: 600; color: #333; margin-bottom: 10px;">🗺️ Öğrenme Haritası</div>
                    <div style="font-size: 0.85em; color: #555;">
                        <div style="margin-bottom: 8px;">
                            <span style="color: #27ae60;">●</span> <strong>Öğrenildi:</strong> <span id="analyticsLearnedCount">0</span> kelime
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="color: #f39c12;">●</span> <strong>Pratik Gerekli:</strong> <span id="analyticsPracticeCount">0</span> kelime
                        </div>
                        <div>
                            <span style="color: #e74c3c;">●</span> <strong>Zorlanılan:</strong> <span id="analyticsStrugglingCount">0</span> kelime
                        </div>
                    </div>
                </div>
            </div>
            <!-- Detaylı Analitik Bölümü Sonu -->
            
            <!-- Liderlik Tablosu Bölümü -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                <h4 style="margin: 0 0 15px 0; font-size: 1.1em; color: #667eea; font-weight: 600;">🏆 Liderlik Tablosu</h4>
                
                <div style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="font-size: 0.9em; font-weight: 600; color: #333; margin-bottom: 10px; text-align: center;">📊 Sıralaman</div>
                    <div style="text-align: center; font-size: 1.5em; font-weight: bold; color: #8b4513;" id="leaderboardYourRank">-</div>
                    <div style="text-align: center; font-size: 0.85em; color: #555; margin-top: 8px;" id="leaderboardYourScore">Hasene: 0</div>
                </div>
                
                <!-- Liderlik Listesi -->
                <div id="leaderboardList" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                    <div style="text-align: center; padding: 20px; color: #666; font-size: 0.9em;">
                        Henüz liderlik tablosu verisi yok. Oyun oynayarak sıralamaya katıl!
                    </div>
                </div>
                
                <!-- Not: Bu basit bir yerel liderlik tablosudur. Gerçek bir sosyal özellik için sunucu desteği gerekir. -->
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 0.75em; color: #666; text-align: center;">
                    💡 Bu yerel bir liderlik tablosudur. Daha gelişmiş sosyal özellikler için sunucu desteği gereklidir.
                </div>
            </div>
            <!-- Liderlik Tablosu Bölümü Sonu -->
            
            </div>
            <!-- Scroll Edilebilir İçerik Sonu -->

        </div>
    </div>

    <!-- Daily Goal Settings Modal -->
    <div class="modal" id="dailyGoalModal" onclick="handleDailyGoalModalClick(event)">
        <div class="modal-content" style="max-width: 360px;" onclick="event.stopPropagation();">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="margin: 0; font-size: 1.05em; text-align: center; flex: 1;">🎯 Günlük Hedef Seç</h3>
                <button onclick="event.stopPropagation(); closeDailyGoalModal();" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; flex-shrink: 0;" onmouseover="this.style.background='#f0f0f0'; this.style.color='#e74c3c';" onmouseout="this.style.background='transparent'; this.style.color='#999';">×</button>
            </div>
            <p style="text-align: center; color: #666; font-size: 0.8em; margin-bottom: 20px;">
                Ne kadar çalışmak istiyorsun?
            </p>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button id="dailyGoalEasyBtn" data-goal="easy" style="background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; text-align: left; transition: transform 0.3s; box-shadow: 0 4px 12px rgba(74,222,128,0.3); touch-action: manipulation; -webkit-tap-highlight-color: transparent;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.8em;">🌱</span>
                        <div>
                            <div style="font-weight: 600; font-size: 0.95em;">Rahat</div>
                            <div style="font-size: 0.75em; opacity: 0.9;">Günde 1,300 Hasene - ~10 dakika</div>
                        </div>
                    </div>
                </button>
                
                <button id="dailyGoalNormalBtn" data-goal="normal" style="background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; text-align: left; transition: transform 0.3s; box-shadow: 0 4px 12px rgba(96,165,250,0.3); touch-action: manipulation; -webkit-tap-highlight-color: transparent;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.8em;">🎯</span>
                        <div>
                            <div style="font-weight: 600; font-size: 0.95em;">Normal</div>
                            <div style="font-size: 0.75em; opacity: 0.9;">Günde 2,700 Hasene - ~20 dakika</div>
                        </div>
                    </div>
                </button>
                
                <button id="dailyGoalSeriousBtn" data-goal="serious" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; border: none; padding: 16px; border-radius: 12px; cursor: pointer; text-align: left; transition: transform 0.3s; box-shadow: 0 4px 12px rgba(249,115,22,0.3); touch-action: manipulation; -webkit-tap-highlight-color: transparent;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 1.8em;">🔥</span>
                        <div>
                            <div style="font-weight: 600; font-size: 0.95em;">Ciddi</div>
                            <div style="font-size: 0.75em; opacity: 0.9;">Günde 6,000 Hasene - ~45 dakika</div>
                        </div>
                    </div>
                </button>
            </div>
            
            <button id="closeDailyGoalBtn" style="width: auto; max-width: 200px; padding: 10px 30px; background: #e74c3c; color: white; border: none; border-radius: 8px; font-size: 0.9em; font-weight: bold; cursor: pointer; margin: 20px auto 0; display: block; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">
                Kapat
            </button>
        </div>
    </div>

    <!-- Hasene Info Modal -->
    <div class="modal" id="xpInfoModal" onclick="handleXPInfoModalClick(event)">
        <div class="modal-content stats-content" style="max-width: 500px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; padding: 20px; touch-action: pan-y;">
            <!-- Başlık ve Kapat Butonu -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-shrink: 0;">
                <h3 style="margin: 0; font-size: 1.2em; font-weight: 700; color: #667eea;">💰 Hasene Sistemi</h3>
                <button onclick="event.stopPropagation(); closeXPInfoModal();" style="background: transparent; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;" onmouseover="this.style.background='#f0f0f0'; this.style.color='#e74c3c';" onmouseout="this.style.background='transparent'; this.style.color='#999';">×</button>
            </div>

            <!-- Scroll Edilebilir İçerik -->
            <div id="xpInfoScrollableContent" style="flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; padding-right: 4px; margin-bottom: 12px; -webkit-overflow-scrolling: touch;">
            <h3 style="margin: 0 0 15px 0; font-size: 1.1em; text-align: center; color: #667eea;">� Hasene Sistemi</h3>
            
                <!-- Özet Bilgi - Modern Tasarım -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center; box-shadow: 0 4px 12px rgba(102,126,234,0.3);">
                    <h3 style="font-size: 16px; margin-bottom: 12px; opacity: 0.9; font-weight: 600;">⏱️ Hızlı Referans</h3>
                    <div style="font-size: 18px; font-weight: 600; opacity: 0.95;">1 Saat Amel = ~8,500 Hasene</div>
            </div>
            
                <!-- Yıldız Sistemi - Modern Tasarım -->
                <div style="background: linear-gradient(135deg, #fff9e6 0%, #ffe6f0 100%); padding: 20px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #ffc107; box-shadow: 0 2px 8px rgba(255,193,7,0.2);">
                    <h4 style="margin: 0 0 12px 0; color: #f59e0b; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.3em;">⭐</span> Yıldız Sistemi
                    </h4>
                    <div style="font-size: 14px; color: #555; line-height: 1.7;">
                        <div style="background: white; padding: 16px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <strong style="color: #f59e0b; font-size: 18px;">100 Hasene = 1 Yıldız</strong>
                        </div>
                        <div style="color: #666; font-size: 14px; font-weight: 500;">
                            Her sahih cevabın mükâfatı. Sürekli ilerleme görürsün! 📈
                        </div>
                </div>
            </div>
            
                <!-- Mertebe Sistemi - Modern Tasarım -->
                <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); padding: 20px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(102,126,234,0.2);">
                    <h4 style="margin: 0 0 16px 0; color: #667eea; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.3em;">🏆</span> Mertebe Sistemi
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div style="background: white; padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2em; margin-bottom: 8px;">🥉</div>
                            <div style="font-weight: 700; color: #cd7f32; margin-bottom: 6px; font-size: 16px;">2,000 Hasene</div>
                            <div style="font-size: 14px; color: #888; font-weight: 500;">Mübtedi</div>
                            <div style="font-size: 12px; color: #aaa; margin-top: 4px;">~15 dk</div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2em; margin-bottom: 8px;">🥈</div>
                            <div style="font-weight: 700; color: #c0c0c0; margin-bottom: 6px; font-size: 16px;">8,500 Hasene</div>
                            <div style="font-size: 14px; color: #888; font-weight: 500;">Müterakki</div>
                            <div style="font-size: 12px; color: #aaa; margin-top: 4px;">~1 saat</div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2em; margin-bottom: 8px;">🥇</div>
                            <div style="font-weight: 700; color: #ffd700; margin-bottom: 6px; font-size: 16px;">25,500 Hasene</div>
                            <div style="font-size: 14px; color: #888; font-weight: 500;">Mütecaviz</div>
                            <div style="font-size: 12px; color: #aaa; margin-top: 4px;">~3 gün</div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 2em; margin-bottom: 8px;">💎</div>
                            <div style="font-weight: 700; color: #00d9ff; margin-bottom: 6px; font-size: 16px;">85,000 Hasene</div>
                            <div style="font-size: 14px; color: #888; font-weight: 500;">Mütebahhir</div>
                            <div style="font-size: 12px; color: #aaa; margin-top: 4px;">~10 gün</div>
                        </div>
                </div>
            </div>
            
                <!-- Bonuslar - Modern Tasarım -->
                <div style="background: linear-gradient(135deg, #fff7e6 0%, #ffe6d9 100%); padding: 20px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #f97316; box-shadow: 0 2px 8px rgba(249,115,22,0.2);">
                    <h4 style="margin: 0 0 16px 0; color: #f97316; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.3em;">🎁</span> Bonus Sistemleri
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='translateX(0)'">
                            <div style="font-weight: 700; color: #f97316; margin-bottom: 8px; font-size: 16px;">🔥 Silsile Bonusu</div>
                            <div style="font-size: 14px; color: #555; line-height: 1.6; font-weight: 500;">
                    <strong>Her 3 sahih cevap = +5 Hasene bonus!</strong><br>
                                <span style="color: #888; font-size: 13px;">Tevali yap, ilave mükâfat kazan!</span>
                </div>
            </div>
                        <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='translateX(0)'">
                            <div style="font-weight: 700; color: #3b82f6; margin-bottom: 8px; font-size: 16px;">🎯 Günlük Vird Bonusu</div>
                            <div style="font-size: 14px; color: #555; line-height: 1.6; font-weight: 500;">
                    Günlük virdini tamamla:<br>
                    <strong style="color: #3b82f6; font-size: 18px;">+1,000 Hasene Müjdesi!</strong>
                            </div>
                        </div>
                        <div style="background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;" onmouseover="this.style.transform='translateX(2px)'" onmouseout="this.style.transform='translateX(0)'">
                            <div style="font-weight: 700; color: #d97706; margin-bottom: 8px; font-size: 16px;">📋 Günlük Görevler</div>
                            <div style="font-size: 14px; color: #555; line-height: 1.6; font-weight: 500;">
                                Tüm günlük görevleri tamamla:<br>
                                <strong style="color: #d97706; font-size: 18px;">+2,500 Hasene Bonus!</strong>
                            </div>
                        </div>
                </div>
            </div>
            
                <!-- Oyun Modlarına Göre Puan - Modern Tasarım -->
                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 16px; margin-bottom: 20px; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(102,126,234,0.2);">
                    <h4 style="margin: 0 0 16px 0; color: #667eea; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 1.3em;">🎮</span> Oyun Modlarına Göre Puan
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 10px; font-size: 0.85em;">
                        <div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-weight: 700; color: #667eea; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                                <span>🔤</span> Kelime Çevir
                    </div>
                            <div style="color: #555; line-height: 1.6;">
                                <strong>Kelime Zorluğu × 2 Hasene</strong><br>
                                <span style="font-size: 0.9em; color: #888;">Kolay: 10-18 | Orta: 20-22 | Zor: 24-42</span>
                    </div>
                    </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-weight: 700; color: #667eea; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                                <span>🎵</span> Dinle ve Bul
                    </div>
                            <div style="color: #555; line-height: 1.6;">
                                <strong>Kelime Zorluğu × 2 Hasene</strong>
                </div>
            </div>
                        <div style="background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-weight: 700; color: #667eea; margin-bottom: 6px; display: flex; align-items: center; gap: 6px;">
                                <span>📝</span> Boşluk Doldur
                </div>
                            <div style="color: #555; line-height: 1.6;">
                                <strong>Sabit 10 Hasene</strong>
            </div>
                        </div>
                        <div style="background: #fff3cd; padding: 10px; border-radius: 8px; margin-top: 8px; border-left: 3px solid #ffc107;">
                            <div style="font-size: 0.8em; color: #856404; line-height: 1.5;">
                                <strong>ℹ️ Not:</strong> 📖 Ayet Oku, 🤲 Dua Öğren, 📚 Hadis Oku modlarında puan kazanılmaz (sadece günlük görev ilerlemesi)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Scroll edilebilir içerik sonu -->

            <!-- Kapat Butonu (Sabit) -->
            <div style="flex-shrink: 0; margin-top: 12px; text-align: center;">
                <button id="closeXPInfoBtn" style="width: auto; max-width: 200px; padding: 10px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 0.9em; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(102,126,234,0.3); transition: transform 0.2s;">
                Bâreke'llahu fîke! 🤲
            </button>
            </div>
        </div>
    </div>

    <!-- Oyun Bitti Modal -->
    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2 id="gameOverTitle">😢 Oyun Bitti</h2>
            <p id="gameOverText"></p>
            <p>Toplam Hasene: <strong id="finalScore">0</strong></p>
            <button class="modal-btn" id="restartBtn">Yeniden Başla</button>
        </div>
    </div>

    <!-- Custom Alert Modal (Professional Replacement for alert()) -->
    <div id="customAlertModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 420px; text-align: center; padding: 30px;">
            <div id="customAlertIcon" style="font-size: 2.5em; margin-bottom: 12px;">ℹ️</div>
            <div id="customAlertTitle" style="font-size: 1.1em; font-weight: bold; color: #333; margin-bottom: 8px;">Bilgi</div>
            <div id="customAlertMessage" style="font-size: 0.9em; color: #666; margin-bottom: 20px; line-height: 1.5;"></div>
            <button id="customAlertOKBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 35px; border-radius: 8px; font-size: 0.95em; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(102,126,234,0.3); transition: transform 0.2s;">
                Tamam
            </button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
        <div style="text-align: center; color: white;">
            <div style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
            <div style="font-size: 1.1em; font-weight: 600;">Yükleniyor...</div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        // Modüler JavaScript dosyaları yüklendi (config.js ve utils.js)
        // Artık CONFIG, log, getLocalDateString, hapticFeedback, initSwipeGestures,
        // sanitizeHTML, safeSetHTML, showLoading, hideLoading, encryptData, decryptData,
        // secureSetItem, secureGetItem, showCustomAlert fonksiyonları kullanılabilir
        
        // ============ GLOBAL FONKSİYONLAR (onclick için erişilebilir olmalı) ============
        
        function switchStatsTab(tabName) {
            log.stats('🔄 switchStatsTab ÇAĞRILDI, tabName:', tabName);
            
            // İçerik divlerini gizle/göster
            const generalContent = document.getElementById('statsContentGeneral');
            const wordsContent = document.getElementById('statsContentWords');
            const generalTab = document.getElementById('statsTabGeneral');
            const wordsTab = document.getElementById('statsTabWords');
            
            // NULL KONTROL - Elementler yoksa hata ver
            if (!generalContent || !wordsContent || !generalTab || !wordsTab) {
                log.error('❌ HATA: İstatistik tab elementleri bulunamadı!', {
                    generalContent: !!generalContent,
                    wordsContent: !!wordsContent,
                    generalTab: !!generalTab,
                    wordsTab: !!wordsTab
                });
                return;
            }
            
            log.elements('📍 Element kontrol:', {
                generalContent: !!generalContent,
                wordsContent: !!wordsContent,
                generalTab: !!generalTab,
                wordsTab: !!wordsTab
            });
            
            if (tabName === 'general') {
                generalContent.style.display = 'block';
                wordsContent.style.display = 'none';
                
                // Tab butonlarını güncelle
                generalTab.style.background = 'linear-gradient(135deg, #8B4513 0%, #D2691E 100%)';
                generalTab.style.color = 'white';
                generalTab.style.border = 'none';
                
                wordsTab.style.background = 'white';
                wordsTab.style.color = '#666';
                wordsTab.style.border = '2px solid #e0e0e0';
            } else if (tabName === 'words') {
                log.stats('📝 Kelimeler sekmesine geçiliyor...');
                generalContent.style.display = 'none';
                wordsContent.style.display = 'block';
                
                log.elements('📍 wordsContent display SONRASI:', window.getComputedStyle(wordsContent).display);
                log.elements('📍 wordsContent visibility:', window.getComputedStyle(wordsContent).visibility);
                log.elements('📍 wordsContent height:', window.getComputedStyle(wordsContent).height);
                log.elements('📍 wordsContent offsetHeight:', wordsContent.offsetHeight);
                
                // Tab butonlarını güncelle
                wordsTab.style.background = 'linear-gradient(135deg, #8B4513 0%, #D2691E 100%)';
                wordsTab.style.color = 'white';
                wordsTab.style.border = 'none';
                
                generalTab.style.background = 'white';
                generalTab.style.color = '#666';
                generalTab.style.border = '2px solid #e0e0e0';
                
                // Kelime istatistiklerini güncelle
                log.stats('🔍 updateWordStatistics fonksiyon tipi:', typeof updateWordStatistics);
                if (typeof updateWordStatistics === 'function') {
                    log.stats('✅ updateWordStatistics çağrılıyor...');
                    updateWordStatistics();
                } else {
                    log.error('❌ updateWordStatistics fonksiyon DEĞİL!');
                }
            }
        }
        
        // Daily Goal Functions
        function showDailyGoalSettings() {
            const modal = document.getElementById('dailyGoalModal');
            if (modal) {
                modal.style.display = 'flex';
                // Touch event'leri başlat
                initDailyGoalModalTouchEvents();
            }
        }
        
        function closeDailyGoalModal() {
            const modal = document.getElementById('dailyGoalModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Daily Goal Modal için touch event'leri
        let dailyGoalModalTouchStart = { x: 0, y: 0, time: 0 };
        let dailyGoalModalIsScrolling = false;
        
        function initDailyGoalModalTouchEvents() {
            const dailyGoalModal = document.getElementById('dailyGoalModal');
            if (!dailyGoalModal) return;
            
            // Eğer zaten eklenmişse, tekrar ekleme
            if (dailyGoalModal.hasAttribute('data-touch-events-initialized')) return;
            dailyGoalModal.setAttribute('data-touch-events-initialized', 'true');
            
            // Modal overlay için touch event'leri
            dailyGoalModal.addEventListener('touchstart', function(e) {
                if (e.target && e.target.closest('.modal-content')) {
                    return;
                }
                
                const touch = e.touches[0];
                dailyGoalModalTouchStart = {
                    x: touch.clientX,
                    y: touch.clientY,
                    time: Date.now()
                };
                dailyGoalModalIsScrolling = false;
            }, { passive: true });
            
            dailyGoalModal.addEventListener('touchmove', function(e) {
                if (e.target && e.target.closest('.modal-content')) {
                    return;
                }
                
                if (dailyGoalModalTouchStart.x !== 0 || dailyGoalModalTouchStart.y !== 0) {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - dailyGoalModalTouchStart.x);
                    const deltaY = Math.abs(touch.clientY - dailyGoalModalTouchStart.y);
                    if (deltaX > 10 || deltaY > 10) {
                        dailyGoalModalIsScrolling = true;
                    }
                }
            }, { passive: true });
            
            dailyGoalModal.addEventListener('touchend', function(e) {
                if (dailyGoalModalIsScrolling) {
                    dailyGoalModalIsScrolling = false;
                    dailyGoalModalTouchStart = { x: 0, y: 0, time: 0 };
                    return;
                }
                
                const touch = e.changedTouches[0];
                const deltaTime = Date.now() - dailyGoalModalTouchStart.time;
                const deltaX = Math.abs(touch.clientX - dailyGoalModalTouchStart.x);
                const deltaY = Math.abs(touch.clientY - dailyGoalModalTouchStart.y);
                
                if (deltaTime < 300 && deltaX < 10 && deltaY < 10) {
                    if (e.target && e.target.closest('.modal-content')) {
                        return;
                    }
                    if (e.target && (e.target.id === 'closeDailyGoalBtn' || e.target.closest('#closeDailyGoalBtn'))) {
                        return;
                    }
                    closeDailyGoalModal();
                }
                
                dailyGoalModalTouchStart = { x: 0, y: 0, time: 0 };
            }, { passive: true });
        }
        
        // Her yere tıklayınca kapatma fonksiyonu
        function handleDailyGoalModalClick(event) {
            const target = event.target;
            if (target && target.closest('button[onclick*="closeDailyGoalModal"]')) {
                return;
            }
            if (target && target.closest('.modal-content')) {
                return;
            }
            closeDailyGoalModal();
        }
        
        // Global olarak erişilebilir yap
        window.handleDailyGoalModalClick = handleDailyGoalModalClick;
        
        function setDailyGoal(level) {
            // 1 saat oyun = ~8000 Hasene
            // Kolay: 10 dakika (~1300 Hasene)
            // Normal: 20 dakika (~2700 Hasene)  
            // Ciddi: 45 dakika (~6000 Hasene)
            const goals = {
                easy: { hasene: 1300, name: 'Rahat', icon: '🌱' },
                normal: { hasene: 2700, name: 'Normal', icon: '🎯' },
                serious: { hasene: 6000, name: 'Ciddi', icon: '🔥' }
            };
            
            const goal = goals[level];
            localStorage.setItem('dailyGoalLevel', level);
            localStorage.setItem('dailyGoalHasene', goal.hasene);
            
            // Günlük Hasene'yi sıfırla (her gün başta)
            const today = getLocalDateString(); // Yerel tarih (YYYY-MM-DD)
            const lastDate = localStorage.getItem('lastDailyGoalDate');
            // Eski format (toDateString) kontrolü - geriye uyumluluk için
            const todayOldFormat = new Date().toDateString();
            if (lastDate !== today && lastDate !== todayOldFormat) {
                localStorage.setItem('dailyXP', '0');
                localStorage.setItem('lastDailyGoalDate', today);
            }
            
            updateDailyGoalDisplay();
            closeDailyGoalModal();
            
            // Başarı mesajı
            showSuccessMessage(goal.icon + ' Günlük hedefin ' + goal.name + ' olarak ayarlandı!');
        }
        
        function updateDailyGoalDisplay() {
            const goalXP = parseInt(localStorage.getItem('dailyGoalHasene')) || 2700;
            const dailyXP = parseInt(localStorage.getItem('dailyHasene')) || 0;
            const goalLevel = localStorage.getItem('dailyGoalLevel') || 'normal';
            
            const goals = {
                easy: { name: 'Rahat', icon: '🌱' },
                normal: { name: 'Normal', icon: '🎯' },
                serious: { name: 'Ciddi', icon: '🔥' }
            };
            
            const progressPercent = Math.min((dailyXP / goalXP) * 100, 100);
            const isCompleted = dailyXP >= goalXP;
            
            // NULL KONTROL - Elementleri kontrol et
            const progressEl = document.getElementById('dailyGoalProgress');
            const progressTextEl = document.getElementById('dailyGoalProgressText');
            const goalTextEl = document.getElementById('dailyGoalText');
            const goalButton = document.querySelector('.goal-settings-btn');
            const goalButtonIcon = document.getElementById('goalButtonIcon');
            
            if (!progressEl || !progressTextEl || !goalTextEl) {
                log.error('❌ HATA: Günlük hedef elementleri bulunamadı!');
                return;
            }
            
            progressEl.style.width = progressPercent + '%';
            progressTextEl.textContent = dailyXP + ' / ' + goalXP + ' Hasene';
            goalTextEl.textContent = goalXP + ' hasene hedefine ulaş! (' + goals[goalLevel].name + ')';
            
            // Hedef tamamlandıysa
            if (isCompleted) {
                goalTextEl.textContent = '✅ Günlük hedef tamamlandı!';
                
                // Butonu altın yap ve kutlama animasyonu ekle
                if (goalButton) {
                    goalButton.classList.add('completed');
                    goalButton.style.background = 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)';
                    goalButton.style.boxShadow = '0 4px 12px rgba(255, 215, 0, 0.5), 0 0 0 0 rgba(255, 215, 0, 0.7)';
                    if (goalButtonIcon) {
                        goalButtonIcon.textContent = '✨';
                    }
                }
            } else {
                // Hedef tamamlanmadıysa normal görünüm
                if (goalButton) {
                    goalButton.classList.remove('completed');
                    goalButton.style.background = 'linear-gradient(135deg, #58cc02 0%, #4db300 100%)';
                    goalButton.style.boxShadow = '0 4px 12px rgba(88, 204, 2, 0.4), 0 0 0 0 rgba(88, 204, 2, 0.7)';
                    if (goalButtonIcon) {
                        goalButtonIcon.textContent = '🎯';
                    }
                }
            }
        }
        
        function addDailyXP(xp) {
            const today = getLocalDateString(); // Yerel tarih (YYYY-MM-DD)
            const lastDate = localStorage.getItem('lastDailyGoalDate');
            // Eski format (toDateString) kontrolü - geriye uyumluluk için
            const todayOldFormat = new Date().toDateString();
            
            // Yeni gün başladıysa sıfırla
            if (lastDate !== today && lastDate !== todayOldFormat) {
                localStorage.setItem('dailyXP', '0');
                localStorage.setItem('lastDailyGoalDate', today);
            }
            
            const currentXP = parseInt(localStorage.getItem('dailyHasene')) || 0;
            const goalXP = parseInt(localStorage.getItem('dailyGoalHasene')) || 2700;
            const newXP = currentXP + xp;
            
            localStorage.setItem('dailyHasene', newXP.toString());
            
            // Hedef tamamlandıysa
            if (currentXP < goalXP && newXP >= goalXP) {
                setTimeout(() => {
                    showSuccessMessage('🎉 Günlük hedefini tamamladın! +1000 bonus Hasene!');
                    // Bonus Hasene ekle (puan sistemine direkt ekle)
                    totalPoints += 1000;
                    updateStatsBar();
                    saveStats();
                    checkAchievements();
                }, 1000);
            }
            
            updateDailyGoalDisplay();
        }
        
        function showSuccessMessage(message) {
            const msg = document.createElement('div');
            msg.textContent = message;
            // comboIndicator ile aynı boyutlar: padding: 10px 16px, font-size: 14px, border-radius: 10px
            msg.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%); color: white; padding: 10px 16px; border-radius: 10px; font-weight: 600; font-size: 14px; z-index: 10000; box-shadow: 0 4px 15px rgba(74,222,128,0.4); animation: slideDown 0.3s ease; max-width: 90%; box-sizing: border-box; text-align: center; line-height: 1.3; margin: 0;';
            document.body.appendChild(msg);
            
            setTimeout(() => {
                msg.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => msg.remove(), 300);
            }, 3000);
        }
        
        // Ses sistemi (GLOBAL)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            const now = audioContext.currentTime;
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'correct':
                    // Yükselen tonlar (C5 -> E5 -> G5)
                    oscillator.frequency.setValueAtTime(523.25, now); // C5
                    oscillator.frequency.setValueAtTime(659.25, now + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, now + 0.2); // G5
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    oscillator.start(now);
                    oscillator.stop(now + 0.3);
                    break;
                    
                case 'wrong':
                    // Düşen ton (G4 -> C4)
                    oscillator.frequency.setValueAtTime(392.00, now); // G4
                    oscillator.frequency.exponentialRampToValueAtTime(261.63, now + 0.2); // C4
                    gainNode.gain.setValueAtTime(0.2, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    oscillator.start(now);
                    oscillator.stop(now + 0.2);
                    break;
                    
                case 'levelup':
                    // Fanfar (C5 -> E5 -> G5 -> C6)
                    oscillator.frequency.setValueAtTime(523.25, now); // C5
                    oscillator.frequency.setValueAtTime(659.25, now + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, now + 0.2); // G5
                    oscillator.frequency.setValueAtTime(1046.50, now + 0.3); // C6
                    gainNode.gain.setValueAtTime(0.3, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                    oscillator.start(now);
                    oscillator.stop(now + 0.5);
                    break;
                    
                case 'combo':
                    // Hızlı yükselen tonlar
                    oscillator.frequency.setValueAtTime(523.25, now); // C5
                    oscillator.frequency.setValueAtTime(783.99, now + 0.05); // G5
                    oscillator.frequency.setValueAtTime(1046.50, now + 0.1); // C6
                    gainNode.gain.setValueAtTime(0.25, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    oscillator.start(now);
                    oscillator.stop(now + 0.15);
                    break;
            }
        }
        
        // ============ KELİME İSTATİSTİKLERİ FONKSİYONLARI ============
        function updateWordStatistics() {
            log.stats('📊 updateWordStatistics ÇAĞRILDI!');
            
            try {
            const wordStats = loadWordStats();
            log.stats('📦 wordStats yüklendi:', wordStats);
            
            // Genel istatistikleri hesapla
            const totalWords = Object.keys(wordStats).length;
            const masteredWords = Object.values(wordStats).filter(stat => stat.masteryLevel >= 3.0 && stat.successRate >= 0.6).length;
            const strugglingWords = Object.values(wordStats).filter(stat => stat.successRate < 0.6 || stat.masteryLevel < 1.0).length;
            
                // Genel özet güncelle (null kontrolü ile)
                const wordStatsTotalEl = document.getElementById('wordStatsTotal');
                const wordStatsMasteredEl = document.getElementById('wordStatsMastered');
                const wordStatsStrugglingEl = document.getElementById('wordStatsStruggling');
                
                if (wordStatsTotalEl) wordStatsTotalEl.textContent = totalWords;
                if (wordStatsMasteredEl) wordStatsMasteredEl.textContent = masteredWords;
                if (wordStatsStrugglingEl) wordStatsStrugglingEl.textContent = strugglingWords;
            
            // Kelime listesini göster (varsayılan: hepsi)
            filterWordStats('all');
            
                // Event listener'ları ekle (sadece bir kez) - null kontrolü ile
                const filterAll = document.getElementById('filterAll');
                const filterFavorites = document.getElementById('filterFavorites');
                const filterReview = document.getElementById('filterReview');
                const filterMastered = document.getElementById('filterMastered');
                const filterStruggling = document.getElementById('filterStruggling');
                const filterRecent = document.getElementById('filterRecent');
                
                // Favoriler ve tekrar listesini yükle
                if (typeof loadFavorites === 'function') loadFavorites();
                if (typeof loadReviewWords === 'function') loadReviewWords();
                
                if (filterAll && !filterAll.hasAttribute('data-listener-added')) {
                    filterAll.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        filterWordStats('all');
                    };
                    filterAll.setAttribute('data-listener-added', 'true');
                }
                if (filterFavorites && !filterFavorites.hasAttribute('data-listener-added')) {
                    filterFavorites.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        if (typeof loadFavorites === 'function') loadFavorites();
                        filterWordStats('favorites');
                    };
                    filterFavorites.setAttribute('data-listener-added', 'true');
                }
                if (filterReview && !filterReview.hasAttribute('data-listener-added')) {
                    filterReview.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        if (typeof loadReviewWords === 'function') loadReviewWords();
                        filterWordStats('review');
                    };
                    filterReview.setAttribute('data-listener-added', 'true');
                }
                if (filterMastered && !filterMastered.hasAttribute('data-listener-added')) {
                    filterMastered.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        filterWordStats('mastered');
                    };
                    filterMastered.setAttribute('data-listener-added', 'true');
                }
                if (filterStruggling && !filterStruggling.hasAttribute('data-listener-added')) {
                    filterStruggling.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        filterWordStats('struggling');
                    };
                    filterStruggling.setAttribute('data-listener-added', 'true');
                }
                if (filterRecent && !filterRecent.hasAttribute('data-listener-added')) {
                    filterRecent.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        filterWordStats('recent');
                    };
                    filterRecent.setAttribute('data-listener-added', 'true');
                }
            } catch (error) {
                log.error('❌ updateWordStatistics HATA:', error);
                log.error('Stack trace:', error.stack);
            }
        }
        
        function filterWordStats(filterType) {
            try {
                log.stats('🔍 filterWordStats BAŞLADI, filterType:', filterType);
                
                const wordStats = loadWordStats();
                const listContainer = document.getElementById('wordStatsList');
                log.stats('🔍 filterWordStats çağrıldı, filterType:', filterType, 'wordStats:', wordStats, 'toplam kelime:', Object.keys(wordStats).length);
                log.elements('📦 listContainer elementi:', listContainer ? 'BULUNDU ✅' : 'BULUNAMADI ❌');
                
                if (!listContainer) {
                    log.error('❌ HATA: wordStatsList elementi bulunamadı!');
                    return;
                }
                
                // Filtre butonlarını güncelle
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                const filterBtn = document.getElementById('filter' + filterType.charAt(0).toUpperCase() + filterType.slice(1));
                if (filterBtn) filterBtn.classList.add('active');
                
                let filteredStats = [];
                
                log.stats('🎯 kelimeCevirData uzunluğu:', window.kelimeCevirData ? window.kelimeCevirData.length : 'undefined');
                log.stats('📦 wordStats keyleri:', Object.keys(wordStats));
                
                // Filtreleme
                Object.entries(wordStats).forEach(([wordId, stat]) => {
                    log.stats('🔄 İşleniyor:', wordId, stat);
                    
                    // Kelime verisini bul
                    let wordData = null;
                    
                    // ID formatı: "sure:ayet:kelime" (örn: "105:4:1" veya "2:51:4")
                    // kelimeCevirData'da ID aynı formatta
                    if (window.kelimeCevirData && window.kelimeCevirData.length > 0) {
                        wordData = window.kelimeCevirData.find(w => w.id === wordId);
                    }
                    
                    log.stats('🔍 wordId:', wordId, 'wordData bulundu mu?', wordData ? 'EVET ✅' : 'HAYIR ❌');
                    
                    // Bulunamazsa - ID'den parse et
                    if (!wordData) {
                        const [sure, ayet, kelimeIndex] = wordId.split(':');
                        wordData = { 
                            kelime: wordId, // Geçici olarak ID'yi göster
                            anlam: `Sure ${sure}, Ayet ${ayet}, Kelime ${kelimeIndex}`,
                            id: wordId
                        };
                        // Sadece debug modunda göster (çok fazla uyarı olabilir)
                        log.stats('⚠️ Kelime verisi bulunamadı, geçici veri oluşturuldu:', wordData);
                    }
                    
                    // Favoriler kontrolü
                    const isFav = typeof isFavorite !== 'undefined' && isFavorite(wordId);
                    
                    // Tekrar listesi kontrolü
                    const needsReview = typeof reviewWords !== 'undefined' && reviewWords.includes(wordId);
                    
                    const shouldShow = 
                        filterType === 'all' ||
                        (filterType === 'favorites' && isFav) ||
                        (filterType === 'review' && needsReview) ||
                        (filterType === 'mastered' && stat.masteryLevel >= 3.0 && stat.successRate >= 0.6) ||
                        (filterType === 'struggling' && (stat.successRate < 0.6 || stat.masteryLevel < 1.0)) ||
                        (filterType === 'recent' && (Date.now() - stat.lastSeen) < 7 * 24 * 60 * 60 * 1000); // Son 7 gün
                    
                    log.stats('🤔 shouldShow:', shouldShow, 'filterType:', filterType, 'stat:', stat);
                    
                    if (shouldShow) {
                        filteredStats.push({ wordId, ...stat, wordData });
                        log.stats('✅ Listeye eklendi:', wordId);
                    } else {
                        log.stats('❌ Listeye EKLENMEDİ:', wordId);
                    }
                });
                
                log.stats('📋 Filtreleme TAMAMLANDI, sonuç:', filteredStats.length, 'kelime');
                
                // Sıralama (öncelik puanına göre)
                filteredStats.sort((a, b) => {
                    if (filterType === 'recent') {
                        return b.lastSeen - a.lastSeen; // En son görülenler önce
                    } else if (filterType === 'review') {
                        // Tekrar listesi için özel öncelik sıralaması
                        if (typeof calculateReviewPriority !== 'undefined') {
                            const priorityA = calculateReviewPriority(a);
                            const priorityB = calculateReviewPriority(b);
                            return priorityB - priorityA;
                        }
                        return b.priority - a.priority;
                    } else if (filterType === 'favorites') {
                        // Favoriler için son görülme zamanına göre sırala
                        return b.lastSeen - a.lastSeen;
                    }
                    return b.priority - a.priority; // Yüksek öncelik önce
                });
                
                log.stats('📋 Sıralama sonrası:', filteredStats.length, 'kelime');
                log.stats('📦 İlk 3 kelime:', filteredStats.slice(0, 3));
                
                // Liste içeriğini oluştur
                if (filteredStats.length === 0) {
                    log.stats('⚠️ filteredStats boş, empty state gösteriliyor');
                // Toplam kelime sayısını kontrol et
                const totalWords = Object.keys(wordStats).length;
                log.stats('📝 Filtrelenmiş liste boş. totalWords:', totalWords, 'filterType:', filterType);
                
                if (totalWords === 0) {
                    // Hiç oyun oynanmamış
                    log.stats('🎮 Hiç oyun oynanmamış - onboarding kartı gösteriliyor');
                    const cardHTML = `
                        <div style="text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; margin: 20px 0;">
                            <div style="font-size: 3em; margin-bottom: 15px;">🎮</div>
                            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">Henüz Hiç Oyun Oynamadın!</div>
                            <div style="font-size: 0.95em; opacity: 0.95; margin-bottom: 20px; line-height: 1.5;">
                                Kelime istatistiklerini görmek için oyun oynamaya başla!<br>
                                Her kelimeyle çalıştıkça ilerleme kaydedilecek 📈
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 300px; margin: 0 auto;">
                                <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 1.5em; margin-bottom: 5px;">📚</div>
                                    <div style="font-size: 0.8em;">Kelime Çevir</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 1.5em; margin-bottom: 5px;">🎧</div>
                                    <div style="font-size: 0.8em;">Dinle ve Bul</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 1.5em; margin-bottom: 5px;">✏️</div>
                                    <div style="font-size: 0.8em;">Boşluk Doldur</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 1.5em; margin-bottom: 5px;">📖</div>
                                    <div style="font-size: 0.8em;">Ayet Oku</div>
                                </div>
                            </div>
                            <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.9;">
                                Ana menüden bir oyun seç ve başla! 🚀
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML = cardHTML;
                    log.elements('✅ Kart HTML\'i listContainer\'a eklendi, innerHTML uzunluğu:', listContainer.innerHTML.length);
                    log.elements('📍 listContainer display:', window.getComputedStyle(listContainer).display);
                    log.elements('📍 listContainer visibility:', window.getComputedStyle(listContainer).visibility);
                } else {
                    // Oyun oynanmış ama bu kategoride kelime yok
                    log.stats('📋 Oyun oynanmış ama bu kategoride kelime yok - filtre mesajı gösteriliyor');
                    const filterMessages = {
                        'all': 'Henüz hiç kelime istatistiği yok',
                        'favorites': 'Henüz favori kelime eklenmemiş. Kelime kartlarındaki ⭐ butonuna tıklayarak favorilere ekleyebilirsin!',
                        'review': 'Harika! Tekrar gerektiren kelime yok. Tüm kelimeler iyi durumda! 🎉',
                        'mastered': 'Henüz öğrenilmiş kelime yok. Daha fazla pratik yap! 💪',
                        'struggling': 'Harika! Zorlandığın kelime yok. Devam et! 🎉',
                        'recent': 'Son 7 günde kelime çalışılmamış. Bugün pratik yap! 📅'
                    };
                    
                    listContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #666;">
                            <div style="font-size: 2.5em; margin-bottom: 15px;">
                                ${filterType === 'struggling' ? '🎉' : '🔍'}
                            </div>
                            <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px; color: #333;">
                                ${filterMessages[filterType] || 'Bu kategoride kelime bulunamadı'}
                            </div>
                            <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
                                ${filterType === 'mastered' ? 'Daha fazla oyun oyna ve kelimeleri öğren!' : 
                                  filterType === 'struggling' ? 'Tüm kelimeler iyi durumda!' :
                                  filterType === 'recent' ? 'Oyun oynayarak listeni güncel tut!' :
                                  'Oyun oynayarak istatistik oluşturmaya başla!'}
                            </div>
                        </div>
                    `;
                }
                return;
            }
            
            // (commented) Kelime listesi log removed during cleanup
            listContainer.innerHTML = filteredStats.slice(0, 50).map(item => { // En fazla 50 kelime göster
                // Kelime verisi yoksa veya geçersizse bu kartı gösterme
                if (!item.wordData || !item.wordData.kelime || item.wordData.kelime.includes('undefined') || item.wordData.kelime.includes('bosluk')) {
                    return ''; // Boş string döndür
                }
                
                const masteryColor = item.masteryLevel >= 3 ? '#27ae60' : item.masteryLevel >= 1.5 ? '#f39c12' : '#e74c3c';
                const masteryText = item.masteryLevel >= 3 ? 'Öğrenildi' : item.masteryLevel >= 1.5 ? 'Öğreniliyor' : 'Zorlanıyor';
                const successPercent = Math.round(item.successRate * 100);
                
                const isFav = typeof isFavorite !== 'undefined' && isFavorite(item.wordId);
                const needsReview = typeof reviewWords !== 'undefined' && reviewWords.includes(item.wordId);
                
                return `
                    <div style="background: white; border-radius: 8px; padding: 12px; margin: 8px 0; border-left: 4px solid ${masteryColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-size: 1.1em; font-weight: bold; color: #2c3e50; margin-bottom: 2px;">
                                    ${item.wordData.kelime || item.wordId}
                                    ${isFav ? ' ⭐' : ''}
                                    ${needsReview ? ' 🔄' : ''}
                                </div>
                                <div style="font-size: 0.9em; color: #666;">${item.wordData.anlam || 'Bilinmiyor'}</div>
                            </div>
                            <div style="text-align: right; display: flex; gap: 5px; align-items: flex-start;">
                                <button class="favorite-btn-inline" data-word-id="${item.wordId}" onclick="if(typeof toggleFavorite !== 'undefined') { const newState = toggleFavorite('${item.wordId}'); this.innerHTML = newState ? '⭐' : '☆'; this.style.background = newState ? '#ffc107' : 'transparent'; this.style.borderColor = newState ? '#ffc107' : '#ccc'; if(newState && typeof showSuccessMessage !== 'undefined') showSuccessMessage('⭐ Favorilere eklendi!'); }" style="background: ${isFav ? '#ffc107' : 'transparent'}; border: 2px solid ${isFav ? '#ffc107' : '#ccc'}; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; padding: 0; margin: 0; transition: all 0.3s ease;">${isFav ? '⭐' : '☆'}</button>
                                <div style="background: ${masteryColor}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold;">${masteryText}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 0.8em;">
                            <div style="text-align: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                <div style="font-weight: bold; color: #27ae60;">${successPercent}%</div>
                                <div style="color: #666;">Başarı</div>
                            </div>
                            <div style="text-align: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                <div style="font-weight: bold; color: #3498db;">${item.attempts}</div>
                                <div style="color: #666;">Deneme</div>
                            </div>
                            <div style="text-align: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                <div style="font-weight: bold; color: #f39c12;">${Math.round(item.priority * 100) / 100}</div>
                                <div style="color: #666;">Öncelik</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 8px; font-size: 0.75em; color: #666; text-align: center;">
                            Son görülme: ${new Date(item.lastSeen).toLocaleDateString('tr-TR')}
                        </div>
                    </div>
                `;
                }).join('');
                
                log.stats('✅ HTML oluşturuldu ve listContainer\'a yazıldı!');
                
            } catch (error) {
                log.error('🚨 filterWordStats HATA:', error);
                log.error('Stack trace:', error.stack);
            }
        }
        
        // ============ KELİME İSTATİSTİK YÖNETİMİ ============
        function loadWordStats() {
            try {
                const saved = localStorage.getItem('hasene_wordStats');
                return saved ? JSON.parse(saved) : {};
            } catch (error) {
                log.error('📊 Kelime istatistikleri yüklenirken hata:', error);
                return {};
            }
        }

        function saveWordStats(wordStats) {
            try {
                localStorage.setItem('hasene_wordStats', JSON.stringify(wordStats));
                // (commented) Kelime istatistikleri kaydedildi
            } catch (error) {
                log.error('📊 Kelime istatistikleri kaydedilirken hata:', error);
            }
        }

        function updateWordStats(wordId, isCorrect) {
            // NULL KONTROL - wordId geçerli mi?
            if (!wordId || typeof wordId !== 'string') {
                log.error('❌ Geçersiz wordId:', wordId);
                return;
            }
            
            const wordStats = loadWordStats();
            
            if (!wordStats[wordId]) {
                wordStats[wordId] = {
                    attempts: 0,
                    correct: 0,
                    wrong: 0,
                    lastSeen: Date.now(),
                    masteryLevel: 0,
                    priority: 1.0
                };
            }

            const stats = wordStats[wordId];
            stats.attempts++;
            stats.lastSeen = Date.now();

            if (isCorrect) {
                stats.correct++;
                // Doğru cevap - ustalık artır, öncelik azalt
                stats.masteryLevel = Math.min(5, stats.masteryLevel + 0.2);
                stats.priority = Math.max(0.1, stats.priority * 0.8);
            } else {
                stats.wrong++;
                // Yanlış cevap - ustalık azalt, öncelik artır
                stats.masteryLevel = Math.max(0, stats.masteryLevel - 0.5);
                stats.priority = Math.min(3.0, stats.priority * 1.5);
            }

            // Başarı oranı hesapla
            stats.successRate = stats.attempts > 0 ? (stats.correct / stats.attempts) : 0;

            saveWordStats(wordStats);
            log.stats(`📊 ${wordId} kelimesi istatistiği güncellendi:`, stats);
            
            // Tekrar listesini güncelle
            if (typeof updateReviewList === 'function') {
                updateReviewList();
            }
        }

        function selectIntelligentWord(filteredData) {
            const wordStats = loadWordStats();
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;

            // Her kelime için öncelik puanı hesapla
            const wordsWithPriority = filteredData.map(word => {
                const stats = wordStats[word.id];
                let priorityScore = 1.0;

                if (stats) {
                    // Temel öncelik puanı (yanlış cevaplanan kelimeler daha öncelikli)
                    priorityScore = stats.priority;

                    // Zaman faktörü (uzun süredir görülmeyen kelimeler)
                    const daysSinceLastSeen = (now - stats.lastSeen) / oneDay;
                    if (daysSinceLastSeen > 3) {
                        priorityScore *= (1 + daysSinceLastSeen * 0.1);
                    }

                    // Başarı oranı faktörü (düşük başarı oranı = yüksek öncelik)
                    if (stats.successRate < 0.6) {
                        // successRate 0-1 arası olduğu için sonuç 0.5-1.5 arası olur
                        priorityScore *= Math.max(0.1, 1.5 - stats.successRate);
                    }

                    // Ustalık seviyesi faktörü (düşük ustalık = yüksek öncelik)
                    // masteryLevel 0-5 arası olduğu için sonuç 1.0-2.0 arası olur
                    priorityScore *= Math.max(0.1, 2.0 - stats.masteryLevel / 5.0);
                } else {
                    // Hiç görülmemiş kelimeler orta öncelikli
                    priorityScore = 1.2;
                }

                return {
                    word,
                    priority: priorityScore
                };
            });

            // Önceliğe göre sırala
            wordsWithPriority.sort((a, b) => b.priority - a.priority);

            // Weighted random selection (en öncelikli kelimeler daha fazla seçilir)
            const totalWeight = wordsWithPriority.reduce((sum, item) => sum + item.priority, 0);
            
            // Güvenlik kontrolü: totalWeight 0 veya negatif olamaz
            if (totalWeight <= 0 || wordsWithPriority.length === 0) {
                log.warn('⚠️ Öncelik puanları hesaplanamadı, rastgele kelime seçiliyor');
                return filteredData[Math.floor(Math.random() * filteredData.length)];
            }
            
            let random = Math.random() * totalWeight;

            for (const item of wordsWithPriority) {
                random -= item.priority;
                if (random <= 0) {
                    // (commented) Seçilen kelime log removed during cleanup
                    return item.word;
                }
            }

            // Fallback: ilk kelimeyi döndür
            return wordsWithPriority[0]?.word || filteredData[0];
        }
        
        // ============ GLOBAL FONKSİYONLAR SONU ============
        
        // DOM yüklendikten sonra çalıştır
        document.addEventListener('DOMContentLoaded', function() {
            // (commented) DOM yüklendi log removed during cleanup
            
            // Daily Goal'u başlat
            if (!localStorage.getItem('dailyGoalHasene')) {
                localStorage.setItem('dailyGoalHasene', '2700');
                localStorage.setItem('dailyGoalLevel', 'normal');
            }
            updateDailyGoalDisplay();
            
            // Modal butonlarına event listener ekle
            const dailyTasksBtn = document.getElementById('dailyTasksBtn');
            const statsBtn = document.getElementById('statsBtn');
            const calendarBtn = document.getElementById('calendarBtn');
            const xpInfoBtn = document.getElementById('xpInfoBtn');
            
            // ============ AYARLAR - BURADAN KONTROLEDEBİLİRSİN ============
            const CONFIG = {
            // OYUN MODLARI
            gameModes: {
                klasik: {
                    name: '📚 Klasik',
                    description: 'Normal oyun modu',
                    questionsPerLevel: 10,
                    timeLimit: 0,  // 0 = süre yok
                    lives: 0,      // 0 = sınırsız can
                    showHint: true
                },
                hizli: {
                    name: '⚡ Hızlı',
                    description: '30 saniye süre',
                    questionsPerLevel: 15,
                    timeLimit: 30,
                    lives: 0,
                    showHint: false
                },
                hayat: {
                    name: '❤️ 3 Can',
                    description: '3 hak, yanlış = -1 can',
                    questionsPerLevel: 20,
                    timeLimit: 0,
                    lives: 3,
                    showHint: true
                },
                zorluk: {
                    name: '🔥 Zorluk',
                    description: 'Sadece zor kelimeler',
                    questionsPerLevel: 10,
                    timeLimit: 20,
                    lives: 3,
                    showHint: false,
                    minDifficulty: 7  // 7-10 arası zorluk
                }
            },

            // ZORLUK SEVİYELERİ (1 saat oyun = ~8000 Hasene hedefli)
            // Ortalama: ~22 XP/soru (360 soru/saat = 7920 XP + combolar)
            difficultyLevels: {
                kolay: {
                    name: '😊 Kolay',
                    minDiff: 5,
                    maxDiff: 9,
                    pointsMultiplier: 2  // ~13 XP/soru
                },
                orta: {
                    name: '😐 Orta',
                    minDiff: 10,
                    maxDiff: 11,
                    pointsMultiplier: 2  // ~21 XP/soru (ideal)
                },
                zor: {
                    name: '😤 Zor',
                    minDiff: 12,
                    maxDiff: 21,
                    pointsMultiplier: 2  // ~33 XP/soru
                },
                karisik: {
                    name: '🎲 Karışık',
                    minDiff: 5,
                    maxDiff: 21,
                    pointsMultiplier: 2  // ~26 XP/soru ortalama
                }
            },

            // VARSAYILAN AYARLAR
            defaultMode: 'klasik',
            defaultDifficulty: 'orta',  // UI'da mevcut olan zorluk seviyesi
            wrongAnswerPenalty: 5  // Yanlış cevap puan cezası
        };

        // ============ ÖZEL ONAY POP-UP ============
        function showCustomConfirm(correct, wrong, xp) {
            forceLog('[MODAL] Fonksiyon cagrildi - Dogru=' + correct + ' Yanlis=' + wrong + ' XP=' + xp);
            return new Promise((resolve) => {
                forceLog('[MODAL] Promise olusturuldu');
                const confirmModal = document.getElementById('customConfirm');
                const confirmCorrect = document.getElementById('confirmCorrect');
                const confirmWrong = document.getElementById('confirmWrong');
                const confirmXP = document.getElementById('confirmXP');
                const confirmOK = document.getElementById('confirmOK');
                const confirmCancel = document.getElementById('confirmCancel');

                forceLog('[MODAL] Element kontrol:', 
                    'Modal=' + !!confirmModal,
                    'Correct=' + !!confirmCorrect,
                    'Wrong=' + !!confirmWrong,
                    'XP=' + !!confirmXP,
                    'OK=' + !!confirmOK,
                    'Cancel=' + !!confirmCancel
                );

                if (!confirmModal || !confirmCorrect || !confirmWrong || !confirmXP || !confirmOK || !confirmCancel) {
                    console.error('[MODAL] HATA - Elementler bulunamadi!');
                    resolve(true);
                    return;
                }

                forceLog('[MODAL] Degerler guncelleniyor...');
                confirmCorrect.textContent = correct;
                confirmWrong.textContent = wrong;
                confirmXP.textContent = xp;

                forceLog('[MODAL] Modal gosteriliyor...');
                
                // Modal'ı body'ye taşı (eğer başka bir yerdeyse)
                if (confirmModal.parentNode !== document.body) {
                    document.body.appendChild(confirmModal);
                    forceLog('[MODAL] Modal body\'ye tasindi');
                }
                
                // Önce tüm stil özelliklerini sıfırla
                confirmModal.style.removeProperty('display');
                confirmModal.style.removeProperty('visibility');
                confirmModal.style.removeProperty('opacity');
                
                // CSS class ile göster (daha güvenilir)
                confirmModal.classList.add('show');
                
                // Ayrıca inline style da ekle (çift güvence)
                confirmModal.style.setProperty('display', 'flex', 'important');
                confirmModal.style.setProperty('visibility', 'visible', 'important');
                confirmModal.style.setProperty('opacity', '1', 'important');
                confirmModal.style.setProperty('z-index', '11000', 'important');
                
                // requestAnimationFrame ile bir sonraki frame'de kontrol et
                requestAnimationFrame(() => {
                    const computedDisplay = window.getComputedStyle(confirmModal).display;
                    const computedVisibility = window.getComputedStyle(confirmModal).visibility;
                    const computedOpacity = window.getComputedStyle(confirmModal).opacity;
                    const computedZIndex = window.getComputedStyle(confirmModal).zIndex;
                    const isVisible = confirmModal.offsetParent !== null;
                    
                    forceLog('[MODAL] Display degeri (sonraki frame):', computedDisplay);
                    forceLog('[MODAL] Visibility:', computedVisibility);
                    forceLog('[MODAL] Opacity:', computedOpacity);
                    forceLog('[MODAL] Z-index:', computedZIndex);
                    forceLog('[MODAL] Gorunur mu?', isVisible);
                    forceLog('[MODAL] Parent:', confirmModal.parentNode?.tagName || 'null');
                    
                    if (computedDisplay === 'none' || !isVisible || computedOpacity === '0') {
                        forceLog('[MODAL] HATA - Hala gorunmuyor! Zorla gosteriliyor...');
                        confirmModal.style.setProperty('display', 'flex', 'important');
                        confirmModal.style.setProperty('visibility', 'visible', 'important');
                        confirmModal.style.setProperty('opacity', '1', 'important');
                        confirmModal.style.setProperty('z-index', '11000', 'important');
                        confirmModal.style.setProperty('position', 'fixed', 'important');
                        confirmModal.style.setProperty('top', '0', 'important');
                        confirmModal.style.setProperty('left', '0', 'important');
                        confirmModal.style.setProperty('width', '100%', 'important');
                        confirmModal.style.setProperty('height', '100%', 'important');
                    }
                });

                const handleOK = () => {
                    forceLog('[MODAL] OK butonuna tiklandi');
                    confirmModal.classList.remove('show');
                    confirmModal.style.setProperty('display', 'none', 'important');
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    forceLog('[MODAL] Cancel butonuna tiklandi');
                    confirmModal.classList.remove('show');
                    confirmModal.style.setProperty('display', 'none', 'important');
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    forceLog('[MODAL] Cleanup yapiliyor...');
                    if (confirmOK) confirmOK.removeEventListener('click', handleOK);
                    if (confirmCancel) confirmCancel.removeEventListener('click', handleCancel);
                };

                forceLog('[MODAL] Event listener\'lar ekleniyor...');
                confirmOK.addEventListener('click', handleOK);
                confirmCancel.addEventListener('click', handleCancel);
                forceLog('[MODAL] Event listener\'lar eklendi - Modal bekleniyor...');
            });
        }

        // ============ ACHIEVEMENT SİSTEMİ (DOMContentLoaded İÇİNDE) ============
        function checkAchievements() {
            const achievements = [
                { id: 'first_win', name: 'İlk Zafer', desc: 'İlk sahih cevabin', icon: '🎯', condition: () => sessionCorrect >= 1 },
                { id: 'combo_master', name: 'Combo Ustası', desc: '5x combo yap', icon: '🔥', condition: () => comboCount >= 5 },
                { id: 'daily_goal', name: 'Günlük Kahraman', desc: 'Günlük hedefini tamamla', icon: '⭐', condition: () => {
                    const dailyHasene = parseInt(localStorage.getItem('dailyHasene')) || 0;
                    const goalHasene = parseInt(localStorage.getItem('dailyGoalHasene')) || 2700;
                    return dailyHasene >= goalHasene;
                }},
                { id: 'streak_7', name: '7 Gün Streak', desc: '7 gün üst üste oyna', icon: '🔥', condition: () => streakData.currentStreak >= 7 },
                { id: 'level_5', name: 'Seviye 5', desc: 'Seviye 5\'e ulaş', icon: '🏆', condition: () => level >= 5 },
                { id: 'level_10', name: 'Seviye 10', desc: 'Seviye 10\'a ulaş', icon: '💎', condition: () => level >= 10 },
                { id: 'level_20', name: 'Seviye 20', desc: 'Seviye 20\'ye ulaş', icon: '🌟', condition: () => level >= 20 },
                // XP bazlı başarımlar (1 saat oyun = 8500 XP mantığında)
                { id: 'xp_500', name: 'İlk Adım', desc: '500 XP topla (~4 dk)', icon: '🌱', condition: () => totalPoints >= 500 },
                { id: 'xp_2000', name: 'Bronz Yolcu', desc: '2,000 XP (1 Bronz)', icon: '🥉', condition: () => totalPoints >= 2000 },
                { id: 'xp_4000', name: 'Hızlı Başlangıç', desc: '4,000 XP topla', icon: '⚡', condition: () => totalPoints >= 4000 },
                { id: 'xp_8500', name: 'Gümüş Master', desc: '8,500 XP (1 Gümüş)', icon: '🥈', condition: () => totalPoints >= 8500 },
                { id: 'xp_17000', name: 'Çift Gümüş', desc: '17,000 XP topla', icon: '💯', condition: () => totalPoints >= 17000 },
                { id: 'xp_25500', name: 'Altın Master', desc: '25,500 XP (1 Altın)', icon: '🥇', condition: () => totalPoints >= 25500 },
                { id: 'xp_51000', name: 'Çift Altın', desc: '51,000 XP topla', icon: '🔥', condition: () => totalPoints >= 51000 },
                { id: 'xp_85000', name: 'Elmas Master', desc: '85,000 XP (1 Elmas)', icon: '💎', condition: () => totalPoints >= 85000 },
                { id: 'xp_170000', name: 'Efsane', desc: '170,000 XP topla', icon: '✨', condition: () => totalPoints >= 170000 }
            ];
            
            const unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements')) || [];
            let newUnlocks = [];
            
            achievements.forEach(ach => {
                if (!unlockedAchievements.includes(ach.id) && ach.condition()) {
                    unlockedAchievements.push(ach.id);
                    newUnlocks.push(ach);
                }
            });
            
            if (newUnlocks.length > 0) {
                localStorage.setItem('unlockedAchievements', JSON.stringify(unlockedAchievements));
                newUnlocks.forEach(ach => {
                    setTimeout(() => {
                        showAchievementUnlock(ach);
                    }, 500);
                });
            }
        }

        

        
        
        function showAchievementUnlock(achievement) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%) translateY(-100px);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px 30px;
                border-radius: 16px;
                z-index: 10001;
                box-shadow: 0 10px 40px rgba(102,126,234,0.5);
                text-align: center;
                min-width: 280px;
                animation: achievementSlide 0.5s ease forwards;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 10px;">${achievement.icon}</div>
                <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">Müjde Kazanıldı!</div>
                <div style="font-size: 1em; font-weight: 600; margin-bottom: 3px;">${achievement.name}</div>
                <div style="font-size: 0.85em; opacity: 0.9;">${achievement.desc}</div>
            `;
            
            document.body.appendChild(notification);
            
            // CSS animation ekle
            if (!document.getElementById('achievementAnim')) {
                const style = document.createElement('style');
                style.id = 'achievementAnim';
                style.textContent = `
                    @keyframes achievementSlide {
                        to { transform: translateX(-50%) translateY(0); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            setTimeout(() => {
                notification.style.animation = 'slideUp 0.5s ease forwards';
                setTimeout(() => notification.remove(), 500);
            }, 4000);
        }

        // ============ OYUN DURUMU ============
        // Veri değişkenleri artık js/data-loader.js'de tanımlı (lazy loading için)
        // kelimeBulData, ayetOkuData, duaData, hadisData global olarak erişilebilir
        
        let currentQuestion = null;
        let currentAyetIndex = 0;
        let currentDuaIndex = 0;
        let currentHadisIndex = 0;
        
        // Cevap pozisyon takibi (tahmin edilmesini zorlaştırmak için)
        let recentAnswerPositions = []; // Son 10 sorunun doğru cevap pozisyonları
        const MAX_POSITION_HISTORY = 10;
        
        // Ses kontrolü için
        let currentAudio = null;

        // Arapça karakter tespiti için yardımcı fonksiyon
        function isArabic(text) {
            const arabicRegex = /[\u0600-\u06FF]/;
            return arabicRegex.test(text);
        }
        
        // Kelime Çevir oyunu için
        let kelimeCevirScore = 0;
        let kelimeCevirCorrect = 0;
        let kelimeCevirWrong = 0;
        
        // Dinle ve Bul oyunu için
        let dinleScore = 0;
        let dinleCorrect = 0;
        let dinleWrong = 0;
        
        // Boşluk Doldur oyunu için
        let boslukScore = 0;
        let boslukCorrect = 0;
        let boslukWrong = 0;
        
        // GLOBAL (KALICI) PUANLAR
        let totalPoints = 0;  // Toplam oyun puanı (kalıcı)
        let starPoints = 0;   // Yıldız puanı (her 500 puan = 1 yıldız)
        let level = 1;        // Global seviye

        // ROZET SİSTEMİ
        let badges = {
            bronze: 0,   // Bronz rozetler (5 yıldız = 1 bronz)
            silver: 0,   // Gümüş rozetler (5 bronz = 1 gümüş)
            gold: 0,     // Altın rozetler (5 gümüş = 1 altın)
            diamond: 0   // Elmas rozetler (5 altın = 1 elmas)
        };

        // STREAK SİSTEMİ (GÜNLİK TAKİP)
        let streakData = {
            currentStreak: 0,    // Mevcut ardışık gün sayısı
            bestStreak: 0,       // En iyi streak rekoru
            lastPlayDate: '',    // Son oyun oynanan tarih (YYYY-MM-DD)
            totalPlayDays: 0,    // Toplam oyun oynanan gün sayısı
            dailyGoal: 5,        // Günlük hedef (doğru cevap sayısı)
            todayProgress: 0,    // Bugünkü ilerleme
            todayDate: '',       // Bugünün tarihi
            playDates: []        // Oyun oynanan tarihler listesi
        };

        // GÜNLİK GÖREVLER SİSTEMİ
        let dailyTasks = {
            lastTaskDate: '',    // Son görev yenileme tarihi
            tasks: [],           // Günlük görevler listesi
            bonusTasks: [],      // Bonus görevler listesi
            completedTasks: [],  // Tamamlanan görevler
            rewardsClaimed: false, // Ödül toplandı mı?
            todayStats: {        // Bugünkü oyun istatistikleri
                kelimeCevir: 0,
                dinleBul: 0,
                boslukDoldur: 0,
                ayetOku: 0,
                duaOgre: 0,
                hadisOku: 0,
                toplamDogru: 0,
                toplamYanlis: 0,  // Bugünkü toplam yanlış cevap sayısı
                toplamPuan: 0,
                perfectStreak: 0,
                farklıZorluk: new Set()
            }
        };
        
        // Global erişim için (bildirim sistemi için)
        window.dailyTasks = dailyTasks;

        // SESSION (OYUN İÇİ) PUANLAR
        let sessionScore = 0;     // Bu oyunun puanı
        let sessionCorrect = 0;   // Bu oyunun doğru sayısı
        let sessionWrong = 0;     // Bu oyunun yanlış sayısı
        let comboCount = 0;       // Üst üste doğru sayısı (combo)

        // ESKI DEĞİŞKENLER (Geriye uyumluluk için)
        let score = 0;
        let correct = 0;
        let wrong = 0;
        let questionCount = 0;
        let currentMode = CONFIG.defaultMode;
        let currentDifficulty = CONFIG.defaultDifficulty;
        
    log.debug('Session değişkenleri başlatıldı:', {sessionScore, sessionCorrect, sessionWrong});
    log.debug(`🏁 Varsayılan zorluk seviyesi: ${currentDifficulty}`);
        let lives = 0;
        let timer = null;
        let timeLeft = 0;

        // ============ DOM ELEMANLARI ============
        const elements = {
            // Ana menü
            mainMenu: document.getElementById('mainMenu'),
            kelimeCevirBtn: document.getElementById('kelimeCevirBtn'),
            dinleBulBtn: document.getElementById('dinleBulBtn'),
            boslukDoldurBtn: document.getElementById('boslukDoldurBtn'),
            duaEtBtn: document.getElementById('duaEtBtn'),
            ayetOkuBtn: document.getElementById('ayetOkuBtn'),
            hadisOkuBtn: document.getElementById('hadisOkuBtn'),
            
            // Kelime oyunu
            score: document.getElementById('score'),
            // level: document.getElementById('level'), // Kaldırıldı - Mertebe artık gösterilmiyor
            correct: document.getElementById('correct'),
            wrong: document.getElementById('wrong'),
            progressBar: document.getElementById('progressBar'),
            sureInfo: document.getElementById('sureInfo'),
            arabicWord: document.getElementById('arabicWord'),
            audioBtn: document.getElementById('audioBtn'),
            hintBtn: document.getElementById('hintBtn'),
            options: document.getElementById('options'),
            feedback: document.getElementById('feedback'),
            nextBtn: document.getElementById('nextBtn'),
            difficulty: document.getElementById('difficulty'),
            modal: document.getElementById('modal'),
            newLevel: document.getElementById('newLevel'),
            modalBtn: document.getElementById('modalBtn'),
            modeSelector: document.getElementById('modeSelector'),
            gameScreen: document.getElementById('gameScreen'),
            settingsBtn: document.getElementById('settingsBtn'),
            startBtn: document.getElementById('startBtn'),
            modeButtons: document.getElementById('modeButtons'),
            difficultyButtons: document.getElementById('difficultyButtons'),
            lives: document.getElementById('lives'),
            livesDisplay: document.getElementById('livesDisplay'),
            timer: document.getElementById('timer'),
            timerDisplay: document.getElementById('timerDisplay'),
            currentMode: document.getElementById('currentMode'),
            gameOverModal: document.getElementById('gameOverModal'),
            gameOverTitle: document.getElementById('gameOverTitle'),
            gameOverText: document.getElementById('gameOverText'),
            finalScore: document.getElementById('finalScore'),
            restartBtn: document.getElementById('restartBtn'),
            backToMenuBtn: document.getElementById('backToMenuBtn'),
            backFromGameBtn: document.getElementById('backFromGameBtn'),
            
            // Ayet modu
            ayetMode: document.getElementById('ayetMode'),
            ayetSureInfo: document.getElementById('ayetSureInfo'),
            ayetArabic: document.getElementById('ayetArabic'),
            ayetTranslation: document.getElementById('ayetTranslation'),
            ayetAudioBtn: document.getElementById('ayetAudioBtn'),
            prevAyetBtn: document.getElementById('prevAyetBtn'),
            nextAyetBtn: document.getElementById('nextAyetBtn'),
            backFromAyetBtn: document.getElementById('backFromAyetBtn'),
            
            // Dua modu
            duaMode: document.getElementById('duaMode'),
            duaSureInfo: document.getElementById('duaSureInfo'),
            duaArabic: document.getElementById('duaArabic'),
            duaTranslation: document.getElementById('duaTranslation'),
            duaAudioBtn: document.getElementById('duaAudioBtn'),
            prevDuaBtn: document.getElementById('prevDuaBtn'),
            nextDuaBtn: document.getElementById('nextDuaBtn'),
            backFromDuaBtn: document.getElementById('backFromDuaBtn'),
            
            // Hadis modu
            hadisMode: document.getElementById('hadisMode'),
            hadisCategory: document.getElementById('hadisCategory'),
            hadisTitle: document.getElementById('hadisTitle'),
            hadisHeader: document.getElementById('hadisHeader'),
            hadisText: document.getElementById('hadisText'),
            hadisRef: document.getElementById('hadisRef'),
            prevHadisBtn: document.getElementById('prevHadisBtn'),
            nextHadisBtn: document.getElementById('nextHadisBtn'),
            backFromHadisBtn: document.getElementById('backFromHadisBtn'),
            
            // Boşluk Doldur modu
            boslukMode: document.getElementById('boslukMode'),
            boslukSureInfo: document.getElementById('boslukSureInfo'),
            boslukAyetText: document.getElementById('boslukAyetText'),
            boslukAudioBtn: document.getElementById('boslukAudioBtn'),
            boslukOptions: document.getElementById('boslukOptions'),
            boslukFeedback: document.getElementById('boslukFeedback'),
            boslukNextBtn: document.getElementById('boslukNextBtn'),
            boslukScore: document.getElementById('boslukScore'),
            boslukCorrect: document.getElementById('boslukCorrect'),
            boslukWrong: document.getElementById('boslukWrong'),
            backFromBoslukBtn: document.getElementById('backFromBoslukBtn'),
            
            // Dinle ve Bul modu
            dinleMode: document.getElementById('dinleMode'),
            dinleSureInfo: document.getElementById('dinleSureInfo'),
            dinleAudioBtn: document.getElementById('dinleAudioBtn'),
            dinleOptions: document.getElementById('dinleOptions'),
            dinleFeedback: document.getElementById('dinleFeedback'),
            dinleNextBtn: document.getElementById('dinleNextBtn'),
            dinleScore: document.getElementById('dinleScore'),
            dinleCorrect: document.getElementById('dinleCorrect'),
            dinleWrong: document.getElementById('dinleWrong'),
            backFromDinleBtn: document.getElementById('backFromDinleBtn')
        };
        
        // ============ KRİTİK: NULL KONTROL - EKSIK ELEMENTLER ============
        function checkElements() {
            const missing = [];
            const critical = ['mainMenu', 'kelimeCevirBtn', 'dinleBulBtn', 'boslukDoldurBtn', 
                            'ayetOkuBtn', 'gameScreen', 'modeSelector'];
            
            for (const [key, value] of Object.entries(elements)) {
                if (!value) {
                    missing.push(key);
                    if (critical.includes(key)) {
                        log.error(`❌ KRİTİK: '${key}' elementi bulunamadı!`);
                    }
                }
            }
            
            if (missing.length > 0) {
                log.warn('⚠️ Eksik elementler:', missing.join(', '));
            }
            
            return missing.length === 0;
        }

        // ============ SES DURDURMA FONKSİYONU ============
        function stopCurrentAudio() {
            if (currentAudio) {
                log.audio('⏹️ Mevcut ses durduruluyor:', {
                    paused: currentAudio.paused,
                    currentTime: currentAudio.currentTime,
                    duration: currentAudio.duration,
                    src: currentAudio.src
                });
                
                if (!currentAudio.paused) {
                    currentAudio.pause();
                    log.audio('⏸️ Ses durduruldu');
                }
                
                // Event listener'ları comprehensive cleanup
                cleanupAudioListeners();
                log.audio('🧹 Event listenerlar temizlendi');
                
                currentAudio.currentTime = 0;
                log.audio('🔄 Ses başa sarıldı');
                currentAudio = null;
                log.audio('🗑️ Audio object temizlendi');
            } else {
                log.audio('ℹ️ Durduracak ses yok');
            }
        }

        // ============ SES ÇALMA FONKSİYONU ============
        function cleanupAudioListeners() {
            // Tüm audio event listener'larını temizle (memory leak önleme)
            if (currentAudio) {
                try {
                    currentAudio.onloadeddata = null;
                    currentAudio.oncanplay = null;
                    currentAudio.onended = null;
                    currentAudio.onerror = null;
                    currentAudio.ontimeupdate = null;
                    currentAudio.onpause = null;
                    currentAudio.onplay = null;
                    currentAudio.onloadstart = null;
                    // Also remove addEventListener if used
                    if (currentAudio.removeEventListener) {
                        currentAudio.removeEventListener('loadeddata', () => {});
                        currentAudio.removeEventListener('canplay', () => {});
                        currentAudio.removeEventListener('ended', () => {});
                        currentAudio.removeEventListener('error', () => {});
                        currentAudio.removeEventListener('timeupdate', () => {});
                    }
                } catch (e) {
                    log.debug('Audio cleanup warning:', e);
                }
            }
        }


// Navigasyon bar'ı gizle/göster fonksiyonları
function hideBottomNavBar() {
    const bottomNavBar = document.getElementById('bottomNavBar');
    if (bottomNavBar) {
        bottomNavBar.style.display = 'none';
    }
}

function showBottomNavBar() {
    const bottomNavBar = document.getElementById('bottomNavBar');
    if (bottomNavBar) {
        bottomNavBar.style.display = 'flex';
    }
}

function hideAllGameScreens() {
    const screens = [
        'kelimeCevirScreen',
        'dinleBulScreen',
        'boslukDoldurScreen',
        'ayetOkuScreen',
        'hadisOkuScreen',
        'duaOgrenScreen'
    ];

    screens.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });
}

// Global olarak erişilebilir yap
window.hideAllGameScreens = hideAllGameScreens;

// Tüm modalları kapat
function closeAllModals() {
    const modals = ['statsModal', 'badgesModal', 'calendarModal', 'dailyTasksModal', 'onboardingModal', 'dailyGoalModal', 'xpInfoModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            modal.style.zIndex = '';
        }
    });
    // Body scroll'u tekrar aktif et
    document.body.style.overflow = '';
}

// Global olarak erişilebilir yap
window.closeAllModals = closeAllModals;




        // Hide all mode containers so only the requested mode is visible
        function hideAllModes() {
            // Tüm oyun modlarını ve ekranları gizle (mainMenu hariç)
            const modeKeys = ['dinleMode','hadisMode','boslukMode','ayetMode','duaMode','modeSelector','gameScreen'];
            modeKeys.forEach(k => {
                try {
                    const el = elements[k];
                    if (el && el.style) {
                        el.style.display = 'none';
                        // Z-index'i de sıfırla (ekranların üst üste binmesini önle)
                        el.style.zIndex = '';
                    }
                } catch (e) {
                    // ignore missing elements
                }
            });
            
            // Tüm game screen container'larını da gizle
            const screenIds = ['kelimeCevirScreen', 'dinleBulScreen', 'boslukDoldurScreen', 'ayetOkuScreen', 'hadisOkuScreen', 'duaOgrenScreen'];
            screenIds.forEach(screenId => {
                try {
                    const screen = document.getElementById(screenId);
                    if (screen && screen.style) {
                        screen.style.display = 'none';
                        screen.style.zIndex = '';
                    }
                } catch (e) {
                    // ignore missing elements
                }
            });
            
            // Tüm modal'ları da gizle
            const modals = ['statsModal', 'badgesModal', 'calendarModal', 'dailyTasksModal', 'onboardingModal', 'dailyGoalModal', 'xpInfoModal'];
            modals.forEach(modalId => {
                try {
                    const modal = document.getElementById(modalId);
                    if (modal && modal.style) {
                        modal.style.display = 'none';
                        modal.style.zIndex = '';
                    }
                } catch (e) {
                    // ignore missing elements
                }
            });
        }
        
        function playAudio(audioUrl, button) {
            // Eğer ses çalıyorsa durdur
            stopCurrentAudio();
            
            if (!audioUrl) {
                log.error('Ses dosyası bulunamadı');
                if (button) button.disabled = false;
                return;
            }
            
            // URL doğrulama
            if (!audioUrl.startsWith('http://') && !audioUrl.startsWith('https://') && !audioUrl.startsWith('data:')) {
                log.error('Geçersiz ses URL formatı:', audioUrl);
                if (button) button.disabled = false;
                return;
            }
            
            // Butonu devre dışı bırak
            if (button) button.disabled = true;
            
            try {
                currentAudio = new Audio(audioUrl);
                
                // Ses yüklendiğinde çal
                currentAudio.addEventListener('loadeddata', () => {
                    currentAudio.play().catch(err => {
                        log.error('Ses çalma hatası:', err);
                        log.error('Ses URL:', audioUrl);
                        if (button) button.disabled = false;
                        cleanupAudioListeners();
                        currentAudio = null;
                    });
                });
                
                // Ses bittiğinde butonu aktif et ve cleanup
                currentAudio.onended = () => {
                        if (button) button.disabled = false;
                        cleanupAudioListeners();
                        if (currentAudio) {
                            currentAudio = null;
                        }
                    };
                    
                    // Hata durumunda cleanup
                    currentAudio.onerror = (e) => {
                        log.error('Ses dosyası yüklenemedi:', audioUrl);
                        log.error('Hata kodu:', currentAudio.error?.code);
                        log.error('Hata mesajı:', currentAudio.error?.message);
                        if (button) button.disabled = false;
                        cleanupAudioListeners();
                        if (currentAudio) {
                            currentAudio = null;
                        }
                    };
                
                // Ses dosyasını yükle
                currentAudio.load();
                
            } catch (err) {
                log.error('Audio oluşturma hatası:', err);
                log.error('Ses URL:', audioUrl);
                if (button) button.disabled = false;
                currentAudio = null;
            }
        }

        // ============ NETWORK - FETCH WITH RETRY ============
        async function fetchWithRetry(url, retries = 3, delay = 1000) {
            // JSON yükleme hatalarında otomatik retry
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    log.debug(`📡 Fetch attempt ${i + 1}/${retries} failed for ${url}`);
                    if (i === retries - 1) {
                        // Son deneme de başarısız
                        throw new Error(`Failed to load ${url} after ${retries} attempts: ${error.message}`);
                    }
                    // Retry öncesi bekle (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));
                }
            }
        }





        // ============ VERİ YÜKLEME ============
        // Artık lazy loading kullanılıyor - veriler sadece ihtiyaç duyulduğunda yüklenir
        // loadKelimeData(), loadAyetData(), loadDuaData(), loadHadisData() fonksiyonları
        // js/data-loader.js dosyasında tanımlı
        
        async function loadData() {
            try {
                // Sadece mod seçiciyi ve butonları başlat
                // Veriler lazy loading ile yüklenecek
                initModeSelector();
                initMainMenuDifficultyButtons();
                
            } catch (error) {
                log.error('Veri yükleme hatası:', error);
                // NULL KONTROL - mainMenu varsa hata mesajı göster
                if (elements.mainMenu) {
                    elements.mainMenu.innerHTML = '<p style="color: red; text-align: center;">Veriler yüklenemedi!</p>';
                } else {
                    log.error('❌ KRİTİK: mainMenu elementi bulunamadı!');
                }
            }
        }

        // ============ İNDEXEDDB SİSTEMİ (ÜÇÜNCü TARAF ÇEREZİ SORUNU İÇİN) ============
        let db = null;
        
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('HaseneGameDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('gameData')) {
                        db.createObjectStore('gameData');
                    }
                };
            });
        }
        
        function saveToIndexedDB(key, value) {
            if (!db) return;
            try {
                const transaction = db.transaction(['gameData'], 'readwrite');
                const store = transaction.objectStore('gameData');
                store.put(value, key);
            } catch(e) { log.error('IndexedDB save failed:', e); }
        }
        
        function loadFromIndexedDB(key) {
            return new Promise((resolve) => {
                if (!db) { resolve(null); return; }
                try {
                    const transaction = db.transaction(['gameData'], 'readonly');
                    const store = transaction.objectStore('gameData');
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result || null);
                    request.onerror = () => resolve(null);
                } catch(e) { resolve(null); }
            });
        }

        // URL TABANLI VERİ SAKLAMA (Mobil fallback - hiçbir şey çalışmazsa)
        function saveToURL() {
            const gameData = {
                p: totalPoints, // points
                b: badges.bronze + ',' + badges.silver + ',' + badges.gold + ',' + badges.diamond, // badges
                s: streakData.currentStreak, // streak
                d: getLocalDateString() // date (yerel tarih)
            };
            const encoded = btoa(JSON.stringify(gameData));
            const newUrl = window.location.origin + window.location.pathname + '?data=' + encoded;
            
            // URL'yi geçmişe ekle (geri butonu ile erişilebilir)
            if (window.history.pushState) {
                window.history.pushState({gameData: encoded}, '', newUrl);
            }
            log.debug('🔗 URL\'ye kaydedildi:', totalPoints, 'puan');
        }
        
        function loadFromURL() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const data = urlParams.get('data');
                if (data) {
                    const decoded = JSON.parse(atob(data));
                    totalPoints = parseInt(decoded.p) || 0;
                    
                    // Rozet verilerini yükle
                    if (decoded.b) {
                        const badgeArray = decoded.b.split(',');
                        badges.bronze = parseInt(badgeArray[0]) || 0;
                        badges.silver = parseInt(badgeArray[1]) || 0;
                        badges.gold = parseInt(badgeArray[2]) || 0;
                        badges.diamond = parseInt(badgeArray[3]) || 0;
                    }
                    
                    // Streak verilerini yükle
                    if (decoded.s) {
                        streakData.currentStreak = parseInt(decoded.s) || 0;
                    }
                    
                    log.debug('🔗 URL\'den yüklendi:', totalPoints, 'puan');
                    return true;
                }
            } catch(e) {
                log.error('URL yükleme hatası:', e);
            }
            return false;
        }

        // ============ İSTATİSTİK BAR FONKSİYONLARI ============
        async function loadStats() {
            try {
                // IndexedDB'den yükle (üçüncü taraf çerez sorunu için)
                const savedPoints = await loadFromIndexedDB('hasene_totalPoints');
                const savedBadges = await loadFromIndexedDB('hasene_badges');
                const savedStreak = await loadFromIndexedDB('hasene_streak');
                const savedTasks = await loadFromIndexedDB('hasene_dailyTasks');
                
                // Puanları yükle (IndexedDB öncelikli, localStorage yedek)
                totalPoints = parseInt(savedPoints || localStorage.getItem('hasene_totalPoints') || '0');
                starPoints = Math.floor(totalPoints / 100);
                level = calculateLevel(totalPoints);
                
                log.debug('📊 IndexedDB yüklendi:', {totalPoints, savedPoints});
            } catch (error) {
                log.debug('IndexedDB hatası, localStorage denenecek:', error);
                try {
                    // localStorage dene
                    totalPoints = parseInt(localStorage.getItem('hasene_totalPoints') || '0');
                    starPoints = Math.floor(totalPoints / 100);
                    level = calculateLevel(totalPoints);
                    log.debug('📊 localStorage yüklendi:', totalPoints);
                } catch (localError) {
                    log.debug('localStorage da çalışmıyor, URL deneniyor:', localError);
                    // Son çare: URL'den yükle
                    const urlLoaded = loadFromURL();
                    if (urlLoaded) {
                        starPoints = Math.floor(totalPoints / 100);
                        level = calculateLevel(totalPoints);
                    } else {
                        // Hiçbir şey çalışmıyor, varsayılan değerler
                        totalPoints = 0;
                        starPoints = 0;
                        level = 1;
                        log.warn('⚠️ Hiçbir veri sistemi çalışmıyor, sıfırdan başlatılıyor');
                    }
                }
            }
            
            // Rozet sistemi yükle (IndexedDB öncelikli)
            const savedBadgesIndexedDB = await loadFromIndexedDB('hasene_badges');
            const savedBadgesData = savedBadgesIndexedDB || localStorage.getItem('hasene_badges');
            if (savedBadgesData) {
                badges = JSON.parse(typeof savedBadgesData === 'string' ? savedBadgesData : JSON.stringify(savedBadgesData));
            }
            
            // Streak sistemi yükle (IndexedDB öncelikli)
            const savedStreakIndexedDB = await loadFromIndexedDB('hasene_streak');
            const savedStreak = savedStreakIndexedDB || localStorage.getItem('hasene_streak');
            if (savedStreak) {
                streakData = { ...streakData, ...JSON.parse(typeof savedStreak === 'string' ? savedStreak : JSON.stringify(savedStreak)) };
            }
            
            // Günlük görevler yükle (IndexedDB öncelikli) - BU ÇOOK ÖNEMLİ!
            const savedTasksIndexedDB = await loadFromIndexedDB('hasene_dailyTasks');
            const savedTasks = savedTasksIndexedDB || localStorage.getItem('hasene_dailyTasks');
            if (savedTasks) {
                dailyTasks = { ...dailyTasks, ...JSON.parse(typeof savedTasks === 'string' ? savedTasks : JSON.stringify(savedTasks)) };
                window.dailyTasks = dailyTasks; // Global erişim için güncelle
                // Set nesnelerini yeniden oluştur
                dailyTasks.todayStats.farklıZorluk = new Set(dailyTasks.todayStats.farklıZorluk || []);
            }
            
            // Oyun ayarları yükle (currentMode ve currentDifficulty) - ÇOOK ÖNEMLİ!
            const savedModeIndexedDB = await loadFromIndexedDB('hasene_currentMode');
            const savedMode = savedModeIndexedDB || localStorage.getItem('hasene_currentMode');
            if (savedMode && CONFIG.gameModes[savedMode]) {
                currentMode = savedMode;
                log.debug(`🎮 Kaydedilen mod yüklendi: ${currentMode}`);
            }
            
            const savedDifficultyIndexedDB = await loadFromIndexedDB('hasene_currentDifficulty');
            const savedDifficulty = savedDifficultyIndexedDB || localStorage.getItem('hasene_currentDifficulty');
            if (savedDifficulty && CONFIG.difficultyLevels[savedDifficulty]) {
                currentDifficulty = savedDifficulty;
                log.debug(`🎯 Kaydedilen zorluk yüklendi: ${currentDifficulty}`);
            }
            
            log.debug('📋 Günlük görevler yüklendi:', {
                completedTasks: dailyTasks.completedTasks.length,
                todayStats: dailyTasks.todayStats,
                lastTaskDate: dailyTasks.lastTaskDate
            });
            
            log.debug('🎮 Oyun ayarları yüklendi:', {
                currentMode: currentMode,
                currentDifficulty: currentDifficulty
            });
            
            // Günlük kontrol
            checkDailyProgress();
            checkDailyTasks(); // Bu fonksiyon içinde zaten updateTasksDisplay() çağrılıyor
        }

        // Daha zorlu seviye hesaplama sistemi
        function calculateLevel(points) {
            if (points < 1000) return 1;        // Level 1: 0-999 puan
            if (points < 2500) return 2;        // Level 2: 1000-2499 puan  
            if (points < 5000) return 3;        // Level 3: 2500-4999 puan
            if (points < 8500) return 4;        // Level 4: 5000-8499 puan
            if (points < 13000) return 5;       // Level 5: 8500-12999 puan
            if (points < 19000) return 6;       // Level 6: 13000-18999 puan
            if (points < 26500) return 7;       // Level 7: 19000-26499 puan
            if (points < 35500) return 8;       // Level 8: 26500-35499 puan
            if (points < 46000) return 9;       // Level 9: 35500-45999 puan
            if (points < 58000) return 10;      // Level 10: 46000-57999 puan
            
            // Level 10'dan sonra her seviye için 15000 puan artış
            const afterLevel10 = points - 58000;
            return 10 + Math.floor(afterLevel10 / 15000) + 1;
        }

        // Bir sonraki seviye için gereken puan
        function getNextLevelRequiredPoints(currentLevel) {
            const levelThresholds = [0, 1000, 2500, 5000, 8500, 13000, 19000, 26500, 35500, 46000, 58000];
            
            // currentLevel 1-10 arasındaysa threshold'u döndür
            if (currentLevel >= 1 && currentLevel <= 10) {
                return levelThresholds[currentLevel];
            }
            
            // Level 10'dan sonra - her seviye için 15000 puan artış
            if (currentLevel > 10) {
                return 58000 + ((currentLevel - 10) * 15000);
            }
            
            // Level 0 veya geçersiz değerler için
            return levelThresholds[1]; // Level 1 threshold'u
        }

        async function saveStats() {
            try {
                // ÇOKLU KAYDETME SİSTEMİ (Üçüncü taraf çerez sorunu için)
                
                // 1. IndexedDB (ana sistem - çerez engellemelerinden etkilenmez)
                if (db) {
                    saveToIndexedDB('hasene_totalPoints', totalPoints.toString());
                    saveToIndexedDB('hasene_badges', JSON.stringify(badges));
                    saveToIndexedDB('hasene_streak', JSON.stringify(streakData));
                    
                    const tasksToSave = { 
                        ...dailyTasks, 
                        todayStats: {
                            ...dailyTasks.todayStats,
                            farklıZorluk: Array.from(dailyTasks.todayStats.farklıZorluk)
                        }
                    };
                    saveToIndexedDB('hasene_dailyTasks', JSON.stringify(tasksToSave));
                    
                    // Oyun ayarları da kaydet (currentMode & currentDifficulty) - KRİTİK!
                    saveToIndexedDB('hasene_currentMode', currentMode);
                    saveToIndexedDB('hasene_currentDifficulty', currentDifficulty);
                }
                
                // 2. localStorage (yedek sistem)
                try {
                    localStorage.setItem('hasene_totalPoints', totalPoints.toString());
                    localStorage.setItem('hasene_badges', JSON.stringify(badges));
                    localStorage.setItem('hasene_streak', JSON.stringify(streakData));
                    
                    // GÜNLÜK GÖREVLER de localStorage'a kaydet (kritik!)
                    const tasksToSave = { 
                        ...dailyTasks, 
                        todayStats: {
                            ...dailyTasks.todayStats,
                            farklıZorluk: Array.from(dailyTasks.todayStats.farklıZorluk)
                        }
                    };
                    localStorage.setItem('hasene_dailyTasks', JSON.stringify(tasksToSave));
                    
                    // Oyun ayarları da localStorage'a kaydet - KRİTİK!
                    localStorage.setItem('hasene_currentMode', currentMode);
                    localStorage.setItem('hasene_currentDifficulty', currentDifficulty);
                } catch(e) { log.error('localStorage failed:', e); }
                
                // 3. URL sistemi (son çare - mobil için)
                try {
                    saveToURL();
                } catch(e) { log.error('URL save failed:', e); }
                
                // 4. Hedef tamamlama bildirimi kontrolü
                if (typeof checkGoalCompletion === 'function') {
                    checkGoalCompletion();
                }
                
                log.debug('💾 ÜÇLÜ KORUMA: IndexedDB + localStorage + URL ile kaydedildi!', totalPoints);
                
            } catch (error) {
                log.error('❌ Kaydetme hatası:', error);
            }
        }

        function resetAllStats() {
    // =========================================
    // 🔥 TEMEL SKORLAR
    // =========================================
    totalPoints = 0;
    starPoints = 0;
    level = 1;
    sessionScore = 0;
    sessionCorrect = 0;
    sessionWrong = 0;
    comboCount = 0;

    // Rozetleri sıfırla
    badges = { bronze: 0, silver: 0, gold: 0, diamond: 0 };

    // =========================================
    // 🔥 ACHIEVEMENT SİSTEMİ SIFIRLA
    // =========================================
    localStorage.removeItem('unlockedAchievements');

    // =========================================
    // 🔥 STREAK + GÜNLÜK HEDEF SIFIRLA
    // =========================================
    streakData = {
        currentStreak: 0,
        playDates: [],
        dailyGoal: 5,
        dailyCorrect: 0
    };

    // =========================================
    // 🔥 DAILY TASKS SIFIRLA
    // =========================================
    dailyTasks = {
        lastTaskDate: null,
        tasks: [],
        bonusTasks: [],
        completedTasks: [],
        rewardsClaimed: false,
        todayStats: {
            kelimeCevir: 0,
            dinleBul: 0,
            boslukDoldur: 0,
            ayetOku: 0,
            duaOgre: 0,
            hadisOku: 0,
            toplamDogru: 0,
            toplamYanlis: 0,
            toplamPuan: 0,
            perfectStreak: 0,
            farklıZorluk: new Set()
        }
    };
    window.dailyTasks = dailyTasks; // Global erişim için güncelle

    // ================================
// 🔥 GÜNLÜK HEDEF (DAILY GOAL) TAM SIFIRLA
// ================================
localStorage.setItem("dailyGoalHasene", "2700");  // hedef sıfır → 2700 varsayılan
localStorage.setItem("dailyHasene", "0");         // günlük kazanılan XP sıfır
localStorage.setItem("dailyGoalLevel", "normal"); // varsayılan zorluk
localStorage.removeItem("lastDailyXPReset");       // reset tarihi temizle

// UI Güncelle → Barları sıfırla
const bar = document.getElementById("dailyGoalProgress");
const barText = document.getElementById("dailyGoalProgressText");
const goalText = document.getElementById("dailyGoalText");

if (bar) bar.style.width = "0%";
if (barText) barText.textContent = `0 / 2700 Hasene`;
if (goalText) goalText.textContent = `Günlük Vird: 2700 Hasene`;

    // Her 1 hedeften 540 XP geliyorsa — dilersen değiştir

    // =========================================
    // 🔥 INDEXED DB TEMİZLE
    // =========================================
    if (db) {
        try {
            const transaction = db.transaction(['gameData'], 'readwrite');
            const store = transaction.objectStore('gameData');
            store.clear();
            log.debug('🗑️ IndexedDB temizlendi');
        } catch(e) {
            log.error('IndexedDB temizleme hatası:', e);
        }
    }

    // =========================================
    // 🔥 LOCAL STORAGE TEMİZLE
    // =========================================
    localStorage.removeItem('hasene_totalPoints');
    localStorage.removeItem('hasene_badges');
    localStorage.removeItem('hasene_streak');
    localStorage.removeItem('hasene_dailyTasks');
    localStorage.removeItem('hasene_currentMode');
    localStorage.removeItem('hasene_currentDifficulty');
    localStorage.removeItem('hasene_wordStats');
    localStorage.removeItem('dailyXP');
    localStorage.removeItem('unlockedAchievements'); // Achievement sistemini de sıfırla

    // =========================================
    // 🔥 URL GEÇMİŞ TEMİZLE
    // =========================================
    try {
        if (window.history.replaceState) {
            window.history.replaceState({}, '', window.location.pathname);
        }
    } catch(e) {
        // URL temizleme hatası kritik değil, sessizce geç
        log.debug('URL geçmiş temizleme hatası (kritik değil):', e);
    }

    // =========================================
    // 🔥 YENİ DAILY TASK ÜRET
    // =========================================
    generateDailyTasks(getLocalDateString());

    // =========================================
    // 🔥 UI GÜNCELLE - TÜM İSTATİSTİK ALANLARI
    // =========================================
    
    // Üst bar güncelle
    updateStatsBar();
    updateUI();
    if (typeof updateDailyGoalDisplay === "function") {
        updateDailyGoalDisplay();
    }

    // İstatistikler Modal - Genel Özet
    const statsLevelEl = document.getElementById('statsLevel');
    const statsPointsEl = document.getElementById('statsPoints');
    const statsStarsEl = document.getElementById('statsStars');
    if (statsLevelEl) statsLevelEl.textContent = '1';
    if (statsPointsEl) statsPointsEl.textContent = '0';
    if (statsStarsEl) statsStarsEl.textContent = '0';

    // İstatistikler Modal - Seviye İlerleme Barı
    const statsCurrentLevelEl = document.getElementById('statsCurrentLevel');
    const statsNextLevelEl = document.getElementById('statsNextLevel');
    const statsLevelProgressEl = document.getElementById('statsLevelProgress');
    const statsLevelPointsNeededEl = document.getElementById('statsLevelPointsNeeded');
    if (statsCurrentLevelEl) statsCurrentLevelEl.textContent = '1';
    if (statsNextLevelEl) statsNextLevelEl.textContent = '2';
    if (statsLevelProgressEl) statsLevelProgressEl.style.width = '0%';
    if (statsLevelPointsNeededEl) statsLevelPointsNeededEl.textContent = '1,000';

    // İstatistikler Modal - Rozet Sistemi
    const statsBronzeEl = document.getElementById('statsBronze');
    const statsSilverEl = document.getElementById('statsSilver');
    const statsGoldEl = document.getElementById('statsGold');
    const statsDiamondEl = document.getElementById('statsDiamond');
    if (statsBronzeEl) statsBronzeEl.textContent = '0';
    if (statsSilverEl) statsSilverEl.textContent = '0';
    if (statsGoldEl) statsGoldEl.textContent = '0';
    if (statsDiamondEl) statsDiamondEl.textContent = '0';

    // Başarılar Modal - Mertebe Rozetleri
    const diamondBadgeCountEl = document.getElementById('diamondBadgeCount');
    const goldBadgeCountEl = document.getElementById('goldBadgeCount');
    const silverBadgeCountEl = document.getElementById('silverBadgeCount');
    const bronzeBadgeCountEl = document.getElementById('bronzeBadgeCount');
    if (diamondBadgeCountEl) diamondBadgeCountEl.textContent = '0';
    if (goldBadgeCountEl) goldBadgeCountEl.textContent = '0';
    if (silverBadgeCountEl) silverBadgeCountEl.textContent = '0';
    if (bronzeBadgeCountEl) bronzeBadgeCountEl.textContent = '0';

    // İstatistikler Modal - Başarı Analizi
    const statsSuccessRateEl = document.getElementById('statsSuccessRate');
    const statsAvgPointsPerDayEl = document.getElementById('statsAvgPointsPerDay');
    const statsPlayConsistencyEl = document.getElementById('statsPlayConsistency');
    const statsLevelProgressTextEl = document.getElementById('statsLevelProgressText');
    if (statsSuccessRateEl) statsSuccessRateEl.textContent = '0%';
    if (statsAvgPointsPerDayEl) statsAvgPointsPerDayEl.textContent = '0';
    if (statsPlayConsistencyEl) statsPlayConsistencyEl.textContent = '0%';
    if (statsLevelProgressTextEl) statsLevelProgressTextEl.textContent = '0%';

    // İstatistikler Modal - Muvazebet İstatistikleri
    const statsCurrentStreakEl = document.getElementById('statsCurrentStreak');
    const statsBestStreakEl = document.getElementById('statsBestStreak');
    const statsTotalDaysEl = document.getElementById('statsTotalDays');
    const statsTodayProgressEl = document.getElementById('statsTodayProgress');
    if (statsCurrentStreakEl) statsCurrentStreakEl.textContent = '0';
    if (statsBestStreakEl) statsBestStreakEl.textContent = '0';
    if (statsTotalDaysEl) statsTotalDaysEl.textContent = '0';
    if (statsTodayProgressEl) statsTodayProgressEl.textContent = '0';

    // İstatistikler Modal - Oyun Türü İstatistikleri
    const statsKelimeCevirEl = document.getElementById('statsKelimeCevir');
    const statsDinleBulEl = document.getElementById('statsDinleBul');
    const statsBoslukDoldurEl = document.getElementById('statsBoslukDoldur');
    const statsAyetOkuEl = document.getElementById('statsAyetOku');
    const statsDuaOgreEl = document.getElementById('statsDuaOgre');
    const statsHadisOkuEl = document.getElementById('statsHadisOku');
    if (statsKelimeCevirEl) statsKelimeCevirEl.textContent = '0';
    if (statsDinleBulEl) statsDinleBulEl.textContent = '0';
    if (statsBoslukDoldurEl) statsBoslukDoldurEl.textContent = '0';
    if (statsAyetOkuEl) statsAyetOkuEl.textContent = '0';
    if (statsDuaOgreEl) statsDuaOgreEl.textContent = '0';
    if (statsHadisOkuEl) statsHadisOkuEl.textContent = '0';

    // İstatistikler Modal - Bugünkü Performans
    const statsTodayCorrectEl = document.getElementById('statsTodayCorrect');
    const statsTodayPointsEl = document.getElementById('statsTodayPoints');
    const statsPerfectStreakEl = document.getElementById('statsPerfectStreak');
    const statsDifficultyCountEl = document.getElementById('statsDifficultyCount');
    if (statsTodayCorrectEl) statsTodayCorrectEl.textContent = '0';
    if (statsTodayPointsEl) statsTodayPointsEl.textContent = '0';
    if (statsPerfectStreakEl) statsPerfectStreakEl.textContent = '0';
    if (statsDifficultyCountEl) statsDifficultyCountEl.textContent = '0';

    // İstatistikler Modal - Kelime İstatistikleri
    const wordStatsTotalEl = document.getElementById('wordStatsTotal');
    const wordStatsMasteredEl = document.getElementById('wordStatsMastered');
    const wordStatsStrugglingEl = document.getElementById('wordStatsStruggling');
    if (wordStatsTotalEl) wordStatsTotalEl.textContent = '0';
    if (wordStatsMasteredEl) wordStatsMasteredEl.textContent = '0';
    if (wordStatsStrugglingEl) wordStatsStrugglingEl.textContent = '0';

    // Başarılar Modal - İstatistikler Özeti
    const badgesUnlockedCountEl = document.getElementById('badgesUnlockedCount');
    const badgesTotalCountEl = document.getElementById('badgesTotalCount');
    const badgesProgressPercentEl = document.getElementById('badgesProgressPercent');
    if (badgesUnlockedCountEl) badgesUnlockedCountEl.textContent = '0';
    if (badgesTotalCountEl) badgesTotalCountEl.textContent = '20';
    if (badgesProgressPercentEl) badgesProgressPercentEl.textContent = '0%';

    // Başarılar Modal - Achievement kartlarını manuel olarak sıfırla
    // ÖNEMLİ: Bu işlem updateAllAchievements() çağrılmadan ÖNCE yapılmalı
    const achievementIds = ['first_win', 'combo_master', 'daily_goal', 'streak_7', 'level_5', 'level_10', 'level_20', 'xp_500', 'xp_2000', 'xp_8500', 'xp_25500', 'xp_85000'];
    
    achievementIds.forEach(achId => {
        const card = document.getElementById(`achievement-${achId}`);
        if (!card) return;
        
        const progressFill = card.querySelector('.achievement-progress-fill');
        const progressText = card.querySelector('.progress-text');
        
        // Kartı kilitli duruma getir
        card.classList.add('locked');
        card.classList.remove('unlocked');
        card.style.background = '#f8f9fa';
        card.style.borderColor = 'transparent';
        card.style.opacity = '0.6';
        card.style.filter = 'grayscale(50%)';
        
        // İlerleme barını sıfırla - !important ile zorla
        if (progressFill) {
            // Transition'ı kaldır ki anında sıfırlansın
            const originalTransition = progressFill.style.transition;
            progressFill.style.transition = 'none';
            progressFill.style.setProperty('width', '0%', 'important');
            progressFill.style.background = '#ccc';
            // Sonra transition'ı geri ekle
            setTimeout(() => {
                if (progressFill) {
                    progressFill.style.transition = originalTransition || 'width 0.5s ease';
                }
            }, 50);
        }
        
        // İlerleme metnini sıfırla
        if (progressText) {
            if (achId === 'level_5') {
                progressText.textContent = '0/5';
            } else if (achId === 'level_10') {
                progressText.textContent = '0/10';
            } else if (achId === 'level_20') {
                progressText.textContent = '0/20';
            } else if (achId === 'combo_master') {
                progressText.textContent = '0/5';
            } else if (achId === 'streak_7') {
                progressText.textContent = '0/7';
            } else if (achId === 'daily_goal') {
                progressText.textContent = '0/2700';
            } else if (achId.startsWith('xp_')) {
                const targetXP = parseInt(achId.split('_')[1]);
                progressText.textContent = `0/${targetXP.toLocaleString()}`;
            } else {
                progressText.textContent = 'Kilitli';
            }
            progressText.style.color = '#999';
            progressText.style.fontWeight = 'normal';
        }
    });
    
    // Sıfırlama işaretini localStorage'a kaydet (updateAllAchievements bu işareti kontrol edecek)
    localStorage.setItem('achievementsJustReset', 'true');

    // Takvim Modal - Streak bilgisi
    const calendarStreakCountEl = document.getElementById('calendarStreakCount');
    if (calendarStreakCountEl) calendarStreakCountEl.textContent = '0';

    showCustomAlert("Tüm veriler tamamen sıfırlandı! 🔥", "success");
}


        function updateStatsBar() {
            // NULL KONTROL - Kritik elementler
            const gamePointsEl = document.getElementById('gamePoints');
            const starPointsEl = document.getElementById('starPoints');
            const playerLevelEl = document.getElementById('playerLevel');
            
            if (!gamePointsEl || !starPointsEl || !playerLevelEl) {
                log.error('❌ HATA: Stats bar elementleri bulunamadı!');
                return;
            }
            
            // Üst bar güncelle
            gamePointsEl.textContent = totalPoints;
            
            // Yıldız puanı güncelle (her 100 puana 1 yıldız - sık geri bildirim için)
            starPoints = Math.floor(totalPoints / 100);
            starPointsEl.textContent = starPoints;
            
            // Rozet sistemini güncelle
            updateBadgeSystem();
            
            // Seviye güncelle (yeni hesaplama sistemi)
            level = calculateLevel(totalPoints);
            playerLevelEl.textContent = level;
            
            // Seviye ilerleme çubuğunu güncelle
            let currentLevelStart, nextLevelStart;
            
            if (level === 1) {
                currentLevelStart = 0;
                nextLevelStart = 1000;
            } else if (level <= 10) {
                const thresholds = [0, 1000, 2500, 5000, 8500, 13000, 19000, 26500, 35500, 46000, 58000];
                currentLevelStart = thresholds[level - 1];
                nextLevelStart = thresholds[level];
            } else {
                // Level 10'dan sonra
                currentLevelStart = 58000 + ((level - 11) * 15000);
                nextLevelStart = 58000 + ((level - 10) * 15000);
            }
            
            const currentLevelPoints = totalPoints - currentLevelStart;
            const levelRequiredPoints = nextLevelStart - currentLevelStart;
            const progressPercentage = Math.max(0, Math.min((currentLevelPoints / levelRequiredPoints) * 100, 100));
            
            const levelProgressElement = document.getElementById('levelProgress');
            if (levelProgressElement) {
                levelProgressElement.style.width = progressPercentage + '%';
            }
            
            // Alt bar (oyun içi stats) güncelle
            const scoreElement = document.getElementById('score');
            if (scoreElement) scoreElement.textContent = totalPoints;
            // level elementi artık yok (Mertebe kaldırıldı)
            
            // Kaydet
            saveStats();
            
            // Debug için mevcut değerleri logla
            log.debug('📊 Mevcut İstatistikler:', {
                totalPoints: totalPoints,
                starPoints: starPoints, 
                level: level,
                sessionScore: sessionScore,
                sessionCorrect: sessionCorrect,
                sessionWrong: sessionWrong
            });
        }
        
        // COMBO FONKSİYONLARI
        function updateCombo() {
            const comboIndicator = document.getElementById('comboIndicator');
            const comboCountEl = document.getElementById('comboCount');
            const comboBonusEl = document.getElementById('comboBonus');
            
            // NULL KONTROL
            if (!comboIndicator || !comboCountEl || !comboBonusEl) {
                log.warn('⚠️ Combo elementleri bulunamadı');
                return;
            }
            
            if (comboCount >= 3) {
                const bonusXP = Math.floor(comboCount / 3) * 5;
                comboCountEl.textContent = comboCount;
                comboBonusEl.textContent = bonusXP;
                
                comboIndicator.style.display = 'block';
                comboIndicator.style.animation = 'comboPopIn 0.3s ease, comboShake 0.5s ease 0.3s';
                
                // Her 3 comboda mesaj göster (bonus zaten addSessionPoints'te eklendi)
                if (comboCount % 3 === 0) {
                    // Combo sesi çal
                    playSound('combo');
                    
                    // Bonus mesajı göster
                    setTimeout(() => {
                        showSuccessMessage(`🔥 COMBO x${comboCount}! +${bonusXP} Bonus XP!`);
                    }, 300);
                }
                
                // 3 saniye sonra gizle
                setTimeout(() => {
                    hideCombo();
                }, 3000);
            }
        }
        
        function hideCombo() {
            const comboIndicator = document.getElementById('comboIndicator');
            comboIndicator.style.animation = 'slideUp 0.3s ease';
            setTimeout(() => {
                comboIndicator.style.display = 'none';
            }, 300);
        }

        // SESSION PUAN FONKSİYONLARI
        function addSessionPoints(points) {
            log.game(`💰 === addSessionPoints(${points}) ÇAĞRILDI ===`);
            log.game(`📊 Önce: sessionScore=${sessionScore}, totalPoints=${totalPoints}`);
            
            // Güvenli puan ekleme - NaN kontrolü
            if (typeof points !== 'number' || isNaN(points)) {
                log.error('❌ Geçersiz puan değeri:', points);
                return;
            }
            
            // Session puanlarını güncelle
            sessionScore += points;
            sessionCorrect++;
            
            // Global puanlara da ekle
            totalPoints += points;
            
            // Bugünkü toplam puana da ekle (günlük performans için)
            dailyTasks.todayStats.toplamPuan += points;
            
            // Bugünkü toplam doğru cevap sayısını güncelle
            dailyTasks.todayStats.toplamDogru++;
            
            // Daily XP ekle
            addDailyXP(points);
            
            // Doğru cevap sesi
            playSound('correct');
            
            // Combo sistemi
            comboCount++;
            updateCombo();
            
            // Her 3 doğru cevapda combo bonusu
            if (comboCount > 0 && comboCount % 3 === 0) {
                const comboBonus = 5;
                totalPoints += comboBonus;
                dailyTasks.todayStats.toplamPuan += comboBonus; // Bugünkü puana da ekle!
                
                // COMBO BONUSUNU DAILY XP'YE DE EKLE
                addDailyXP(comboBonus);
                
                log.game(`🔥 Combo bonusu: +${comboBonus} XP`);
                
                // COMBO BONUS SONRASI HEMEN UI GÜNCELLE
                updateStatsBar(); // Üst barı hemen güncelle
            }
            
            // Geriye uyumluluk için eski değişkenleri de güncelle
            score = sessionScore;
            correct = sessionCorrect;
            
            // UI güncelle
            updateUI(); // Oyun içi barı güncelle
            updateStatsBar(); // Üst barı güncelle
            checkAchievements(); // Başarımları kontrol et
            
            log.game(`📊 Sonra: sessionScore=${sessionScore}, totalPoints=${totalPoints}, combo=${comboCount}`);
            log.game(`✅ addSessionPoints tamamlandı!`);
        }

        function addSessionWrong() {
            log.game(`❌ === addSessionWrong() ÇAĞRILDI ===`);
            log.game(`📊 Önce: sessionWrong=${sessionWrong}, wrong=${wrong}`);
            sessionWrong++;
            
            // Bugünkü toplam yanlış cevap sayısını güncelle
            if (dailyTasks && dailyTasks.todayStats) {
                dailyTasks.todayStats.toplamYanlis = (dailyTasks.todayStats.toplamYanlis || 0) + 1;
            }
            
            // Yanlış cevap sesi
            playSound('wrong');
            
            // Combo kır
            if (comboCount > 0) {
                comboCount = 0;
                hideCombo();
            }
            wrong = sessionWrong; // Geriye uyumluluk
            log.debug(`📊 Sonra: sessionWrong=${sessionWrong}, wrong=${wrong}`);
            log.debug(`🎨 updateUI() çağrılıyor...`);
            updateUI();
            log.debug(`✅ addSessionWrong tamamlandı!`);
        }

        // ============ ROZET SİSTEMİ ============
        function updateBadgeSystem() {
            // 🎯 XP BAZLI ROZET SİSTEMİ (1 saat oyun = ~8500 XP)
            // 🥉 Bronz: 2,000 XP = 1 bronz (~15 dk)
            // 🥈 Gümüş: 8,500 XP = 1 gümüş (~1 saat, 1 günlük hedef)
            // 🥇 Altın: 25,500 XP = 1 altın (~3 gün)
            // 💎 Elmas: 85,000 XP = 1 elmas (~10 gün)
            
            const xp = totalPoints;
            const newBronze = Math.floor(xp / 2000);
            const newSilver = Math.floor(xp / 8500);
            const newGold = Math.floor(xp / 25500);
            const newDiamond = Math.floor(xp / 85000);
            
            // Rozet seviye kontrolü ve modal gösterimi (önce en yüksek rozetleri kontrol et)
            if (newDiamond > badges.diamond) {
                badges.diamond = newDiamond;
                showBadgeUpModal('diamond', '💎 Mütebahhir');
                playSound('levelup'); // Elmas çok önemli, levelup sesi çal
            } else if (newGold > badges.gold) {
                badges.gold = newGold;
                showBadgeUpModal('gold', '🥇 Mütecaviz');
                playSound('levelup');
            } else if (newSilver > badges.silver) {
                badges.silver = newSilver;
                showBadgeUpModal('silver', '🥈 Müterakki');
                playSound('correct');
            } else if (newBronze > badges.bronze) {
                badges.bronze = newBronze;
                showBadgeUpModal('bronze', '🥉 Mübtedi');
                playSound('correct');
            }
            
            // Tüm rozet sayılarını güncelle
            badges.bronze = newBronze;
            badges.silver = newSilver;
            badges.gold = newGold;
            badges.diamond = newDiamond;
        }

        function showBadgeUpModal(badgeType, badgeName) {
            // Rozet kazanma modalı - profesyonel UI
            showCustomAlert(`${badgeName} rozeti kazandınız!`, 'success', 'Tebrikler');
        }

        function showBadgesModal() {
            // Önce tüm modalları ve oyun ekranlarını kapat
            closeAllModals();
            if (typeof hideAllGameScreens === 'function') {
                hideAllGameScreens();
            }
            if (typeof hideAllModes === 'function') {
                hideAllModes();
            }
            
            // Touch event'lerini başlat (eğer henüz başlatılmadıysa)
            initBadgesModalTouchEvents();
            
            // Body scroll'u engelle
            document.body.style.overflow = 'hidden';
            
            // Tüm rozet sayılarını güncelle
            const diamondEl = document.getElementById('diamondBadgeCount');
            const goldEl = document.getElementById('goldBadgeCount');
            const silverEl = document.getElementById('silverBadgeCount');
            const bronzeEl = document.getElementById('bronzeBadgeCount');
            
            if (diamondEl) diamondEl.textContent = badges.diamond;
            if (goldEl) goldEl.textContent = badges.gold;
            if (silverEl) silverEl.textContent = badges.silver;
            if (bronzeEl) bronzeEl.textContent = badges.bronze;
            
            // Yeni tasarım için istatistikleri güncelle
            updateBadgesModalStats();
            
            // Tüm achievement'ları güncelle
            updateAllAchievements();
            
            // İlk kategoriyi göster
            showBadgeCategory('daily');
            
            // Modal'ı göster
            document.getElementById('badgesModal').style.display = 'flex';
        }

        // Kategori değiştirme fonksiyonu
        function showBadgeCategory(category, clickedElement) {
            // Tüm sekmeleri ve içerikleri gizle
            document.querySelectorAll('.badge-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'transparent';
                tab.style.color = '#999';
            });
            document.querySelectorAll('.badge-category-content').forEach(content => {
                content.style.display = 'none';
            });

            // Seçilen sekme ve içeriği göster
            const activeTab = clickedElement || document.querySelector(`.badge-tab[onclick*="'${category}'"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                activeTab.style.color = 'white';
            }
            
            const categoryContent = document.getElementById(`badgeCategory${category.charAt(0).toUpperCase() + category.slice(1)}`);
            if (categoryContent) {
                categoryContent.style.display = 'block';
            }
        }

        // Başarılar modal istatistiklerini güncelle
        function updateBadgesModalStats() {
            const unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements')) || [];
            const totalAchievements = 20; // Toplam achievement sayısı
            const unlockedCount = unlockedAchievements.length;
            const progressPercent = Math.round((unlockedCount / totalAchievements) * 100);

            const unlockedEl = document.getElementById('badgesUnlockedCount');
            const totalEl = document.getElementById('badgesTotalCount');
            const progressEl = document.getElementById('badgesProgressPercent');

            if (unlockedEl) unlockedEl.textContent = unlockedCount;
            if (totalEl) totalEl.textContent = totalAchievements;
            if (progressEl) progressEl.textContent = progressPercent + '%';
        }

        // Tüm achievement'ları güncelle
        function updateAllAchievements() {
            // Sıfırlama işareti varsa, achievement kartlarını güncelleme (zaten sıfırlandı)
            const justReset = localStorage.getItem('achievementsJustReset');
            if (justReset === 'true') {
                localStorage.removeItem('achievementsJustReset');
                // Sıfırlama sonrası ilk güncelleme, sadece kilitli durumu koru
                return;
            }
            
            const unlockedAchievements = JSON.parse(localStorage.getItem('unlockedAchievements')) || [];
            const achievements = [
                { id: 'first_win', name: 'İlk Zafer', desc: 'İlk sahih cevabin', icon: '🎯', condition: () => sessionCorrect >= 1 },
                { id: 'combo_master', name: 'Combo Ustası', desc: '5x combo yap', icon: '🔥', condition: () => comboCount >= 5, progress: () => Math.min(comboCount || 0, 5) },
                { id: 'daily_goal', name: 'Günlük Kahraman', desc: 'Günlük hedefini tamamla', icon: '⭐', condition: () => {
                    const dailyHasene = parseInt(localStorage.getItem('dailyHasene')) || 0;
                    const goalHasene = parseInt(localStorage.getItem('dailyGoalHasene')) || 2700;
                    return dailyHasene >= goalHasene;
                }, progress: () => {
                    const dailyHasene = parseInt(localStorage.getItem('dailyHasene')) || 0;
                    const goalHasene = parseInt(localStorage.getItem('dailyGoalHasene')) || 2700;
                    return Math.min((dailyHasene / goalHasene) * 100, 100);
                }},
                { id: 'streak_7', name: '7 Gün Seri', desc: '7 gün üst üste oyna', icon: '🔥', condition: () => streakData.currentStreak >= 7, progress: () => Math.min((streakData.currentStreak || 0) / 7 * 100, 100) },
                { id: 'level_5', name: 'Seviye 5', desc: 'Seviye 5\'e ulaş', icon: '🏆', condition: () => level >= 5, progress: () => {
                    // Level 1 ise 0% göster, 1/5 değil
                    if (level <= 1) return 0;
                    return Math.min((level / 5) * 100, 100);
                }},
                { id: 'level_10', name: 'Seviye 10', desc: 'Seviye 10\'a ulaş', icon: '💎', condition: () => level >= 10, progress: () => {
                    // Level 1 ise 0% göster, 1/10 değil
                    if (level <= 1) return 0;
                    return Math.min((level / 10) * 100, 100);
                }},
                { id: 'level_20', name: 'Seviye 20', desc: 'Seviye 20\'ye ulaş', icon: '🌟', condition: () => level >= 20, progress: () => {
                    // Level 1 ise 0% göster, 1/20 değil
                    if (level <= 1) return 0;
                    return Math.min((level / 20) * 100, 100);
                }},
                { id: 'xp_500', name: 'İlk Adım', desc: '500 Hasene topla', icon: '🌱', condition: () => totalPoints >= 500, progress: () => Math.min((totalPoints || 0) / 500 * 100, 100) },
                { id: 'xp_2000', name: 'Bronz Yolcu', desc: '2,000 Hasene', icon: '🥉', condition: () => totalPoints >= 2000, progress: () => Math.min((totalPoints || 0) / 2000 * 100, 100) },
                { id: 'xp_8500', name: 'Gümüş Master', desc: '8,500 Hasene', icon: '🥈', condition: () => totalPoints >= 8500, progress: () => Math.min((totalPoints || 0) / 8500 * 100, 100) },
                { id: 'xp_25500', name: 'Altın Master', desc: '25,500 Hasene', icon: '🥇', condition: () => totalPoints >= 25500, progress: () => Math.min((totalPoints || 0) / 25500 * 100, 100) },
                { id: 'xp_85000', name: 'Elmas Master', desc: '85,000 Hasene', icon: '💎', condition: () => totalPoints >= 85000, progress: () => Math.min((totalPoints || 0) / 85000 * 100, 100) }
            ];

            achievements.forEach(ach => {
                const card = document.getElementById(`achievement-${ach.id}`);
                if (!card) return;

                const isUnlocked = unlockedAchievements.includes(ach.id);
                const progressFill = card.querySelector('.achievement-progress-fill');
                const progressText = card.querySelector('.progress-text');

                if (isUnlocked) {
                    card.classList.add('unlocked');
                    card.classList.remove('locked');
                    card.style.background = 'linear-gradient(135deg, #fff 0%, #f0f7ff 100%)';
                    card.style.borderColor = '#667eea';
                    card.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.2)';
                    if (progressFill) progressFill.style.width = '100%';
                    if (progressText) progressText.textContent = '✓ Tamamlandı';
                    if (progressText) progressText.style.color = '#667eea';
                    if (progressText) progressText.style.fontWeight = '600';
                } else {
                    card.classList.add('locked');
                    card.classList.remove('unlocked');
                    card.style.background = '#f8f9fa';
                    card.style.borderColor = 'transparent';
                    card.style.opacity = '0.6';
                    card.style.filter = 'grayscale(50%)';
                    
                    // İlerleme göster
                    if (ach.progress && progressFill) {
                        const progress = ach.progress();
                        // Level achievement'ları için özel kontrol: level 1 ise 0% göster
                        let finalProgress = progress;
                        if (ach.id.startsWith('level_') && level <= 1) {
                            finalProgress = 0;
                        }
                        progressFill.style.width = finalProgress + '%';
                        progressFill.style.background = finalProgress > 0 ? 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)' : '#ccc';
                    }
                    
                    // İlerleme metni
                    if (progressText && ach.progress) {
                        const progress = ach.progress();
                        if (ach.id === 'combo_master') {
                            progressText.textContent = `${comboCount || 0}/5`;
                        } else if (ach.id === 'daily_goal') {
                            const dailyHasene = parseInt(localStorage.getItem('dailyHasene')) || 0;
                            const goalHasene = parseInt(localStorage.getItem('dailyGoalHasene')) || 2700;
                            progressText.textContent = `${dailyHasene}/${goalHasene}`;
                        } else if (ach.id === 'streak_7') {
                            progressText.textContent = `${streakData.currentStreak || 0}/7`;
                        } else if (ach.id.startsWith('level_')) {
                            const targetLevel = parseInt(ach.id.split('_')[1]);
                            // Level 1 ise 0/X göster, 1/X değil
                            const currentLevel = (level <= 1) ? 0 : level;
                            progressText.textContent = `${currentLevel}/${targetLevel}`;
                        } else if (ach.id.startsWith('xp_')) {
                            const targetXP = parseInt(ach.id.split('_')[1]);
                            progressText.textContent = `${(totalPoints || 0).toLocaleString()}/${targetXP.toLocaleString()}`;
                        } else {
                            progressText.textContent = 'Kilitli';
                        }
                        progressText.style.color = '#999';
                        progressText.style.fontWeight = 'normal';
                    }
                }
            });
        }

        function closeBadgesModal() {
            const modal = document.getElementById('badgesModal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.zIndex = '';
                // Body scroll'u tekrar aktif et
                document.body.style.overflow = '';
                
                // Tüm oyun ekranlarını ve modlarını gizle
                if (typeof hideAllGameScreens === 'function') {
                    hideAllGameScreens();
                }
                if (typeof hideAllModes === 'function') {
                    hideAllModes();
                } else {
                    // Fallback: Manuel olarak modları gizle
                    const modeIds = ['gameScreen', 'modeSelector', 'ayetMode', 'duaMode', 'hadisMode', 'boslukMode', 'dinleMode'];
                    modeIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.style.display = 'none';
                            el.style.zIndex = '';
                        }
                    });
                }
                
                // Ana sayfanın görünür olduğundan emin ol
                if (elements && elements.mainMenu) {
                    elements.mainMenu.style.display = 'block';
                }
            }
        }
        
        // Touch event tracking for badges modal scroll detection
        let badgesModalTouchStart = { x: 0, y: 0, time: 0 };
        let badgesModalIsScrolling = false;
        
        // Badges modal için touch event'leri
        function initBadgesModalTouchEvents() {
            const badgesModal = document.getElementById('badgesModal');
            const badgesScrollableContent = document.getElementById('badgesScrollableContent');
            if (!badgesModal) return;
            
            // Eğer zaten eklenmişse, tekrar ekleme
            if (badgesModal.hasAttribute('data-touch-events-initialized')) return;
            badgesModal.setAttribute('data-touch-events-initialized', 'true');
            
            // Scroll edilebilir içerik alanında scroll algılama
            if (badgesScrollableContent) {
                badgesScrollableContent.addEventListener('touchstart', function(e) {
                    badgesModalIsScrolling = false;
                }, { passive: true });
                
                badgesScrollableContent.addEventListener('touchmove', function(e) {
                    // Scroll edilebilir içerik alanında hareket varsa, bu bir scroll'dur
                    badgesModalIsScrolling = true;
                }, { passive: true });
            }
            
            // Modal overlay için touch event'leri
            badgesModal.addEventListener('touchstart', function(e) {
                // Eğer scroll edilebilir içerik alanına tıklanmışsa, ignore et
                if (e.target && (e.target.id === 'badgesScrollableContent' || e.target.closest('#badgesScrollableContent'))) {
                    return;
                }
                
                const touch = e.touches[0];
                badgesModalTouchStart = {
                    x: touch.clientX,
                    y: touch.clientY,
                    time: Date.now()
                };
                badgesModalIsScrolling = false;
            }, { passive: true });
            
            badgesModal.addEventListener('touchmove', function(e) {
                // Eğer scroll edilebilir içerik alanında hareket varsa, bu bir scroll'dur
                if (e.target && (e.target.id === 'badgesScrollableContent' || e.target.closest('#badgesScrollableContent'))) {
                    badgesModalIsScrolling = true;
                    return;
                }
                
                if (badgesModalTouchStart.x !== 0 || badgesModalTouchStart.y !== 0) {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - badgesModalTouchStart.x);
                    const deltaY = Math.abs(touch.clientY - badgesModalTouchStart.y);
                    // Eğer 10px'den fazla hareket varsa, bu bir scroll'dur
                    if (deltaX > 10 || deltaY > 10) {
                        badgesModalIsScrolling = true;
                    }
                }
            }, { passive: true });
            
            badgesModal.addEventListener('touchend', function(e) {
                // Touch end'de scroll kontrolü yap
                if (badgesModalIsScrolling) {
                    // Scroll oldu, kapatma
                    badgesModalIsScrolling = false;
                    badgesModalTouchStart = { x: 0, y: 0, time: 0 };
                    return;
                }
                
                // Scroll değilse, normal click gibi davran
                const touch = e.changedTouches[0];
                const deltaTime = Date.now() - badgesModalTouchStart.time;
                const deltaX = Math.abs(touch.clientX - badgesModalTouchStart.x);
                const deltaY = Math.abs(touch.clientY - badgesModalTouchStart.y);
                
                // Kısa süre (300ms) ve küçük hareket (10px) = tap
                if (deltaTime < 300 && deltaX < 10 && deltaY < 10) {
                    // X butonuna tıklanmışsa ignore et
                    const target = e.target;
                    if (target && target.closest('button[onclick="closeBadgesModal()"]')) {
                        badgesModalTouchStart = { x: 0, y: 0, time: 0 };
                        return;
                    }
                    
                    // Panel üzerine veya dış arka plana tap yapıldı, kapat
                    closeBadgesModal();
                }
                
                badgesModalTouchStart = { x: 0, y: 0, time: 0 };
            }, { passive: true });
        }
        
        // Her yere tıklayınca kapatma fonksiyonu (Panel üzerine de tıklanınca kapanır)
        function handleBadgesModalClick(event) {
            // X butonuna tıklanırsa kapatma (zaten kendi handler'ı var)
            const target = event.target;
            if (target && target.closest('button[onclick="closeBadgesModal()"]')) {
                return;
            }
            
            // Modal içeriğine (modal-content) tıklanırsa, kapatma (sadece arka plana tıklanınca kapat)
            if (target && (target.closest('.modal-content'))) {
                return;
            }
            
            // Scroll edilebilir içerik alanına tıklanırsa, scroll kontrolü yap
            if (target && (target.id === 'badgesScrollableContent' || target.closest('#badgesScrollableContent'))) {
                // Scroll yapıldıysa veya scroll edilebilir içerik alanına tıklanırsa, kapatma
                return;
            }
            
            // Sadece modal overlay'e (arka plana) tıklanırsa kapat
            closeBadgesModal();
        }
        
        function showXPInfoModal() {
            const modal = document.getElementById('xpInfoModal');
            if (modal) {
                modal.style.display = 'flex';
                // Touch event'leri başlat
                initXPInfoModalTouchEvents();
            }
        }
        
        function closeXPInfoModal() {
            const modal = document.getElementById('xpInfoModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Global olarak erişilebilir yap
        window.closeXPInfoModal = closeXPInfoModal;
        window.showXPInfoModal = showXPInfoModal;
        
        // XP Info Modal için touch event'leri
        let xpInfoModalTouchStart = { x: 0, y: 0, time: 0 };
        let xpInfoModalIsScrolling = false;
        
        function initXPInfoModalTouchEvents() {
            const xpInfoModal = document.getElementById('xpInfoModal');
            const xpInfoScrollableContent = document.getElementById('xpInfoScrollableContent');
            if (!xpInfoModal) return;
            
            // Eğer zaten eklenmişse, tekrar ekleme
            if (xpInfoModal.hasAttribute('data-touch-events-initialized')) return;
            xpInfoModal.setAttribute('data-touch-events-initialized', 'true');
            
            // Scroll edilebilir içerik alanında scroll algılama
            if (xpInfoScrollableContent) {
                xpInfoScrollableContent.addEventListener('touchstart', function(e) {
                    xpInfoModalIsScrolling = false;
                }, { passive: true });
                
                xpInfoScrollableContent.addEventListener('touchmove', function(e) {
                    xpInfoModalIsScrolling = true;
                }, { passive: true });
            }
            
            // Modal overlay için touch event'leri
            xpInfoModal.addEventListener('touchstart', function(e) {
                if (e.target && (e.target.id === 'xpInfoScrollableContent' || e.target.closest('#xpInfoScrollableContent'))) {
                    return;
                }
                
                const touch = e.touches[0];
                xpInfoModalTouchStart = {
                    x: touch.clientX,
                    y: touch.clientY,
                    time: Date.now()
                };
                xpInfoModalIsScrolling = false;
            }, { passive: true });
            
            xpInfoModal.addEventListener('touchmove', function(e) {
                if (e.target && (e.target.id === 'xpInfoScrollableContent' || e.target.closest('#xpInfoScrollableContent'))) {
                    xpInfoModalIsScrolling = true;
                    return;
                }
                
                if (xpInfoModalTouchStart.x !== 0 || xpInfoModalTouchStart.y !== 0) {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - xpInfoModalTouchStart.x);
                    const deltaY = Math.abs(touch.clientY - xpInfoModalTouchStart.y);
                    if (deltaX > 10 || deltaY > 10) {
                        xpInfoModalIsScrolling = true;
                    }
                }
            }, { passive: true });
            
            xpInfoModal.addEventListener('touchend', function(e) {
                if (xpInfoModalIsScrolling) {
                    xpInfoModalIsScrolling = false;
                    xpInfoModalTouchStart = { x: 0, y: 0, time: 0 };
                    return;
                }
                
                const touch = e.changedTouches[0];
                const deltaTime = Date.now() - xpInfoModalTouchStart.time;
                const deltaX = Math.abs(touch.clientX - xpInfoModalTouchStart.x);
                const deltaY = Math.abs(touch.clientY - xpInfoModalTouchStart.y);
                
                if (deltaTime < 300 && deltaX < 10 && deltaY < 10) {
                    if (e.target && (e.target.id === 'xpInfoScrollableContent' || e.target.closest('#xpInfoScrollableContent'))) {
                        return;
                    }
                    if (e.target && (e.target.id === 'closeXPInfoBtn' || e.target.closest('#closeXPInfoBtn'))) {
                        return;
                    }
                    if (e.target && e.target.closest('.modal-content')) {
                        return;
                    }
                    closeXPInfoModal();
                }
                
                xpInfoModalTouchStart = { x: 0, y: 0, time: 0 };
            }, { passive: true });
        }
        
        // Her yere tıklayınca kapatma fonksiyonu
        function handleXPInfoModalClick(event) {
            const target = event.target;
            if (target && target.closest('button[onclick*="closeXPInfoModal"]')) {
                return;
            }
            if (target && target.closest('.modal-content')) {
                return;
            }
            if (target && (target.id === 'xpInfoScrollableContent' || target.closest('#xpInfoScrollableContent'))) {
                return;
            }
            closeXPInfoModal();
        }
        
        // Global olarak erişilebilir yap
        window.handleXPInfoModalClick = handleXPInfoModalClick;

        // ============ İSTATİSTİKLER SİSTEMİ ============
        function showStatsModal() {
            // Önce tüm modalları ve oyun ekranlarını kapat
            closeAllModals();
            if (typeof hideAllGameScreens === 'function') {
                hideAllGameScreens();
            }
            if (typeof hideAllModes === 'function') {
                hideAllModes();
            }
            
            // Touch event'lerini başlat (eğer henüz başlatılmadıysa)
            initStatsModalTouchEvents();
            
            // Body scroll'u engelle
            document.body.style.overflow = 'hidden';
            // Genel istatistikleri güncelle
            document.getElementById('statsLevel').textContent = level;
            document.getElementById('statsPoints').textContent = totalPoints.toLocaleString();
            document.getElementById('statsStars').textContent = starPoints;
            
            // Seviye ilerleme barını hesapla
            let currentLevelStart, nextLevelStart;
            const nextLevel = level + 1;
            
            if (level === 1) {
                currentLevelStart = 0;
                nextLevelStart = 1000;
            } else if (level <= 10) {
                const thresholds = [0, 1000, 2500, 5000, 8500, 13000, 19000, 26500, 35500, 46000, 58000];
                currentLevelStart = thresholds[level - 1];
                nextLevelStart = thresholds[level] || (58000 + ((level - 10) * 15000));
            } else {
                // Level 10'dan sonra
                currentLevelStart = 58000 + ((level - 11) * 15000);
                nextLevelStart = 58000 + ((level - 10) * 15000);
            }
            
            const currentLevelPoints = totalPoints - currentLevelStart;
            const levelRequiredPoints = nextLevelStart - currentLevelStart;
            const progressPercentage = Math.max(0, Math.min((currentLevelPoints / levelRequiredPoints) * 100, 100));
            const pointsNeeded = Math.max(0, nextLevelStart - totalPoints);
            
            document.getElementById('statsCurrentLevel').textContent = level;
            document.getElementById('statsNextLevel').textContent = nextLevel;
            document.getElementById('statsLevelProgress').style.width = progressPercentage + '%';
            document.getElementById('statsLevelPointsNeeded').textContent = pointsNeeded.toLocaleString();
            
            // Rozet sayılarını güncelle
            document.getElementById('statsBronze').textContent = badges.bronze;
            document.getElementById('statsSilver').textContent = badges.silver;
            document.getElementById('statsGold').textContent = badges.gold;
            document.getElementById('statsDiamond').textContent = badges.diamond;
            
            // Başarı analizi hesapla
            // Toplam deneme sayısı = Doğru + Yanlış
            const totalAttempts = (dailyTasks.todayStats.toplamDogru || 0) + (dailyTasks.todayStats.toplamYanlis || 0);
            
            // Başarı oranı: Bugünkü toplam doğru cevap / Bugünkü toplam deneme sayısı
            const successRate = totalAttempts > 0 ? Math.round((dailyTasks.todayStats.toplamDogru / totalAttempts) * 100) : 0;
            const avgPointsPerDay = streakData.totalPlayDays > 0 ? Math.round(totalPoints / streakData.totalPlayDays) : totalPoints;
            const playConsistency = Math.round((streakData.totalPlayDays / Math.max(1, getDaysFromFirstPlay())) * 100);
            const levelProgressPercent = Math.round(progressPercentage);
            
            document.getElementById('statsSuccessRate').textContent = successRate + '%';
            document.getElementById('statsAvgPointsPerDay').textContent = avgPointsPerDay.toLocaleString();
            document.getElementById('statsPlayConsistency').textContent = Math.min(100, playConsistency) + '%';
            document.getElementById('statsLevelProgressText').textContent = levelProgressPercent + '%';
            
            // Streak bilgilerini güncelle
            document.getElementById('statsCurrentStreak').textContent = streakData.currentStreak;
            document.getElementById('statsBestStreak').textContent = streakData.bestStreak;
            document.getElementById('statsTotalDays').textContent = streakData.totalPlayDays;
            document.getElementById('statsTodayProgress').textContent = Math.min(streakData.todayProgress, streakData.dailyGoal) + '/' + streakData.dailyGoal;
            
            // Bugünkü oyun türü istatistikleri
            document.getElementById('statsKelimeCevir').textContent = dailyTasks.todayStats.kelimeCevir;
            document.getElementById('statsDinleBul').textContent = dailyTasks.todayStats.dinleBul;
            document.getElementById('statsBoslukDoldur').textContent = dailyTasks.todayStats.boslukDoldur;
            document.getElementById('statsAyetOku').textContent = dailyTasks.todayStats.ayetOku;
            document.getElementById('statsDuaOgre').textContent = dailyTasks.todayStats.duaOgre;
            document.getElementById('statsHadisOku').textContent = dailyTasks.todayStats.hadisOku;
            
            // Bugünkü performans
            document.getElementById('statsTodayCorrect').textContent = dailyTasks.todayStats.toplamDogru;
            document.getElementById('statsTodayPoints').textContent = dailyTasks.todayStats.toplamPuan;
            document.getElementById('statsPerfectStreak').textContent = dailyTasks.todayStats.perfectStreak;
            document.getElementById('statsDifficultyCount').textContent = dailyTasks.todayStats.farklıZorluk.size;
            
            // Modal'ı göster
            document.getElementById('statsModal').style.display = 'flex';
            
            // Kelime istatistiklerini güncelle (artık tek sayfa olduğu için her zaman göster)
            if (typeof updateWordStatistics === 'function') {
                updateWordStatistics();
            }
            
            // ============ DETAYLI ANALİTİK VERİLERİNİ GÜNCELLE ============
            updateAnalyticsData();
            
            // ============ LİDERLİK TABLOSU VERİLERİNİ GÜNCELLE ============
            updateLeaderboard();
            
            log.debug('📊 İstatistikler modalı açıldı');
        }
        
        // ============ DETAYLI ANALİTİK VERİLERİNİ GÜNCELLE ============
        function updateAnalyticsData() {
            // Zaman analizi
            const todayTotalQuestions = (dailyTasks.todayStats.toplamDogru || 0) + (dailyTasks.todayStats.toplamYanlis || 0);
            // Ortalama bir soru ~10 saniye sürer (kelime çevir için)
            const todayMinutes = Math.round((todayTotalQuestions * 10) / 60);
            const questionsPerHour = todayMinutes > 0 ? Math.round((todayTotalQuestions / todayMinutes) * 60) : 0;
            
            const analyticsTodayTime = document.getElementById('analyticsTodayTime');
            const analyticsQuestionPerHour = document.getElementById('analyticsQuestionPerHour');
            if (analyticsTodayTime) analyticsTodayTime.textContent = todayMinutes + ' dk';
            if (analyticsQuestionPerHour) analyticsQuestionPerHour.textContent = questionsPerHour;
            
            // Günlük hedef durumu
            const dailyGoalHasene = parseInt(localStorage.getItem('dailyGoalHasene') || '2700');
            const todayProgress = dailyTasks.todayStats.toplamPuan || 0;
            const goalProgressPercent = dailyGoalHasene > 0 ? Math.min(100, Math.round((todayProgress / dailyGoalHasene) * 100)) : 0;
            
            const analyticsDailyGoal = document.getElementById('analyticsDailyGoal');
            const analyticsTodayProgress = document.getElementById('analyticsTodayProgress');
            const analyticsDailyGoalTotal = document.getElementById('analyticsDailyGoalTotal');
            const analyticsGoalProgressBar = document.getElementById('analyticsGoalProgressBar');
            const analyticsTimeToGoal = document.getElementById('analyticsTimeToGoal');
            
            if (analyticsDailyGoal) analyticsDailyGoal.textContent = dailyGoalHasene.toLocaleString();
            if (analyticsTodayProgress) analyticsTodayProgress.textContent = todayProgress.toLocaleString();
            if (analyticsDailyGoalTotal) analyticsDailyGoalTotal.textContent = dailyGoalHasene.toLocaleString();
            if (analyticsGoalProgressBar) analyticsGoalProgressBar.style.width = goalProgressPercent + '%';
            
            // Hedef için tahmini süre hesapla
            if (analyticsTimeToGoal) {
                const remainingPoints = Math.max(0, dailyGoalHasene - todayProgress);
                if (remainingPoints === 0) {
                    analyticsTimeToGoal.textContent = '🎉 Hedef tamamlandı!';
                } else if (questionsPerHour > 0 && todayProgress > 0) {
                    // Ortalama puan/soru: bugünkü puan / bugünkü soru sayısı
                    const avgPointsPerQuestion = todayTotalQuestions > 0 ? todayProgress / todayTotalQuestions : 20;
                    const remainingQuestions = Math.ceil(remainingPoints / avgPointsPerQuestion);
                    const estimatedMinutes = Math.ceil((remainingQuestions * 10) / 60);
                    
                    if (estimatedMinutes < 60) {
                        analyticsTimeToGoal.textContent = `Tahmini: ${estimatedMinutes} dakika kaldı`;
                    } else {
                        const hours = Math.floor(estimatedMinutes / 60);
                        const mins = estimatedMinutes % 60;
                        analyticsTimeToGoal.textContent = `Tahmini: ${hours} saat ${mins} dakika kaldı`;
                    }
                } else {
                    analyticsTimeToGoal.textContent = 'Oyun oynayarak başla!';
                }
            }
            
            // Kelime performansı
            const wordStats = loadWordStats();
            const wordStatsArray = Object.values(wordStats);
            
            if (wordStatsArray.length > 0) {
                // Ortalama başarı oranı
                const totalSuccessRate = wordStatsArray.reduce((sum, stat) => sum + (stat.successRate || 0), 0);
                const avgSuccessRate = Math.round((totalSuccessRate / wordStatsArray.length) * 100);
                
                // En zor kelime (en düşük başarı oranı ve en çok deneme)
                const hardestWord = wordStatsArray
                    .filter(s => s.attempts > 0)
                    .sort((a, b) => {
                        const scoreA = (a.successRate || 0) * (a.attempts || 1);
                        const scoreB = (b.successRate || 0) * (b.attempts || 1);
                        return scoreA - scoreB; // En düşük skor en zor
                    })[0];
                
                const analyticsAvgSuccess = document.getElementById('analyticsAvgSuccess');
                const analyticsHardestWord = document.getElementById('analyticsHardestWord');
                
                if (analyticsAvgSuccess) analyticsAvgSuccess.textContent = '%' + avgSuccessRate;
                if (analyticsHardestWord && hardestWord) {
                    // Kelime verisini bul (null kontrolü ile)
                    if (kelimeBulData && Array.isArray(kelimeBulData)) {
                        const wordData = kelimeBulData.find(w => w.id === hardestWord.wordId);
                        if (wordData) {
                            analyticsHardestWord.textContent = wordData.kelime || '-';
                        } else {
                            analyticsHardestWord.textContent = '-';
                        }
                    } else {
                        analyticsHardestWord.textContent = '-';
                    }
                }
            }
            
            // Öğrenme haritası
            const masteredWords = wordStatsArray.filter(s => s.masteryLevel >= 3.0 && s.successRate >= 0.6).length;
            const practiceWords = wordStatsArray.filter(s => s.masteryLevel >= 1.5 && s.masteryLevel < 3.0 && s.successRate >= 0.5).length;
            const strugglingWords = wordStatsArray.filter(s => s.successRate < 0.6 || s.masteryLevel < 1.0).length;
            
            const analyticsLearnedCount = document.getElementById('analyticsLearnedCount');
            const analyticsPracticeCount = document.getElementById('analyticsPracticeCount');
            const analyticsStrugglingCount = document.getElementById('analyticsStrugglingCount');
            
            if (analyticsLearnedCount) analyticsLearnedCount.textContent = masteredWords;
            if (analyticsPracticeCount) analyticsPracticeCount.textContent = practiceWords;
            if (analyticsStrugglingCount) analyticsStrugglingCount.textContent = strugglingWords;
        }
        
        // ============ LİDERLİK TABLOSU SİSTEMİ ============
        // Liderlik tablosu verisini yükle
        function loadLeaderboard() {
            try {
                const data = localStorage.getItem('haseneLeaderboard');
                if (data) {
                    return JSON.parse(data);
                }
            } catch (error) {
                log.error('Liderlik tablosu yükleme hatası:', error);
            }
            return [];
        }
        
        // Liderlik tablosu verisini kaydet
        function saveLeaderboard(leaderboard) {
            try {
                // Maksimum 100 kayıt tut
                const sorted = leaderboard
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 100);
                localStorage.setItem('haseneLeaderboard', JSON.stringify(sorted));
                return sorted;
            } catch (error) {
                log.error('Liderlik tablosu kaydetme hatası:', error);
                return leaderboard;
            }
        }
        
        // Liderlik tablosuna kullanıcı ekle/güncelle
        function updateLeaderboardEntry(userName, score) {
            const leaderboard = loadLeaderboard();
            const now = new Date().toISOString();
            
            // Kullanıcı adını localStorage'dan al veya varsayılan kullan
            const defaultName = userName || 'Kullanıcı';
            
            // Mevcut kullanıcıyı bul
            let userIndex = leaderboard.findIndex(entry => entry.name === defaultName);
            
            if (userIndex >= 0) {
                // Güncelle
                if (score > leaderboard[userIndex].score) {
                    leaderboard[userIndex].score = score;
                    leaderboard[userIndex].updatedAt = now;
                }
            } else {
                // Yeni ekle
                leaderboard.push({
                    name: defaultName,
                    score: score,
                    createdAt: now,
                    updatedAt: now
                });
            }
            
            return saveLeaderboard(leaderboard);
        }
        
        // Liderlik tablosunu güncelle ve göster
        function updateLeaderboard() {
            // Önce mevcut kullanıcıyı güncelle
            const userName = localStorage.getItem('haseneUserName') || 'Kullanıcı';
            updateLeaderboardEntry(userName, totalPoints);
            
            // Liderlik tablosunu yükle
            const leaderboard = loadLeaderboard();
            const sortedLeaderboard = leaderboard.sort((a, b) => b.score - a.score);
            
            // Kullanıcının sıralamasını bul
            const userIndex = sortedLeaderboard.findIndex(entry => entry.name === userName);
            const userRank = userIndex >= 0 ? userIndex + 1 : '-';
            const userScore = totalPoints;
            
            // Kullanıcı bilgilerini güncelle
            const leaderboardYourRank = document.getElementById('leaderboardYourRank');
            const leaderboardYourScore = document.getElementById('leaderboardYourScore');
            
            if (leaderboardYourRank) {
                if (userRank === 1) {
                    leaderboardYourRank.textContent = '🥇 ' + userRank;
                } else if (userRank === 2) {
                    leaderboardYourRank.textContent = '🥈 ' + userRank;
                } else if (userRank === 3) {
                    leaderboardYourRank.textContent = '🥉 ' + userRank;
                } else {
                    leaderboardYourRank.textContent = '#' + userRank;
                }
            }
            if (leaderboardYourScore) {
                leaderboardYourScore.textContent = 'Hasene: ' + userScore.toLocaleString();
            }
            
            // Liderlik listesini göster
            const leaderboardList = document.getElementById('leaderboardList');
            if (leaderboardList) {
                if (sortedLeaderboard.length === 0) {
                    leaderboardList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666; font-size: 0.9em;">
                            Henüz liderlik tablosu verisi yok. Oyun oynayarak sıralamaya katıl!
                        </div>
                    `;
                } else {
                    leaderboardList.innerHTML = sortedLeaderboard.slice(0, 10).map((entry, index) => {
                        const rank = index + 1;
                        const rankEmoji = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : '';
                        const isCurrentUser = entry.name === userName;
                        
                        return `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; margin-bottom: 8px; background: ${isCurrentUser ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#f8f9fa'}; border-radius: 8px; border: ${isCurrentUser ? '2px solid #667eea' : '1px solid #e0e0e0'};">
                                <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                                    <div style="font-size: 1.2em; font-weight: bold; color: ${isCurrentUser ? 'white' : '#667eea'}; min-width: 40px; text-align: center;">
                                        ${rankEmoji || '#' + rank}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: ${isCurrentUser ? 'bold' : '600'}; color: ${isCurrentUser ? 'white' : '#333'}; font-size: 0.9em;">
                                            ${sanitizeHTML(entry.name)}${isCurrentUser ? ' (Sen)' : ''}
                                        </div>
                                        <div style="font-size: 0.75em; color: ${isCurrentUser ? 'rgba(255,255,255,0.9)' : '#666'}; margin-top: 2px;">
                                            ${new Date(entry.updatedAt).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' })}
                                        </div>
                                    </div>
                                </div>
                                <div style="font-size: 1.1em; font-weight: bold; color: ${isCurrentUser ? 'white' : '#667eea'};">
                                    ${entry.score.toLocaleString()}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        }

        function getDaysFromFirstPlay() {
            if (streakData.playDates.length === 0) return 1;
            
            const firstPlayDate = new Date(streakData.playDates[0]);
            const today = new Date();
            const diffTime = Math.abs(today - firstPlayDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return Math.max(1, diffDays);
        }
        
        function closeStatsModal() {
            const modal = document.getElementById('statsModal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.zIndex = '';
                // Body scroll'u tekrar aktif et
                document.body.style.overflow = '';
                
                // Tüm oyun ekranlarını ve modlarını gizle
                if (typeof hideAllGameScreens === 'function') {
                    hideAllGameScreens();
                }
                if (typeof hideAllModes === 'function') {
                    hideAllModes();
                } else {
                    // Fallback: Manuel olarak modları gizle
                    const modeIds = ['gameScreen', 'modeSelector', 'ayetMode', 'duaMode', 'hadisMode', 'boslukMode', 'dinleMode'];
                    modeIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.style.display = 'none';
                            el.style.zIndex = '';
                        }
                    });
                }
                
                // Ana sayfanın görünür olduğundan emin ol
                if (elements && elements.mainMenu) {
                    elements.mainMenu.style.display = 'block';
                }
            }
        }
        
        // Her yere tıklayınca kapatma fonksiyonu (Panel üzerine de tıklanınca kapanır)
        // Touch event tracking for scroll detection
        let statsModalTouchStart = { x: 0, y: 0, time: 0 };
        let statsModalIsScrolling = false;
        
        // Stats modal için touch event'leri - DOMContentLoaded içinde ekleniyor
        function initStatsModalTouchEvents() {
            const statsModal = document.getElementById('statsModal');
            const statsScrollableContent = document.getElementById('statsScrollableContent');
            if (!statsModal) return;
            
            // Eğer zaten eklenmişse, tekrar ekleme
            if (statsModal.hasAttribute('data-touch-events-initialized')) return;
            statsModal.setAttribute('data-touch-events-initialized', 'true');
            
            // Scroll edilebilir içerik alanında scroll algılama
            if (statsScrollableContent) {
                statsScrollableContent.addEventListener('touchstart', function(e) {
                    statsModalIsScrolling = false;
                }, { passive: true });
                
                statsScrollableContent.addEventListener('touchmove', function(e) {
                    // Scroll edilebilir içerik alanında hareket varsa, bu bir scroll'dur
                    statsModalIsScrolling = true;
                }, { passive: true });
            }
            
            // Modal overlay için touch event'leri
            statsModal.addEventListener('touchstart', function(e) {
                // Eğer scroll edilebilir içerik alanına tıklanmışsa, ignore et
                if (e.target && (e.target.id === 'statsScrollableContent' || e.target.closest('#statsScrollableContent'))) {
                    return;
                }
                
                const touch = e.touches[0];
                statsModalTouchStart = {
                    x: touch.clientX,
                    y: touch.clientY,
                    time: Date.now()
                };
                statsModalIsScrolling = false;
            }, { passive: true });
            
            statsModal.addEventListener('touchmove', function(e) {
                // Eğer scroll edilebilir içerik alanında hareket varsa, bu bir scroll'dur
                if (e.target && (e.target.id === 'statsScrollableContent' || e.target.closest('#statsScrollableContent'))) {
                    statsModalIsScrolling = true;
                    return;
                }
                
                if (statsModalTouchStart.x !== 0 || statsModalTouchStart.y !== 0) {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - statsModalTouchStart.x);
                    const deltaY = Math.abs(touch.clientY - statsModalTouchStart.y);
                    // Eğer 10px'den fazla hareket varsa, bu bir scroll'dur
                    if (deltaX > 10 || deltaY > 10) {
                        statsModalIsScrolling = true;
                    }
                }
            }, { passive: true });
            
            statsModal.addEventListener('touchend', function(e) {
                // Touch end'de scroll kontrolü yap
                if (statsModalIsScrolling) {
                    // Scroll oldu, kapatma
                    statsModalIsScrolling = false;
                    statsModalTouchStart = { x: 0, y: 0, time: 0 };
                    return;
                }
                
                // Scroll değilse, normal click gibi davran
                const touch = e.changedTouches[0];
                const deltaTime = Date.now() - statsModalTouchStart.time;
                const deltaX = Math.abs(touch.clientX - statsModalTouchStart.x);
                const deltaY = Math.abs(touch.clientY - statsModalTouchStart.y);
                
                // Kısa süre (300ms) ve küçük hareket (10px) = tap
                if (deltaTime < 300 && deltaX < 10 && deltaY < 10) {
                    // X butonuna tıklanmışsa ignore et
                    const target = e.target;
                    if (target && (target.id === 'closeStatsBtn' || target.closest('#closeStatsBtn'))) {
                        statsModalTouchStart = { x: 0, y: 0, time: 0 };
                        return;
                    }
                    
                    // Panel üzerine veya dış arka plana tap yapıldı, kapat
                    closeStatsModal();
                }
                
                statsModalTouchStart = { x: 0, y: 0, time: 0 };
            }, { passive: true });
        }
        
        function handleStatsModalClick(event) {
            // X butonuna tıklanırsa kapatma (zaten kendi handler'ı var)
            const target = event.target;
            if (target && (target.id === 'closeStatsBtn' || target.closest('#closeStatsBtn'))) {
                return;
            }
            
            // Filtre butonlarına tıklanırsa paneli kapatma
            if (target && (
                target.id === 'filterAll' || 
                target.id === 'filterMastered' || 
                target.id === 'filterStruggling' || 
                target.id === 'filterRecent' ||
                target.closest('#filterAll') ||
                target.closest('#filterMastered') ||
                target.closest('#filterStruggling') ||
                target.closest('#filterRecent')
            )) {
                // Filtre butonlarının kendi onclick handler'ları çalışsın
                return;
            }
            
            // Modal içeriğine (modal-content) tıklanırsa, kapatma (sadece arka plana tıklanınca kapat)
            if (target && (target.closest('.modal-content'))) {
                return;
            }
            
            // Scroll edilebilir içerik alanına tıklanırsa, scroll kontrolü yap
            if (target && (target.id === 'statsScrollableContent' || target.closest('#statsScrollableContent'))) {
                // Scroll yapıldıysa veya scroll edilebilir içerik alanına tıklanırsa, kapatma
                return;
            }
            
            // Sadece modal overlay'e (arka plana) tıklanırsa kapat
            closeStatsModal();
        }
        
        function confirmResetStats() {
            const confirmed = confirm('🚨 DİKKAT!\n\nTüm oyun verilerini sıfırlamak istediğinden emin misin?\n\n• Tüm puanlar (0\'a döner)\n• Tüm rozetler (silinir)\n• Tüm başarılar/achievement\'lar (sıfırlanır)\n• Achievement ilerleme barları (0%\'a döner)\n• Mertebe rozetleri (Mütebahhir, Mütecaviz, Müterakki, Mübtedi - sıfırlanır)\n• Tüm streak verileri (sıfırlanır)\n• Tüm günlük görevler (yenilenir)\n• Tüm istatistikler (temizlenir)\n• İstatistikler paneli tüm alanları (sıfırlanır)\n• KELİME PANELİ istatistikleri (sıfırlanır)\n• GÜNLÜK HEDEF XP (0\'a döner)\n• Başarılar modal istatistikleri (sıfırlanır)\n• Takvim modal streak bilgisi (sıfırlanır)\n\nBu işlem GERİ ALINMAZ!\n\nDevam etmek istiyor musun?');
            
            if (confirmed) {
                // İkinci onay
                const doubleConfirmed = confirm('🔥 SON UYARI!\n\nGerçekten TÜM VERİLERİ sıfırlamak istiyor musun?\n\nBu işlemden sonra oyuna sıfırdan başlayacaksın!\n\n✅ EVET = Sıfırla\n❌ HAYIR = İptal et');
                
                if (doubleConfirmed) {
                    closeStatsModal(); // Modal'ı kapat
                    resetAllStats(); // Mevcut fonksiyonu kullan
                }
            }
        }

        // Global fonksiyonlar (window'a ekle)
        window.showStatsModal = showStatsModal;
        window.closeStatsModal = closeStatsModal;
        window.handleStatsModalClick = handleStatsModalClick;
        window.handleCalendarModalClick = handleCalendarModalClick;
        window.handleBadgesModalClick = handleBadgesModalClick;
        window.handleDailyTasksModalClick = handleDailyTasksModalClick;
        window.confirmResetStats = confirmResetStats;
        window.showBadgeCategory = showBadgeCategory;
        window.showBadgesModal = showBadgesModal;
        window.closeBadgesModal = closeBadgesModal;
        
        // ============ ONBOARDING/TUTORIAL SİSTEMİ ============
        let currentOnboardingSlide = 1;
        const totalOnboardingSlides = 6;
        
        function showOnboarding() {
            const onboardingModal = document.getElementById('onboardingModal');
            if (onboardingModal) {
                onboardingModal.style.display = 'flex';
                currentOnboardingSlide = 1;
                updateOnboardingSlide();
            }
        }
        
        function closeOnboarding() {
            const onboardingModal = document.getElementById('onboardingModal');
            if (onboardingModal) {
                onboardingModal.style.display = 'none';
                // İlk açılış işaretini kaydet
                localStorage.setItem('hasSeenOnboarding', 'true');
                // Ana menüyü göster
                const mainContainer = document.getElementById('mainMenu');
                if (mainContainer) {
                    mainContainer.style.display = 'block';
                }
            }
        }
        
        function nextOnboardingSlide() {
            if (currentOnboardingSlide < totalOnboardingSlides) {
                currentOnboardingSlide++;
                updateOnboardingSlide();
            } else {
                // Son slide'da "Başla" butonu göster
                closeOnboarding();
            }
        }
        
        function prevOnboardingSlide() {
            if (currentOnboardingSlide > 1) {
                currentOnboardingSlide--;
                updateOnboardingSlide();
            }
        }
        
        function skipOnboarding() {
            closeOnboarding();
        }
        
        function updateOnboardingSlide() {
            // Tüm slide'ları gizle
            const slides = document.querySelectorAll('.onboarding-slide');
            slides.forEach(slide => {
                slide.classList.remove('active');
            });
            
            // Aktif slide'ı göster
            const activeSlide = document.querySelector(`.onboarding-slide[data-slide="${currentOnboardingSlide}"]`);
            if (activeSlide) {
                activeSlide.classList.add('active');
            }
            
            // İlerleme barını güncelle
            const progressBar = document.getElementById('onboardingProgressBar');
            const progressText = document.getElementById('onboardingProgressText');
            const nextBtn = document.getElementById('onboardingNextBtn');
            const skipBtn = document.getElementById('onboardingSkipBtn');
            
            if (progressBar) {
                const progress = (currentOnboardingSlide / totalOnboardingSlides) * 100;
                progressBar.style.width = progress + '%';
            }
            
            if (progressText) {
                progressText.textContent = `${currentOnboardingSlide} / ${totalOnboardingSlides}`;
            }
            
            // Butonların görünür olduğundan emin ol
            if (nextBtn) {
                nextBtn.style.display = 'block';
                nextBtn.style.visibility = 'visible';
                nextBtn.style.opacity = '1';
                if (currentOnboardingSlide === totalOnboardingSlides) {
                    nextBtn.textContent = 'Başla! 🚀';
                } else {
                    nextBtn.textContent = 'İleri →';
                }
            }
            
            if (skipBtn) {
                skipBtn.style.display = 'block';
                skipBtn.style.visibility = 'visible';
                skipBtn.style.opacity = '1';
            }
        }
        
        // Global fonksiyonlar
        window.showOnboarding = showOnboarding;
        window.closeOnboarding = closeOnboarding;
        window.nextOnboardingSlide = nextOnboardingSlide;
        window.prevOnboardingSlide = prevOnboardingSlide;
        window.skipOnboarding = skipOnboarding;

        // ============ TAKVİM SİSTEMİ ============
        function checkDailyProgress() {
            const today = getLocalDateString(); // Yerel tarih (YYYY-MM-DD)
            
            // Eğer bugün ilk defa açılıyorsa
            if (streakData.todayDate !== today) {
                log.debug(`🕐 Gün değişikliği algılandı: ${streakData.todayDate} → ${today}`);
                
                // Gelişmiş streak kontrolü
                const streakValidation = validateCurrentStreak(today);
                if (!streakValidation.isValid) {
                    log.debug(`🔴 Streak tutarsızlığı: ${streakValidation.reason}`);
                    streakData.currentStreak = streakValidation.correctStreak;
                }
                
                // Bugünün verilerini sıfırla
                streakData.todayDate = today;
                streakData.todayProgress = 0;
                
                log.debug(`📅 Yeni gün başladı: ${today}, mevcut streak: ${streakData.currentStreak}`);
            }
        }

        // 🔍 Streak doğruluğunu kapsamlı kontrol eden fonksiyon
        function validateCurrentStreak(today) {
            if (streakData.playDates.length === 0) {
                return { isValid: true, correctStreak: 0, reason: 'Hiç oyun oynammış' };
            }

            // Tarihleri sırala (en yeniden eskiye)
            const sortedDates = [...streakData.playDates].sort().reverse();
            
            // Bugünden başlayarak geriye doğru ardışık günleri say
            let consecutiveDays = 0;
            let currentDate = today;
            
            for (let i = 0; i < sortedDates.length; i++) {
                if (sortedDates[i] === currentDate) {
                    consecutiveDays++;
                    // Bir önceki günü hesapla
                    const prevDate = new Date(currentDate);
                    prevDate.setDate(prevDate.getDate() - 1);
                    currentDate = getLocalDateString(prevDate);
                } else {
                    // Ardışık olmayan tarih bulundu, streak burada bitiyor
                    break;
                }
            }

            const isValid = consecutiveDays === streakData.currentStreak;
            const reason = isValid ? 'Streak doğru' : 
                          `Hesaplanan: ${consecutiveDays}, kayıtlı: ${streakData.currentStreak}`;

            return { 
                isValid, 
                correctStreak: consecutiveDays, 
                reason: reason
            };
        }

        // 📅 Mevcut streak'in gerçek tarihlerini hesapla
        function calculateCurrentStreakDates() {
            if (streakData.playDates.length === 0 || streakData.currentStreak === 0) {
                return [];
            }

            // Son oyun tarihinden başlayarak geriye doğru ardışık tarihleri bul
            const sortedDates = [...streakData.playDates].sort().reverse();
            const streakDates = [];
            let currentDate = sortedDates[0]; // En son oyun tarihi

            for (let i = 0; i < sortedDates.length && streakDates.length < streakData.currentStreak; i++) {
                if (sortedDates[i] === currentDate) {
                    streakDates.push(currentDate);
                    // Bir önceki günü hesapla
                    const prevDate = new Date(currentDate);
                    prevDate.setDate(prevDate.getDate() - 1);
                    currentDate = getLocalDateString(prevDate);
                } else {
                    // Ardışık olmayan tarih, streak burada bitiyor
                    break;
                }
            }

            log.debug(`🔥 Streak tarihleri hesaplandı: [${streakDates.join(', ')}]`);
            return streakDates;
        }

        function updateDailyProgress(correctAnswers) {
            const today = getLocalDateString(); // Yerel tarih (YYYY-MM-DD)
            
            // Günlük ilerleme güncelle
            streakData.todayProgress += correctAnswers;
            
            // Takvim açıksa bugünkü hedefi gerçek zamanlı güncelle
            const todayProgressElement = document.getElementById('todayProgress');
            const todayProgressIconElement = document.getElementById('todayProgressIcon');
            
            if (todayProgressElement) {
                const currentProgress = Math.min(streakData.todayProgress, streakData.dailyGoal);
                todayProgressElement.textContent = currentProgress;
                
                // İlerlemeye göre dinamik emoji
                if (todayProgressIconElement) {
                    if (currentProgress >= 5) {
                        todayProgressIconElement.textContent = '✅'; // Tamamlandı
                    } else if (currentProgress >= 3) {
                        todayProgressIconElement.textContent = '🔥'; // İyi gidiyor  
                    } else if (currentProgress >= 1) {
                        todayProgressIconElement.textContent = '💪'; // Başlamış
                    } else {
                        todayProgressIconElement.textContent = '⏳'; // Henüz başlamamış
                    }
                }
            }
            
            // Günlük hedef tamamlandı mı?
            if (streakData.todayProgress >= streakData.dailyGoal && streakData.lastPlayDate !== today) {
                log.debug(`🎯 Günlük hedef tamamlandı! İlerleme: ${streakData.todayProgress}/${streakData.dailyGoal}`);
                
                // İlk defa bugün hedefi tamamladı
                streakData.lastPlayDate = today;
                streakData.totalPlayDays++;
                
                log.debug(`📈 Toplam oyun günü: ${streakData.totalPlayDays}, önceki streak: ${streakData.currentStreak}`);
                
                // Oyun tarihi listesine ekle
                if (!streakData.playDates.includes(today)) {
                    streakData.playDates.push(today);
                    streakData.playDates.sort();
                }
                
                // Streak güncelle - bugün ilk kez hedefi tamamladı
                if (streakData.currentStreak === 0) {
                    // İlk gün veya streak kırılmışsa 1'den başla
                    streakData.currentStreak = 1;
                } else {
                    // Streak devam ediyorsa artır
                    streakData.currentStreak++;
                }
                
                // En iyi streak'i güncelle
                if (streakData.currentStreak > streakData.bestStreak) {
                    streakData.bestStreak = streakData.currentStreak;
                    log.debug(`🏆 Yeni rekor streak: ${streakData.bestStreak} gün!`);
                }
                
                log.debug(`🔥 Streak güncellendi: ${streakData.currentStreak} gün (en iyi: ${streakData.bestStreak})`);
                
                // Streak doğruluğunu kontrol et
                const validation = validateCurrentStreak(today);
                if (!validation.isValid) {
                    log.debug(`⚠️ Streak otomatik düzeltme: ${streakData.currentStreak} → ${validation.correctStreak}`);
                    streakData.currentStreak = validation.correctStreak;
                }

                // Veriyi kaydet
                saveStats();
                
                // Eğer takvim açıksa otomatik yenile (mavi -> yeşil)
                const calendarModal = document.getElementById('calendarModal');
                if (calendarModal && calendarModal.style.display === 'flex') {
                    generateCalendar();
                }
            }
        }

        function showCalendarModal() {
            // Önce tüm modalları ve oyun ekranlarını kapat
            closeAllModals();
            if (typeof hideAllGameScreens === 'function') {
                hideAllGameScreens();
            }
            if (typeof hideAllModes === 'function') {
                hideAllModes();
            }
            
            // Body scroll'u engelle
            document.body.style.overflow = 'hidden';
            // Haftalık streak gösterimini oluştur
            generateWeeklyStreakDisplay();
            
            // Aylık takvimi oluştur
            generateMonthlyCalendar();
            
            // Modal'ı göster
            document.getElementById('calendarModal').style.display = 'flex';
        }

        function closeCalendarModal() {
            const modal = document.getElementById('calendarModal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.zIndex = '';
                // Body scroll'u tekrar aktif et
                document.body.style.overflow = '';
                
                // Tüm oyun ekranlarını ve modlarını gizle
                if (typeof hideAllGameScreens === 'function') {
                    hideAllGameScreens();
                }
                if (typeof hideAllModes === 'function') {
                    hideAllModes();
                } else {
                    // Fallback: Manuel olarak modları gizle
                    const modeIds = ['gameScreen', 'modeSelector', 'ayetMode', 'duaMode', 'hadisMode', 'boslukMode', 'dinleMode'];
                    modeIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.style.display = 'none';
                            el.style.zIndex = '';
                        }
                    });
                }
                
                // Ana sayfanın görünür olduğundan emin ol
                if (elements && elements.mainMenu) {
                    elements.mainMenu.style.display = 'block';
                }
            }
        }
        
        // Touch event tracking for calendar modal scroll detection
        let calendarModalTouchStart = { x: 0, y: 0, time: 0 };
        let calendarModalIsScrolling = false;
        
        // Touch event tracking for daily tasks modal scroll detection
        let dailyTasksModalTouchStart = { x: 0, y: 0, time: 0 };
        let dailyTasksModalIsScrolling = false;
        
        // Calendar modal için touch event'leri
        function initCalendarModalTouchEvents() {
            const calendarModal = document.getElementById('calendarModal');
            const calendarScrollableContent = document.getElementById('calendarScrollableContent');
            if (!calendarModal) return;
            
            // Eğer zaten eklenmişse, tekrar ekleme
            if (calendarModal.hasAttribute('data-touch-events-initialized')) return;
            calendarModal.setAttribute('data-touch-events-initialized', 'true');
            
            // Scroll edilebilir içerik alanında scroll algılama
            if (calendarScrollableContent) {
                calendarScrollableContent.addEventListener('touchstart', function(e) {
                    calendarModalIsScrolling = false;
                }, { passive: true });
                
                calendarScrollableContent.addEventListener('touchmove', function(e) {
                    // Scroll edilebilir içerik alanında hareket varsa, bu bir scroll'dur
                    calendarModalIsScrolling = true;
                }, { passive: true });
            }
            
            // Modal overlay için touch event'leri
            calendarModal.addEventListener('touchstart', function(e) {
                // Eğer scroll edilebilir içerik alanına tıklanmışsa, ignore et
                if (e.target && (e.target.id === 'calendarScrollableContent' || e.target.closest('#calendarScrollableContent'))) {
                    return;
                }
                
                const touch = e.touches[0];
                calendarModalTouchStart = {
                    x: touch.clientX,
                    y: touch.clientY,
                    time: Date.now()
                };
                calendarModalIsScrolling = false;
            }, { passive: true });
            
            calendarModal.addEventListener('touchmove', function(e) {
                // Eğer scroll edilebilir içerik alanında hareket varsa, bu bir scroll'dur
                if (e.target && (e.target.id === 'calendarScrollableContent' || e.target.closest('#calendarScrollableContent'))) {
                    calendarModalIsScrolling = true;
                    return;
                }
                
                if (calendarModalTouchStart.x !== 0 || calendarModalTouchStart.y !== 0) {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - calendarModalTouchStart.x);
                    const deltaY = Math.abs(touch.clientY - calendarModalTouchStart.y);
                    // Eğer 10px'den fazla hareket varsa, bu bir scroll'dur
                    if (deltaX > 10 || deltaY > 10) {
                        calendarModalIsScrolling = true;
                    }
                }
            }, { passive: true });
            
            calendarModal.addEventListener('touchend', function(e) {
                // Touch end'de scroll kontrolü yap
                if (calendarModalIsScrolling) {
                    // Scroll oldu, kapatma
                    calendarModalIsScrolling = false;
                    calendarModalTouchStart = { x: 0, y: 0, time: 0 };
                    return;
                }
                
                // Scroll değilse, normal click gibi davran
                const touch = e.changedTouches[0];
                const deltaTime = Date.now() - calendarModalTouchStart.time;
                const deltaX = Math.abs(touch.clientX - calendarModalTouchStart.x);
                const deltaY = Math.abs(touch.clientY - calendarModalTouchStart.y);
                
                // Kısa süre (300ms) ve küçük hareket (10px) = tap
                if (deltaTime < 300 && deltaX < 10 && deltaY < 10) {
                    // X butonuna tıklanmışsa ignore et
                    const target = e.target;
                    if (target && (target.id === 'closeCalendarBtn' || target.closest('#closeCalendarBtn') || target.closest('button[onclick="closeCalendarModal()"]'))) {
                        calendarModalTouchStart = { x: 0, y: 0, time: 0 };
                        return;
                    }
                    
                    // Panel üzerine veya dış arka plana tap yapıldı, kapat
                    closeCalendarModal();
                }
                
                calendarModalTouchStart = { x: 0, y: 0, time: 0 };
            }, { passive: true });
        }
        
        // Her yere tıklayınca kapatma fonksiyonu (Panel üzerine de tıklanınca kapanır)
        function handleCalendarModalClick(event) {
            // X butonuna veya kapat butonuna tıklanırsa kapatma
            const target = event.target;
            if (target && (target.id === 'closeCalendarBtn' || target.closest('#closeCalendarBtn') || target.closest('button[onclick="closeCalendarModal()"]'))) {
                return;
            }
            
            // Modal içeriğine (modal-content) tıklanırsa, kapatma (sadece arka plana tıklanınca kapat)
            if (target && (target.closest('.modal-content'))) {
                return;
            }
            
            // Scroll edilebilir içerik alanına tıklanırsa, scroll kontrolü yap
            if (target && (target.id === 'calendarScrollableContent' || target.closest('#calendarScrollableContent'))) {
                // Scroll yapıldıysa veya scroll edilebilir içerik alanına tıklanırsa, kapatma
                return;
            }
            
            // Sadece modal overlay'e (arka plana) tıklanırsa kapat
            closeCalendarModal();
        }

        function generateWeeklyStreakDisplay() {
            // Son 7 günü hesapla
            const today = new Date();
            const weekDays = [];
            const dayNames = ['Pz', 'Pt', 'Sl', 'Çr', 'Pr', 'Cm', 'Ct'];
            
            // Son 7 günü geriye doğru hesapla
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                weekDays.push({
                    date: date,
                    dateStr: getLocalDateString(date),
                    dayName: dayNames[date.getDay()],
                    isToday: i === 0
                });
            }
            
            // PlayDates set'ini oluştur
            const playDatesSet = new Set(streakData.playDates);
            const currentStreakDates = calculateCurrentStreakDates();
            const currentStreakSet = new Set(currentStreakDates);
            
            // HTML oluştur - Duolingo Style
            let html = '';
            
            // Gün isimleri (üst satır)
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 12px;">';
            weekDays.forEach(day => {
                const dayColor = day.isToday ? '#58cc02' : '#999';
                const fontWeight = day.isToday ? '700' : '400';
                html += `<div style="text-align: center; font-size: 0.75em; color: ${dayColor}; font-weight: ${fontWeight};">${day.dayName}</div>`;
            });
            html += '</div>';
            
            // Günler (alt satır) - Duolingo kare stili
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;">';
            weekDays.forEach(day => {
                const hasPlayed = playDatesSet.has(day.dateStr);
                const isInStreak = currentStreakSet.has(day.dateStr);
                
                let boxStyle = 'aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: 600; transition: transform 0.2s;';
                
                if (day.isToday) {
                    if (hasPlayed) {
                        // Bugün tamamlandı - yeşil (Duolingo style)
                        boxStyle += ' background: #58cc02; color: white; border: 2px solid #58cc02;';
                    } else {
                        // Bugün henüz oynanmadı - mavi kenarlık
                        boxStyle += ' background: #e5f4e3; color: #58cc02; border: 2px solid #58cc02;';
                    }
                } else if (isInStreak && hasPlayed) {
                    // Streak günü - altın/yeşil (Duolingo style)
                    boxStyle += ' background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #1a1a1a; border: 2px solid #ffd700;';
                } else if (hasPlayed) {
                    // Oynandı ama streak dışında - yeşil
                    boxStyle += ' background: #58cc02; color: white; border: 2px solid #58cc02;';
                } else {
                    // Oynanmadı - gri
                    boxStyle += ' background: #e5e5e5; color: #999; border: 2px solid #e5e5e5;';
                }
                
                const icon = hasPlayed ? '✓' : '';
                html += `<div style="${boxStyle}" title="${day.dateStr}">${icon}</div>`;
            });
            html += '</div>';
            
            // HTML'i yerleştir
            document.getElementById('weeklyStreakDisplay').innerHTML = html;
            
            // Streak sayısını güncelle
            const streakCountEl = document.getElementById('calendarStreakCount');
            if (streakCountEl) {
                streakCountEl.textContent = streakData.currentStreak || 0;
            }
        }

        function generateMonthlyCalendar() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const todayDate = today.getDate();
            const todayStr = getLocalDateString();
            
            // Ay adını güncelle
            const monthNames = [
                'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
            ];
            document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
            
            // Takvim grid'ini temizle ve yeni HTML oluştur
            const grid = document.getElementById('calendarGrid');
            
            // HTML string olarak oluştur
            let html = '';
            
            // Haftanın günlerini ekle (Duolingo style - üst satır)
            const dayNames = ['Pz', 'Pt', 'Sl', 'Çr', 'Pr', 'Cm', 'Ct'];
            dayNames.forEach(day => {
                html += `<div style="text-align: center; font-weight: 600; font-size: 0.75em; color: #999; padding: 8px 0; display: flex; align-items: center; justify-content: center;">${day}</div>`;
            });
            
            // Ayın ilk gününün haftanın hangi günü olduğunu bul
            const firstDay = new Date(year, month, 1);
            const startingDayOfWeek = (firstDay.getDay() + 6) % 7; // Pazartesi = 0
            
            // Boş günler ekle
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div></div>';
            }
            
            // Mevcut streak'in gerçek tarih aralığını hesapla
            const currentStreakDates = calculateCurrentStreakDates();
            const currentStreakSet = new Set(currentStreakDates);

            // playDates array'ini Set'e çevir
            const playDatesSet = new Set(streakData.playDates);
            
            // Ayın günlerini ekle (Duolingo kare stili)
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasPlayed = playDatesSet.has(dateStr);
                const isInStreak = currentStreakSet.has(dateStr);
                const isToday = dateStr === todayStr;
                
                // Duolingo style kare
                let boxStyle = 'aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;';
                
                if (isToday) {
                    if (hasPlayed) {
                        // Bugün tamamlandı - yeşil (Duolingo style)
                        boxStyle += ' background: #58cc02; color: white; border: 2px solid #58cc02; box-shadow: 0 2px 8px rgba(88, 204, 2, 0.3);';
                    } else {
                        // Bugün henüz oynanmadı - mavi kenarlık
                        boxStyle += ' background: #e5f4e3; color: #58cc02; border: 2px solid #58cc02;';
                    }
                } else if (isInStreak && hasPlayed) {
                    // Streak günü - altın (Duolingo style)
                    boxStyle += ' background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #1a1a1a; border: 2px solid #ffd700; box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);';
                } else if (hasPlayed) {
                    // Oynandı ama streak dışında - yeşil
                    boxStyle += ' background: #58cc02; color: white; border: 2px solid #58cc02;';
                } else if (day < todayDate) {
                    // Geçmiş gün - oynanmadı - gri
                    boxStyle += ' background: #e5e5e5; color: #999; border: 2px solid #e5e5e5;';
                } else {
                    // Gelecek gün - açık gri
                    boxStyle += ' background: #f7f7f7; color: #ccc; border: 2px solid #f7f7f7;';
                }
                
                const content = hasPlayed ? '✓' : day;
                const tooltip = `${dateStr}${hasPlayed ? ' - Tamamlandı' : isToday ? ' - Bugün' : ''}${isInStreak && hasPlayed ? ' - Streak!' : ''}`;
                
                html += `<div style="${boxStyle}" title="${tooltip}" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">${content}</div>`;
            }
            
            // HTML'i yerleştir
            grid.innerHTML = html;
        }

        // Global fonksiyonlar (window'a ekle ki HTML onclick çalışsın)
        window.showCalendarModal = showCalendarModal;
        window.closeCalendarModal = closeCalendarModal;

        // 🔍 STREAK ANALİZ SİSTEMİ - DEBUG TOOLS
        function analyzeStreakSystem() {
            log.stats('🔍 STREAK SİSTEMİ ANALİZ RAPORU');
            log.stats('=====================================');
            
            const today = getLocalDateString();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = getLocalDateString(yesterday);
            
            // Mevcut streak verilerini analiz et
            log.stats('📊 Mevcut Veriler:');
            log.stats(`├── Bugün: ${today}`);
            log.stats(`├── Dün: ${yesterdayStr}`);
            log.stats(`├── Son oyun tarihi: ${streakData.lastPlayDate}`);
            log.stats(`├── Mevcut streak: ${streakData.currentStreak} gün`);
            log.stats(`├── En iyi streak: ${streakData.bestStreak} gün`);
            log.stats(`├── Bugünkü ilerleme: ${streakData.todayProgress}/${streakData.dailyGoal}`);
            log.stats(`├── Toplam oyun günü: ${streakData.totalPlayDays}`);
            log.stats(`└── Oyun tarihleri: [${streakData.playDates.join(', ')}]`);
            
            // Streak mantık kontrolü
            log.stats('\n🧠 Streak Mantık Kontrolü:');
            const streakShouldBreak = streakData.lastPlayDate !== yesterdayStr && 
                                     streakData.lastPlayDate !== today && 
                                     streakData.lastPlayDate !== '';
            
            log.stats(`├── Streak kırılmalı mı? ${streakShouldBreak ? '✅ EVET' : '❌ HAYIR'}`);
            log.stats(`├── Bugün oynanmış mı? ${streakData.playDates.includes(today) ? '✅ EVET' : '❌ HAYIR'}`);
            log.stats(`├── Dün oynanmış mı? ${streakData.playDates.includes(yesterdayStr) ? '✅ EVET' : '❌ HAYIR'}`);
            
            // Ardışık gün analizi (gelişmiş)
            log.stats('\n📅 Ardışık Gün Analizi:');
            const validation = validateCurrentStreak(today);
            log.stats(`├── Hesaplanan ardışık gün: ${validation.correctStreak}`);
            log.stats(`├── Kayıtlı streak: ${streakData.currentStreak}`);
            log.stats(`├── Tutarlılık: ${validation.isValid ? '✅ DOĞRU' : '❌ YANLIŞ'}`);
            log.stats(`└── Açıklama: ${validation.reason}`);
            
            // Takvim görünümü kontrolü
            log.stats('\n📆 Takvim Görünümü Test:');
            const currentStreakDates = calculateCurrentStreakDates();
            log.stats(`├── Streak tarih aralığı: [${currentStreakDates.join(', ')}]`);
            log.stats(`├── Takvimde 🔥 gösterilecek günler: ${currentStreakDates.length}`);
            
            // Öneriler
            log.stats('\n💡 Öneriler:');
            if (consecutiveDays !== streakData.currentStreak) {
                log.stats('├── ⚠️ Streak hesaplaması düzeltilmeli');
                log.stats(`├── 🔧 Doğru değer: ${consecutiveDays} olmalı`);
            } else {
                log.stats('├── ✅ Streak hesaplaması doğru');
            }
            
            if (streakData.playDates.includes(today) && streakData.todayProgress < streakData.dailyGoal) {
                log.stats('├── ⚠️ Bugün oynanmış ama hedef tamamlanmamış - veri tutarsızlığı');
            }
            
            log.stats('\n=====================================');
            log.stats('🔍 Analiz tamamlandı!');
        }

        // Test fonksiyonları
        function testStreakScenarios() {
            log.stats('🧪 STREAK TEST SENARYOLARİ');
            log.stats('=============================');
            
            // Backup mevcut veri
            const backup = {
                currentStreak: streakData.currentStreak,
                bestStreak: streakData.bestStreak,
                lastPlayDate: streakData.lastPlayDate,
                totalPlayDays: streakData.totalPlayDays,
                todayProgress: streakData.todayProgress,
                playDates: [...streakData.playDates]
            };
            
            log.stats('Test 1: Streak kırılması simülasyonu');
            streakData.lastPlayDate = '2025-11-08'; // 2 gün önce
            checkDailyProgress();
            log.stats(`├── Streak kırıldı mı? ${streakData.currentStreak === 0 ? '✅ EVET' : '❌ HAYIR'}`);
            
            log.stats('\nTest 2: Hedef tamamlama simülasyonu');
            streakData.todayProgress = 0;
            updateDailyProgress(5); // 5 doğru cevap ekle
            log.stats(`├── Hedef tamamlandı mı? ${streakData.todayProgress >= streakData.dailyGoal ? '✅ EVET' : '❌ HAYIR'}`);
            
            // Restore backup
            Object.assign(streakData, backup);
            log.stats('\n🔄 Veriler geri yüklendi');
            log.stats('=============================');
        }

        // Geliştirici araçları - console'da çağırılabilir
        window.analyzeStreak = analyzeStreakSystem;
        window.testStreak = testStreakScenarios;

        // ============ GÜNLİK GÖREVLER SİSTEMİ ============
        function checkDailyTasks() {
            const today = getLocalDateString(); // Yerel tarih (YYYY-MM-DD)
            
            log.debug('🔍 Günlük görev kontrolü:', {
                bugün: today,
                sonGörevTarihi: dailyTasks.lastTaskDate,
                yeniGünMü: dailyTasks.lastTaskDate !== today,
                mevcutTamamlananlar: dailyTasks.completedTasks.length,
                bugünküStats: dailyTasks.todayStats
            });
            
            // Eğer yeni gün başladıysa görevleri yenile
            if (dailyTasks.lastTaskDate !== today) {
                log.debug('🔄 Yeni gün başladı, görevler yenileniyor...');
                generateDailyTasks(today);
                // Görevler oluşturulduktan sonra badge'i güncelle
                if (typeof updateTasksDisplay === 'function') {
                    updateTasksDisplay();
                }
            } else {
                log.debug('✅ Aynı gün, mevcut görevler korunuyor');
                // Mevcut görevler için de badge'i güncelle
                if (typeof updateTasksDisplay === 'function') {
                    updateTasksDisplay();
                }
            }
        }

        function generateDailyTasks(date) {
            // Temel görevler listesi (tüm oyun modlarını kapsayacak şekilde genişletildi)
            const baseTasks = [
                { id: 'kelime5', name: '5 kelime çevir', target: 5, current: 0, type: 'kelimeCevir', reward: 1 },
                { id: 'ayet3', name: '3 ayet oku', target: 3, current: 0, type: 'ayetOku', reward: 1 },
                { id: 'dua2', name: '2 dua öğren', target: 2, current: 0, type: 'duaOgre', reward: 1 },
                { id: 'hadis1', name: '1 hadis oku', target: 1, current: 0, type: 'hadisOku', reward: 1 },
                { id: 'dinle2', name: '2 kelime dinle', target: 2, current: 0, type: 'dinleBul', reward: 1 },
                { id: 'bosluk1', name: '1 boşluk doldur', target: 1, current: 0, type: 'boslukDoldur', reward: 1 },
                { id: 'dogru10', name: '10 doğru cevap ver', target: 10, current: 0, type: 'toplamDogru', reward: 1 },
                { id: 'puan100', name: '100 puan topla', target: 100, current: 0, type: 'toplamPuan', reward: 1 }
            ];

            // Bonus görevler listesi (daha fazla çeşitlilik)
            const bonusTasksList = [
                { id: 'perfect5', name: 'Hiç yanlış yapmadan 5 soru çöz', target: 5, current: 0, type: 'perfectStreak', reward: 2 },
                { id: 'allDiff', name: '3 farklı zorlukta oyna', target: 3, current: 0, type: 'farklıZorluk', reward: 2 },
                { id: 'combo15', name: '15 doğru cevap ver (bonus)', target: 15, current: 0, type: 'toplamDogru', reward: 2 },
                { id: 'dinle5', name: '5 kelime dinle (bonus)', target: 5, current: 0, type: 'dinleBul', reward: 2 },
                { id: 'bosluk3', name: '3 boşluk doldur (bonus)', target: 3, current: 0, type: 'boslukDoldur', reward: 2 },
                { id: 'kelime10', name: '10 kelime çevir (bonus)', target: 10, current: 0, type: 'kelimeCevir', reward: 2 },
                { id: 'puan200', name: '200 puan topla (bonus)', target: 200, current: 0, type: 'toplamPuan', reward: 2 },
                { id: 'dogru20', name: '20 doğru cevap ver (bonus)', target: 20, current: 0, type: 'toplamDogru', reward: 2 }
            ];

            // Rastgele 3 bonus görev seç (2'den 3'e çıkarıldı)
            const selectedBonus = bonusTasksList.sort(() => 0.5 - Math.random()).slice(0, 3);

            dailyTasks.lastTaskDate = date;
            dailyTasks.tasks = baseTasks;
            dailyTasks.bonusTasks = selectedBonus;
            dailyTasks.completedTasks = [];
            dailyTasks.rewardsClaimed = false;
            dailyTasks.todayStats = {
                kelimeCevir: 0,
                dinleBul: 0,
                boslukDoldur: 0,
                ayetOku: 0,
                duaOgre: 0,
                hadisOku: 0,
                toplamDogru: 0,
                toplamYanlis: 0,
                toplamPuan: 0,
                perfectStreak: 0,
                farklıZorluk: new Set()
            };

            log.debug('🎯 Yeni günlük görevler oluşturuldu:', {
                tarih: date,
                temelGörevler: baseTasks.length,
                bonusGörevler: selectedBonus.length,
                toplamGörevler: baseTasks.length + selectedBonus.length,
                tamamlananlar: dailyTasks.completedTasks.length,
                stats: dailyTasks.todayStats
            });

            saveStats();
            
            // Görevler oluşturulduktan sonra badge'i güncelle
            // Not: checkDailyTasks() içinde de çağrılıyor ama burada da çağırmak daha güvenli
            setTimeout(() => {
                if (typeof updateTasksDisplay === 'function') {
                    updateTasksDisplay();
                }
            }, 100);
        }

        function updateTaskProgress(gameType, amount = 1) {
            log.debug(`📋 updateTaskProgress çağrıldı: ${gameType} +${amount}`);
            
            // Oyun tipine göre istatistiği güncelle
            if (dailyTasks.todayStats[gameType] !== undefined) {
                const eskiDeger = dailyTasks.todayStats[gameType];
                dailyTasks.todayStats[gameType] += amount;
                log.debug(`📊 ${gameType}: ${eskiDeger} → ${dailyTasks.todayStats[gameType]}`);
            }

            // Zorluk takibi
            if (currentDifficulty) {
                dailyTasks.todayStats.farklıZorluk.add(currentDifficulty);
                log.debug(`🎯 Zorluk eklendi: ${currentDifficulty}, toplam: ${dailyTasks.todayStats.farklıZorluk.size}`);
            }

            // Görevleri kontrol et ve güncelle
            const allTasks = [...dailyTasks.tasks, ...dailyTasks.bonusTasks];
            
            allTasks.forEach(task => {
                const eskiCurrent = task.current;
                if (task.type === gameType) {
                    task.current = Math.min(task.target, dailyTasks.todayStats[gameType]);
                } else if (task.type === 'farklıZorluk') {
                    task.current = dailyTasks.todayStats.farklıZorluk.size;
                }

                // Görev tamamlandı mı?
                if (task.current >= task.target && !dailyTasks.completedTasks.includes(task.id)) {
                    dailyTasks.completedTasks.push(task.id);
                    log.debug(`✅ Görev tamamlandı: ${task.id} (${task.name})`);
                }
                
                if (eskiCurrent !== task.current) {
                    log.debug(`🎯 Görev ilerleme: ${task.id} ${eskiCurrent}/${task.target} → ${task.current}/${task.target}`);
                }
            });

            log.debug(`📋 Toplam tamamlanan görev: ${dailyTasks.completedTasks.length}`);
            saveStats();
            
            // Badge'i güncelle
            updateTasksDisplay();
        }

        function showDailyTasksModal() {
            // Önce tüm modalları ve oyun ekranlarını kapat
            closeAllModals();
            if (typeof hideAllGameScreens === 'function') {
                hideAllGameScreens();
            }
            if (typeof hideAllModes === 'function') {
                hideAllModes();
            }
            
            // Günlük görevleri kontrol et ve güncelle
            checkDailyTasks();
            
            // Debug: Görev durumunu logla
            log.debug('📋 Daily Tasks Debug:', {
                tasks: dailyTasks.tasks.length,
                bonusTasks: dailyTasks.bonusTasks.length,
                completed: dailyTasks.completedTasks.length,
                lastDate: dailyTasks.lastTaskDate,
                today: getLocalDateString()
            });
            
            // Görev verilerini güncelle
            updateTasksDisplay();
            
            // Modal'ı göster
            const modal = document.getElementById('dailyTasksModal');
            if (modal) {
                modal.style.display = 'flex';
                // Body scroll'u engelle
                document.body.style.overflow = 'hidden';
                // Touch event'leri başlat
                initDailyTasksModalTouchEvents();
            }
        }

        function closeDailyTasksModal() {
            const modal = document.getElementById('dailyTasksModal');
            if (modal) {
                modal.style.display = 'none';
                modal.style.zIndex = '';
                // Body scroll'u tekrar aktif et
                document.body.style.overflow = '';
                
                // Tüm oyun ekranlarını ve modlarını gizle
                if (typeof hideAllGameScreens === 'function') {
                    hideAllGameScreens();
                }
                if (typeof hideAllModes === 'function') {
                    hideAllModes();
                } else {
                    // Fallback: Manuel olarak modları gizle
                    const modeIds = ['gameScreen', 'modeSelector', 'ayetMode', 'duaMode', 'hadisMode', 'boslukMode', 'dinleMode'];
                    modeIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            el.style.display = 'none';
                            el.style.zIndex = '';
                        }
                    });
                }
                
                // Ana sayfanın görünür olduğundan emin ol
                if (elements && elements.mainMenu) {
                    elements.mainMenu.style.display = 'block';
                }
            }
        }
        
        // Daily tasks modal için touch event'leri (İstatistikler modalı ile aynı yapı)
        function initDailyTasksModalTouchEvents() {
            const dailyTasksModal = document.getElementById('dailyTasksModal');
            const dailyTasksScrollableContent = document.getElementById('dailyTasksScrollableContent');
            if (!dailyTasksModal) return;
            
            // Eğer zaten eklenmişse, tekrar ekleme
            if (dailyTasksModal.hasAttribute('data-touch-events-initialized')) return;
            dailyTasksModal.setAttribute('data-touch-events-initialized', 'true');
            
            // Scroll edilebilir içerik alanında scroll algılama
            if (dailyTasksScrollableContent) {
                dailyTasksScrollableContent.addEventListener('touchstart', function(e) {
                    dailyTasksModalIsScrolling = false;
                }, { passive: true });
                
                dailyTasksScrollableContent.addEventListener('touchmove', function(e) {
                    // Scroll edilebilir içerik alanında hareket varsa, bu bir scroll'dur
                    dailyTasksModalIsScrolling = true;
                }, { passive: true });
            }
            
            // Modal overlay için touch event'leri
            dailyTasksModal.addEventListener('touchstart', function(e) {
                // Eğer scroll edilebilir içerik alanına tıklanmışsa, ignore et
                if (e.target && (e.target.id === 'dailyTasksScrollableContent' || e.target.closest('#dailyTasksScrollableContent'))) {
                    return;
                }
                
                const touch = e.touches[0];
                dailyTasksModalTouchStart = {
                    x: touch.clientX,
                    y: touch.clientY,
                    time: Date.now()
                };
                dailyTasksModalIsScrolling = false;
            }, { passive: true });
            
            dailyTasksModal.addEventListener('touchmove', function(e) {
                // Eğer scroll edilebilir içerik alanında hareket varsa, bu bir scroll'dur
                if (e.target && (e.target.id === 'dailyTasksScrollableContent' || e.target.closest('#dailyTasksScrollableContent'))) {
                    dailyTasksModalIsScrolling = true;
                    return;
                }
                
                if (dailyTasksModalTouchStart.x !== 0 || dailyTasksModalTouchStart.y !== 0) {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - dailyTasksModalTouchStart.x);
                    const deltaY = Math.abs(touch.clientY - dailyTasksModalTouchStart.y);
                    // Eğer 10px'den fazla hareket varsa, bu bir scroll'dur
                    if (deltaX > 10 || deltaY > 10) {
                        dailyTasksModalIsScrolling = true;
                    }
                }
            }, { passive: true });
            
            dailyTasksModal.addEventListener('touchend', function(e) {
                // Touch end'de scroll kontrolü yap
                if (dailyTasksModalIsScrolling) {
                    // Scroll oldu, kapatma
                    dailyTasksModalIsScrolling = false;
                    dailyTasksModalTouchStart = { x: 0, y: 0, time: 0 };
                    return;
                }
                
                // Scroll değilse, normal click gibi davran
                const touch = e.changedTouches[0];
                const deltaTime = Date.now() - dailyTasksModalTouchStart.time;
                const deltaX = Math.abs(touch.clientX - dailyTasksModalTouchStart.x);
                const deltaY = Math.abs(touch.clientY - dailyTasksModalTouchStart.y);
                
                // Kısa süre (300ms) ve küçük hareket (10px) = tap
                if (deltaTime < 300 && deltaX < 10 && deltaY < 10) {
                    // Scroll edilebilir içerik alanına tıklanmışsa ignore et
                    if (e.target && (e.target.id === 'dailyTasksScrollableContent' || e.target.closest('#dailyTasksScrollableContent'))) {
                        return;
                    }
                    // X butonuna veya ödül toplama butonuna tıklanmışsa ignore et
                    if (e.target && (e.target.id === 'closeDailyTasksBtn' || e.target.id === 'claimRewardsBtn' || e.target.closest('#closeDailyTasksBtn') || e.target.closest('#claimRewardsBtn'))) {
                        return;
                    }
                    // Modal içeriğine tıklanmışsa ignore et
                    if (e.target && e.target.closest('.modal-content')) {
                        return;
                    }
                    // Arka plana tap yapıldı, kapat
                    closeDailyTasksModal();
                }
                
                dailyTasksModalTouchStart = { x: 0, y: 0, time: 0 };
            }, { passive: true });
        }
        
        // Her yere tıklayınca kapatma fonksiyonu (Hasene Nasıl Kazanılır paneli ile aynı mantık)
        function handleDailyTasksModalClick(event) {
            const target = event.target;
            // Close button veya claim rewards button kontrolü
            if (target && target.closest('button[onclick*="closeDailyTasksModal"]')) {
                return;
            }
            if (target && (target.id === 'claimRewardsBtn' || target.closest('#claimRewardsBtn'))) {
                return;
            }
            // Modal içeriğine tıklanırsa, kapatma (sadece arka plana tıklanınca kapat)
            if (target && target.closest('.modal-content')) {
                return;
            }
            // Scroll edilebilir içerik alanına tıklanırsa, kapatma
            if (target && (target.id === 'dailyTasksScrollableContent' || target.closest('#dailyTasksScrollableContent'))) {
                return;
            }
            // Arka plana tıklanırsa, modal'ı kapat
            closeDailyTasksModal();
        }

        function updateTasksDisplay() {
            // Güvenlik kontrolü: Eğer görevler boşsa, yeniden oluştur
            if (!dailyTasks.tasks || dailyTasks.tasks.length === 0) {
                log.debug('⚠️ Tasks boş, yeniden oluşturuluyor...');
                generateDailyTasks(getLocalDateString());
            }
            
            const completedCount = dailyTasks.completedTasks.length;
            const totalCount = dailyTasks.tasks.length + dailyTasks.bonusTasks.length;
            const incompleteCount = totalCount - completedCount;
            
            log.debug('📊 updateTasksDisplay:', { 
                completedCount, 
                totalCount, 
                incompleteCount,
                baseTasks: dailyTasks.tasks.length,
                bonusTasks: dailyTasks.bonusTasks.length,
                rewardsClaimed: dailyTasks.rewardsClaimed
            });
            
            // Genel ilerleme
            document.getElementById('completedTasks').textContent = completedCount;
            document.getElementById('totalTasks').textContent = totalCount;
            
            const progressPercent = (completedCount / totalCount) * 100;
            document.getElementById('taskProgress').style.width = progressPercent + '%';
            
            // Badge güncelle (tamamlanmamış görev varsa göster)
            const tasksBadge = document.getElementById('tasksBadge');
            if (tasksBadge) {
                if (incompleteCount > 0 && !dailyTasks.rewardsClaimed) {
                    tasksBadge.style.display = 'flex';
                    // 12 veya daha fazla ise "9+" göster, değilse tam sayıyı göster
                    // (11 görev olduğu için, kullanıcı tam sayıyı görebilsin)
                    const badgeText = incompleteCount >= 12 ? '9+' : incompleteCount.toString();
                    tasksBadge.textContent = badgeText;
                    log.debug('🏷️ Badge güncellendi:', { incompleteCount, badgeText });
                } else {
                    tasksBadge.style.display = 'none';
                    log.debug('🏷️ Badge gizlendi:', { incompleteCount, rewardsClaimed: dailyTasks.rewardsClaimed });
                }
            } else {
                log.error('❌ tasksBadge elementi bulunamadı!');
            }

            // Temel görevleri göster
            const dailyList = document.getElementById('dailyTasksList');
            dailyList.innerHTML = '';
            
            dailyTasks.tasks.forEach(task => {
                const taskElement = createTaskElement(task);
                dailyList.appendChild(taskElement);
            });

            // Bonus görevleri göster
            const bonusList = document.getElementById('bonusTasksList');
            bonusList.innerHTML = '';
            
            dailyTasks.bonusTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                bonusList.appendChild(taskElement);
            });

            // Ödül bölümü
            const rewardsSection = document.getElementById('rewardsSection');
            if (completedCount === totalCount && !dailyTasks.rewardsClaimed) {
                rewardsSection.style.display = 'block';
            } else {
                rewardsSection.style.display = 'none';
            }
        }

        function createTaskElement(task) {
            const isCompleted = dailyTasks.completedTasks.includes(task.id);
            const progressPercent = (task.current / task.target) * 100;
            
            const div = document.createElement('div');
            div.style.cssText = `
                padding: 8px 10px; 
                border: 2px solid ${isCompleted ? '#4caf50' : '#e0e0e0'}; 
                border-radius: 8px; 
                background: ${isCompleted ? '#f1f8e9' : 'white'};
                transition: all 0.2s;
            `;
            
            // Tıklama event'lerini durdur (yanlışlıkla oyun modu açılmasın)
            div.onclick = function(e) {
                e.stopPropagation();
                e.preventDefault();
            };
            div.ontouchstart = function(e) {
                e.stopPropagation();
                e.preventDefault();
            };
            
            // Hover efekti
            div.onmouseover = function() {
                if (!isCompleted) {
                    this.style.borderColor = '#667eea';
                    this.style.transform = 'translateY(-1px)';
                    this.style.boxShadow = '0 2px 8px rgba(102,126,234,0.2)';
                }
            };
            div.onmouseout = function() {
                if (!isCompleted) {
                    this.style.borderColor = '#e0e0e0';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                }
            };
            
            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-weight: 600; font-size: 0.8em; color: ${isCompleted ? '#2e7d2e' : '#333'}; line-height: 1.3;">
                        ${isCompleted ? '✅' : '⏳'} ${getTaskDisplayName(task)}
                    </span>
                    <span style="font-size: 0.7em; color: ${isCompleted ? '#2e7d2e' : '#f59e0b'}; font-weight: 600;">+${task.reward} ⭐</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                    <div style="flex: 1; background: #f0f0f0; border-radius: 6px; height: 4px; overflow: hidden;">
                        <div style="background: ${isCompleted ? '#4caf50' : '#2196f3'}; height: 100%; border-radius: 6px; width: ${progressPercent}%; transition: width 0.3s;"></div>
                    </div>
                    <span style="font-size: 0.65em; color: #666; font-weight: 600; white-space: nowrap;">${task.current}/${task.target}</span>
                </div>
            `;
            
            return div;
        }

        function getTaskDisplayName(task) {
            // Görev tipine göre uygun isim döndür
            const taskNames = {
                'kelime5': '5 Kelime Çevir',
                'kelime10': '10 Kelime Çevir (Bonus)',
                'ayet3': '3 Ayet Oku', 
                'dua2': '2 Dua Öğren',
                'hadis1': '1 Hadis Oku',
                'dinle2': '2 Kelime Dinle',
                'dinle3': '3 Kelime Dinle (Bonus)',
                'dinle5': '5 Kelime Dinle (Bonus)',
                'bosluk1': '1 Boşluk Doldur',
                'bosluk2': '2 Boşluk Doldur (Bonus)',
                'bosluk3': '3 Boşluk Doldur (Bonus)',
                'dogru10': '10 Doğru Cevap',
                'dogru20': '20 Doğru Cevap (Bonus)',
                'puan100': '100 Puan Topla',
                'puan200': '200 Puan Topla (Bonus)',
                'perfect5': 'Mükemmel Seri (5 Soru)',
                'allDiff': '3 Farklı Zorlukta Oyna',
                'combo15': '15 Doğru Cevap (Combo)'
            };
            
            return taskNames[task.id] || task.name;
        }

        function claimDailyRewards() {
            const completedCount = dailyTasks.completedTasks.length;
            const totalCount = dailyTasks.tasks.length + dailyTasks.bonusTasks.length;
            
            if (completedCount === totalCount && !dailyTasks.rewardsClaimed) {
                // 2500 XP bonus ver (5 yıldız değerinde)
                const bonusXP = 2500;
                totalPoints += bonusXP;
                
                // Bugünkü toplam puana da ekle (istatistikler için)
                dailyTasks.todayStats.toplamPuan += bonusXP;
                
                // Daily XP'ye de ekle
                addDailyXP(bonusXP);
                
                dailyTasks.rewardsClaimed = true;
                saveStats();
                updateStatsBar();
                checkAchievements();
                
                // Ödül modalı göster
                showSuccessMessage('🎉 Tüm günlük görevleri tamamladın! +2,500 XP bonus!');
                
                updateTasksDisplay();
            }
        }

        // Ödül butonu event listener
        document.addEventListener('DOMContentLoaded', () => {
            const claimBtn = document.getElementById('claimRewardsBtn');
            if (claimBtn) {
                claimBtn.addEventListener('click', claimDailyRewards);
            }
            
            // Sayfa yüklendiğinde badge'i güncelle
            if (typeof updateTasksDisplay === 'function') {
                updateTasksDisplay();
            }
        });

        // Global fonksiyonlar
        window.showDailyTasksModal = showDailyTasksModal;
        window.closeDailyTasksModal = closeDailyTasksModal;
        window.claimDailyRewards = claimDailyRewards;

        // OYUN BİTİŞ FONKSİYONU (Oyun bitince çağrılır)
        // NOT: Puanlar zaten addSessionPoints() ile eklendi, burada sadece kontrol yapıyoruz
        function addToGlobalPoints(points, correctAnswers = 0) {
            // Seviye kontrol et (puanlar zaten totalPoints'e eklendi)
            const oldLevel = level;
            const newLevel = calculateLevel(totalPoints);
            
            // Seviye atlama kontrolü
            if (newLevel > oldLevel) {
                level = newLevel;
                showLevelUpModal(newLevel);
                playSound('levelup');
            }
            
            // Günlük ilerlemeyi güncelle
            if (correctAnswers > 0) {
                updateDailyProgress(correctAnswers);
                
                // Günlük görevleri güncelle
                updateTaskProgress('toplamDogru', correctAnswers);
                // NOT: toplamPuan zaten addSessionPoints'te eklendi, burada tekrar ekleme!
            }
            
            updateStatsBar(); // Global barı güncelle
            checkAchievements(); // Başarımları kontrol et
            saveStats(); // Verileri kaydet
        }
        
        // ============ ZORLUK UI GÜNCELLEYICI ============
        function updateDifficultyUI() {
            // Kaydedilen zorluk seviyesine göre UI'yı ayarla
            log.debug(`🎯 Zorluk UI güncelleniyor: ${currentDifficulty}`);
            
            // Tüm butonları başlangıç durumuna getir
            document.getElementById('mainDiffKolay').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: white; color: #4CAF50; border: 2px solid #4CAF50;';
            document.getElementById('mainDiffOrta').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: white; color: #FF9800; border: 2px solid #FF9800;';
            document.getElementById('mainDiffZor').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: white; color: #f44336; border: 2px solid #f44336;';
            
            // Active class'ları temizle
            document.querySelectorAll('#mainMenu .diff-btn').forEach(btn => btn.classList.remove('active'));
            
            // Seçili zorluk seviyesini vurgula
            if (currentDifficulty === 'kolay') {
                document.getElementById('mainDiffKolay').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: #4CAF50; color: white; border: 2px solid #4CAF50;';
                document.getElementById('mainDiffKolay').classList.add('active');
            } else if (currentDifficulty === 'orta') {
                document.getElementById('mainDiffOrta').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: #FF9800; color: white; border: 2px solid #FF9800;';
                document.getElementById('mainDiffOrta').classList.add('active');
            } else if (currentDifficulty === 'zor') {
                document.getElementById('mainDiffZor').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: #f44336; color: white; border: 2px solid #f44336;';
                document.getElementById('mainDiffZor').classList.add('active');
            }
        }

        // ============ ANA MENÜ ZORLUK BUTONLARI ============
        function initMainMenuDifficultyButtons() {
            // (commented) initMainMenuDifficultyButtons called log removed during cleanup
            
            // Kaydedilen zorluk seviyesini UI'da göster
            updateDifficultyUI();
            
            document.getElementById('mainDiffKolay').onclick = () => {
                log.debug("===== ZORLUK DEĞİŞTİ =====");
                log.debug("YENİ ZORLUK: KOLAY");
                log.debug("Aralık: 5-9");
                log.debug("Çarpan: 2x");
                log.debug("=======================");
                currentDifficulty = 'kolay';
                saveStats(); // Zorluk değiştiğinde kaydet!
                // Kolay yeşil seçili, diğerleri kendi border renkleri ile beyaz
                document.getElementById('mainDiffKolay').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: #4CAF50; color: white; border: 2px solid #4CAF50;';
                document.getElementById('mainDiffOrta').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: white; color: #FF9800; border: 2px solid #FF9800;';
                document.getElementById('mainDiffZor').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: white; color: #f44336; border: 2px solid #f44336;';
                // Active class'ları güncelle
                document.querySelectorAll('#mainMenu .diff-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('mainDiffKolay').classList.add('active');
            };
            
            document.getElementById('mainDiffOrta').onclick = () => {
                log.debug("===== ZORLUK DEĞİŞTİ =====");
                log.debug("YENİ ZORLUK: ORTA");
                log.debug("Aralık: 10-11");
                log.debug("Çarpan: 2x");
                log.debug("=======================");
                currentDifficulty = 'orta';
                saveStats(); // Zorluk değiştiğinde kaydet!
                // Orta turuncu seçili, diğerleri kendi border renkleri ile beyaz
                document.getElementById('mainDiffKolay').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: white; color: #4CAF50; border: 2px solid #4CAF50;';
                document.getElementById('mainDiffOrta').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: #FF9800; color: white; border: 2px solid #FF9800;';
                document.getElementById('mainDiffZor').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: white; color: #f44336; border: 2px solid #f44336;';
                // Active class'ları güncelle
                document.querySelectorAll('#mainMenu .diff-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('mainDiffOrta').classList.add('active');
            };
            
            document.getElementById('mainDiffZor').onclick = () => {
                log.debug("===== ZORLUK DEĞİŞTİ =====");
                log.debug("YENİ ZORLUK: ZOR");
                log.debug("Aralık: 12-21");
                log.debug("Çarpan: 2x");
                log.debug("=======================");
                currentDifficulty = 'zor';
                saveStats(); // Zorluk değiştiğinde kaydet!
                // Zor kırmızı seçili, diğerleri kendi border renkleri ile beyaz
                document.getElementById('mainDiffKolay').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: white; color: #4CAF50; border: 2px solid #4CAF50;';
                document.getElementById('mainDiffOrta').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: white; color: #FF9800; border: 2px solid #FF9800;';
                document.getElementById('mainDiffZor').style.cssText = 'flex: 1; min-width: 90px; max-width: 120px; margin: 0; padding: 10px; font-size: 0.85em; background: #f44336; color: white; border: 2px solid #f44336;';
                // Active class'ları güncelle
                document.querySelectorAll('#mainMenu .diff-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('mainDiffZor').classList.add('active');
            };
        }

        // ============ ANA MENÜ NAVİGASYONU ============
        // Kelime Çevir modu - oyun modları seçici ile başlar
        elements.kelimeCevirBtn.onclick = async () => {
            log.game('📚 === KELİME ÇEVİR OYUNU BAŞLATILIYOR ===');
            log.game('📋 1. Veri kontrol ediliyor...');
            
            // Lazy loading: Kelime verilerini yükle
            try {
                await loadKelimeData();
            } catch (error) {
                log.warn('❌ Kelime verileri yüklenemedi!');
                showCustomAlert('Kelime verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            
            if (!kelimeBulData || kelimeBulData.length === 0) {
                log.warn('❌ Kelime verileri yüklenemedi!');
                showCustomAlert('Kelime verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            log.game(`✅ Kelime verileri OK: ${kelimeBulData.length} kelime mevcut`);
            log.game(`🎯 Mevcut zorluk: ${currentDifficulty}`);
            
            // Önce tüm modalları kapat
            closeAllModals();
            
            log.game('📋 2. Mode Selector açılıyor...');
            hideAllModes();
            // Main menu'yu gizle
            if (elements.mainMenu) elements.mainMenu.style.display = 'none';
            if (elements.modeSelector) elements.modeSelector.style.display = 'block';
            if (elements.settingsBtn) elements.settingsBtn.style.display = 'block';
            log.game('✅ Mode Selector açıldı!');
        };

        // Dinle ve Bul modu - Doğrudan başlat
        elements.dinleBulBtn.onclick = async () => {
            // Önce tüm modalları kapat
            closeAllModals();
            
            log.game('🔥 === DINLE VE BUL OYUNU BAŞLATILIYOR ===');
            log.game('📋 1. Veri kontrol ediliyor...');
            
            // Lazy loading: Kelime verilerini yükle
            try {
                await loadKelimeData();
            } catch (error) {
                log.warn('❌ Kelime verileri yüklenemedi!');
                showCustomAlert('Kelime verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            
            if (!kelimeBulData || kelimeBulData.length === 0) {
                log.warn('❌ Kelime verileri yüklenemedi!');
                showCustomAlert('Kelime verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            log.game(`✅ Kelime verileri OK: ${kelimeBulData.length} kelime mevcut`);
            
            log.game('📋 2. Zorluk seviyesi kontrol ediliyor...');
            log.game(`🎯 Mevcut zorluk: ${currentDifficulty}`);
            log.game(`🎯 Zorluk config:`, CONFIG.difficultyLevels[currentDifficulty]);
            
            log.game('📋 3. UI değiştiriliyor...');
            hideAllModes();
            // Main menu'yu de gizle
            if (elements.mainMenu) elements.mainMenu.style.display = 'none';
            if (elements.dinleMode) {
                elements.dinleMode.style.display = 'block';
                
                // Navigasyon bar'ı gizle (oyun başladığında)
                hideBottomNavBar();
                
                // Ses tanıma sistemini başlat
                initSpeechRecognition();
                elements.dinleMode.style.zIndex = '';
            }
            log.game('✅ UI değişikliği tamamlandı');
            
            log.game('📋 4. Oyun değişkenleri sıfırlanıyor...');
            log.game(`🔄 Önceki değerler: score=${dinleScore}, correct=${dinleCorrect}, wrong=${dinleWrong}, questionCount=${dinleQuestionCount}`);
            // Dinle modunu başlat
            dinleScore = 0;
            dinleCorrect = 0;
            dinleWrong = 0;
            dinleQuestionCount = 0;
            log.game(`✅ Yeni değerler: score=${dinleScore}, correct=${dinleCorrect}, wrong=${dinleWrong}, questionCount=${dinleQuestionCount}`);
            log.game(`📊 Session değerler: sessionScore=${sessionScore}, sessionCorrect=${sessionCorrect}, sessionWrong=${sessionWrong}`);
            
            // Audio butonu event handler
            if (elements.dinleAudioBtn) {
                // Masaüstü için onclick
                elements.dinleAudioBtn.onclick = () => {
                    if (currentDinleQuestion && currentDinleQuestion.ses_dosyasi) {
                        playAudio(currentDinleQuestion.ses_dosyasi, elements.dinleAudioBtn);
                    }
                };
                // Mobil için touchend
                elements.dinleAudioBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (currentDinleQuestion && currentDinleQuestion.ses_dosyasi) {
                        playAudio(currentDinleQuestion.ses_dosyasi, elements.dinleAudioBtn);
                    }
                }, { passive: false });
            }
            
            // Mikrofon butonu event listener
            const dinleMicBtn = document.getElementById('dinleMicBtn');
            if (dinleMicBtn) {
                // Masaüstü için onclick
                dinleMicBtn.onclick = () => {
                    startSpeechRecognition();
                };
                // Mobil için touchend
                dinleMicBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    startSpeechRecognition();
                }, { passive: false });
            }
            
            // Next butonu event handler'ını buraya taşıdık
            if (elements.dinleNextBtn) {
                // Masaüstü için onclick
                elements.dinleNextBtn.onclick = () => {
                    log.debug(`🔄 === NEXT BUTONU TIKLANDI! ===`);
                    log.debug(`📊 Mevcut durum: dinleQuestionCount=${dinleQuestionCount}/${DINLE_MAX_QUESTIONS}`);
                    log.debug(`🎯 Bir sonraki soru yükleniyor...`);
                    // Butonu hemen gizle
                    if (elements.dinleNextBtn) {
                        elements.dinleNextBtn.style.display = 'none';
                        elements.dinleNextBtn.classList.remove("next-appear");
                    }
                    loadDinleQuestion();
                };
                // Mobil için touchend
                elements.dinleNextBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    log.debug(`🔄 === NEXT BUTONU TIKLANDI! ===`);
                    log.debug(`📊 Mevcut durum: dinleQuestionCount=${dinleQuestionCount}/${DINLE_MAX_QUESTIONS}`);
                    log.debug(`🎯 Bir sonraki soru yükleniyor...`);
                    // Butonu hemen gizle
                    if (elements.dinleNextBtn) {
                        elements.dinleNextBtn.style.display = 'none';
                        elements.dinleNextBtn.classList.remove("next-appear");
                    }
                    loadDinleQuestion();
                }, { passive: false });
            }
            
            updateDinleUI();
            loadDinleQuestion();
        };

        // Boşluk Doldur modu
        elements.boslukDoldurBtn.onclick = async () => {
            // Önce tüm modalları kapat
            closeAllModals();
            
            log.debug('📋 === BOŞLUK DOLDUR OYUNU BAŞLATILIYOR ===');
            log.debug('📋 1. Veri kontrol ediliyor...');

            // Lazy loading: Ayet verilerini yükle
            try {
                await loadAyetData();
            } catch (error) {
                log.error('❌ Ayet verileri yüklenemedi!');
                showCustomAlert('Ayet verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            
            if (!ayetOkuData || ayetOkuData.length === 0) {
                log.error('❌ Ayet verileri yüklenemedi!');
                showCustomAlert('Ayet verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            log.debug(`✅ Ayet verileri OK: ${ayetOkuData.length} ayet mevcut`);
            log.debug(`🎯 Mevcut zorluk: ${currentDifficulty}`);

            log.debug('📋 2. UI değiştiriliyor...');
            hideAllModes();
            // Main menu'yu de gizle
            if (elements.mainMenu) elements.mainMenu.style.display = 'none';
            if (elements.boslukMode) {
                elements.boslukMode.style.display = 'block';
                
                // Navigasyon bar'ı gizle (oyun başladığında)
                hideBottomNavBar();
                
                elements.boslukMode.style.zIndex = '';
            }
            log.debug('✅ UI değişikliği tamamlandı');

            log.debug('📋 3. Oyun değişkenleri sıfırlanıyor...');
            log.debug(`🔄 Önceki değerler: score=${boslukScore}, correct=${boslukCorrect}, wrong=${boslukWrong}`);
            // Boşluk modunu başlat
            boslukScore = 0;
            boslukCorrect = 0;
            boslukWrong = 0;
            log.debug(`✅ Yeni değerler: score=${boslukScore}, correct=${boslukCorrect}, wrong=${boslukWrong}`);
            log.debug(`📊 Session değerler: sessionScore=${sessionScore}, sessionCorrect=${sessionCorrect}, sessionWrong=${sessionWrong}`);
            
            updateBoslukUI();
            loadBoslukQuestion();
        };

        // Dua Et modu
        elements.duaEtBtn.onclick = async () => {
            // Önce tüm modalları kapat
            closeAllModals();
            
            // Lazy loading: Dua verilerini yükle
            try {
                await loadDuaData();
            } catch (error) {
                showCustomAlert('Dua verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            
            if (!duaData || duaData.length === 0) {
                showCustomAlert('Dua verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            hideAllModes();
            // Main menu'yu de gizle
            if (elements.mainMenu) elements.mainMenu.style.display = 'none';
            if (elements.duaMode) {
                elements.duaMode.style.display = 'block';
                elements.duaMode.style.zIndex = '';
            }
            // Rastgele dua ile başla
            currentDuaIndex = Math.floor(Math.random() * duaData.length);
            showDua();
        };

        // Ayet Oku modu
        elements.ayetOkuBtn.onclick = async () => {
            // Önce tüm modalları kapat
            closeAllModals();
            
            // Lazy loading: Ayet verilerini yükle
            try {
                await loadAyetData();
            } catch (error) {
                showCustomAlert('Ayet verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            
            if (!ayetOkuData || ayetOkuData.length === 0) {
                showCustomAlert('Ayet verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            hideAllModes();
            // Main menu'yu de gizle
            if (elements.mainMenu) elements.mainMenu.style.display = 'none';
            if (elements.ayetMode) {
                elements.ayetMode.style.display = 'block';
                elements.ayetMode.style.zIndex = '';
            }
            // Rastgele ayet ile başla
            currentAyetIndex = Math.floor(Math.random() * ayetOkuData.length);
            showAyet();
        };

        // Hadis Oku modu
        elements.hadisOkuBtn.onclick = async () => {
            // Önce tüm modalları kapat
            closeAllModals();
            
            // Lazy loading: Hadis verilerini yükle
            try {
                await loadHadisData();
            } catch (error) {
                showCustomAlert('Hadis verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            
            if (!hadisData || hadisData.length === 0) {
                showCustomAlert('Hadis verileri yüklenemedi! Lütfen sayfayı yenileyin.', 'error');
                return;
            }
            hideAllModes();
            // Main menu'yu de gizle
            if (elements.mainMenu) elements.mainMenu.style.display = 'none';
            if (elements.hadisMode) {
                elements.hadisMode.style.display = 'block';
                elements.hadisMode.style.zIndex = '';
            }
            // Rastgele hadis ile başla
            currentHadisIndex = Math.floor(Math.random() * hadisData.length);
            showHadis();
        };

        // Geri butonları
        elements.backToMenuBtn.onclick = () => {
            // Ensure all modes are hidden and return to main menu
            hideAllModes();
            if (elements.mainMenu) elements.mainMenu.style.display = 'block';
            if (elements.settingsBtn) elements.settingsBtn.style.display = 'none';
            
            // Navigasyon bar'ı göster (ana ekrana dönünce)
            showBottomNavBar();
        };

        if (elements.backFromGameBtn) {
        elements.backFromGameBtn.onclick = async () => {
                forceLog('=== GERI BUTONU TIKLANDI (KELIME CEVIR) ===');
                try {
                    forceLog('[1] Ses durduruluyor...');
            stopCurrentAudio();
            
                    forceLog('[2] Timer durduruluyor...');
                    stopTimer();
                    
                    forceLog('[3] Skor kontrol:', 'Score=' + sessionScore, 'Dogru=' + sessionCorrect, 'Yanlis=' + sessionWrong);
                    
                    if (sessionScore > 0 || sessionCorrect > 0 || sessionWrong > 0) {
                        forceLog('[4] Puan VAR - Modal gosteriliyor...');
                const confirmed = await showCustomConfirm(sessionCorrect, sessionWrong, sessionScore);
                        forceLog('[5] Modal sonucu:', confirmed ? 'ONAYLANDI' : 'IPTAL EDILDI');
                
                if (!confirmed) {
                            forceLog('[6] IPTAL - Cikis yapilmiyor');
                            return;
                }
                
                        forceLog('[7] ONAYLANDI - Istatistikler kaydediliyor...');
                if (sessionCorrect > 0) {
                    updateTaskProgress('toplamDogru', sessionCorrect);
                        }
                    } else {
                        forceLog('[4] Puan YOK - Direkt cikis');
                }
                
                    forceLog('[8] State\'ler sifirlaniyor...');
                sessionScore = 0;
                sessionCorrect = 0;
                sessionWrong = 0;
                comboCount = 0;
                    questionCount = 0;
                    score = 0;
                    correct = 0;
                    wrong = 0;
                    lives = 0;
                    timeLeft = 0;
                    
                    updateUI();
                    updateProgress();
                    
                    forceLog('[9] Ekranlar gizleniyor...');
            if (elements.gameScreen) elements.gameScreen.style.display = 'none';
            if (elements.modeSelector) elements.modeSelector.style.display = 'none';
            if (elements.mainMenu) {
                elements.mainMenu.removeAttribute('style');
                elements.mainMenu.style.display = 'block';
            }
            if (elements.settingsBtn) elements.settingsBtn.style.display = 'none';
            
            // Navigasyon bar'ı göster (ana ekrana dönünce)
            showBottomNavBar();
            
                    forceLog('[10] TAMAMLANDI - Ana menuye donuldu!');
                } catch (error) {
                    console.error('HATA - Geri butonu:', error);
                    console.error('HATA - Stack:', error.stack);
                    hideAllModes();
                    if (elements.mainMenu) {
                        elements.mainMenu.style.display = 'block';
                    }
                    
                    // Navigasyon bar'ı göster (ana ekrana dönünce)
                    showBottomNavBar();
                }
            };
        } else {
            console.warn('⚠️ backFromGameBtn elementi bulunamadı!');
        }

        if (elements.backFromAyetBtn) {
            elements.backFromAyetBtn.onclick = () => {
                stopCurrentAudio(); // Mevcut ses varsa durdur
                hideAllModes();
                if (elements.mainMenu) {
                    elements.mainMenu.removeAttribute('style');
                    elements.mainMenu.style.display = 'block';
                }
                if (elements.settingsBtn) elements.settingsBtn.style.display = 'none';
            };
        }

        if (elements.backFromDuaBtn) {
                elements.backFromDuaBtn.onclick = () => {
                log.debug('⬅️ Dua geri butonuna tıklandı');
                stopCurrentAudio(); // Mevcut ses varsa durdur
                hideAllModes();
                if (elements.mainMenu) {
                    elements.mainMenu.removeAttribute('style');
                    elements.mainMenu.style.display = 'block';
                }
                if (elements.settingsBtn) elements.settingsBtn.style.display = 'none';
                
                // Navigasyon bar'ı göster (ana ekrana dönünce)
                showBottomNavBar();
                
                log.debug('✅ Ana menüye döndü');
            };
        }

        if (elements.backFromHadisBtn) {
            elements.backFromHadisBtn.onclick = () => {
                stopCurrentAudio(); // Mevcut ses varsa durdur
                hideAllModes();
                if (elements.mainMenu) {
                    elements.mainMenu.removeAttribute('style');
                    elements.mainMenu.style.display = 'block';
                }
                if (elements.settingsBtn) elements.settingsBtn.style.display = 'none';
                
                // Navigasyon bar'ı göster (ana ekrana dönünce)
                showBottomNavBar();
            };
        }

        if (elements.backFromBoslukBtn) {
        elements.backFromBoslukBtn.onclick = async () => {
                forceLog('=== GERI BUTONU TIKLANDI (BOSLUK DOLDUR) ===');
                try {
                    forceLog('[1] Ses durduruluyor...');
            stopCurrentAudio();
            
                    forceLog('[2] Timer durduruluyor...');
                    stopTimer();
                    
                    forceLog('[3] Skor kontrol:', 'Score=' + boslukScore, 'Dogru=' + boslukCorrect, 'Yanlis=' + boslukWrong);
                    
                    if (boslukScore > 0 || boslukCorrect > 0 || boslukWrong > 0) {
                        forceLog('[4] Puan VAR - Modal gosteriliyor...');
                const confirmed = await showCustomConfirm(boslukCorrect, boslukWrong, boslukScore);
                        forceLog('[5] Modal sonucu:', confirmed ? 'ONAYLANDI' : 'IPTAL EDILDI');
                
                        if (!confirmed) {
                            forceLog('[6] IPTAL - Cikis yapilmiyor');
                            return;
                        }
                
                        forceLog('[7] ONAYLANDI - Istatistikler kaydediliyor...');
                if (boslukCorrect > 0) {
                    updateTaskProgress('boslukDoldur', boslukCorrect);
                    updateTaskProgress('toplamDogru', boslukCorrect);
                        }
                    } else {
                        forceLog('[4] Puan YOK - Direkt cikis');
                }
                
                    forceLog('[8] State\'ler sifirlaniyor...');
                boslukScore = 0;
                boslukCorrect = 0;
                boslukWrong = 0;
                    boslukQuestionCount = 0;
                sessionScore = 0;
                sessionCorrect = 0;
                sessionWrong = 0;
                comboCount = 0;
            
                    updateBoslukUI();
                    
                    forceLog('[9] Ekranlar gizleniyor...');
            hideAllModes();
            if (elements.mainMenu) {
                elements.mainMenu.removeAttribute('style');
                elements.mainMenu.style.display = 'block';
            }
            if (elements.settingsBtn) elements.settingsBtn.style.display = 'none';
            
            // Navigasyon bar'ı göster (ana ekrana dönünce)
            showBottomNavBar();
            
                    forceLog('[10] TAMAMLANDI - Ana menuye donuldu!');
                } catch (error) {
                    console.error('HATA - Bosluk geri butonu:', error);
                    console.error('HATA - Stack:', error.stack);
                    hideAllModes();
                    if (elements.mainMenu) {
                        elements.mainMenu.style.display = 'block';
                    }
                    
                    // Navigasyon bar'ı göster (ana ekrana dönünce)
                    showBottomNavBar();
                }
            };
        } else {
            console.warn('⚠️ backFromBoslukBtn elementi bulunamadı!');
        }

        if (elements.backFromDinleBtn) {
        elements.backFromDinleBtn.onclick = async () => {
                forceLog('=== GERI BUTONU TIKLANDI (DINLE) ===');
                try {
                    forceLog('[1] Ses durduruluyor...');
            stopCurrentAudio();
            
                    forceLog('[2] Timer durduruluyor...');
                    stopTimer();
                    
                    forceLog('[3] Skor kontrol:', 'Score=' + dinleScore, 'Dogru=' + dinleCorrect, 'Yanlis=' + dinleWrong);
                    
                    if (dinleScore > 0 || dinleCorrect > 0 || dinleWrong > 0) {
                        forceLog('[4] Puan VAR - Modal gosteriliyor...');
                const confirmed = await showCustomConfirm(dinleCorrect, dinleWrong, dinleScore);
                        forceLog('[5] Modal sonucu:', confirmed ? 'ONAYLANDI' : 'IPTAL EDILDI');
                
                        if (!confirmed) {
                            forceLog('[6] IPTAL - Cikis yapilmiyor');
                            return;
                        }
                
                        forceLog('[7] ONAYLANDI - Istatistikler kaydediliyor...');
                if (dinleCorrect > 0) {
                    updateTaskProgress('dinleBul', dinleCorrect);
                    updateTaskProgress('toplamDogru', dinleCorrect);
                        }
                    } else {
                        forceLog('[4] Puan YOK - Direkt cikis');
                }
                
                    forceLog('[8] State\'ler sifirlaniyor...');
                dinleScore = 0;
                dinleCorrect = 0;
                dinleWrong = 0;
                    dinleQuestionCount = 0;
                sessionScore = 0;
                sessionCorrect = 0;
                sessionWrong = 0;
                comboCount = 0;
            
                    updateDinleUI();
                    
                    forceLog('[9] Ekranlar gizleniyor...');
            hideAllModes();
            if (elements.mainMenu) {
                elements.mainMenu.removeAttribute('style');
                elements.mainMenu.style.display = 'block';
            }
            if (elements.settingsBtn) {
                elements.settingsBtn.style.display = 'none';
                    }
            
            // Navigasyon bar'ı göster (ana ekrana dönünce)
            showBottomNavBar();
            
                    forceLog('[10] TAMAMLANDI - Ana menuye donuldu!');
                } catch (error) {
                    console.error('HATA - Dinle geri butonu:', error);
                    console.error('HATA - Stack:', error.stack);
                    hideAllModes();
                    if (elements.mainMenu) {
                        elements.mainMenu.style.display = 'block';
                    }
                    
                    // Navigasyon bar'ı göster (ana ekrana dönünce)
                    showBottomNavBar();
                }
            };
        } else {
            console.warn('⚠️ backFromDinleBtn elementi bulunamadı!');
        }

        // ============ MOD SEÇİCİYİ BAŞLAT (Sadece Kelime Çevir için) ============
        function initModeSelector() {
            // Sadece Kelime Çevir oyun modlarını oluştur
            Object.keys(CONFIG.gameModes).forEach(modeKey => {
                const mode = CONFIG.gameModes[modeKey];
                const btn = document.createElement('button');
                btn.className = 'mode-btn';
                if (modeKey === currentMode) btn.classList.add('active');
                btn.innerHTML = `<strong>${mode.name}</strong><small>${mode.description}</small>`;
                btn.onclick = () => selectMode(modeKey);
                elements.modeButtons.appendChild(btn);
            });
        }

        // ============ MOD SEÇ ============
        function selectMode(modeKey) {
            currentMode = modeKey;
            // "Zorluk" modu seçildiğinde otomatik olarak zorluk seviyesini 'zor' yap
            if (modeKey === 'zorluk') {
                currentDifficulty = 'zor';
                log.debug('🔥 Zorluk modu seçildi, zorluk seviyesi "zor" olarak ayarlandı');
            }
            saveStats(); // Mod değiştiğinde kaydet!
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.mode-btn').classList.add('active');
        }

        // ============ OYUNU BAŞLAT ============
        if (elements.startBtn) {
        elements.startBtn.onclick = () => {
            const mode = CONFIG.gameModes[currentMode];
            
            // Ayarları uygula
            lives = mode.lives;
            
            // Kalplerin görünürlüğünü kontrol et
            // Sadece: (Mod: "hayat") VEYA (Mod: "zorluk" VE zorluk: "zor")
            const duolingoHearts = document.getElementById('duolingoHearts');
            const shouldShowHearts = (currentMode === 'hayat') || (currentMode === 'zorluk' && currentDifficulty === 'zor');
            
            if (duolingoHearts) {
                if (shouldShowHearts && lives > 0) {
                    duolingoHearts.style.display = 'flex';
                    // Kalpleri başlangıç değerine ayarla
                    const heartSpans = duolingoHearts.querySelectorAll('span');
                    heartSpans.forEach((heart, index) => {
                        if (index < lives) {
                            heart.style.opacity = '1';
                        } else {
                            heart.style.opacity = '0.3';
                        }
                    });
                } else {
                    duolingoHearts.style.display = 'none';
                }
            }
            
            if (lives > 0) {
                if (elements.livesDisplay) elements.livesDisplay.style.display = 'block';
                if (elements.lives) elements.lives.textContent = lives;
            } else {
                if (elements.livesDisplay) elements.livesDisplay.style.display = 'none';
            }

            if (mode.timeLimit > 0) {
                if (elements.timerDisplay) elements.timerDisplay.style.display = 'block';
            } else {
                if (elements.timerDisplay) elements.timerDisplay.style.display = 'none';
            }

            if (mode.showHint) {
                if (elements.hintBtn) elements.hintBtn.style.display = 'block';
            } else {
                if (elements.hintBtn) elements.hintBtn.style.display = 'none';
            }

            if (elements.currentMode) elements.currentMode.textContent = mode.name;

            // Session puanlarını sıfırla (global puanları koru)
            sessionScore = 0;
            sessionCorrect = 0;
            sessionWrong = 0;
            comboCount = 0;
            questionCount = 0;
            
            // Combo indicator'ı gizle
            hideCombo();
            
            // Geriye uyumluluk için eski değişkenleri de sıfırla
            score = 0;
            correct = 0;
            wrong = 0;
            
            // Cevap pozisyon geçmişini sıfırla (yeni oyun başladığında)
            recentAnswerPositions = [];

            updateUI();

            // Ekranları değiştir - Sadece Kelime Çevir oyunu başlat
            if (elements.modeSelector) elements.modeSelector.style.display = 'none';
            // Main menu'yu da gizle (eğer hala açıksa)
            if (elements.mainMenu) elements.mainMenu.style.display = 'none';
            if (elements.gameScreen) elements.gameScreen.style.display = 'block';
            
            // Navigasyon bar'ı gizle (oyun başladığında)
            hideBottomNavBar();
            
                // 🎮 Gesture sistemini başlat
                /* gestures removed per cleanup: swipe gestures intentionally disabled
                    Kept commented init call so code can be re-enabled in future if needed. */
                // initGameGestures();
            
            // ⚡ Speed animation ile yeni soruyu yükle
            if (elements.gameScreen) {
            addSpeedAnimation(elements.gameScreen, 'slide-up');
            }
            
            loadQuestion();
        };
        }

        // ============ AYARLARA DÖN ============
        if (elements.settingsBtn) {
            elements.settingsBtn.onclick = () => {
                stopTimer();
                elements.gameScreen.style.display = 'none';
                elements.modeSelector.style.display = 'block';
            };
        }

        // ============ SORU YÜKLEME (Kelime Çevir) ============
        function loadQuestion() {
            // Önceki ses varsa durdur
            stopCurrentAudio();
            
            log.debug('📚 === KELİME ÇEVİR SORU YÜKLENİYOR (AKILLI SEÇİM) ===');
            log.debug(`📊 Mevcut soru sayısı: ${questionCount}`);
            log.debug(`🎯 Mevcut mod: ${currentMode}`);
            log.debug(`🎯 Zorluk: ${currentDifficulty}`);
            
            const mode = CONFIG.gameModes[currentMode];
            log.debug(`📋 Mod detayları:`, mode);
            
            // Soru sayısı kontrolü - oyun bitirme
            if (questionCount >= mode.questionsPerLevel) {
                log.game(`🏁 === KELİME ÇEVİR OYUNU BİTTİ ===`);
                log.game(`✅ ${mode.questionsPerLevel} soru tamamlandı!`);
                log.game(`📊 Final session score: ${sessionScore}`);
                
                // Günlük görev ilerlemesini güncelle
                updateTaskProgress('kelimeCevir', sessionCorrect);
                
                // Session puanlarını global'e aktar
                log.game(`💰 Session puanları global'e aktarılıyor: ${sessionScore} puan`);
                addToGlobalPoints(sessionScore, sessionCorrect);
                
                // Direkt ana menüye dön (popup yok)
                log.debug(`🔄 Ana menüye dönülüyor...`);
                elements.gameScreen.style.display = 'none';
                elements.modeSelector.style.display = 'none';
                elements.mainMenu.style.display = 'block';
                
                // Navigasyon bar'ı göster (ana ekrana dönünce)
                showBottomNavBar();
                
                log.game(`✅ Kelime Çevir oyunu bitti ve ana menüye dönüldü!`);
                return;
            }

            // Can kontrolü
            if (mode.lives > 0 && lives <= 0) {
                log.game(`💀 Can bitti! Oyun sona eriyor...`);
                gameOver('Can bitti!');
                return;
            }

            log.debug(`🔍 Zorluk filtreleme başlıyor...`);
            log.debug(`🎯 Seçili zorluk: ${currentDifficulty}`);

            // Zorluk filtreleme
            const diffLevel = CONFIG.difficultyLevels[currentDifficulty];
            log.debug(`📋 Zorluk aralığı: ${diffLevel.minDiff}-${diffLevel.maxDiff}`);
            log.debug(`📦 Toplam kelime sayısı: ${kelimeBulData.length}`);

            let filteredData = kelimeBulData.filter(w => 
                w.difficulty >= diffLevel.minDiff && w.difficulty <= diffLevel.maxDiff
            );
            log.debug(`✅ Zorluk filtresi sonrası: ${filteredData.length} kelime`);

            // Mod özel zorluk kontrolü
            if (mode.minDifficulty) {
                log.debug(`📋 Mod minimum zorluk kontrolü: >= ${mode.minDifficulty}`);
                filteredData = filteredData.filter(w => w.difficulty >= mode.minDifficulty);
                log.debug(`✅ Mod filtresi sonrası: ${filteredData.length} kelime`);
            }

            if (filteredData.length === 0) {
                filteredData = kelimeBulData;
            }

            // AKILLI KELİME SEÇİMİ - Zorlanılan kelimeleri daha sık göster
            log.debug('🧠 Akıllı kelime seçimi başlıyor...');
            currentQuestion = selectIntelligentWord(filteredData);

            // SEÇİLEN KELİME DETAYLARI
            log.debug("===== SEÇİLEN KELİME =====");
            log.debug("Kelime:", currentQuestion.kelime);
            log.debug("Anlam:", currentQuestion.anlam);
            log.debug("Zorluk:", currentQuestion.difficulty);
            log.debug("ID:", currentQuestion.id);
            log.debug("Zorluk aralığı:", diffLevel.minDiff + "-" + diffLevel.maxDiff);
            const isInRange = currentQuestion.difficulty >= diffLevel.minDiff && currentQuestion.difficulty <= diffLevel.maxDiff;
            log.debug("Aralıkta mı:", isInRange ? "EVET" : "HAYIR");
            log.debug("========================");

            // UI güncelle
            elements.arabicWord.textContent = currentQuestion.kelime;
            elements.sureInfo.textContent = `ID: ${currentQuestion.id} | Zorluk: ${currentQuestion.difficulty} | Aralık: ${diffLevel.minDiff}-${diffLevel.maxDiff}`;

            // Seçenekler oluştur
            const wrongAnswers = getWrongAnswers(3);
            const allOptions = [
                { text: currentQuestion.anlam, correct: true },
                ...wrongAnswers.map(w => ({ text: w.anlam, correct: false }))
            ];

            // Akıllı karıştır (tahmin edilmesini zorlaştırmak için)
            smartShuffle(allOptions);

            // Seçenekleri göster - Duolingo Tarzı
            elements.options.innerHTML = '';
            allOptions.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'duolingo-option';
                // Türkçe kelimeler için özel class ekle (Arapça değilse)
                if (!isArabic(opt.text)) {
                    btn.classList.add('turkish-option');
                }
                btn.textContent = opt.text;
                
                // Touch event tracking (scroll/tap ayrımı için)
                let touchStart = { x: 0, y: 0, time: 0 };
                let isScrolling = false;
                
                // Masaüstü için onclick handler
                btn.onclick = () => {
                    if (!btn.classList.contains('disabled')) {
                        checkAnswer(btn, opt.correct);
                    }
                };
                
                // Mobil için touch event'leri
                btn.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    touchStart = {
                        x: touch.clientX,
                        y: touch.clientY,
                        time: Date.now()
                    };
                    isScrolling = false;
                }, { passive: true });
                
                btn.addEventListener('touchmove', (e) => {
                    if (touchStart.x !== 0 || touchStart.y !== 0) {
                        const touch = e.touches[0];
                        const deltaX = Math.abs(touch.clientX - touchStart.x);
                        const deltaY = Math.abs(touch.clientY - touchStart.y);
                        // 10px'den fazla hareket varsa scroll'dur
                        if (deltaX > 10 || deltaY > 10) {
                            isScrolling = true;
                        }
                    }
                }, { passive: true });
                
                btn.addEventListener('touchend', (e) => {
                    // Scroll yapıldıysa tıklamayı engelle
                    if (isScrolling) {
                        touchStart = { x: 0, y: 0, time: 0 };
                        isScrolling = false;
                        return;
                    }
                    
                    // Scroll değilse, tap olarak kabul et
                    const touch = e.changedTouches[0];
                    const deltaTime = Date.now() - touchStart.time;
                    const deltaX = Math.abs(touch.clientX - touchStart.x);
                    const deltaY = Math.abs(touch.clientY - touchStart.y);
                    
                    // Kısa süre (300ms) ve küçük hareket (10px) = tap
                    if (deltaTime < 300 && deltaX < 10 && deltaY < 10) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!btn.classList.contains('disabled')) {
                            checkAnswer(btn, opt.correct);
                        }
                    }
                    
                    touchStart = { x: 0, y: 0, time: 0 };
                    isScrolling = false;
                }, { passive: false });
                
                elements.options.appendChild(btn);
            });
            
            // Duolingo tarzı soru numarasını güncelle
            const duolingoQuestionNumber = document.getElementById('duolingoQuestionNumber');
            if (duolingoQuestionNumber) {
                duolingoQuestionNumber.textContent = `Soru ${questionCount + 1} / ${mode.questionsPerLevel}`;
            }
            
            // Duolingo tarzı ilerleme çubuğunu güncelle
            const duolingoProgressBar = document.getElementById('duolingoProgressBar');
            if (duolingoProgressBar) {
                const progress = ((questionCount + 1) / mode.questionsPerLevel) * 100;
                duolingoProgressBar.style.width = progress + '%';
            }
            
            // Kalplerin görünürlüğünü kontrol et (her soru yüklendiğinde)
            const duolingoHearts = document.getElementById('duolingoHearts');
            const shouldShowHearts = (currentMode === 'hayat') || (currentMode === 'zorluk' && currentDifficulty === 'zor');
            if (duolingoHearts) {
                if (shouldShowHearts && mode.lives > 0) {
                    duolingoHearts.style.display = 'flex';
                    // Kalpleri güncelle
                    const heartSpans = duolingoHearts.querySelectorAll('span');
                    heartSpans.forEach((heart, index) => {
                        if (index < lives) {
                            heart.style.opacity = '1';
                        } else {
                            heart.style.opacity = '0.3';
                        }
                    });
                } else {
                    duolingoHearts.style.display = 'none';
                }
            }

            // Sıfırla
            elements.feedback.textContent = '';
            elements.feedback.className = 'feedback';
            elements.nextBtn.style.display = 'none';
            elements.hintBtn.disabled = false;
            
            // Tüm butonları aktif et
            const allBtns = document.querySelectorAll('.duolingo-option, .option');
            allBtns.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('disabled', 'correct', 'wrong');
            });

            // İlerleme güncelle
            updateProgress();

            // Süreyi başlat
            if (mode.timeLimit > 0) {
                startTimer(mode.timeLimit);
            }

            // Arapça hareke renklerini uygula
            setTimeout(() => {
                updateArabicTextColoring();
            }, 100);
        }

        // ============ YANLIŞ CEVAPLAR ============
        function getWrongAnswers(count) {
            const wrong = [];
            const filtered = kelimeBulData.filter(w => w.id !== currentQuestion.id);
            
            while (wrong.length < count && filtered.length > 0) {
                const idx = Math.floor(Math.random() * filtered.length);
                const word = filtered[idx];
                
                if (!wrong.find(w => w.anlam === word.anlam)) {
                    wrong.push(word);
                }
                filtered.splice(idx, 1);
            }
            
            return wrong;
        }

        // ============ KARIŞTIR ============
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        // ============ AKILLI CEVAP POZİSYONU SEÇİMİ ============
        // Kullanıcının tahmin etmesini zorlaştırmak için akıllı pozisyon seçimi
        function getSmartAnswerPosition(totalOptions = 4) {
            // Son pozisyonları kontrol et
            const positionCounts = [0, 0, 0, 0]; // Her pozisyonun son 10 sorudaki görünme sayısı
            
            recentAnswerPositions.forEach(pos => {
                if (pos >= 0 && pos < totalOptions) {
                    positionCounts[pos]++;
                }
            });
            
            // En az kullanılan pozisyonları bul
            const minCount = Math.min(...positionCounts);
            const leastUsedPositions = positionCounts
                .map((count, index) => ({ count, index }))
                .filter(item => item.count === minCount)
                .map(item => item.index);
            
            // Son pozisyonu kontrol et - üst üste aynı pozisyonda gelmesin
            const lastPosition = recentAnswerPositions.length > 0 ? recentAnswerPositions[recentAnswerPositions.length - 1] : -1;
            const availablePositions = leastUsedPositions.filter(pos => pos !== lastPosition);
            
            // Eğer son pozisyon hariç en az kullanılan pozisyon varsa, onu kullan
            let selectedPosition;
            if (availablePositions.length > 0) {
                selectedPosition = availablePositions[Math.floor(Math.random() * availablePositions.length)];
            } else if (leastUsedPositions.length > 0) {
                // Son pozisyon hariç seçenek yoksa, en az kullanılanlardan rastgele seç
                selectedPosition = leastUsedPositions[Math.floor(Math.random() * leastUsedPositions.length)];
            } else {
                // Fallback: tamamen rastgele
                selectedPosition = Math.floor(Math.random() * totalOptions);
            }
            
            // Pozisyon geçmişine ekle
            recentAnswerPositions.push(selectedPosition);
            if (recentAnswerPositions.length > MAX_POSITION_HISTORY) {
                recentAnswerPositions.shift(); // En eski pozisyonu çıkar
            }
            
            return selectedPosition;
        }
        
        // Akıllı karıştırma - doğru cevabı belirli pozisyona yerleştir
        function smartShuffle(options) {
            // Doğru cevabı bul
            const correctIndex = options.findIndex(opt => opt.correct === true);
            if (correctIndex === -1) {
                // Doğru cevap bulunamadıysa normal karıştır
                shuffle(options);
                return;
            }
            
            // Doğru cevabı çıkar
            const correctAnswer = options.splice(correctIndex, 1)[0];
            
            // Yanlış cevapları karıştır
            shuffle(options);
            
            // Akıllı pozisyon seç
            const targetPosition = getSmartAnswerPosition(options.length + 1);
            
            // Doğru cevabı hedef pozisyona yerleştir
            options.splice(targetPosition, 0, correctAnswer);
        }

        // ============ CEVAP KONTROL ============
        function checkAnswer(button, isCorrect) {
            log.game(`🚨 === KELİME ÇEVİR CEVAP KONTROLÜ ===`);
            log.game(`👆 Tıklanan buton: "${button.textContent}"`);
            log.game(`✅/❌ isCorrect parametresi: ${isCorrect}`);
            log.game(`📊 Mevcut soru: #${questionCount + 1}`);
            log.game(`📊 Önce - session: score=${sessionScore}, correct=${sessionCorrect}, wrong=${sessionWrong}`);
            log.game(`📊 Önce - kelime çevir: score=${score}, correct=${correct}, wrong=${wrong}`);
            
            stopTimer();
            
            // Tüm butonları kapat - Duolingo tarzı
            const allBtns = document.querySelectorAll('.duolingo-option, .option');
            log.game(`🔒 ${allBtns.length} buton devre dışı bırakılıyor...`);
            allBtns.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled');
            });

            const mode = CONFIG.gameModes[currentMode];
            const diffLevel = CONFIG.difficultyLevels[currentDifficulty];
            log.game(`🎯 Mod: ${currentMode}, Zorluk: ${currentDifficulty}`);

            // KELİME İSTATİSTİKLERİNİ GÜNCELLE
            log.game(`📊 Kelime istatistiği güncelleniyor: ${currentQuestion.kelime} (ID: ${currentQuestion.id})`);
            updateWordStats(currentQuestion.id, isCorrect);

            if (isCorrect) {
                log.game(`✅ === SAHİH CEVAP İŞLEMİ ===`);
                button.classList.add('correct');
                if (elements.feedback) {
                elements.feedback.textContent = '✅ Mâşâallah!';
                elements.feedback.className = 'feedback correct';
                }
                
                // 🎆 SUCCESS ANIMATIONS & FEEDBACK
                triggerSuccessBurst(button);
                triggerHaptic('success');
                if (elements.feedback) {
                addSpeedAnimation(elements.feedback, 'bounce-in');
                }
                
                // Combo sistemi için confetti
                if (comboCount >= 2) {
                    triggerConfetti();
                    triggerHaptic('combo');
                }
                
                const points = currentQuestion.difficulty * diffLevel.pointsMultiplier;
                log.game(`💰 Puan hesaplama: ${currentQuestion.difficulty} × ${diffLevel.pointsMultiplier} = ${points} puan`);
                log.game(`📊 addSessionPoints(${points}) çağrılıyor...`);
                addSessionPoints(points); // Session puanına ekle
                
                // Daily task progress - her doğru cevap için
                updateTaskProgress('kelimeCevir', 1);
                
                // Perfect streak kontrolü - hiç yanlış yapmamışsak perfect streak artır
                if (sessionWrong === 0) {
                    updateTaskProgress('perfectStreak', 1);
                    log.game(`🔥 Perfect streak artırıldı! Mevcut: ${dailyTasks.todayStats.perfectStreak}`);
                }
                
                log.game(`✅ Doğru cevap işlemi tamamlandı!`);
                
                updateUI();
            } else {
                log.game(`❌ === HATA CEVAP İŞLEMİ ===`);
                button.classList.add('wrong');
                if (elements.feedback) {
                elements.feedback.textContent = `❌ Hatalı! Sahih: ${currentQuestion.anlam}`;
                elements.feedback.className = 'feedback wrong';
                }
                
                // 📱 ERROR FEEDBACK
                triggerHaptic('error');
                if (elements.feedback) {
                addSpeedAnimation(elements.feedback, 'zoom-in');
                }
                
                log.game(`📊 addSessionWrong() çağrılıyor...`);
                addSessionWrong(); // Session yanlış sayısını artır
                
                log.game(`💸 Puan cezası uygulanıyor: ${CONFIG.wrongAnswerPenalty} puan`);
                log.game(`📊 Eski score: ${score}`);
                // Puan cezası
                score = Math.max(0, score - CONFIG.wrongAnswerPenalty);
                log.game(`📊 Yeni score: ${score}`);
                
                // Can kaybı
                if (mode.lives > 0) {
                    log.game(`💀 Can kaybı: ${lives} - 1 = ${lives - 1}`);
                    lives--;
                    if (elements.lives) {
                    elements.lives.textContent = lives;
                    }
                    // Duolingo tarzı kalpleri güncelle (sadece görünürse)
                    const duolingoHearts = document.getElementById('duolingoHearts');
                    if (duolingoHearts && duolingoHearts.style.display !== 'none') {
                        const heartSpans = duolingoHearts.querySelectorAll('span');
                        heartSpans.forEach((heart, index) => {
                            if (index < lives) {
                                heart.style.opacity = '1';
                            } else {
                                heart.style.opacity = '0.3';
                            }
                        });
                    }
                    
                    if (lives <= 0) {
                        setTimeout(() => gameOver('Canlarınız bitti!'), 1500);
                    }
                }

                updateUI();

                // Doğru cevabı göster
                allBtns.forEach(btn => {
                    if (btn.textContent.includes(currentQuestion.anlam)) {
                        btn.classList.add('correct');
                    }
                });
            }

            questionCount++;
            // Show the next button (Kelime)
            try {
                if (elements && elements.nextBtn) {
                    elements.nextBtn.style.display = 'block';
                    elements.nextBtn.style.visibility = 'visible';
                    elements.nextBtn.removeAttribute('hidden');
                    elements.nextBtn.removeAttribute('aria-hidden'); // Görünür buton için aria-hidden kaldırılmalı

                    // 🔥 Animasyonu ekle
        elements.nextBtn.classList.add("next-appear");
                    // Ensure it's visible on small viewports by scrolling it into view
                    setTimeout(() => {
                        try {
                            elements.nextBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        } catch (e) {
                            log.warn('scrollIntoView failed:', e);
                        }
                    }, 60);
                } else {
                    log.warn('elements.nextBtn is not available to show');
                }
            } catch (err) {
                log.error('Error while showing nextBtn for Kelime:', err);
            }
        }

        // ============ SES ÇALMA ============
        if (elements.audioBtn) {
            // Masaüstü için onclick
        elements.audioBtn.onclick = () => {
            if (currentQuestion && currentQuestion.ses_dosyasi) {
                playAudio(currentQuestion.ses_dosyasi, elements.audioBtn);
            }
        };
            // Mobil için touchend
            elements.audioBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (currentQuestion && currentQuestion.ses_dosyasi) {
                    playAudio(currentQuestion.ses_dosyasi, elements.audioBtn);
                }
            }, { passive: false });
        }

        // ============ SONRAKİ SORU ============
        if (elements.nextBtn) {
            // Masaüstü için onclick
        elements.nextBtn.onclick = () => {
            // ⚡ Speed animation ve haptic feedback
            addSpeedAnimation(elements.gameScreen, 'fade-in');
            triggerHaptic('light');
            
            // Butonu hemen gizle
                if (elements.nextBtn) {
            elements.nextBtn.style.display = 'none';
            elements.nextBtn.style.visibility = 'hidden';
            // display: none olduğunda aria-hidden gerekmez, zaten erişilebilirlik ağacından çıkar
            elements.nextBtn.classList.remove("next-appear");
                }
            
            loadQuestion();
        };
            // Mobil için touchend
            elements.nextBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // ⚡ Speed animation ve haptic feedback
                addSpeedAnimation(elements.gameScreen, 'fade-in');
                triggerHaptic('light');
                
                // Butonu hemen gizle
                if (elements.nextBtn) {
                    elements.nextBtn.style.display = 'none';
                    elements.nextBtn.style.visibility = 'hidden';
                    elements.nextBtn.classList.remove("next-appear");
                }
                
                loadQuestion();
            }, { passive: false });
        }

        // ============ İLERLEME GÜNCELLE ============
        function updateProgress() {
            const mode = CONFIG.gameModes[currentMode];
            const progress = (questionCount / mode.questionsPerLevel) * 100;
            if (elements.progressBar) {
                elements.progressBar.style.width = `${progress}%`;
            }
        }

        // ============ UI GÜNCELLE ============
        function updateUI() {
            // Alt bar: Sadece session (oyun içi) puanları göster
            if (elements.score) elements.score.textContent = sessionScore;
            if (elements.correct) elements.correct.textContent = sessionCorrect;
            if (elements.wrong) elements.wrong.textContent = sessionWrong;
            // level elementi artık yok (Mertebe kaldırıldı), bu yüzden güncelleme yapılmıyor
        }

        // ============ SÜRE YÖNETİMİ ============
        function startTimer(seconds) {
            stopTimer();
            timeLeft = seconds;
            
            // Timer elementini kontrol et
            if (elements.timer) {
                elements.timer.textContent = timeLeft;
            }
            
            timer = setInterval(() => {
                timeLeft--;
                
                // Timer elementini sadece varsa güncelle
                if (elements.timer) {
                    elements.timer.textContent = timeLeft;
                }
                
                if (timeLeft <= 0) {
                    stopTimer();
                    gameOver('Süre doldu!');
                }
            }, 1000);
        }

        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        // ============ İPUCU ============
        if (elements.hintBtn) {
            const handleHint = () => {
                // currentQuestion kontrolü
                if (!currentQuestion || !currentQuestion.anlam) {
                    console.warn('⚠️ İpucu: currentQuestion bulunamadı!');
                    return;
                }
                
                // Bir yanlış cevabı kaldır - Duolingo tarzı butonlar için
                // Sadece game-screen içindeki butonları ara
                const gameScreen = document.getElementById('gameScreen');
                if (!gameScreen) {
                    console.warn('⚠️ İpucu: gameScreen bulunamadı!');
                    return;
                }
                
                const allBtns = gameScreen.querySelectorAll('.duolingo-option, .option');
                const wrongBtns = Array.from(allBtns).filter(btn => {
                    if (btn.disabled) return false;
                    const btnText = btn.textContent || btn.innerText || '';
                    // Doğru cevabı içermeyen butonları bul
                    return !btnText.includes(currentQuestion.anlam);
                });
            
            if (wrongBtns.length > 0) {
                const randomWrong = wrongBtns[Math.floor(Math.random() * wrongBtns.length)];
                randomWrong.style.opacity = '0.3';
                randomWrong.disabled = true;
                    randomWrong.classList.add('disabled');
                
                // İpucu puan cezası
                score = Math.max(0, score - 10);
                updateUI();
                
                    if (elements.hintBtn) {
                elements.hintBtn.disabled = true;
                    }
                } else {
                    console.warn('⚠️ İpucu: Yanlış buton bulunamadı!');
                }
            };
            // Masaüstü için onclick
            elements.hintBtn.onclick = handleHint;
            // Mobil için touchend
            elements.hintBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                handleHint();
            }, { passive: false });
        }

        // ============ SEVİYE ATLAMA ============
        function showLevelUpModal(newLevel) {
            elements.newLevel.textContent = newLevel;
            
            // Modal için ek bilgileri güncelle
            const modalTotalPoints = document.getElementById('modalTotalPoints');
            const modalNextLevelPoints = document.getElementById('modalNextLevelPoints');
            
            if (modalTotalPoints && modalNextLevelPoints) {
                modalTotalPoints.textContent = totalPoints.toLocaleString();
                modalNextLevelPoints.textContent = getNextLevelRequiredPoints(newLevel).toLocaleString();
            }
            
            // Seviye atlama sesi çal
            playSound('levelup');
            
            // Konfeti efekti başlat!
            createConfetti();
            
            elements.modal.style.display = 'flex';
        }
        
        function createConfetti() {
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: fixed;
                        width: 10px;
                        height: 10px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        left: ${Math.random() * 100}%;
                        top: -10px;
                        opacity: 1;
                        transform: rotate(${Math.random() * 360}deg);
                        z-index: 10000;
                        pointer-events: none;
                        border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                    `;
                    
                    document.body.appendChild(confetti);
                    
                    const fall = confetti.animate([
                        { 
                            transform: `translateY(0) rotate(${Math.random() * 360}deg)`,
                            opacity: 1
                        },
                        { 
                            transform: `translateY(${window.innerHeight + 20}px) rotate(${Math.random() * 360 + 720}deg)`,
                            opacity: 0
                        }
                    ], {
                        duration: 2000 + Math.random() * 1000,
                        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                    });
                    
                    fall.onfinish = () => confetti.remove();
                }, i * 30);
            }
        }

        // NOTE: eski levelUp fonksiyonu kaldırıldı (unused)

        // ============ OYUN BİTTİ ============
        function gameOver(reason) {
            stopTimer();
            
            // Session puanlarını global'e aktar
            addToGlobalPoints(sessionScore, sessionCorrect);
            
            if (elements.gameOverTitle) elements.gameOverTitle.textContent = '😢 Oyun Bitti';
            if (elements.gameOverText) elements.gameOverText.textContent = reason;
            if (elements.finalScore) elements.finalScore.textContent = `Bu Oyun: ${sessionScore} puan\nToplam: ${totalPoints} puan`;
            if (elements.gameOverModal) elements.gameOverModal.style.display = 'block';
        }

        // ============ YENİDEN BAŞLAT ============
        elements.restartBtn.onclick = () => {
            if (elements.gameOverModal) elements.gameOverModal.style.display = 'none';
            if (elements.gameScreen) elements.gameScreen.style.display = 'none';
            if (elements.modeSelector) elements.modeSelector.style.display = 'none';
            if (elements.mainMenu) elements.mainMenu.style.display = 'block';
            if (elements.settingsBtn) elements.settingsBtn.style.display = 'none';
        };

        // ============ MODAL KAPAT ============
        elements.modalBtn.onclick = () => {
            if (elements.modal) elements.modal.style.display = 'none';
            // Sadece modal'ı kapat - seviye yükselme bilgilendirmesi için gereksiz işlem yapma
        };

        // ============ DİNLE VE BUL MODU ============
        let currentDinleQuestion = null;
        let dinleQuestionCount = 0;
        const DINLE_MAX_QUESTIONS = 10;
        
        // ============ SES TANIMA SİSTEMİ ============
        let recognition = null;
        let isListening = false;
        
        // Mikrofon iznini kontrol et
        async function checkMicrophonePermission() {
            try {
                // Permissions API desteği var mı? (Chrome/Edge için)
                if (navigator.permissions && navigator.permissions.query) {
                    try {
                        // Chrome/Edge için 'microphone' kullan
                        const permission = await navigator.permissions.query({ name: 'microphone' });
                        log.debug('Mikrofon izin durumu (Permissions API):', permission.state);
                        return permission.state;
                    } catch (permError) {
                        // Permissions API'de 'microphone' desteklenmiyorsa getUserMedia ile test et
                        log.debug('Permissions API mikrofon desteği yok, getUserMedia ile test ediliyor');
                    }
                }
                
                // Permissions API yoksa veya desteklenmiyorsa, getUserMedia ile test et
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        stream.getTracks().forEach(track => track.stop()); // Stream'i hemen kapat
                        log.debug('Mikrofon izin durumu (getUserMedia): granted');
                        return 'granted';
                    } catch (error) {
                        log.debug('Mikrofon izin hatası:', error.name, error.message);
                        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                            return 'denied';
                        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                            return 'not-found';
                        }
                        return 'prompt';
                    }
                }
                
                return 'unknown';
            } catch (error) {
                log.error('Mikrofon izin kontrolü hatası:', error);
                return 'unknown';
            }
        }
        
        // Mobil cihaz tespiti
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
        }
        
        // Web Speech API desteğini kontrol et ve başlat
        function initSpeechRecognition() {
            const isMobile = isMobileDevice();
            
            // HTTPS kontrolü (mobil cihazlarda daha esnek)
            const isSecureContext = location.protocol === 'https:' || 
                                   location.hostname === 'localhost' || 
                                   location.hostname === '127.0.0.1' ||
                                   location.hostname === '0.0.0.0' ||
                                   window.isSecureContext;
            
            if (!isSecureContext) {
                log.warn('Ses tanıma için HTTPS gerekli');
                const micBtn = document.getElementById('dinleMicBtn');
                const statusEl = document.getElementById('speechStatus');
                if (micBtn) {
                    micBtn.style.display = 'none';
                }
                if (statusEl) {
                    if (isMobile) {
                        statusEl.textContent = '⚠️ Ses tanıma için güvenli bağlantı gerekli. Lütfen HTTPS üzerinden erişin veya uygulamayı ana ekrana ekleyin.';
                    } else {
                        statusEl.textContent = '⚠️ Ses tanıma için HTTPS gerekli';
                    }
                    statusEl.style.color = '#f39c12';
                }
                return false;
            }
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                log.warn('Ses tanıma API desteği yok');
                const micBtn = document.getElementById('dinleMicBtn');
                const statusEl = document.getElementById('speechStatus');
                if (micBtn) {
                    micBtn.style.display = 'none';
                }
                if (statusEl) {
                    if (isMobile) {
                        statusEl.textContent = '⚠️ Bu tarayıcı ses tanımayı desteklemiyor. Chrome veya Safari kullanmayı deneyin.';
                    } else {
                        statusEl.textContent = '⚠️ Bu tarayıcı ses tanımayı desteklemiyor. Chrome veya Edge kullanmayı deneyin.';
                    }
                    statusEl.style.color = '#f39c12';
                }
                return false;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            // Dinle ve Bul modu Arapça telaffuz beklediğinden varsayılan dil Arapça (Suudi Arabistan)
            // Web Speech API tek dil kabul ettiği için önceden verilen "tr-TR,ar-SA" değeri tarayıcının İngilizceye dönmesine neden olabiliyordu.
            // İleride kullanıcı dil seçimi eklenene kadar lokalStorage üzerinden override imkanı bırakıyoruz.
            const speechLang = localStorage.getItem('speechRecognitionLang') || 'ar-SA';
            recognition.lang = speechLang;
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.maxAlternatives = 3;
            
            recognition.onstart = () => {
                isListening = true;
                const statusEl = document.getElementById('speechStatus');
                const micBtn = document.getElementById('dinleMicBtn');
                if (statusEl) {
                    statusEl.textContent = '🎤 Dinleniyor...';
                    statusEl.style.color = '#667eea';
                }
                if (micBtn) {
                    micBtn.style.background = 'linear-gradient(135deg, #f44336 0%, #e91e63 100%)';
                    micBtn.style.transform = 'scale(1.1)';
                }
                triggerHaptic('light');
            };
            
            recognition.onresult = (event) => {
                const results = event.results;
                let recognizedText = '';
                
                // En iyi sonucu al
                for (let i = 0; i < results.length; i++) {
                    recognizedText = results[i][0].transcript.trim();
                    log.debug('Ses tanıma sonucu:', recognizedText);
                }
                
                // Kelimeyi bul ve eşleştir
                if (recognizedText && currentDinleQuestion) {
                    matchSpeechToAnswer(recognizedText);
                }
            };
            
            recognition.onerror = (event) => {
                isListening = false;
                const statusEl = document.getElementById('speechStatus');
                const micBtn = document.getElementById('dinleMicBtn');
                
                let errorMsg = 'Ses tanıma hatası';
                let helpText = '';
                
                if (event.error === 'no-speech') {
                    errorMsg = 'Konuşma algılanamadı';
                    helpText = 'Daha yüksek sesle konuşmayı deneyin';
                } else if (event.error === 'audio-capture') {
                    errorMsg = 'Mikrofon bulunamadı';
                    helpText = 'Mikrofonun bağlı olduğundan emin olun. Bluetooth kulaklık kullanıyorsanız, sistem ayarlarından mikrofonu seçtiğinizden emin olun.';
                } else if (event.error === 'not-allowed') {
                    errorMsg = 'Mikrofon izni verilmedi';
                    helpText = 'Tarayıcı ayarlarından mikrofon izni verin';
                } else if (event.error === 'aborted') {
                    errorMsg = 'Ses tanıma durduruldu';
                    helpText = '';
                } else if (event.error === 'network') {
                    errorMsg = 'Bağlantı hatası';
                    helpText = 'Ses tanıma servisine bağlanılamıyor. İnternet bağlantınızı kontrol edin veya birkaç saniye sonra tekrar deneyin.';
                } else {
                    // Bilinmeyen hata
                    errorMsg = 'Ses tanıma hatası';
                    helpText = `Hata kodu: ${event.error}. Lütfen sayfayı yenileyip tekrar deneyin.`;
                }
                
                if (statusEl) {
                    statusEl.innerHTML = '❌ ' + errorMsg + (helpText ? '<br><small style="font-size: 0.75em; margin-top: 4px; display: block;">' + helpText + '</small>' : '');
                    statusEl.style.color = '#f44336';
                    
                    // Network hatası için yardım butonu ekle
                    if (event.error === 'network') {
                        const retryBtn = document.createElement('button');
                        retryBtn.textContent = '🔄 Tekrar Dene';
                        retryBtn.style.cssText = 'margin-top: 8px; padding: 6px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; font-weight: 600;';
                        retryBtn.onclick = () => {
                            statusEl.innerHTML = '🔄 Tekrar deneniyor...';
                            statusEl.style.color = '#f39c12';
                            setTimeout(() => {
                                if (window.startSpeechRecognition) {
                                    window.startSpeechRecognition();
                                }
                            }, 500);
                        };
                        // Önceki butonu kaldır
                        const oldBtn = statusEl.querySelector('button');
                        if (oldBtn) oldBtn.remove();
                        statusEl.appendChild(retryBtn);
                    }
                }
                if (micBtn) {
                    micBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    micBtn.style.transform = 'scale(1)';
                }
                
                log.error('Ses tanıma hatası:', event.error, event);
                triggerHaptic('error');
                
                // İzin hatası ise kullanıcıya yardım göster
                if (event.error === 'not-allowed') {
                    setTimeout(() => {
                        showMicrophonePermissionHelp();
                    }, 1000);
                } else if (event.error === 'audio-capture') {
                    // Mikrofon bulunamadı hatası için Bluetooth yardımı göster
                    setTimeout(() => {
                        showBluetoothMicrophoneHelp();
                    }, 1500);
                } else if (event.error === 'network') {
                    // Network hatası için de yardım göster
                    setTimeout(() => {
                        showNetworkErrorHelp();
                    }, 1500);
                }
            };
            
            recognition.onend = () => {
                isListening = false;
                const micBtn = document.getElementById('dinleMicBtn');
                if (micBtn) {
                    micBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    micBtn.style.transform = 'scale(1)';
                }
                // Stream'i temizle (Bluetooth mikrofon için)
                if (microphoneStream) {
                    microphoneStream.getTracks().forEach(track => track.stop());
                    microphoneStream = null;
                }
            };
            
            return true;
        }
        
        // Bluetooth mikrofon yardımı göster
        function showBluetoothMicrophoneHelp() {
            const helpMsg = `<div style="text-align: left; line-height: 1.6; font-size: 0.9em; padding: 10px 0;">
<strong style="color: #667eea; font-size: 1.1em;">🎧 Bluetooth Mikrofon Sorunu</strong><br><br>

<strong style="color: #333;">1️⃣ Sistem Ayarları:</strong><br>
• <strong>Windows:</strong> Ayarlar > Sistem > Ses > Giriş > Bluetooth kulaklığınızı seçin<br>
• <strong>Mac:</strong> Sistem Tercihleri > Ses > Giriş > Bluetooth kulaklığınızı seçin<br>
• <strong>Android:</strong> Ayarlar > Bağlantılar > Bluetooth > Kulaklık ayarları > Mikrofon izni<br>
• <strong>iOS:</strong> Ayarlar > Bluetooth > Kulaklık > Mikrofon izni<br><br>

<strong style="color: #333;">2️⃣ Tarayıcı Ayarları:</strong><br>
• Chrome/Edge: Adres çubuğundaki 🔒 simgesine tıklayın<br>
• "Mikrofon" iznini <strong>"İzin ver"</strong> yapın<br>
• Sayfayı yenileyin (F5)<br><br>

<strong style="color: #333;">3️⃣ Bluetooth Bağlantısı:</strong><br>
• Bluetooth kulaklığın tam olarak bağlı olduğundan emin olun<br>
• Kulaklığı çıkarıp tekrar takmayı deneyin<br>
• Bluetooth'u kapatıp açmayı deneyin<br><br>

<strong style="color: #333;">4️⃣ Alternatif Çözüm:</strong><br>
• Bilgisayarın dahili mikrofonunu kullanmayı deneyin<br>
• Farklı bir Bluetooth kulaklık deneyin<br>
• Manuel olarak cevap seçeneklerinden birini seçebilirsiniz<br><br>

<small style="color: #666;">💡 <strong>Not:</strong> Bazı Bluetooth kulaklıklar sadece ses çıkışı için tasarlanmıştır ve mikrofon özelliği olmayabilir.</small>
</div>`;
            showCustomAlert(helpMsg, 'warning', '🎧 Bluetooth Mikrofon');
        }
        
        // Network hatası yardımı göster
        function showNetworkErrorHelp() {
            const helpMsg = `<div style="text-align: left; line-height: 1.6; font-size: 0.9em; padding: 10px 0;">
<strong style="color: #667eea; font-size: 1.1em;">🌐 Bağlantı Hatası Çözümleri</strong><br><br>

<strong style="color: #333;">1️⃣ İnternet Bağlantısını Kontrol Edin:</strong><br>
• WiFi veya mobil veri bağlantınızın aktif olduğundan emin olun<br>
• Başka bir web sitesine bağlanmayı deneyin<br>
• Modemi yeniden başlatmayı deneyin<br><br>

<strong style="color: #333;">2️⃣ Tarayıcı Ayarları:</strong><br>
• Sayfayı yenileyin (F5 veya Cmd+R)<br>
• Tarayıcı önbelleğini temizleyin<br>
• Farklı bir tarayıcı deneyin (Chrome, Edge, Firefox)<br><br>

<strong style="color: #333;">3️⃣ Güvenlik Duvarı / VPN:</strong><br>
• VPN kullanıyorsanız kapatmayı deneyin<br>
• Güvenlik duvarının ses tanıma servisini engellemediğinden emin olun<br><br>

<strong style="color: #333;">4️⃣ Alternatif Çözüm:</strong><br>
• Birkaç saniye bekleyip tekrar deneyin<br>
• Ses tanıma servisi geçici olarak kullanılamıyor olabilir<br>
• Manuel olarak cevap seçeneklerinden birini seçebilirsiniz<br><br>

<small style="color: #666;">💡 <strong>Not:</strong> Web Speech API, Google'ın ses tanıma servisini kullanır ve aktif internet bağlantısı gerektirir.</small>
</div>`;
            showCustomAlert(helpMsg, 'warning', '🌐 Bağlantı Sorunu');
        }
        
        // Mikrofon izin yardımı göster
        function showMicrophonePermissionHelp() {
            const helpMsg = `<div style="text-align: left; line-height: 1.6; font-size: 0.9em; padding: 10px 0;">
<strong style="color: #667eea; font-size: 1.1em;">🎤 Mikrofon İzni Nasıl Verilir?</strong><br><br>

<strong style="color: #333;">🌐 Chrome/Edge:</strong><br>
1️⃣ Adres çubuğundaki <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">🔒</span> veya <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">🎤</span> simgesine tıklayın<br>
2️⃣ "Mikrofon" seçeneğini <strong>"İzin ver"</strong> yapın<br>
3️⃣ Sayfayı yenileyin (F5)<br><br>

<strong style="color: #333;">🍎 Safari:</strong><br>
1️⃣ <strong>Safari</strong> > <strong>Ayarlar</strong> > <strong>Web Siteleri</strong> > <strong>Mikrofon</strong><br>
2️⃣ Bu site için <strong>"İzin ver"</strong> seçin<br>
3️⃣ Sayfayı yenileyin (Cmd+R)<br><br>

<strong style="color: #333;">🦊 Firefox:</strong><br>
1️⃣ Adres çubuğundaki <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">🔒</span> simgesine tıklayın<br>
2️⃣ "İzinler" bölümünde <strong>"Mikrofon"</strong>u <strong>"İzin ver"</strong> yapın<br>
3️⃣ Sayfayı yenileyin (F5)<br><br>

<small style="color: #666;">💡 <strong>Not:</strong> İzin verdikten sonra sayfayı yenilemeyi unutmayın!</small>
</div>`;
            showCustomAlert(helpMsg, 'info', '🎤 Mikrofon İzni Gerekli');
        }
        
        // Mikrofon stream'i (Bluetooth mikrofon desteği için)
        let microphoneStream = null;
        
        // Ses tanımayı başlat (global erişim için)
        window.startSpeechRecognition = async function() {
            if (!currentDinleQuestion) {
                showCustomAlert('Önce bir soru yüklenmeli!', 'warning');
                return;
            }
            
            if (isListening) {
                // Eğer zaten dinleniyorsa durdur
                if (recognition) {
                    recognition.stop();
                }
                if (microphoneStream) {
                    microphoneStream.getTracks().forEach(track => track.stop());
                    microphoneStream = null;
                }
                return;
            }
            
            // İzin kontrolü
            const statusEl = document.getElementById('speechStatus');
            if (statusEl) {
                statusEl.textContent = '🔍 Mikrofon hazırlanıyor...';
                statusEl.style.color = '#f39c12';
            }
            
            const permission = await checkMicrophonePermission();
            if (permission === 'denied') {
                if (statusEl) {
                    statusEl.textContent = '❌ Mikrofon izni reddedildi';
                    statusEl.style.color = '#f44336';
                }
                showMicrophonePermissionHelp();
                return;
            } else if (permission === 'not-found') {
                if (statusEl) {
                    statusEl.textContent = '❌ Mikrofon bulunamadı';
                    statusEl.style.color = '#f44336';
                }
                showCustomAlert('Mikrofon cihazı bulunamadı. Lütfen mikrofonun bağlı olduğundan emin olun.', 'error');
                return;
            } else if (permission === 'unknown') {
                // Bilinmeyen durum - yine de denemeye devam et
                log.warn('Mikrofon izin durumu bilinmiyor, denemeye devam ediliyor');
            }
            
            // Mobil cihaz tespiti
            const isMobile = isMobileDevice();
            
            // Mobil cihazlarda getUserMedia'ya gerek olmayabilir (direkt Speech Recognition çalışabilir)
            // Ancak masaüstünde Bluetooth mikrofon için getUserMedia gerekli
            const needsGetUserMedia = !isMobile; // Masaüstünde getUserMedia kullan
            
            if (needsGetUserMedia && navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // Bluetooth mikrofon desteği: getUserMedia ile mikrofonu aktif hale getir (sadece masaüstü)
                try {
                    if (statusEl) {
                        statusEl.textContent = '🎤 Mikrofon bağlanıyor...';
                        statusEl.style.color = '#f39c12';
                    }
                    
                    // Önceki stream varsa kapat
                    if (microphoneStream) {
                        microphoneStream.getTracks().forEach(track => track.stop());
                    }
                    
                    // Mikrofonu aktif hale getir (Bluetooth dahil tüm mikrofonlar için)
                    microphoneStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            // Tüm mikrofonları kabul et (Bluetooth dahil)
                            sampleRate: 44100
                        } 
                    });
                    
                    const audioTracks = microphoneStream.getAudioTracks();
                    const trackInfo = audioTracks.map(t => ({
                        label: t.label,
                        kind: t.kind,
                        enabled: t.enabled,
                        readyState: t.readyState
                    }));
                    
                    log.debug('Mikrofon stream aktif:', trackInfo);
                    
                    // Kullanıcıya hangi mikrofonun kullanıldığını göster
                    const micLabel = audioTracks[0]?.label || 'Bilinmeyen mikrofon';
                    const isBluetooth = micLabel.toLowerCase().includes('bluetooth') || 
                                       micLabel.toLowerCase().includes('bt') ||
                                       micLabel.toLowerCase().includes('wireless');
                    
                    if (statusEl) {
                        if (isBluetooth) {
                            statusEl.innerHTML = `✅ Bluetooth mikrofon hazır: <small style="font-size: 0.75em; color: #666;">${micLabel}</small>`;
                        } else {
                            statusEl.innerHTML = `✅ Mikrofon hazır: <small style="font-size: 0.75em; color: #666;">${micLabel}</small>`;
                        }
                        statusEl.style.color = '#4caf50';
                    }
                    
                    // Kısa bir gecikme ile Speech Recognition'ı başlat
                    // (Mikrofonun tam olarak hazır olması için)
                    await new Promise(resolve => setTimeout(resolve, 300));
                } catch (mediaError) {
                    log.error('Mikrofon erişim hatası:', mediaError);
                    if (statusEl) {
                        statusEl.textContent = '❌ Mikrofon erişilemedi';
                        statusEl.style.color = '#f44336';
                    }
                    
                    if (mediaError.name === 'NotAllowedError' || mediaError.name === 'PermissionDeniedError') {
                        showMicrophonePermissionHelp();
                    } else if (mediaError.name === 'NotFoundError' || mediaError.name === 'DevicesNotFoundError') {
                        showBluetoothMicrophoneHelp();
                    } else {
                        showCustomAlert('Mikrofon erişilemedi. Bluetooth kulaklık kullanıyorsanız, sistem ayarlarından mikrofonu seçtiğinizden emin olun.', 'error');
                    }
                    return;
                }
            } else if (isMobile) {
                // Mobil cihazlarda direkt Speech Recognition başlat (getUserMedia'ya gerek yok)
                if (statusEl) {
                    statusEl.textContent = '🎤 Hazırlanıyor...';
                    statusEl.style.color = '#f39c12';
                }
                // Kısa bir gecikme (mobil cihazlarda daha hızlı)
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    showCustomAlert('Ses tanıma özelliği bu tarayıcıda desteklenmiyor.', 'error');
                    return;
                }
            }
            
            try {
                if (statusEl) {
                    if (isMobile) {
                        statusEl.textContent = '🎤 Dinleniyor... (Mobil)';
                    } else {
                        statusEl.textContent = '🎤 Dinleniyor...';
                    }
                    statusEl.style.color = '#667eea';
                }
                recognition.start();
            } catch (error) {
                log.error('Ses tanıma başlatma hatası:', error);
                
                // Stream'i temizle
                if (microphoneStream) {
                    microphoneStream.getTracks().forEach(track => track.stop());
                    microphoneStream = null;
                }
                
                if (error.name === 'NotAllowedError' || error.message.includes('not allowed')) {
                    if (statusEl) {
                        statusEl.textContent = '❌ Mikrofon izni verilmedi';
                        statusEl.style.color = '#f44336';
                    }
                    showMicrophonePermissionHelp();
                } else {
                    if (isMobile) {
                        showCustomAlert('Ses tanıma başlatılamadı. Mobil cihazlarda genellikle daha iyi çalışır. Lütfen tekrar deneyin veya tarayıcı ayarlarından mikrofon iznini kontrol edin.', 'error');
                    } else {
                        showCustomAlert('Ses tanıma başlatılamadı. Lütfen tekrar deneyin.', 'error');
                    }
                }
            }
        };
        
        // Konuşulan metni cevaplarla eşleştir
        function matchSpeechToAnswer(spokenText) {
            const statusEl = document.getElementById('speechStatus');
            const allBtns = elements.dinleOptions.querySelectorAll('.option');
            
            if (!allBtns || allBtns.length === 0) {
                if (statusEl) {
                    statusEl.textContent = '❌ Seçenekler bulunamadı';
                    statusEl.style.color = '#f44336';
                }
                return;
            }
            
            // Konuşulan metni normalize et (küçük harf, boşlukları temizle)
            const normalizedSpoken = spokenText.toLowerCase().trim();
            
            if (statusEl) {
                statusEl.textContent = '🔍 "' + spokenText + '" aranıyor...';
                statusEl.style.color = '#f39c12';
            }
            
            // Doğru cevabı bul
            const correctWord = currentDinleQuestion.kelime;
            const correctWordNormalized = correctWord.toLowerCase().trim();
            
            // Tüm seçenekleri kontrol et
            let matchedButton = null;
            let bestMatch = null;
            let bestScore = 0;
            
            allBtns.forEach(btn => {
                const btnText = btn.textContent.trim();
                const btnTextNormalized = btnText.toLowerCase().trim();
                
                // Tam eşleşme
                if (btnTextNormalized === normalizedSpoken || 
                    normalizedSpoken.includes(btnTextNormalized) || 
                    btnTextNormalized.includes(normalizedSpoken)) {
                    const score = Math.max(
                        btnTextNormalized.length / normalizedSpoken.length,
                        normalizedSpoken.length / btnTextNormalized.length
                    );
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = btn;
                    }
                }
            });
            
            matchedButton = bestMatch;
            
            if (matchedButton) {
                // Butonu bulundu, tıkla
                setTimeout(() => {
                    matchedButton.click();
                    if (statusEl) {
                        statusEl.textContent = '✅ Eşleşme bulundu!';
                        statusEl.style.color = '#4caf50';
                    }
                    triggerHaptic('success');
                }, 300);
            } else {
                // Eşleşme bulunamadı
                if (statusEl) {
                    statusEl.textContent = '❌ Eşleşme bulunamadı: "' + spokenText + '"';
                    statusEl.style.color = '#f44336';
                }
                triggerHaptic('error');
                
                // Kullanıcıya doğru kelimeyi hatırlat
                setTimeout(() => {
                    if (statusEl) {
                        statusEl.textContent = '💡 Doğru kelime: ' + correctWord;
                        statusEl.style.color = '#667eea';
                    }
                }, 2000);
            }
        }

        function loadDinleQuestion() {
            // Önceki ses varsa durdur
            stopCurrentAudio();
            
            log.debug(`🎪 === SORU YÜKLENİYOR ===`);
            log.debug(`📊 Mevcut soru sayısı: ${dinleQuestionCount}/${DINLE_MAX_QUESTIONS}`);
            log.debug(`📊 Oyun durumu: score=${dinleScore}, correct=${dinleCorrect}, wrong=${dinleWrong}`);
            
            // 10 soru kontrolü
            if (dinleQuestionCount >= DINLE_MAX_QUESTIONS) {
                log.game(`🏁 === OYUN BİTİŞİ TETİKLENDİ ===`);
                log.game(`✅ ${DINLE_MAX_QUESTIONS} soru tamamlandı!`);
                log.game(`📊 Final oyun skorları: dinleScore=${dinleScore}, dinleCorrect=${dinleCorrect}, dinleWrong=${dinleWrong}`);
                log.game(`📊 Final session skorları: sessionScore=${sessionScore}, sessionCorrect=${sessionCorrect}, sessionWrong=${sessionWrong}`);
                
                // Günlük görev ilerlemesini güncelle
                updateTaskProgress('dinleBul', sessionCorrect);
                
                log.game(`💰 Session puanları global'e aktarılıyor: ${sessionScore} puan`);
                // Session puanlarını global'e aktar
                addToGlobalPoints(sessionScore, sessionCorrect);
                
                log.debug(`🔄 Ana menüye dönülüyor...`);
                // Direkt ana menüye dön
                elements.dinleMode.style.display = 'none';
                elements.mainMenu.style.display = 'block';
                
                // Navigasyon bar'ı göster (ana ekrana dönünce)
                showBottomNavBar();
                
                log.debug(`🧹 Oyun değişkenleri temizleniyor...`);
                // Sıfırla
                dinleScore = 0;
                dinleCorrect = 0;
                dinleWrong = 0;
                dinleQuestionCount = 0;
                updateDinleUI();
                log.game(`✅ Oyun bitti ve ana menüye dönüldü!`);
                return;
            }

            log.debug(`🔍 Zorluk filtreleme başlıyor...`);
            log.debug(`🎯 Seçili zorluk: ${currentDifficulty}`);
            // Zorluk filtreleme (Kelime Çevir ile aynı)
            const diffLevel = CONFIG.difficultyLevels[currentDifficulty];
            log.debug(`📋 Zorluk aralığı: ${diffLevel.minDiff}-${diffLevel.maxDiff}`);
            log.debug(`📦 Toplam kelime sayısı: ${kelimeBulData.length}`);
            
            let filteredData = kelimeBulData.filter(w => 
                w.difficulty >= diffLevel.minDiff && w.difficulty <= diffLevel.maxDiff
            );
            log.debug(`✅ Filtrelenmiş kelime sayısı: ${filteredData.length}`);

            if (filteredData.length === 0) {
                log.debug(`⚠️ Filtrelenmiş veri boş! Tüm kelimeler kullanılacak.`);
                filteredData = kelimeBulData;
            }

            log.debug(`🧠 Akıllı kelime seçimi (Dinle Modu) başlıyor...`);
            currentDinleQuestion = selectIntelligentWord(filteredData);
            
            // 🔍 SEÇİLEN KELİME DETAYLARI (DİNLE MODU)
            log.debug("===== DINLE MODU KELİME =====");
            log.debug(`� Kelime: ${currentDinleQuestion.kelime}`);
            log.debug("Anlam:", currentDinleQuestion.anlam);
            log.debug("Zorluk:", currentDinleQuestion.difficulty);
            log.debug("ID:", currentDinleQuestion.id);
            log.debug("Zorluk aralığı:", diffLevel.minDiff + "-" + diffLevel.maxDiff);
            const isInRange = currentDinleQuestion.difficulty >= diffLevel.minDiff && currentDinleQuestion.difficulty <= diffLevel.maxDiff;
            log.debug("Aralıkta mı:", isInRange ? "EVET" : "HAYIR");
            log.debug("Puan:", currentDinleQuestion.difficulty * 2);
            log.debug("==========================");

            log.debug(`🎨 UI güncelleniyor...`);
            // UI güncelle
            elements.dinleSureInfo.textContent = `ID: ${currentDinleQuestion.id} | Zorluk: ${currentDinleQuestion.difficulty} | Aralık: ${diffLevel.minDiff}-${diffLevel.maxDiff}`;
            log.debug(`✅ Kelime ID: ${currentDinleQuestion.id}`);

            log.debug(`🔀 Seçenekler oluşturuluyor... (4 Arapça kelime)`);
            // Seçenekler oluştur (4 Arapça kelime) - aynı zorluktan
            const wrongAnswers = [];
            let attempts = 0;
            while (wrongAnswers.length < 3 && attempts < 50) {
                attempts++;
                const random = filteredData[Math.floor(Math.random() * filteredData.length)];
                if (random.kelime !== currentDinleQuestion.kelime && 
                    !wrongAnswers.find(w => w.kelime === random.kelime)) {
                    wrongAnswers.push(random);
                    log.debug(`✅ Yanlış cevap #${wrongAnswers.length}: "${random.kelime}" (zorluk: ${random.difficulty})`);
                }
            }
            log.debug(`📊 Yanlış cevap oluşturma: ${attempts} deneme, ${wrongAnswers.length}/3 başarılı`);

            const allOptions = [
                { text: currentDinleQuestion.kelime, correct: true },
                ...wrongAnswers.map(w => ({ text: w.kelime, correct: false }))
            ];
            log.debug(`🎯 Doğru cevap: "${currentDinleQuestion.kelime}" (index: 0)`);
            log.debug(`❌ Yanlış cevaplar: ${wrongAnswers.map(w => `"${w.kelime}"`).join(', ')}`);

            // Akıllı karıştır (tahmin edilmesini zorlaştırmak için)
            smartShuffle(allOptions);

            // Seçenekleri göster - Duolingo Tarzı
            elements.dinleOptions.innerHTML = '';
            allOptions.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'duolingo-option';
                // Arapça ise özel sınıf ekle ve düzgün formatlama
                if (isArabic(opt.text)) {
                    btn.classList.add('arabic-option');
                    btn.innerHTML = `<span style="direction: rtl;">${opt.text}</span>`;
                } else {
                    btn.textContent = opt.text;
                }
                
                // Touch event tracking (scroll/tap ayrımı için)
                let touchStart = { x: 0, y: 0, time: 0 };
                let isScrolling = false;
                
                // Masaüstü için onclick handler
                btn.onclick = () => {
                    if (!btn.classList.contains('disabled')) {
                        checkDinleAnswer(btn, opt.correct);
                    }
                };
                
                // Mobil için touch event'leri
                btn.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    touchStart = {
                        x: touch.clientX,
                        y: touch.clientY,
                        time: Date.now()
                    };
                    isScrolling = false;
                }, { passive: true });
                
                btn.addEventListener('touchmove', (e) => {
                    if (touchStart.x !== 0 || touchStart.y !== 0) {
                        const touch = e.touches[0];
                        const deltaX = Math.abs(touch.clientX - touchStart.x);
                        const deltaY = Math.abs(touch.clientY - touchStart.y);
                        // 10px'den fazla hareket varsa scroll'dur
                        if (deltaX > 10 || deltaY > 10) {
                            isScrolling = true;
                        }
                    }
                }, { passive: true });
                
                btn.addEventListener('touchend', (e) => {
                    // Scroll yapıldıysa tıklamayı engelle
                    if (isScrolling) {
                        touchStart = { x: 0, y: 0, time: 0 };
                        isScrolling = false;
                        return;
                    }
                    
                    // Scroll değilse, tap olarak kabul et
                    const touch = e.changedTouches[0];
                    const deltaTime = Date.now() - touchStart.time;
                    const deltaX = Math.abs(touch.clientX - touchStart.x);
                    const deltaY = Math.abs(touch.clientY - touchStart.y);
                    
                    // Kısa süre (300ms) ve küçük hareket (10px) = tap
                    if (deltaTime < 300 && deltaX < 10 && deltaY < 10) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!btn.classList.contains('disabled')) {
                            checkDinleAnswer(btn, opt.correct);
                        }
                    }
                    
                    touchStart = { x: 0, y: 0, time: 0 };
                    isScrolling = false;
                }, { passive: false });
                
                elements.dinleOptions.appendChild(btn);
            });

            // Duolingo tarzı soru numarasını güncelle
            const dinleQuestionNumber = document.getElementById('dinleQuestionNumber');
            if (dinleQuestionNumber) {
                dinleQuestionNumber.textContent = `Soru ${dinleQuestionCount + 1} / ${DINLE_MAX_QUESTIONS}`;
            }
            
            // Duolingo tarzı ilerleme çubuğunu güncelle
            const dinleProgressBar = document.getElementById('dinleProgressBar');
            if (dinleProgressBar) {
                const progress = ((dinleQuestionCount + 1) / DINLE_MAX_QUESTIONS) * 100;
                dinleProgressBar.style.width = progress + '%';
            }

            if (elements.dinleFeedback) {
            elements.dinleFeedback.textContent = '';
            elements.dinleFeedback.className = 'feedback';
            }
            if (elements.dinleNextBtn) {
            elements.dinleNextBtn.style.display = 'none';
            }
            
            // Tüm butonları aktif et
            const allBtns = document.querySelectorAll('.dinle-mode .duolingo-option, .dinle-mode .option');
            allBtns.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('disabled', 'correct', 'wrong');
            });

            // Otomatik ses çal
            if (currentDinleQuestion.ses_dosyasi) {
                playAudio(currentDinleQuestion.ses_dosyasi, elements.dinleAudioBtn);
            }

            // Arapça hareke renklerini uygula
            setTimeout(() => {
                updateArabicTextColoring();
            }, 100);
        }

        function checkDinleAnswer(button, isCorrect) {
            log.debug(`🚨 === CEVAP KONTROLÜ BAŞLIYOR ===`);
            log.debug(`👆 Tıklanan buton: "${button.textContent}"`);
            log.debug(`✅/❌ isCorrect parametresi: ${isCorrect}`);
            log.debug(`📊 Mevcut soru: #${dinleQuestionCount + 1}/${DINLE_MAX_QUESTIONS}`);
            log.debug(`� Önce - session score: ${sessionScore}, session correct: ${sessionCorrect}, session wrong: ${sessionWrong}`);
            log.debug(`📊 Önce - dinle score: ${dinleScore}, dinle correct: ${dinleCorrect}, dinle wrong: ${dinleWrong}`);
            
            // KELİME İSTATİSTİKLERİNİ GÜNCELLE (Dinle Modu)
            log.debug(`📊 Kelime istatistiği güncelleniyor (Dinle): ${currentDinleQuestion.kelime} (ID: ${currentDinleQuestion.id})`);
            updateWordStats(currentDinleQuestion.id, isCorrect);
            
            const allBtns = elements.dinleOptions.querySelectorAll('.duolingo-option, .option');
            log.debug(`🔒 ${allBtns.length} buton devre dışı bırakılıyor...`);
            allBtns.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled');
            });

            if (isCorrect) {
                log.debug(`✅ === SAHİH CEVAP İŞLEMİ ===`);
                button.classList.add('correct');
                if (elements.dinleFeedback) {
                elements.dinleFeedback.textContent = '✅ Mâşâallah!';
                elements.dinleFeedback.className = 'feedback correct';
                }
                
                // Haptic feedback - doğru cevap
                triggerHaptic('success');
                
                const points = currentDinleQuestion.difficulty * 2;
                log.debug(`💰 Puan hesaplama: ${currentDinleQuestion.difficulty} × 2 = ${points} puan`);
                
                log.debug(`📊 Dinle score güncelleniyor: ${dinleScore} + ${points} = ${dinleScore + points}`);
                dinleScore += points; // Local oyun puanı
                
                log.debug(`📊 Dinle correct güncelleniyor: ${dinleCorrect} + 1 = ${dinleCorrect + 1}`);
                dinleCorrect++;
                
                log.debug(`📊 addSessionPoints(${points}) çağrılıyor...`);
                addSessionPoints(points); // Session puanına ekle
                
                // Daily task progress - her doğru cevap için
                updateTaskProgress('dinleBul', 1);
                
                // Perfect streak kontrolü - hiç yanlış yapmamışsak perfect streak artır
                if (sessionWrong === 0) {
                    updateTaskProgress('perfectStreak', 1);
                    log.debug(`🔥 Perfect streak artırıldı! Mevcut: ${dailyTasks.todayStats.perfectStreak}`);
                }
                
                log.debug(`✅ Doğru cevap işlemi tamamlandı!`);
                log.debug(`📊 Sonra - session score: ${sessionScore}, session correct: ${sessionCorrect}`);
            } else {
                log.debug(`❌ === YANLIŞ CEVAP İŞLEMİ ===`);
                button.classList.add('wrong');
                if (elements.dinleFeedback) {
                elements.dinleFeedback.textContent = `❌ Hatalı! Doğru: ${currentDinleQuestion.kelime} (${currentDinleQuestion.anlam})`;
                elements.dinleFeedback.className = 'feedback wrong';
                }
                
                // Haptic feedback - yanlış cevap
                triggerHaptic('error');
                
                log.debug(`📊 Dinle wrong güncelleniyor: ${dinleWrong} + 1 = ${dinleWrong + 1}`);
                dinleWrong++;
                
                log.debug(`📊 addSessionWrong() çağrılıyor...`);
                addSessionWrong(); // Session yanlış sayısını artır
                log.debug(`❌ ÖNEMLI: Yanlış cevap için puan EKLENMEDİ!`);
                log.debug(`📊 Session score değişmedi: ${sessionScore}`);

                log.debug(`🔍 Doğru cevabı gösteriliyor...`);
                // Doğru cevabı göster
                let correctButtonFound = false;
                allBtns.forEach(btn => {
                    if (btn.textContent.includes(currentDinleQuestion.kelime)) {
                        btn.classList.add('correct');
                        correctButtonFound = true;
                        log.debug(`✅ Doğru buton bulundu ve işaretlendi: "${btn.textContent}"`);
                    }
                });
                if (!correctButtonFound) {
                    log.warn(`⚠️ Doğru buton bulunamadı!`);
                }
            }

            log.debug(`📊 Soru sayacı artırılıyor: ${dinleQuestionCount} + 1 = ${dinleQuestionCount + 1}`);
            dinleQuestionCount++; // Soru sayacını artır
            log.debug(`📊 FINAL - session: score=${sessionScore}, correct=${sessionCorrect}, wrong=${sessionWrong}`);
            log.debug(`📊 FINAL - dinle: score=${dinleScore}, correct=${dinleCorrect}, wrong=${dinleWrong}, questionCount=${dinleQuestionCount}`);
            log.debug(`🚨 === CEVAP KONTROLÜ BİTTİ ===`);
            log.debug(`🎨 UI güncelleniyor ve Next butonu gösteriliyor...`);
            updateDinleUI();
            // Show the Dinle 'Next' button
            if (elements.dinleNextBtn) {
            elements.dinleNextBtn.style.display = 'block';
            // 🔥 Animasyonu ekle
            elements.dinleNextBtn.classList.add("next-appear");
            }
            log.debug(`✅ Cevap işlemi tamamen tamamlandı!`);
        }

        function updateDinleUI() {
            log.debug(`🎨 DinleUI güncelleniyor...`);
            log.debug(`📊 Gösterilecek değerler: score=${dinleScore}, correct=${dinleCorrect}, wrong=${dinleWrong}`);
            if (elements.dinleScore) elements.dinleScore.textContent = dinleScore;
            if (elements.dinleCorrect) elements.dinleCorrect.textContent = dinleCorrect;
            if (elements.dinleWrong) elements.dinleWrong.textContent = dinleWrong;
            log.debug(`✅ DinleUI güncellendi!`);
        }

        // ============ BOŞLUK DOLDUR MODU ============
        let currentBoslukQuestion = null;
        let missingWord = '';
        let missingIndex = -1;
        let boslukQuestionCount = 0;
        const BOSLUK_MAX_QUESTIONS = 10;

        function loadBoslukQuestion() {
            // Önceki ses varsa durdur
            stopCurrentAudio();
            
            if (boslukQuestionCount >= BOSLUK_MAX_QUESTIONS) {
                log.game(`🏁 === BOŞLUK DOLDUR OYUNU BİTTİ ===`);
                log.game(`✅ ${BOSLUK_MAX_QUESTIONS} soru tamamlandı!`);
                log.game(`📊 Final oyun skorları: boslukScore=${boslukScore}, boslukCorrect=${boslukCorrect}, boslukWrong=${boslukWrong}`);
                log.game(`📊 Final session skorları: sessionScore=${sessionScore}, sessionCorrect=${sessionCorrect}, sessionWrong=${sessionWrong}`);
                
                // Günlük görev ilerlemesini güncelle
                updateTaskProgress('boslukDoldur', sessionCorrect);
                
                log.game(`💰 Session puanları global'e aktarılıyor: ${sessionScore} puan`);
                // Session puanlarını global'e aktar
                addToGlobalPoints(sessionScore, sessionCorrect);
                
                log.debug(`🔄 Ana menüye dönülüyor...`);
                // Direkt ana menüye dön
                elements.boslukMode.style.display = 'none';
                elements.mainMenu.style.display = 'block';
                
                // Navigasyon bar'ı göster (ana ekrana dönünce)
                showBottomNavBar();
                
                log.debug(`🧹 Oyun değişkenleri temizleniyor...`);
                // Sıfırla
                boslukScore = 0;
                boslukCorrect = 0;
                boslukWrong = 0;
                boslukQuestionCount = 0;
                updateBoslukUI();
                log.game(`✅ Boşluk Doldur oyunu bitti ve ana menüye dönüldü!`);
                return;
            }

            log.debug(`🔍 Ayet filtreleme başlıyor...`);
            log.debug(`🎯 Seçili zorluk: ${currentDifficulty}`);
            
            // Rastgele ayet seç (ayet_metni olan ayetleri filtrele)
            let validAyets = ayetOkuData.filter(a => a.ayet_metni && a.ayet_metni.trim());
            log.debug(`📦 Toplam ayet sayısı: ${ayetOkuData.length}`);
            log.debug(`✅ Geçerli ayet sayısı: ${validAyets.length}`);
            
            // Zorluk seviyesine göre filtrele (kelime sayısına göre)
            const diffLevel = CONFIG.difficultyLevels[currentDifficulty];
            log.debug(`📋 Zorluk aralığı: ${diffLevel.minDiff}-${diffLevel.maxDiff} (kelime sayısı)`);
            
            // Ayetleri kelime sayısına göre filtrele
            validAyets = validAyets.filter(ayet => {
                const words = ayet.ayet_metni.split(' ').filter(w => w && w.trim());
                const wordCount = words.length;
                // Kelime sayısını zorluk aralığına göre filtrele
                return wordCount >= diffLevel.minDiff && wordCount <= diffLevel.maxDiff;
            });
            
            log.debug(`✅ Zorluk filtresi sonrası: ${validAyets.length} ayet`);
            
            // Eğer filtrelenmiş ayet yoksa, tüm geçerli ayetleri kullan
            if (validAyets.length === 0) {
                log.warn('⚠️ Zorluk filtresine uygun ayet bulunamadı, tüm ayetler kullanılacak');
                validAyets = ayetOkuData.filter(a => a.ayet_metni && a.ayet_metni.trim());
            }
            
            if (validAyets.length === 0) {
                log.error('❌ Geçerli ayet bulunamadı!');
                return;
            }
            
            log.debug(`🎲 Rastgele ayet seçiliyor...`);
            const randomIndex = Math.floor(Math.random() * validAyets.length);
            const ayet = validAyets[randomIndex];
            log.debug(`✅ Seçilen ayet index: ${randomIndex}/${validAyets.length}`);
            
            log.debug(`📝 === SORU #${boslukQuestionCount + 1} ===`);
            log.debug(`📖 Sure: ${ayet.sure_adi || 'Bilinmiyor'}`);
            log.debug(`🔢 Ayet No: ${ayet.ayet_no || 'Bilinmiyor'}`);
            log.debug(`📝 Ayet Metni: "${ayet.ayet_metni}"`);
            
            // Ayet metnini kelimelere böl
            const words = ayet.ayet_metni.split(' ').filter(w => w && w.trim());
            log.debug(`🔤 Kelime sayısı: ${words.length}`);
            log.debug(`🔤 Kelimeler:`, words);
            
            if (words.length < 4) {
                // Çok kısa ayetler için tekrar dene
                loadBoslukQuestion();
                return;
            }

            // Rastgele bir kelimeyi gizle
            missingIndex = Math.floor(Math.random() * words.length);
            missingWord = words[missingIndex];

            // Boşluk ile değiştir
            const displayText = words.map((w, i) => i === missingIndex ? '______' : w).join(' ');

            currentBoslukQuestion = ayet;

            // UI güncelle
            elements.boslukAyetText.textContent = displayText;

            // Seçenekler oluştur (boşluğa gelecek kelime)
            const wrongWords = [];
            let attempts = 0;
            while (wrongWords.length < 3 && attempts < 100) {
                attempts++;
                const randomAyet = validAyets[Math.floor(Math.random() * validAyets.length)];
                if (!randomAyet.ayet_metni) continue;
                
                const randomWords = randomAyet.ayet_metni.split(' ').filter(w => w && w.trim());
                if (randomWords.length === 0) continue;
                
                const randomWord = randomWords[Math.floor(Math.random() * randomWords.length)];
                if (randomWord && randomWord !== missingWord && !wrongWords.includes(randomWord)) {
                    wrongWords.push(randomWord);
                }
            }
            
            // Eğer yeterli yanlış cevap bulunamadıysa, eksik olanları doldur
            while (wrongWords.length < 3) {
                wrongWords.push('...');
            }

            const allOptions = [
                { text: missingWord, correct: true },
                ...wrongWords.map(w => ({ text: w, correct: false }))
            ];

            // Akıllı karıştır (tahmin edilmesini zorlaştırmak için)
            smartShuffle(allOptions);

            // Seçenekleri göster - Duolingo Tarzı
            elements.boslukOptions.innerHTML = '';
            allOptions.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = 'duolingo-option';
                // Boşluk Doldur'da her zaman Arapça format kullan (ayet parçaları)
                if (opt.text === '...' || opt.text.trim() === '') {
                    // Boş seçenekler için normal format
                    btn.textContent = opt.text;
                } else {
                    // Arapça kelimeler için özel format
                    btn.classList.add('arabic-option');
                    btn.innerHTML = `<span style="direction: rtl;">${opt.text}</span>`;
                }
                
                // Touch event tracking (scroll/tap ayrımı için)
                let touchStart = { x: 0, y: 0, time: 0 };
                let isScrolling = false;
                
                // Masaüstü için onclick handler
                btn.onclick = () => {
                    if (!btn.classList.contains('disabled')) {
                        checkBoslukAnswer(btn, opt.correct);
                    }
                };
                
                // Mobil için touch event'leri
                btn.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    touchStart = {
                        x: touch.clientX,
                        y: touch.clientY,
                        time: Date.now()
                    };
                    isScrolling = false;
                }, { passive: true });
                
                btn.addEventListener('touchmove', (e) => {
                    if (touchStart.x !== 0 || touchStart.y !== 0) {
                        const touch = e.touches[0];
                        const deltaX = Math.abs(touch.clientX - touchStart.x);
                        const deltaY = Math.abs(touch.clientY - touchStart.y);
                        // 10px'den fazla hareket varsa scroll'dur
                        if (deltaX > 10 || deltaY > 10) {
                            isScrolling = true;
                        }
                    }
                }, { passive: true });
                
                btn.addEventListener('touchend', (e) => {
                    // Scroll yapıldıysa tıklamayı engelle
                    if (isScrolling) {
                        touchStart = { x: 0, y: 0, time: 0 };
                        isScrolling = false;
                        return;
                    }
                    
                    // Scroll değilse, tap olarak kabul et
                    const touch = e.changedTouches[0];
                    const deltaTime = Date.now() - touchStart.time;
                    const deltaX = Math.abs(touch.clientX - touchStart.x);
                    const deltaY = Math.abs(touch.clientY - touchStart.y);
                    
                    // Kısa süre (300ms) ve küçük hareket (10px) = tap
                    if (deltaTime < 300 && deltaX < 10 && deltaY < 10) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (!btn.classList.contains('disabled')) {
                            checkBoslukAnswer(btn, opt.correct);
                        }
                    }
                    
                    touchStart = { x: 0, y: 0, time: 0 };
                    isScrolling = false;
                }, { passive: false });
                
                elements.boslukOptions.appendChild(btn);
            });

            // Duolingo tarzı soru numarasını güncelle
            const boslukQuestionNumber = document.getElementById('boslukQuestionNumber');
            if (boslukQuestionNumber) {
                boslukQuestionNumber.textContent = `Soru ${boslukQuestionCount + 1} / ${BOSLUK_MAX_QUESTIONS}`;
            }
            
            // Duolingo tarzı ilerleme çubuğunu güncelle
            const boslukProgressBar = document.getElementById('boslukProgressBar');
            if (boslukProgressBar) {
                const progress = ((boslukQuestionCount + 1) / BOSLUK_MAX_QUESTIONS) * 100;
                boslukProgressBar.style.width = progress + '%';
            }
            
            // Sure info güncelle
            if (elements.boslukSureInfo && currentBoslukQuestion) {
                elements.boslukSureInfo.textContent = `${currentBoslukQuestion.sure_adi || ''} ${currentBoslukQuestion.ayet_no || ''}`;
                elements.boslukSureInfo.style.display = 'block';
            }

            if (elements.boslukFeedback) {
            elements.boslukFeedback.textContent = '';
            elements.boslukFeedback.className = 'feedback';
            }
            if (elements.boslukNextBtn) {
            elements.boslukNextBtn.style.display = 'none';
            }
            
            // Tüm butonları aktif et
            const allBtns = document.querySelectorAll('.bosluk-mode .duolingo-option, .bosluk-mode .option');
            allBtns.forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('disabled', 'correct', 'wrong');
            });

            // Otomatik ses çal
            if (currentBoslukQuestion && currentBoslukQuestion.ayet_ses_dosyasi) {
                playAudio(currentBoslukQuestion.ayet_ses_dosyasi, elements.boslukAudioBtn);
            }
        }

        if (elements.boslukAudioBtn) {
            // Masaüstü için onclick
            elements.boslukAudioBtn.onclick = () => {
                if (currentBoslukQuestion && currentBoslukQuestion.ayet_ses_dosyasi) {
                    playAudio(currentBoslukQuestion.ayet_ses_dosyasi, elements.boslukAudioBtn);
                }
            };
            // Mobil için touchend
            elements.boslukAudioBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (currentBoslukQuestion && currentBoslukQuestion.ayet_ses_dosyasi) {
                    playAudio(currentBoslukQuestion.ayet_ses_dosyasi, elements.boslukAudioBtn);
                }
            }, { passive: false });
        }

        function checkBoslukAnswer(button, isCorrect) {
            log.debug(`🚨 === BOŞLUK DOLDUR CEVAP KONTROLÜ ===`);
            log.debug(`👆 Tıklanan buton: "${button.textContent}"`);
            log.debug(`✅/❌ isCorrect parametresi: ${isCorrect}`);
            log.debug(`📊 Mevcut soru: #${boslukQuestionCount + 1}/${BOSLUK_MAX_QUESTIONS}`);
            log.debug(`📊 Eksik kelime: "${missingWord}"`);
            log.debug(`📊 Önce - session: score=${sessionScore}, correct=${sessionCorrect}, wrong=${sessionWrong}`);
            log.debug(`📊 Önce - boşluk: score=${boslukScore}, correct=${boslukCorrect}, wrong=${boslukWrong}`);
            
            // KELİME İSTATİSTİKLERİ SADECE KELİME ÇEVİR OYUNUNDA KAYIT EDİLİYOR
            // Boşluk Doldur oyunu için istatistik kaydedilmiyor
            
            const allBtns = elements.boslukOptions.querySelectorAll('.duolingo-option, .option');
            log.debug(`🔒 ${allBtns.length} buton devre dışı bırakılıyor...`);
            allBtns.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled');
            });

            if (isCorrect) {
                log.debug(`✅ === DOĞRU CEVAP İŞLEMİ ===`);
                button.classList.add('correct');
                if (elements.boslukFeedback) {
                elements.boslukFeedback.textContent = '✅ Mâşâallah!';
                elements.boslukFeedback.className = 'feedback correct';
                }
                
                // Haptic feedback - doğru cevap
                triggerHaptic('success');
                
                log.debug(`💰 Boşluk Doldur sabit puan: 10 puan ekleniyor`);
                log.debug(`📊 Boşluk score güncelleniyor: ${boslukScore} + 10 = ${boslukScore + 10}`);
                boslukScore += 10; // Local oyun puanı
                boslukCorrect++;
                
                log.debug(`📊 addSessionPoints(10) çağrılıyor...`);
                addSessionPoints(10); // Session puanına ekle
                
                // Daily task progress - her doğru cevap için
                updateTaskProgress('boslukDoldur', 1);
                
                // Perfect streak kontrolü - hiç yanlış yapmamışsak perfect streak artır
                if (sessionWrong === 0) {
                    updateTaskProgress('perfectStreak', 1);
                    log.debug(`🔥 Perfect streak artırıldı! Mevcut: ${dailyTasks.todayStats.perfectStreak}`);
                }
                
                log.debug(`✅ Doğru cevap işlemi tamamlandı!`);

                // Tam ayeti doğru kelimeyi altın sarısı ile vurgulayarak göster
                showAnswerWithGoldenHighlight();
            } else {
                log.debug(`❌ === YANLIŞ CEVAP İŞLEMİ ===`);
                button.classList.add('wrong');
                if (elements.boslukFeedback) {
                elements.boslukFeedback.textContent = `❌ Hatalı! Doğru kelime: ${missingWord}`;
                elements.boslukFeedback.className = 'feedback wrong';
                }
                
                // Haptic feedback - yanlış cevap
                triggerHaptic('error');
                
                log.debug(`📊 Boşluk wrong güncelleniyor: ${boslukWrong} + 1 = ${boslukWrong + 1}`);
                boslukWrong++;
                
                log.debug(`📊 addSessionWrong() çağrılıyor...`);
                addSessionWrong(); // Session yanlış sayısını artır
                log.debug(`❌ ÖNEMLI: Yanlış cevap için puan EKLENMEDİ!`);

                log.debug(`🔍 Doğru cevabı gösteriliyor...`);
                // Doğru cevabı göster
                let correctButtonFound = false;
                allBtns.forEach(btn => {
                    if (btn.textContent.includes(missingWord)) {
                        btn.classList.add('correct');
                        correctButtonFound = true;
                        log.debug(`✅ Doğru buton bulundu: "${btn.textContent}"`);
                    }
                });
                if (!correctButtonFound) {
                    log.debug(`⚠️ Doğru buton bulunamadı! Aranan: "${missingWord}"`);
                }

                // Tam ayeti doğru kelimeyi altın sarısı ile vurgulayarak göster
                showAnswerWithGoldenHighlight();
            }

            log.debug(`📊 Soru sayacı artırılıyor: ${boslukQuestionCount} + 1 = ${boslukQuestionCount + 1}`);
            boslukQuestionCount++; // Soru sayacını artır
            log.debug(`📊 FINAL - session: score=${sessionScore}, correct=${sessionCorrect}, wrong=${sessionWrong}`);
            log.debug(`📊 FINAL - boşluk: score=${boslukScore}, correct=${boslukCorrect}, wrong=${boslukWrong}, questionCount=${boslukQuestionCount}`);
            log.debug(`🚨 === BOŞLUK DOLDUR CEVAP KONTROLÜ BİTTİ ===`);
            updateBoslukUI();
            // Show the Bosluk 'Next' button
            if (elements.boslukNextBtn) {
            elements.boslukNextBtn.style.display = 'block';
                elements.boslukNextBtn.classList.add("next-appear");
            }
        }

        if (elements.boslukNextBtn) {
            // Masaüstü için onclick
            elements.boslukNextBtn.onclick = () => {
                // Butonu hemen gizle
                if (elements.boslukNextBtn) {
                    elements.boslukNextBtn.style.display = 'none';
                    elements.boslukNextBtn.classList.remove("next-appear");
                }
                
                loadBoslukQuestion();
            };
            // Mobil için touchend
            elements.boslukNextBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Butonu hemen gizle
                if (elements.boslukNextBtn) {
                    elements.boslukNextBtn.style.display = 'none';
                    elements.boslukNextBtn.classList.remove("next-appear");
                }
                
                loadBoslukQuestion();
            }, { passive: false });
        }

        function updateBoslukUI() {
            log.debug(`🎨 BoslukUI güncelleniyor...`);
            log.debug(`📊 Gösterilecek değerler: score=${boslukScore}, correct=${boslukCorrect}, wrong=${boslukWrong}`);
            if (elements.boslukScore) elements.boslukScore.textContent = boslukScore;
            if (elements.boslukCorrect) elements.boslukCorrect.textContent = boslukCorrect;
            if (elements.boslukWrong) elements.boslukWrong.textContent = boslukWrong;
            log.debug(`✅ BoslukUI güncellendi!`);
        }

        function showAnswerWithGoldenHighlight() {
            // Doğru kelimeyi belirgin renkte vurgulayarak tam ayeti göster
            const fullText = currentBoslukQuestion.ayet_metni;
            
            log.debug(`🔍 Vurgulanacak kelime: "${missingWord}"`);
            log.debug(`📄 Tam metin uzunluğu: ${fullText.length}`);
            log.debug(`📄 Tam metin (ilk 50 karakter): "${fullText.substring(0, 50)}"`);
            
            // Arapça metinlerde direkt string replacement kullan (en güvenilir yöntem)
            // Kelimeyi bul ve tüm eşleşmeleri değiştir
            const highlightStyle = `style="color: #FF6B35 !important; font-weight: 700 !important; font-size: 1.15em !important; text-shadow: 0 2px 8px rgba(255, 107, 53, 0.6) !important; background: linear-gradient(135deg, rgba(255, 107, 53, 0.25) 0%, rgba(255, 193, 7, 0.25) 100%) !important; padding: 3px 6px !important; border-radius: 6px !important; border: 2px solid rgba(255, 107, 53, 0.4) !important; display: inline-block !important; font-family: 'KFGQPC Uthmanic Script HAFS Regular', 'Amiri', serif !important; transform: scale(1.05) !important; transition: all 0.3s ease !important;"`;
            
            // Direkt string replacement - tüm eşleşmeleri değiştir
            const highlightedWord = `<span class="golden-highlight" ${highlightStyle}>${missingWord}</span>`;
            const finalText = fullText.split(missingWord).join(highlightedWord);
            
            log.debug(`✅ Vurgulama yapıldı. Yeni metin uzunluğu: ${finalText.length}`);
            log.debug(`📄 Vurgulanmış metin (ilk 100 karakter): "${finalText.substring(0, 100)}"`);
            
            // innerHTML ile set et
            elements.boslukAyetText.innerHTML = finalText;
            
            // Ekstra güvenlik için direct style da uygula
            setTimeout(() => {
                const goldenSpans = elements.boslukAyetText.querySelectorAll('.golden-highlight');
                log.debug(`🔍 Bulunan span sayısı: ${goldenSpans.length}`);
                
                goldenSpans.forEach((span, index) => {
                    span.style.color = '#FF6B35';
                    span.style.fontWeight = '700';
                    span.style.fontSize = '1.15em';
                    span.style.textShadow = '0 2px 8px rgba(255, 107, 53, 0.6)';
                    span.style.background = 'linear-gradient(135deg, rgba(255, 107, 53, 0.25) 0%, rgba(255, 193, 7, 0.25) 100%)';
                    span.style.padding = '3px 6px';
                    span.style.borderRadius = '6px';
                    span.style.border = '2px solid rgba(255, 107, 53, 0.4)';
                    span.style.display = 'inline-block';
                    span.style.transform = 'scale(1.05)';
                    span.style.transition = 'all 0.3s ease';
                    
                    log.debug(`✨ Span #${index + 1} stil uygulandı. İçerik: "${span.textContent}"`);
                });
                
                if (goldenSpans.length === 0) {
                    log.error(`❌ Hiç span bulunamadı! Kelime eşleşmedi: "${missingWord}"`);
                    log.error(`📄 Metin içinde kelime var mı kontrol: ${fullText.includes(missingWord)}`);
                } else {
                    log.debug(`✅ ${goldenSpans.length} vurgulu span bulundu ve stil uygulandı!`);
                }
            }, 100);
        }

        // ============ DUA ET MODU ============
        function showDua() {
            const dua = duaData[currentDuaIndex];
            if (!dua) return;

            elements.duaSureInfo.textContent = `Ayet: ${dua.ayet || ''}`;
            elements.duaArabic.textContent = dua.dua || '';
            elements.duaTranslation.textContent = dua.tercume || '';

            elements.prevDuaBtn.disabled = currentDuaIndex === 0;
            elements.nextDuaBtn.disabled = currentDuaIndex === duaData.length - 1;
        }

        elements.prevDuaBtn.onclick = () => {
            log.debug('⬅️ Önceki dua butonuna tıklandı');
            if (currentDuaIndex > 0) {
                log.debug('📍 Önceki duaya geçiliyor:', currentDuaIndex, '->', currentDuaIndex - 1);
                stopCurrentAudio(); // Mevcut ses varsa durdur
                currentDuaIndex--;
                showDua();
                log.debug('✅ Önceki dua gösterildi');
                // Navigasyon - görev sayılmaz
            }
        };

        elements.nextDuaBtn.onclick = () => {
            log.debug('➡️ Sonraki dua butonuna tıklandı');
            if (currentDuaIndex < duaData.length - 1) {
                log.debug('📍 Sonraki duaya geçiliyor:', currentDuaIndex, '->', currentDuaIndex + 1);
                stopCurrentAudio(); // Mevcut ses varsa durdur
                currentDuaIndex++;
                showDua();
                log.debug('✅ Sonraki dua gösterildi');
                // Navigasyon - görev sayılmaz
            }
        };

        elements.duaAudioBtn.onclick = () => {
            log.debug('🔊 Dua audio butonuna tıklandı');
            const dua = duaData[currentDuaIndex];
            log.debug('📊 Mevcut dua bilgileri:', {
                index: currentDuaIndex,
                hasUrl: !!(dua && dua.ses_url),
                url: dua?.ses_url,
                start: dua?.start,
                title: dua?.dua_adi
            });
            
            if (dua && dua.ses_url) {
                // Önceki sesi durdur
                stopCurrentAudio();
                
                // Butonu devre dışı bırak
                elements.duaAudioBtn.disabled = true;
                log.debug('🔒 Audio butonu devre dışı bırakıldı');
                
                try {
                    currentAudio = new Audio(dua.ses_url);
                    
                    // Başlangıç zamanı varsa ayarla (yüklenmeden önce)
                    if (dua.start) {
                        currentAudio.currentTime = dua.start;
                    }
                    
                    // Direkt çalmayı dene
                    currentAudio.play().then(() => {
                        log.debug('🎵 Dua sesi başlatıldı - URL:', dua.ses_url);
                        log.debug('🎵 Audio object durumu:', {
                            currentTime: currentAudio.currentTime,
                            duration: currentAudio.duration,
                            paused: currentAudio.paused,
                            readyState: currentAudio.readyState,
                            volume: currentAudio.volume
                        });
                        elements.duaAudioBtn.disabled = false; // Butonu tekrar aktif et
                    }).catch(err => {
                        log.error('❌ Ses çalma hatası:', err);
                        elements.duaAudioBtn.disabled = false;
                        currentAudio = null;
                    });
                    
                    // Ses yüklenme durumu
                    currentAudio.onloadstart = () => {
                        log.debug('📥 Ses yüklenmeye başladı');
                    };

                    currentAudio.oncanplay = () => {
                        log.debug('✅ Ses çalmaya hazır');
                    };

                    currentAudio.onplay = () => {
                        log.debug('▶️ Ses çalmaya başladı');
                    };

                    currentAudio.onpause = () => {
                        log.debug('⏸️ Ses duraklatıldı');
                    };

                    currentAudio.ontimeupdate = () => {
                        // Null check - eğer currentAudio silinmişse event'i durdur
                        if (!currentAudio) return;
                        
                        // Her 5 saniyede bir log (çok fazla log'u önlemek için)
                        if (currentAudio.currentTime > 0 && Math.floor(currentAudio.currentTime) % 5 === 0) {
                            log.debug('⏱️ Ses oynatma zamanı:', currentAudio.currentTime.toFixed(2) + 's / ' + (currentAudio.duration || 0).toFixed(2) + 's');
                        }
                    };
                    
                    // Ses bittiğinde
                    currentAudio.onended = () => {
                        log.debug('🏁 Ses bitti');
                        elements.duaAudioBtn.disabled = false;
                        updateTaskProgress('duaOgre', 1);
                        currentAudio = null;
                    };
                    
                    // Hata durumunda
                    currentAudio.onerror = (err) => {
                        log.error('❌ Ses dosyası hatası:', err);
                        log.error('❌ Hata detayları:', {
                            code: currentAudio.error?.code,
                            message: currentAudio.error?.message
                        });
                        elements.duaAudioBtn.disabled = false;
                        currentAudio = null;
                    };
                    
                } catch (err) {
                    log.error('Audio oluşturma hatası:', err);
                    elements.duaAudioBtn.disabled = false;
                    currentAudio = null;
                }
            }
        };

        // ============ AYET OKU MODU (RASTGELE) ============
        function showAyet() {
            // Rastgele ayet seç
            currentAyetIndex = Math.floor(Math.random() * ayetOkuData.length);
            const ayet = ayetOkuData[currentAyetIndex];
            if (!ayet) return;
            
            elements.ayetSureInfo.textContent = `${ayet.sure_adı || 'Sûre'} - Ayet`;
            elements.ayetArabic.textContent = ayet.ayet_metni || '';
            elements.ayetTranslation.textContent = ayet.meal || '';
        }

        elements.prevAyetBtn.onclick = () => {
            log.debug('⬅️ Önceki ayet butonuna tıklandı');
            stopCurrentAudio(); // Mevcut ses varsa durdur
            showAyet(); // Rastgele önceki ayet
            log.debug('✅ Önceki ayet gösterildi');
            // Navigasyon - görev sayılmaz
        };

        elements.nextAyetBtn.onclick = () => {
            log.debug('➡️ Sonraki ayet butonuna tıklandı');
            stopCurrentAudio(); // Mevcut ses varsa durdur
            showAyet(); // Rastgele sonraki ayet
            log.debug('✅ Sonraki ayet gösterildi');
            // Navigasyon - görev sayılmaz
        };

        elements.ayetAudioBtn.onclick = () => {
            log.debug('🔊 Ayet audio butonuna tıklandı');
            const ayet = ayetOkuData[currentAyetIndex];
            log.debug('📊 Mevcut ayet bilgileri:', {
                index: currentAyetIndex,
                hasUrl: !!(ayet && ayet.ayet_ses_dosyasi),
                url: ayet?.ayet_ses_dosyasi,
                sure: ayet?.sure_adi,
                ayetNo: ayet?.ayet_no
            });
            
            if (ayet && ayet.ayet_ses_dosyasi) {
                // Önceki sesi durdur
                stopCurrentAudio();
                
                // Butonu devre dışı bırak
                elements.ayetAudioBtn.disabled = true;
                log.debug('🔒 Audio butonu devre dışı bırakıldı');
                
                try {
                    // URL doğrulama
                    if (!ayet.ayet_ses_dosyasi || (!ayet.ayet_ses_dosyasi.startsWith('http://') && !ayet.ayet_ses_dosyasi.startsWith('https://'))) {
                        log.error('❌ Geçersiz ses URL formatı:', ayet.ayet_ses_dosyasi);
                        elements.ayetAudioBtn.disabled = false;
                        return;
                    }
                    
                    currentAudio = new Audio(ayet.ayet_ses_dosyasi);
                    
                    // Ses yüklendiğinde çal
                    currentAudio.addEventListener('loadeddata', () => {
                    currentAudio.play().then(() => {
                        log.debug('🎵 Ayet sesi başlatıldı - URL:', ayet.ayet_ses_dosyasi);
                        log.debug('🎵 Audio object durumu:', {
                            currentTime: currentAudio.currentTime,
                            duration: currentAudio.duration,
                            paused: currentAudio.paused,
                            readyState: currentAudio.readyState,
                            volume: currentAudio.volume
                        });
                            elements.ayetAudioBtn.disabled = false;
                    }).catch(err => {
                        log.error('❌ Ses çalma hatası:', err);
                            log.error('❌ Ses URL:', ayet.ayet_ses_dosyasi);
                        elements.ayetAudioBtn.disabled = false;
                        currentAudio = null;
                        });
                    });
                    
                    // Hata durumunda
                    currentAudio.onerror = (e) => {
                        log.error('❌ Ses dosyası yüklenemedi:', ayet.ayet_ses_dosyasi);
                        log.error('❌ Hata kodu:', currentAudio.error?.code);
                        log.error('❌ Hata mesajı:', currentAudio.error?.message);
                        log.error('❌ Hata tipi:', currentAudio.error?.name);
                        
                        // Tanzil.net URL'lerini everyayah.com'a çevir (fallback)
                        if (ayet.ayet_ses_dosyasi && ayet.ayet_ses_dosyasi.includes('tanzil.net')) {
                            const ayetNo = ayet.ayet_kimligi?.split(':')[1] || '';
                            const sureNo = ayet.ayet_kimligi?.split(':')[0] || '';
                            const fallbackUrl = `https://everyayah.com/data/Alafasy_128kbps/${String(sureNo).padStart(3, '0')}${String(ayetNo).padStart(3, '0')}.mp3`;
                            log.error('🔄 Fallback URL deneniyor:', fallbackUrl);
                            
                            // Fallback URL'i dene
                            const fallbackAudio = new Audio(fallbackUrl);
                            fallbackAudio.addEventListener('loadeddata', () => {
                                fallbackAudio.play().then(() => {
                                    log.debug('✅ Fallback ses başarıyla çalındı');
                                    currentAudio = fallbackAudio;
                                }).catch(err => {
                                    log.error('❌ Fallback ses de çalınamadı:', err);
                                    elements.ayetAudioBtn.disabled = false;
                                });
                            });
                            fallbackAudio.onerror = () => {
                                log.error('❌ Fallback ses de yüklenemedi');
                                elements.ayetAudioBtn.disabled = false;
                            };
                            fallbackAudio.load();
                        } else {
                            elements.ayetAudioBtn.disabled = false;
                            currentAudio = null;
                        }
                    };
                    
                    // Ses dosyasını yükle
                    currentAudio.load();
                    
                    // Ses yüklenme durumu
                    currentAudio.onloadstart = () => {
                        log.debug('📥 Ses yüklenmeye başladı');
                    };

                    currentAudio.oncanplay = () => {
                        log.debug('✅ Ses çalmaya hazır');
                    };

                    currentAudio.onplay = () => {
                        log.debug('▶️ Ses çalmaya başladı');
                    };

                    currentAudio.onpause = () => {
                        log.debug('⏸️ Ses duraklatıldı');
                    };

                    currentAudio.ontimeupdate = () => {
                        // Null check - eğer currentAudio silinmişse event'i durdur
                        if (!currentAudio) return;
                        
                        // Her 5 saniyede bir log (çok fazla log'u önlemek için)
                        if (currentAudio.currentTime > 0 && Math.floor(currentAudio.currentTime) % 5 === 0) {
                            log.debug('⏱️ Ses oynatma zamanı:', currentAudio.currentTime.toFixed(2) + 's / ' + (currentAudio.duration || 0).toFixed(2) + 's');
                        }
                    };
                    
                    // Ses bittiğinde
                    currentAudio.onended = () => {
                        log.debug('🏁 Ayet sesi bitti');
                        elements.ayetAudioBtn.disabled = false;
                        updateTaskProgress('ayetOku', 1); // Görev sayılsın
                        currentAudio = null;
                    };
                    
                    // Hata durumunda
                    currentAudio.onerror = (err) => {
                        log.error('❌ Ses dosyası hatası:', err);
                        log.error('❌ Hata detayları:', {
                            code: currentAudio.error?.code,
                            message: currentAudio.error?.message
                        });
                        elements.ayetAudioBtn.disabled = false;
                        currentAudio = null;
                    };
                    
                } catch (err) {
                    log.error('Audio oluşturma hatası:', err);
                    elements.ayetAudioBtn.disabled = false;
                    currentAudio = null;
                }
            }
        };

        // ============ HADİS OKU MODU (RASTGELE) ============
        function showHadis() {
            // Rastgele hadis seç
            currentHadisIndex = Math.floor(Math.random() * hadisData.length);
            const hadis = hadisData[currentHadisIndex];
            if (!hadis) return;

            elements.hadisCategory.textContent = hadis.section || '';
            elements.hadisTitle.textContent = hadis.chapterName || '';
            elements.hadisHeader.textContent = hadis.header || '';
            elements.hadisText.textContent = hadis.text || '';
            elements.hadisRef.textContent = hadis.refno || '';
        }

        elements.prevHadisBtn.onclick = () => {
            stopCurrentAudio(); // Mevcut ses varsa durdur
            showHadis(); // Rastgele önceki hadis
            // Daily task progress - hadis okuma
            updateTaskProgress('hadisOku', 1);
        };

        elements.nextHadisBtn.onclick = () => {
            stopCurrentAudio(); // Mevcut ses varsa durdur
            showHadis(); // Rastgele sonraki hadis
            // Daily task progress - hadis okuma
            updateTaskProgress('hadisOku', 1);
        };

        // ============ OYUNU BAŞLAT ============
        // Performance: Async initialization
        setTimeout(async () => {
            try {
                await loadData();
                updateStatsBar(); // İstatistik barını initialize et
                log.debug('✅ Oyun veriler yüklendi ve hazır');
            } catch (error) {
                log.error('❌ Oyun yükleme hatası:', error);
            }
        }, 100); // DOM hazır olduktan sonra async başlat
            // Global debug fonksiyonu - console'dan çağırılabilir
            window.debugStats = function() {
                log.debug('🔧 DEBUG - Mevcut Oyun İstatistikleri:');
                log.debug('Total Points:', typeof totalPoints !== 'undefined' ? totalPoints : 'Henüz yüklenmedi');
                log.debug('Star Points:', typeof starPoints !== 'undefined' ? starPoints : 'Henüz yüklenmedi');
                log.debug('Level:', typeof level !== 'undefined' ? level : 'Henüz yüklenmedi');
                log.debug('Session Score:', typeof sessionScore !== 'undefined' ? sessionScore : 'Henüz yüklenmedi');
            };

            // 🔍 SENKRONİZASYON TESTİ - Kapsamlı kontrol
            window.testSenkronizasyon = function() {
                log.debug('\n═══════════════════════════════════════');
                log.debug('🔍 BAŞARI & PUAN SİSTEMİ SENKRONİZASYON TESTİ');
                log.debug('═══════════════════════════════════════\n');

                // 1. MEVCUT DURUM
                log.debug('📊 1. MEVCUT DURUM:');
                log.debug('   totalPoints:', totalPoints);
                log.debug('   sessionScore:', sessionScore);
                log.debug('   level:', level);
                log.debug('   starPoints:', starPoints);
                log.debug('   badges:', JSON.stringify(badges));
                log.debug('   comboCount:', comboCount);

                // 2. ROZET HESAPLAMA KONTROLÜ
                log.debug('\n🏅 2. ROZET SİSTEMİ KONTROLÜ:');
                const expectedBadges = {
                    bronze: Math.floor(totalPoints / 2000),
                    silver: Math.floor(totalPoints / 8500),
                    gold: Math.floor(totalPoints / 25500),
                    diamond: Math.floor(totalPoints / 85000)
                };
                log.debug('   Beklenen:', JSON.stringify(expectedBadges));
                log.debug('   Mevcut:', JSON.stringify(badges));

                const badgeMatch = JSON.stringify(expectedBadges) === JSON.stringify(badges);
                log.debug('   Senkronizasyon:', badgeMatch ? '✅ UYUMLU' : '❌ UYUMSUZ');

                if (!badgeMatch) {
                    log.debug('   ⚠️ Rozet sayıları tutarsız! updateBadgeSystem() çağrılıyor...');
                    updateBadgeSystem();
                    log.debug('   Düzeltilmiş:', JSON.stringify(badges));
                }

                // 3. BAŞARIM KONTROLÜ
                log.debug('\n🏆 3. BAŞARIM SİSTEMİ KONTROLÜ:');
                const unlockedAch = JSON.parse(localStorage.getItem('unlockedAchievements')) || [];
                log.debug('   Açılan başarımlar:', unlockedAch.length, 'adet');
                log.debug('   Liste:', unlockedAch.join(', '));

                // XP tabanlı başarımları kontrol et
                const xpAchievements = [
                    { id: 'xp_500', threshold: 500, name: 'İlk Adım' },
                    { id: 'xp_2000', threshold: 2000, name: 'Bronz Yolcu' },
                    { id: 'xp_4000', threshold: 4000, name: 'Hızlı Başlangıç' },
                    { id: 'xp_8500', threshold: 8500, name: 'Gümüş Master' },
                    { id: 'xp_17000', threshold: 17000, name: 'Çift Gümüş' },
                    { id: 'xp_25500', threshold: 25500, name: 'Altın Master' },
                    { id: 'xp_51000', threshold: 51000, name: 'Çift Altın' },
                    { id: 'xp_85000', threshold: 85000, name: 'Elmas Master' },
                    { id: 'xp_170000', threshold: 170000, name: 'Efsane' }
                ];

                let expectedAchievements = [];
                xpAchievements.forEach(ach => {
                    if (totalPoints >= ach.threshold) {
                        expectedAchievements.push(ach.id);
                        const hasAch = unlockedAch.includes(ach.id);
                        log.debug(`   ${hasAch ? '✅' : '❌'} ${ach.name} (${ach.threshold} XP): ${hasAch ? 'Açık' : 'KAPALI!'}`);
                    }
                });

                const missingAchievements = expectedAchievements.filter(id => !unlockedAch.includes(id));
                if (missingAchievements.length > 0) {
                    log.debug('   ⚠️ Eksik başarımlar:', missingAchievements.join(', '));
                    log.debug('   💡 checkAchievements() çağrılıyor...');
                    checkAchievements();
                }

                // 4. VERİ KALICILIĞI KONTROLÜ
                log.debug('\n💾 4. VERİ KALICILIĞI KONTROLÜ:');
                const lsPoints = localStorage.getItem('hasene_totalPoints');
                const lsBadges = localStorage.getItem('hasene_badges');
                log.debug('   localStorage totalPoints:', lsPoints);
                log.debug('   localStorage badges:', lsBadges);
                log.debug('   Memory totalPoints:', totalPoints);
                log.debug('   Memory badges:', JSON.stringify(badges));

                const lsMatch = parseInt(lsPoints) === totalPoints;
                log.debug('   Points senkronizasyon:', lsMatch ? '✅ UYUMLU' : '❌ UYUMSUZ');

                if (!lsMatch) {
                    log.debug('   ⚠️ localStorage güncel değil! saveStats() çağrılıyor...');
                    saveStats();
                }

                // 5. GÜNLÜK GÖREV KONTROLÜ
                log.debug('\n📅 5. GÜNLÜK GÖREV KONTROLÜ:');
                log.debug('   Bugünkü toplam puan:', dailyTasks.todayStats.toplamPuan);
                log.debug('   Günlük hedef:', dailyTasks.hedefler.toplamPuan);
                const dailyHasene = parseInt(localStorage.getItem('dailyHasene')) || 0;
                const goalHasene = parseInt(localStorage.getItem('dailyGoalHasene')) || 2700;
                log.debug('   Daily Hasene:', dailyHasene, '/', goalHasene);
                log.debug('   Günlük hedef tamamlandı mı?', dailyHasene >= goalHasene ? '✅ EVET' : '❌ HAYIR');

                // 6. SEVIYE HESAPLAMA KONTROLÜ
                log.debug('\n⬆️ 6. SEVİYE SİSTEMİ KONTROLÜ:');
                const calculatedLevel = calculateLevel(totalPoints);
                log.debug('   Hesaplanan seviye:', calculatedLevel);
                log.debug('   Mevcut seviye:', level);
                log.debug('   Seviye senkronizasyon:', calculatedLevel === level ? '✅ UYUMLU' : '❌ UYUMSUZ');

                if (calculatedLevel !== level) {
                    log.debug('   ⚠️ Seviye tutarsız! Düzeltiliyor...');
                    level = calculatedLevel;
                    updateStatsBar();
                }

                // 7. ÖZET RAPOR
                log.debug('\n═══════════════════════════════════════');
                log.debug('📊 ÖZET RAPOR:');
                log.debug('═══════════════════════════════════════');
                const allOK = badgeMatch && lsMatch && (calculatedLevel === level);
                log.debug('Genel Durum:', allOK ? '✅ TÜM SİSTEMLER SENKRONİZE' : '⚠️ BAZI SORUNLAR VAR');
                log.debug('Rozet Sistemi:', badgeMatch ? '✅' : '❌');
                log.debug('Veri Kalıcılığı:', lsMatch ? '✅' : '❌');
                log.debug('Seviye Sistemi:', (calculatedLevel === level) ? '✅' : '❌');
                log.debug('═══════════════════════════════════════\n');

                return allOK;
            };
            
            // Test puan ekleme fonksiyonu
            window.testAddPoints = function(points) {
                log.stats(`\n🎯 TEST: ${points} puan ekleniyor...`);
                log.stats('Önceki totalPoints:', totalPoints);
                addSessionPoints(points);
                log.stats('Sonraki totalPoints:', totalPoints);
                log.stats('✅ Puan eklendi. testSenkronizasyon() çalıştırılıyor...\n');
                setTimeout(() => testSenkronizasyon(), 500);
            };
            
            // Hızlı test senaryoları
            window.testSenaryo1 = function() {
                log.stats('\n🧪 SENARYO 1: Yeni kullanıcı (0 → 2500 XP)');
                resetPoints();
                testAddPoints(2500);
            };
            
            window.testSenaryo2 = function() {
                log.stats('\n🧪 SENARYO 2: Combo bonusu (3x doğru cevap)');
                resetPoints();
                addSessionPoints(10);
                addSessionPoints(10);
                addSessionPoints(10); // 3. cevap combo bonusu tetikler
                setTimeout(() => testSenkronizasyon(), 500);
            };
            
            window.testSenaryo3 = function() {
                log.stats('\n🧪 SENARYO 3: Rozet seviye atlama (25000 → 26000 XP)');
                totalPoints = 25000;
                updateBadgeSystem();
                saveStats();
                testAddPoints(1000); // Altın rozet kazanılmalı
            };
            
            window.testSenaryo4 = function() {
                log.stats('\n🧪 SENARYO 4: Sayfa yenileme simülasyonu');
                log.stats('1. Mevcut durum kaydediliyor...');
                saveStats();
                log.stats('2. Veri değişkenleri sıfırlanıyor (sayfa yenileme sim.)...');
                const savedPoints = totalPoints;
                totalPoints = 0;
                level = 1;
                badges = { bronze: 0, silver: 0, gold: 0, diamond: 0 };
                log.stats('3. Veriler yeniden yükleniyor...');
                loadStats().then(() => {
                    log.stats('4. Senkronizasyon kontrol ediliyor...');
                    setTimeout(() => {
                        log.stats('Kaydedilen XP:', savedPoints);
                        log.stats('Yüklenen XP:', totalPoints);
                        testSenkronizasyon();
                    }, 500);
                });
            };

            // Seviye geçiş test fonksiyonu - console'dan çağırılabilir
            window.testLevelUp = function(targetPoints) {
                log.stats('🎯 Seviye geçiş testi başlatılıyor...');
                log.stats('Mevcut puan:', totalPoints);
                log.stats('Hedef puan:', targetPoints);
                
                // Hedef puana sıçrama
                const oldLevel = calculateLevel(totalPoints);
                const difference = targetPoints - totalPoints;
                totalPoints = targetPoints;
                
                // Bugünkü puana da farkı ekle (test amaçlı)
                dailyTasks.todayStats.toplamPuan += difference;
                
                const newLevel = calculateLevel(totalPoints);
                
                log.debug('Eski seviye:', oldLevel);
                log.debug('Yeni seviye:', newLevel);
                
                // Seviye atlama kontrolü
                if (newLevel > oldLevel) {
                    level = newLevel;
                    log.game('✅ Seviye atlandı! Modal gösteriliyor...');
                    showLevelUpModal(newLevel);
                } else {
                    log.stats('❌ Seviye atlanmadı.');
                }
                
                updateStatsBar();
                saveStats(); // Değişiklikleri kaydet
            };

            // Hızlı seviye test fonksiyonları
            window.testLevel2 = () => testLevelUp(1000);   // Seviye 2'ye çık
            window.testLevel3 = () => testLevelUp(2500);   // Seviye 3'e çık
            window.testLevel5 = () => testLevelUp(8500);   // Seviye 5'e çık
            window.testLevel10 = () => testLevelUp(46000); // Seviye 10'a çık
            window.resetPoints = () => { 
                totalPoints = 0; 
                level = 1; 
                updateStatsBar(); 
                saveStats(); 
                log.stats('🔄 Puanlar sıfırlandı'); 
            };
            window.resetAllStats = resetAllStats;

            // Modal fonksiyonlarını global hale getir
            window.showBadgesModal = showBadgesModal;
            window.closeBadgesModal = closeBadgesModal;
            
            // SON ADIM: Kaydedilmiş verileri yükle
            try {
                // VERI SİSTEMİ BAŞLATMA (üçüncü taraf çerez sorunu için)
                log.debug('🚀 Veri sistemi başlatılıyor...');
                
                // IndexedDB başlat (çerez engellemelerinden etkilenmez)
                initIndexedDB().then(async () => {
                    log.debug('✅ IndexedDB hazır!');
                    await loadStats(); // Verileri yükle (IndexedDB öncelikli) - AWAIT EKLENDİ!
                    updateStatsBar();
                    log.debug('💾 Veriler yüklendi:', totalPoints, 'puan');
                }).catch(async (error) => {
                    log.error('❌ IndexedDB hatası, localStorage kullanılıyor:', error);
                    await loadStats(); // Fallback olarak localStorage - AWAIT EKLENDİ!
                    updateStatsBar();
                });
            } catch (error) {
                showCustomAlert(`Veri yükleme hatası: ${error.message}`, 'error');
                log.error('❌ Veri yükleme hatası:', error);
            }
            
            // ============ MODAL BUTONLARINA EVENT LISTENER EKLE ============
            if (dailyTasksBtn) dailyTasksBtn.onclick = showDailyTasksModal;
            if (statsBtn) statsBtn.onclick = showStatsModal;
            if (calendarBtn) calendarBtn.onclick = showCalendarModal;
            if (xpInfoBtn) xpInfoBtn.onclick = showXPInfoModal;
            
            // Modal kapatma butonları
            const closeBadgesBtn = document.getElementById('closeBadgesBtn');
            const closeCalendarBtn = document.getElementById('closeCalendarBtn');
            const closeDailyTasksBtn = document.getElementById('closeDailyTasksBtn');
            const closeStatsBtn = document.getElementById('closeStatsBtn');
            const closeDailyGoalBtn = document.getElementById('closeDailyGoalBtn');
            const closeXPInfoBtn = document.getElementById('closeXPInfoBtn');
            
            if (closeBadgesBtn) closeBadgesBtn.onclick = closeBadgesModal;
            if (closeCalendarBtn) closeCalendarBtn.onclick = closeCalendarModal;
            if (closeDailyTasksBtn) closeDailyTasksBtn.onclick = closeDailyTasksModal;
            if (closeStatsBtn) closeStatsBtn.onclick = closeStatsModal;
            
            // Daily Goal Modal butonları
            if (closeDailyGoalBtn) {
                closeDailyGoalBtn.onclick = function(e) {
                    e.stopPropagation();
                    closeDailyGoalModal();
                };
                // Touch event için de ekle
                closeDailyGoalBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeDailyGoalModal();
                }, { passive: false });
            }
            
            // Hedef seçim butonları
            const dailyGoalEasyBtn = document.getElementById('dailyGoalEasyBtn');
            const dailyGoalNormalBtn = document.getElementById('dailyGoalNormalBtn');
            const dailyGoalSeriousBtn = document.getElementById('dailyGoalSeriousBtn');
            
            if (dailyGoalEasyBtn) {
                dailyGoalEasyBtn.onclick = function(e) {
                    e.stopPropagation();
                    setDailyGoal('easy');
                };
                dailyGoalEasyBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    setDailyGoal('easy');
                }, { passive: false });
            }
            
            if (dailyGoalNormalBtn) {
                dailyGoalNormalBtn.onclick = function(e) {
                    e.stopPropagation();
                    setDailyGoal('normal');
                };
                dailyGoalNormalBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    setDailyGoal('normal');
                }, { passive: false });
            }
            
            if (dailyGoalSeriousBtn) {
                dailyGoalSeriousBtn.onclick = function(e) {
                    e.stopPropagation();
                    setDailyGoal('serious');
                };
                dailyGoalSeriousBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    setDailyGoal('serious');
                }, { passive: false });
            }
            if (closeXPInfoBtn) closeXPInfoBtn.onclick = closeXPInfoModal;
            
            // Not: Touch event'ler artık initStatsModalTouchEvents, initBadgesModalTouchEvents, 
            // initCalendarModalTouchEvents, initDailyTasksModalTouchEvents fonksiyonları tarafından yönetiliyor
            
            // ============ MODAL SWIPE GESTURES ============
            // Modal'lara swipe down ile kapatma özelliği ekle
            const modals = ['badgesModal', 'statsModal', 'calendarModal', 'dailyTasksModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal && CONFIG.swipeGesturesEnabled) {
                    initSwipeGestures(modal, {
                        onSwipeDown: () => {
                            // Swipe down ile modal'ı kapat
                            if (modalId === 'badgesModal') closeBadgesModal();
                            else if (modalId === 'statsModal') closeStatsModal();
                            else if (modalId === 'calendarModal') closeCalendarModal();
                            else if (modalId === 'dailyTasksModal') closeDailyTasksModal();
                        }
                    });
                }
            });
            
            // ============ BUTON HAPTIC FEEDBACK ============
            // Ana butonlara haptic feedback ekle
            const mainButtons = document.querySelectorAll('.flutter-btn, .game-card, .nav-btn, .back-btn');
            mainButtons.forEach(btn => {
                if (CONFIG.hapticEnabled) {
                    btn.addEventListener('click', () => {
                        triggerHaptic('light');
                    }, { passive: true });
                }
            });
            
            // ============ MODE SWIPE GESTURES ============
            // Ayet Oku, Dua Et, Hadis Oku modlarına swipe jestleri ekle
            if (CONFIG.swipeGesturesEnabled) {
                // Ayet Oku modu - swipe left/right ile önceki/sonraki ayet
                const ayetMode = document.getElementById('ayetMode');
                if (ayetMode) {
                    initSwipeGestures(ayetMode, {
                        onSwipeLeft: () => {
                            // Swipe left = sonraki ayet
                            const nextBtn = document.getElementById('nextAyetBtn');
                            if (nextBtn && !nextBtn.disabled) {
                                nextBtn.click();
                            }
                        },
                        onSwipeRight: () => {
                            // Swipe right = önceki ayet
                            const prevBtn = document.getElementById('prevAyetBtn');
                            if (prevBtn && !prevBtn.disabled) {
                                prevBtn.click();
                            }
                        }
                    });
                }
                
                // Dua Et modu - swipe left/right ile önceki/sonraki dua
                const duaMode = document.getElementById('duaMode');
                if (duaMode) {
                    initSwipeGestures(duaMode, {
                        onSwipeLeft: () => {
                            // Swipe left = sonraki dua
                            const nextBtn = document.getElementById('nextDuaBtn');
                            if (nextBtn && !nextBtn.disabled) {
                                nextBtn.click();
                            }
                        },
                        onSwipeRight: () => {
                            // Swipe right = önceki dua
                            const prevBtn = document.getElementById('prevDuaBtn');
                            if (prevBtn && !prevBtn.disabled) {
                                prevBtn.click();
                            }
                        }
                    });
                }
                
                // Hadis Oku modu - swipe left/right ile önceki/sonraki hadis
                const hadisMode = document.getElementById('hadisMode');
                if (hadisMode) {
                    initSwipeGestures(hadisMode, {
                        onSwipeLeft: () => {
                            // Swipe left = sonraki hadis
                            const nextBtn = document.getElementById('nextHadisBtn');
                            if (nextBtn && !nextBtn.disabled) {
                                nextBtn.click();
                            }
                        },
                        onSwipeRight: () => {
                            // Swipe right = önceki hadis
                            const prevBtn = document.getElementById('prevHadisBtn');
                            if (prevBtn && !prevBtn.disabled) {
                                prevBtn.click();
                            }
                        }
                    });
                }
            }
        
        }); // DOMContentLoaded event listener sonu

        
        // ============ YENİ LOADING SCREEN ============
        window.addEventListener('DOMContentLoaded', () => {
            // Yeni Loading Screen JavaScript
    const loadingScreen = document.getElementById('loadingScreen');
            const mainContainer = document.getElementById('mainMenu');
            const progressBar = document.getElementById('loadingProgressBar');
            const progressLabel = document.getElementById('loadingProgressLabel');
            const hadisArabic = document.getElementById('hadisArabic');
            const hadisTurkish = document.getElementById('hadisTurkish');
            const bagIcon = document.getElementById('bagIcon');
            
            // Dinamik Hadisler Listesi
            const hadisler = [
                {
                    arabic: 'مَنْ قَرَأَ حَرْفًا مِنْ كِتَابِ اللَّهِ فَلَهُ بِهِ حَسَنَةٌ وَالْحَسَنَةُ بِعَشْرِ أَمْثَالِهَا',
                    turkish: '"Kim Allah\'ın kitabından bir harf okursa, ona bir sevap verilir. O sevap da on mislidir."',
                    source: '(Tirmizi, Sevâbü\'l-Kur\'ân 16)'
                },
                {
                    arabic: 'خَيْرُكُمْ مَنْ تَعَلَّمَ الْقُرْآنَ وَعَلَّمَهُ',
                    turkish: '"Sizin en hayırlınız, Kur\'an\'ı öğrenen ve öğretendir."',
                    source: '(Buhari, Fedâilü\'l-Kur\'ân 21)'
                },
                {
                    arabic: 'إِنَّ اللَّهَ يُحِبُّ إِذَا عَمِلَ أَحَدُكُمْ عَمَلًا أَنْ يُتْقِنَهُ',
                    turkish: '"Allah, sizden birinizin bir iş yaptığında onu mükemmel yapmasını sever."',
                    source: '(Taberani)'
                },
                {
                    arabic: 'طَلَبُ الْعِلْمِ فَرِيضَةٌ عَلَى كُلِّ مُسْلِمٍ',
                    turkish: '"İlim öğrenmek her Müslümana farzdır."',
                    source: '(İbn Mâce)'
                },          
                {
                    arabic: 'إِنَّ الْأَجْرَ مَعَ الْمُصْطَلِحِينَ',
                    turkish: '"Kazancı, hakseverlerle birlikte olanlara verir."',
                    source: '(Ahmed bin Hanbel)'
                }
            ];
            
            // Rastgele hadis seç
            const randomHadis = hadisler[Math.floor(Math.random() * hadisler.length)];
            if (hadisArabic && hadisTurkish) {
                hadisArabic.textContent = randomHadis.arabic;
                const hadisSource = document.querySelector('.loading-hadith-source-text');
                if (hadisSource) {
                    hadisTurkish.textContent = randomHadis.turkish;
                    hadisSource.textContent = randomHadis.source;
                } else {
                hadisTurkish.innerHTML = `"${randomHadis.turkish}"<br><small style="opacity: 0.7; font-size: 13px; margin-top: 10px; display: block;">${randomHadis.source}</small>`;
                }
            }
            
            // Harfleri kitaba uçurma animasyonu
            const arabicAlphabet = ['ا', 'ب', 'ت', 'ث', 'ج', 'ح', 'خ', 'د', 'ذ', 'ر', 'ز', 'س', 'ش', 'ص', 'ض', 'ط', 'ظ', 'ع', 'غ', 'ف', 'ق', 'ك', 'ل', 'م', 'ن', 'ه', 'و', 'ي'];
            let animationInterval = null;
            
            // Tüm uçan harfleri temizle
            function clearAllFlyingLetters() {
                const allLetters = document.querySelectorAll('.flying-letter');
                allLetters.forEach(letter => {
                    if (letter.parentNode) {
                        letter.parentNode.removeChild(letter);
                    }
                });
            }
            
            function animateLettersToBag() {
                // Önce tüm eski harfleri temizle
                clearAllFlyingLetters();
                
                const bagIconElement = document.getElementById('bagIcon');
                if (!bagIconElement) {
                    setTimeout(animateLettersToBag, 500);
                    return;
                }
                
                const bagRect = bagIconElement.getBoundingClientRect();
                const bagCenterX = bagRect.left + bagRect.width / 2;
                const bagCenterY = bagRect.top + bagRect.height / 2;
                
                arabicAlphabet.forEach((letter, index) => {
                    setTimeout(() => {
                        // Rastgele başlangıç pozisyonu - kesinlikle ekranın dışından
                        const side = Math.floor(Math.random() * 4);
                        let startX, startY;
                        
                        if (side === 0) { // Üst
                            startX = Math.random() * window.innerWidth;
                            startY = -100; // Ekranın üstünden
                        } else if (side === 1) { // Sağ
                            startX = window.innerWidth + 100;
                            startY = Math.random() * window.innerHeight;
                        } else if (side === 2) { // Alt
                            startX = Math.random() * window.innerWidth;
                            startY = window.innerHeight + 100;
                        } else { // Sol
                            startX = -100;
                            startY = Math.random() * window.innerHeight;
                        }
                        
                        const letterEl = document.createElement('div');
                        letterEl.className = 'flying-letter';
                        letterEl.textContent = letter;
                        letterEl.style.position = 'fixed';
                        letterEl.style.left = startX + 'px';
                        letterEl.style.top = startY + 'px';
                        letterEl.style.zIndex = '100000';
                        letterEl.style.pointerEvents = 'none';
                        letterEl.style.opacity = '1';
                        letterEl.style.transform = 'scale(1)';
                        letterEl.style.transition = 'none'; // İlk başta transition yok
                        letterEl.style.willChange = 'transform, opacity, left, top';
                        
                        // Loading screen içine ekle
                        if (loadingScreen) {
                            loadingScreen.appendChild(letterEl);
                        } else {
                            document.body.appendChild(letterEl);
                        }
                        
                        // Animasyonu hemen başlat (requestAnimationFrame ile)
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                // Transition'ı aktif et ve hedefe git - daha yavaş (4.5 saniye)
                                letterEl.style.transition = 'all 4.5s cubic-bezier(0.4, 0, 0.2, 1)';
                                letterEl.style.left = bagCenterX + 'px';
                                letterEl.style.top = bagCenterY + 'px';
                                letterEl.style.transform = 'scale(0.4) rotate(360deg)';
                                
                                // Kitaba yaklaştıkça küçül
                    setTimeout(() => {
                                    if (letterEl && letterEl.parentNode) {
                                        letterEl.style.transform = 'scale(0.25) rotate(360deg)';
                                    }
                                }, 3500); // 2000'den 3500'e çıkarıldı
                                
                                // Kitaba ulaştıktan sonra kaybol - kesinlikle kaldır
                                setTimeout(() => {
                                    if (letterEl && letterEl.parentNode) {
                                        letterEl.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                        letterEl.style.opacity = '0';
                                        letterEl.style.transform = 'scale(0.01) rotate(360deg)';
                                        
                                        // DOM'dan kesinlikle kaldır
                                        setTimeout(() => {
                                            if (letterEl && letterEl.parentNode) {
                                                try {
                                                    letterEl.parentNode.removeChild(letterEl);
                                                } catch(e) {
                                                    // Zaten kaldırılmış olabilir
                                                }
                                            }
                                        }, 300);
                                    }
                                }, 4500); // 2500'den 4500'e çıkarıldı
                            });
                        });
                    }, index * 300); // 200'den 300'e çıkarıldı (harfler arası gecikme)
                });
            }
            
            // Animasyonu başlat
            const startAnimation = () => {
                // Önce tüm harfleri temizle
                clearAllFlyingLetters();
                
                const bagIconElement = document.getElementById('bagIcon');
                if (bagIconElement && bagIconElement.complete) {
                    // Önceki interval'i temizle
                    if (animationInterval) {
                        clearInterval(animationInterval);
                        animationInterval = null;
                    }
                    
                    // İlk animasyonu başlat
                    setTimeout(() => {
                        animateLettersToBag();
                    }, 1000);
                    
                    // Yeni interval başlat - daha uzun aralık (harfler yavaş uçtuğu için)
                    animationInterval = setInterval(() => {
                        animateLettersToBag();
                    }, 12000); // 8 saniyeden 12 saniyeye çıkarıldı
                } else {
                    setTimeout(startAnimation, 200);
                }
            };
            
            // Sayfa yüklendiğinde temizle ve başlat
            clearAllFlyingLetters();
            
            // Biraz bekleyip başlat (DOM'un hazır olması için)
            setTimeout(() => {
                startAnimation();
            }, 300);
            
            // Sayfa kapanırken temizle
            window.addEventListener('beforeunload', () => {
                clearAllFlyingLetters();
                if (animationInterval) {
                    clearInterval(animationInterval);
                }
            });
            
            // Progress bar animasyonu
            let progress = 0;
            const progressSteps = [
                { percent: 40, label: 'Kelime verileri yükleniyor...', duration: 2000 },
                { percent: 70, label: 'Ayetler hazırlanıyor...', duration: 2000 },
                { percent: 100, label: 'Haydi Bismillah...', duration: 1500 }
            ];
            
            function updateProgress() {
                if (progressSteps.length === 0) return;
                
                const step = progressSteps.shift();
                const targetProgress = step.percent;
                const increment = (targetProgress - progress) / (step.duration / 30);
                
                const interval = setInterval(() => {
                    progress += increment;
                    if (progress >= targetProgress) {
                        progress = targetProgress;
                        clearInterval(interval);
                        
                        if (progressSteps.length > 0) {
                            setTimeout(updateProgress, 500);
                        } else {
            setTimeout(() => {
                                // Loading screen kapanırken tüm harfleri temizle
                                clearAllFlyingLetters();
                                if (animationInterval) {
                                    clearInterval(animationInterval);
                                    animationInterval = null;
                                }
                                
                                if (loadingScreen) {
                                    loadingScreen.style.opacity = '0';
                                    setTimeout(() => {
                                        loadingScreen.style.display = 'none';
                                        // Ekstra temizlik
                                        clearAllFlyingLetters();
                                    }, 500);
                                }
                                
                        const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
                        if (!hasSeenOnboarding) {
                            setTimeout(() => {
                                if (typeof showOnboarding === 'function') {
                                    showOnboarding();
                                } else {
                if (mainContainer) mainContainer.style.display = 'block';
                                }
                            }, 100);
                        } else {
                            if (mainContainer) mainContainer.style.display = 'block';
                        }
                            }, 1000);
                        }
                    }
                    
                if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }
                }, 30);
                
                if (progressLabel) {
                    progressLabel.textContent = step.label;
                }
            }
            
            setTimeout(() => {
                updateProgress();
            }, 500);
        });



    </script>

    <!-- Özel Onay Pop-up -->
        <script>
        // Arapça hareke renklendirme fonksiyonu artık boş
        function updateArabicTextColoring() {}
            
        
        </script>




    <div class="custom-confirm" id="customConfirm">
        <div class="confirm-content">
            <div class="confirm-title">🎮 Oyundan Çıkış</div>
            <div class="confirm-stats" id="confirmStats">
                <div class="confirm-stat">
                    <span>✅ Doğru cevap:</span>
                    <span id="confirmCorrect">0</span>
                </div>
                <div class="confirm-stat">
                    <span>❌ Hatalı cevap:</span>
                    <span id="confirmWrong">0</span>
                </div>
                <div class="confirm-stat">
                    <span>� Kazanılan Hasene:</span>
                    <span id="confirmXP">0</span>
                </div>
            </div>
            <div class="confirm-message">
                Puanlarınız zaten kaydedildi, güvenle çıkabilirsiniz.
            </div>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" id="confirmCancel">İptal</button>
                <button class="confirm-btn ok" id="confirmOK">Çıkış Yap</button>
            </div>
        </div>
    </div>

    <!-- Flutter Bottom Navigation -->
    <div class="flutter-top-nav" id="bottomNavBar">                                
        <a class="flutter-nav-item" onclick="showMainMenu(); setActiveNavItem(0);">
            <i class="material-icons">home</i>
            <span>Ana Sayfa</span>
        </a>
        <a class="flutter-nav-item" onclick="showStatsModal(); setActiveNavItem(1);">
            <i class="material-icons">analytics</i>
            <span>İstatistik</span>
        </a>
        <a class="flutter-nav-item" onclick="showDailyTasksModal(); setActiveNavItem(2);" id="navTasks">
            <i class="material-icons">task_alt</i>
            <span>Görevler</span>
            <span class="nav-badge" id="tasksBadge" style="display: none;">!</span>
        </a>
        <a class="flutter-nav-item" onclick="showBadgesModal(); setActiveNavItem(3);">
            <i class="material-icons">emoji_events</i>
            <span>Başarılar</span>
        </a>
        <a class="flutter-nav-item" onclick="showCalendarModal(); setActiveNavItem(4);">
            <i class="material-icons">calendar_today</i>
            <span>Takvim</span>
        </a>
    </div>

    <script>

// Ana menüyü göster - uses hideAllGameScreens from main script
function showMainMenu() {
    // Tüm ekranları ve modal'ları gizle
    if (typeof hideAllGameScreens === 'function') {
        hideAllGameScreens();
    } else {
        // Fallback if function not available
        const screens = ['kelimeCevirScreen', 'dinleBulScreen', 'boslukDoldurScreen', 'ayetOkuScreen', 'hadisOkuScreen', 'duaOgrenScreen'];
        screens.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.style.display = 'none';
                el.style.zIndex = '';
            }
        });
    }
    
    // Navigasyon bar'ı göster (ana ekrana dönünce)
    if (typeof showBottomNavBar === 'function') {
        showBottomNavBar();
    }
    
    // Tüm oyun modlarını gizle
    const modeIds = ['gameScreen', 'modeSelector', 'ayetMode', 'duaMode', 'hadisMode', 'boslukMode', 'dinleMode'];
    modeIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.style.display = 'none';
            el.style.zIndex = '';
        }
    });
    
    // Tüm modal'ları gizle
    const modals = ['statsModal', 'badgesModal', 'calendarModal', 'dailyTasksModal', 'onboardingModal', 'dailyGoalModal', 'xpInfoModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            modal.style.zIndex = '';
        }
    });
    
    // Ana menüyü göster
    if (document.getElementById('mainMenu')) {
        const mainMenu = document.getElementById('mainMenu');
        mainMenu.style.display = 'block';
        mainMenu.style.zIndex = '';
    }

// Navigation active state
        document.querySelectorAll('.flutter-nav-item').forEach(item => {
            item.classList.remove('active');
        });
        const firstNavItem = document.querySelector('.flutter-nav-item');
        if (firstNavItem) firstNavItem.classList.add('active');
}


        // Bottom navigation active state yönetimi
        function setActiveNavItem(index) {
            document.querySelectorAll('.flutter-nav-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
        }

        // ⚡ SPEED ANIMATIONS SYSTEM
        function addSpeedAnimation(element, type = 'fade-in') {
            if (!element) return;
            element.classList.add(`speed-${type}`);
            setTimeout(() => element.classList.remove(`speed-${type}`), 600);
        }

        // 🎆 SUCCESS ANIMATIONS - CONFETTI SYSTEM
        function triggerConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);

            // 50 konfeti parçası oluştur
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                container.appendChild(confetti);
            }

            // 3 saniye sonra temizle
            setTimeout(() => {
                if (container.parentNode) {
                    container.parentNode.removeChild(container);
                }
            }, 3000);
        }

        function triggerSuccessBurst(element) {
            if (!element) return;
            element.classList.add('success-burst');
            setTimeout(() => element.classList.remove('success-burst'), 800);
        }

        // 📱 HAPTIC FEEDBACK SYSTEM
        function triggerHaptic(type = 'medium') {
            // CONFIG kontrolü ile haptic feedback
            if (!CONFIG.hapticEnabled) return;
            
            try {
                // Modern haptic feedback API
                if ('vibrate' in navigator) {
                    const patterns = {
                        light: [10],
                        medium: [20],
                        heavy: [50],
                        success: [20, 50, 20],
                        error: [50, 100, 50],
                        combo: [20, 30, 20, 30, 50],
                        warning: [30, 50, 30]
                    };
                    navigator.vibrate(patterns[type] || patterns.medium);
                }
            } catch (error) {
                log.debug('Haptic feedback not supported');
            }
        }

        // ============ SMOKE TESTS / QUICK CHECKS ============
        // Non-destructive helper to validate Kelime flow: load a question,
        // click the first option and confirm the Next button becomes visible.
        // Call from console with: __testKelimeFlow()
        window.__testKelimeFlow = async function() {
                try {
                    log.stats('🧪 Running quick Kelime smoke test...');
                if (!elements || !elements.kelimeCevirBtn) {
                    log.debug('⚠️ kelimeCevirBtn or elements not found');
                    return false;
                }
                // Ensure mode selector shown and start the game
                elements.kelimeCevirBtn.click();
                await new Promise(r => setTimeout(r, 150));
                if (elements.startBtn) elements.startBtn.click();
                await new Promise(r => setTimeout(r, 300));

                const opts = document.querySelectorAll('#options .option');
                if (!opts || opts.length === 0) {
                    console.warn('⚠️ No options rendered yet; ensure kelime data is loaded');
                    return false;
                }
                // Click first option
                opts[0].click();
                await new Promise(r => setTimeout(r, 200));
                const visible = elements.nextBtn && window.getComputedStyle(elements.nextBtn).display !== 'none';
                log.stats('🧪 Next button visible after answer?', visible);
                return visible;
            } catch (err) {
                log.error('🧪 Smoke test failed:', err);
                return false;
            }
        };
       

    </script>

<!-- SERVICE WORKER KAYIT KODU BURAYA -->
<script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js")
            .then(() => console.log("SW registered ✔"))
            .catch(err => console.log("SW registration failed ❌", err));
    }
</script>

<!-- PUSH NOTIFICATIONS SYSTEM -->
<script>
    // ============ PUSH BİLDİRİMLERİ SİSTEMİ ============
    let notificationPermission = 'default';
    let notificationSettings = {
        dailyReminder: true,
        streakWarning: true,
        goalCompletion: true,
        customEvents: true,
        reminderTime: '20:00' // Varsayılan: 20:00
    };
    
    // Bildirim ayarlarını yükle
    function loadNotificationSettings() {
        try {
            const saved = localStorage.getItem('haseneNotificationSettings');
            if (saved) {
                notificationSettings = { ...notificationSettings, ...JSON.parse(saved) };
            }
        } catch (e) {
            log.error('Bildirim ayarları yükleme hatası:', e);
        }
    }
    
    // Bildirim ayarlarını kaydet
    function saveNotificationSettings() {
        try {
            localStorage.setItem('haseneNotificationSettings', JSON.stringify(notificationSettings));
        } catch (e) {
            log.error('Bildirim ayarları kaydetme hatası:', e);
        }
    }
    
    // Bildirim izni kontrolü ve isteme
    async function requestNotificationPermission() {
        if (!('Notification' in window)) {
            log.warn('Bu tarayıcı bildirimleri desteklemiyor');
            return false;
        }
        
        notificationPermission = Notification.permission;
        
        if (notificationPermission === 'default') {
            try {
                const permission = await Notification.requestPermission();
                notificationPermission = permission;
                log.debug('Bildirim izni:', permission);
                return permission === 'granted';
            } catch (e) {
                log.error('Bildirim izni hatası:', e);
                return false;
            }
        }
        
        return notificationPermission === 'granted';
    }
    
    // Bildirim göster (Service Worker üzerinden)
    async function showNotification(title, options = {}) {
        if (!('Notification' in window) || !('serviceWorker' in navigator)) {
            log.warn('Bildirimler desteklenmiyor');
            return;
        }
        
        if (Notification.permission !== 'granted') {
            const granted = await requestNotificationPermission();
            if (!granted) {
                log.warn('Bildirim izni verilmedi');
                return;
            }
        }
        
        try {
            const registration = await navigator.serviceWorker.ready;
            
            const notificationOptions = {
                body: options.body || '',
                icon: options.icon || './icon-192-v4-RED-MUSHAF.png',
                badge: options.badge || './icon-192-v4-RED-MUSHAF.png',
                tag: options.tag || 'hasene-notification',
                requireInteraction: options.requireInteraction || false,
                data: {
                    url: options.url || window.location.href,
                    ...options.data
                },
                vibrate: options.vibrate || [200, 100, 200],
                ...options
            };
            
            await registration.showNotification(title, notificationOptions);
            log.debug('Bildirim gösterildi:', title);
        } catch (e) {
            log.error('Bildirim gösterilirken hata:', e);
        }
    }
    
    // Günlük hatırlatıcı zamanlayıcısı
    let dailyReminderTimer = null;
    
    function scheduleDailyReminder() {
        if (!notificationSettings.dailyReminder) return;
        
        // Mevcut zamanlayıcıyı temizle
        if (dailyReminderTimer) {
            clearTimeout(dailyReminderTimer);
        }
        
        const [hours, minutes] = notificationSettings.reminderTime.split(':').map(Number);
        const now = new Date();
        const reminderTime = new Date();
        reminderTime.setHours(hours, minutes, 0, 0);
        
        // Eğer bugünün saati geçtiyse, yarın için ayarla
        if (reminderTime <= now) {
            reminderTime.setDate(reminderTime.getDate() + 1);
        }
        
        const msUntilReminder = reminderTime.getTime() - now.getTime();
        
        dailyReminderTimer = setTimeout(async () => {
            // Bugün oyun oynanmış mı kontrol et
            const today = typeof getLocalDateString === 'function' ? getLocalDateString() : new Date().toISOString().split('T')[0];
            const lastPlayDate = localStorage.getItem('haseneLastPlayDate');
            
            // dailyTasks'tan veya localStorage'dan bugünkü istatistikleri al
            let todayStats = {};
            if (typeof window.dailyTasks !== 'undefined' && window.dailyTasks && window.dailyTasks.todayStats) {
                todayStats = window.dailyTasks.todayStats;
            } else {
                try {
                    const dailyTasksStr = localStorage.getItem('hasene_dailyTasks');
                    if (dailyTasksStr) {
                        const dailyTasks = JSON.parse(dailyTasksStr);
                        if (dailyTasks && dailyTasks.todayStats) {
                            todayStats = dailyTasks.todayStats;
                        }
                    }
                } catch (e) {
                    // Hata durumunda boş obje kullan
                }
            }
            
            const hasPlayedToday = lastPlayDate === today && (todayStats.toplamPuan > 0 || todayStats.kelimeCevir > 0);
            
            if (!hasPlayedToday) {
                await showNotification('📚 Günlük Hatırlatıcı', {
                    body: 'Bugün henüz oyun oynamadınız! Serinizi bozmamak için hemen oyuna başlayın. 🔥',
                    tag: 'daily-reminder',
                    requireInteraction: false,
                    vibrate: [200, 100, 200]
                });
            }
            
            // Yarın için tekrar zamanla
            scheduleDailyReminder();
        }, msUntilReminder);
        
        log.debug('Günlük hatırlatıcı zamanlandı:', reminderTime);
    }
    
    // Seri bozulma uyarısı kontrolü
    function checkStreakWarning() {
        if (!notificationSettings.streakWarning) return;
        
        try {
            const streakDataStr = localStorage.getItem('haseneStreakData');
            if (!streakDataStr) return;
            
            const streakData = JSON.parse(streakDataStr);
            const currentStreak = streakData.currentStreak || 0;
            const lastPlayDate = localStorage.getItem('haseneLastPlayDate');
            const today = getLocalDateString();
            
            // Eğer seri varsa ve bugün oyun oynanmamışsa uyar
            if (currentStreak > 0 && lastPlayDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = getLocalDateString(yesterday);
                
                // Dün oynanmışsa, bugün uyarı ver
                if (lastPlayDate === yesterdayStr) {
                    showNotification('⚠️ Seri Bozulma Uyarısı!', {
                        body: `${currentStreak} günlük seriniz bozulmak üzere! Bugün oyun oynamayı unutmayın. 🔥`,
                        tag: 'streak-warning',
                        requireInteraction: false,
                        vibrate: [300, 100, 300]
                    });
                }
            }
        } catch (e) {
            log.error('Seri uyarısı kontrolü hatası:', e);
        }
    }
    
    // Hedef tamamlama bildirimi
    function checkGoalCompletion() {
        if (!notificationSettings.goalCompletion) return;
        
        try {
            const dailyGoalHasene = parseInt(localStorage.getItem('dailyGoalHasene') || '2700');
            
            // dailyTasks'tan veya localStorage'dan bugünkü puanı al
            let todayProgress = 0;
            
            // Önce global dailyTasks değişkenini kontrol et
            if (typeof window.dailyTasks !== 'undefined' && window.dailyTasks && window.dailyTasks.todayStats) {
                todayProgress = window.dailyTasks.todayStats.toplamPuan || 0;
            } else {
                // localStorage'dan oku
                try {
                    const dailyTasksStr = localStorage.getItem('hasene_dailyTasks');
                    if (dailyTasksStr) {
                        const dailyTasks = JSON.parse(dailyTasksStr);
                        if (dailyTasks && dailyTasks.todayStats) {
                            todayProgress = dailyTasks.todayStats.toplamPuan || 0;
                        }
                    }
                } catch (e) {
                    // localStorage'dan okuyamazsa, dailyHasene'yi kullan
                    todayProgress = parseInt(localStorage.getItem('dailyHasene') || '0');
                }
            }
            
            // Hedef tamamlandıysa bildirim göster
            if (todayProgress >= dailyGoalHasene && dailyGoalHasene > 0) {
                // Sadece bir kez bildirim göster (bugün için)
                const today = typeof getLocalDateString === 'function' ? getLocalDateString() : new Date().toISOString().split('T')[0];
                const goalNotificationShown = localStorage.getItem(`goalNotification_${today}`);
                if (!goalNotificationShown) {
                    showNotification('🎉 Günlük Hedef Tamamlandı!', {
                        body: `Tebrikler! Günlük hedefinizi tamamladınız (${dailyGoalHasene} puan). Devam edin! 🏆`,
                        tag: 'goal-completion',
                        requireInteraction: false,
                        vibrate: [200, 100, 200, 100, 200]
                    });
                    localStorage.setItem(`goalNotification_${today}`, 'true');
                }
            }
        } catch (e) {
            log.error('Hedef tamamlama kontrolü hatası:', e);
        }
    }
    
    // Özel etkinlik bildirimi gönder
    function sendCustomEventNotification(title, body, options = {}) {
        if (!notificationSettings.customEvents) return;
        
        showNotification(title, {
            body: body,
            tag: options.tag || 'custom-event',
            requireInteraction: options.requireInteraction || false,
            vibrate: options.vibrate || [200, 100, 200],
            ...options
        });
    }
    
    // Sayfa yüklendiğinde bildirim sistemini başlat
    window.addEventListener('DOMContentLoaded', () => {
        loadNotificationSettings();
        
        // Bildirim izni kontrolü
        if ('Notification' in window) {
            notificationPermission = Notification.permission;
            
            // İzin verilmişse zamanlayıcıları başlat
            if (notificationPermission === 'granted') {
                scheduleDailyReminder();
                checkStreakWarning();
            }
        }
        
        // Her 30 dakikada bir seri uyarısı kontrol et
        setInterval(() => {
            if (notificationPermission === 'granted') {
                checkStreakWarning();
            }
        }, 30 * 60 * 1000); // 30 dakika
        
        // Her 5 dakikada bir hedef tamamlama kontrolü
        setInterval(() => {
            if (notificationPermission === 'granted') {
                checkGoalCompletion();
            }
        }, 5 * 60 * 1000); // 5 dakika
    });
    
    // Global erişim için
    window.requestNotificationPermission = requestNotificationPermission;
    window.showNotification = showNotification;
    window.sendCustomEventNotification = sendCustomEventNotification;
    window.notificationSettings = notificationSettings;
    window.saveNotificationSettings = saveNotificationSettings;
</script>

<!-- PWA INSTALL PROMPT -->
<script>
    let deferredPrompt;
    let pwaInstallBtn;
    
    // localStorage kontrolü - daha önce yükleme yapıldı mı?
    function hasPWAInstallBeenShown() {
        return localStorage.getItem('pwaInstallShown') === 'true' || localStorage.getItem('pwaInstalled') === 'true';
    }
    
    function markPWAInstallShown() {
        localStorage.setItem('pwaInstallShown', 'true');
    }
    
    function markPWAInstalled() {
        localStorage.setItem('pwaInstalled', 'true');
        localStorage.setItem('pwaInstallShown', 'true');
    }
    
    // Sayfa yüklendiğinde butonu al
    window.addEventListener('DOMContentLoaded', () => {
        pwaInstallBtn = document.getElementById('pwaInstallBtn');
        
        // Mobil cihaz kontrolü
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        
        // Eğer standalone modda çalışıyorsa (zaten yüklü), butonu gizle
        if (isStandalone) {
            if (pwaInstallBtn) {
                pwaInstallBtn.style.display = 'none';
            }
            markPWAInstalled();
            log.debug('📱 Uygulama standalone modda çalışıyor (zaten yüklü)');
            return;
        }
        
        // Eğer daha önce yükleme yapıldıysa veya gösterildiyse, butonu gizle
        if (hasPWAInstallBeenShown()) {
            if (pwaInstallBtn) {
                pwaInstallBtn.style.display = 'none';
            }
            log.debug('📱 PWA install butonu daha önce gösterildi, tekrar gösterilmiyor');
            return;
        }
        
        // Buton başlangıçta gizli, sadece beforeinstallprompt event'i geldiğinde gösterilecek
        if (pwaInstallBtn) {
            pwaInstallBtn.style.display = 'none';
        }
    });
    
    // beforeinstallprompt event'i yakala
    window.addEventListener('beforeinstallprompt', (e) => {
        // Eğer daha önce yükleme yapıldıysa, event'i ignore et
        if (hasPWAInstallBeenShown()) {
            log.debug('📱 PWA install daha önce gösterildi, event ignore ediliyor');
            return;
        }
        
        // Varsayılan prompt'u engelle
        e.preventDefault();
        // Event'i sakla
        deferredPrompt = e;
        
        // Mobil cihaz kontrolü
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Sadece mobil cihazlarda butonu göster
        if (pwaInstallBtn && isMobile) {
            pwaInstallBtn.style.display = 'block';
            log.debug('📲 PWA install butonu görünür (mobil cihaz, beforeinstallprompt)');
        }
    });
    
    // Uygulama zaten yüklüyse butonu gizle
    window.addEventListener('appinstalled', () => {
        if (pwaInstallBtn) {
            pwaInstallBtn.style.display = 'none';
        }
        deferredPrompt = null;
        markPWAInstalled();
        log.debug('✅ PWA başarıyla yüklendi');
    });
    
    // PWA install fonksiyonu
    window.triggerPWAInstall = async () => {
        if (!deferredPrompt) {
            // Mobil cihaz kontrolü
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (!isMobile) {
                // Masaüstünde buton görünmemeli, ama eğer görünürse kullanıcıya bilgi ver
                log.debug('💻 Masaüstü cihaz - PWA install tarayıcı UI ile yapılır');
                alert('💻 Masaüstünde uygulamayı yüklemek için:\n\n' +
                      '• Chrome/Edge: Adres çubuğundaki yükle ikonuna (⬇) tıklayın\n' +
                      '• Veya Menü (⋮) > "Uygulamayı yükle"\n\n' +
                      'Not: Bu buton sadece mobil cihazlarda görünür.');
                return;
            }
            
            // Mobil cihazlarda prompt yoksa manuel talimat ver
            log.debug('⚠️ PWA install prompt mevcut değil (mobil cihaz)');
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            const isChrome = /Chrome/.test(navigator.userAgent);
            
            let instructions = '📲 Uygulamayı ana ekrana eklemek için:\n\n';
            
            if (isIOS) {
                instructions += '• Safari: Paylaş butonu (□↑) > "Ana Ekrana Ekle"\n';
            } else if (isAndroid) {
                if (isChrome) {
                    instructions += '• Chrome: Menü (⋮) > "Uygulamayı yükle" veya "Ana ekrana ekle"\n';
                } else {
                    instructions += '• Tarayıcı menüsünden "Ana ekrana ekle" seçeneğini bulun\n';
                }
            } else {
                instructions += '• Tarayıcı menüsünden "Ana ekrana ekle" seçeneğini bulun\n';
            }
            
            alert(instructions);
            return;
        }
        
        // Prompt'u göster
        deferredPrompt.prompt();
        
        // Kullanıcının seçimini bekle
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            log.debug('✅ Kullanıcı PWA yüklemeyi kabul etti');
            markPWAInstalled();
        } else {
            log.debug('❌ Kullanıcı PWA yüklemeyi reddetti');
            markPWAInstallShown(); // Reddettiğinde de gösterildi olarak işaretle, tekrar çıkmasın
        }
        
        // Prompt'u temizle
        deferredPrompt = null;
        
        // Butonu gizle
        if (pwaInstallBtn) {
            pwaInstallBtn.style.display = 'none';
        }
    };
</script>

<button id="pwaInstallBtn" onclick="window.triggerPWAInstall()"
    style="
        position: fixed;
        bottom: 100px;
        right: 15px;
        left: 15px;
        max-width: 300px;
        margin: 0 auto;
        padding: 14px 20px;
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        border: none;
        border-radius: 14px;
        font-size: clamp(14px, 3.5vw, 16px);
        font-weight: bold;
        color: #1a1a1a;
        box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        z-index: 10000;
        display: none;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    "
    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(255, 215, 0, 0.6)'"
    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.5)'">
    📲 Uygulamayı Yükle
</button>

</body>
</html>



